<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport updated for "Notch" support on mobile phones -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Spanish by Sammy</title>

    <!-- ================= PWA SETTINGS ================= -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SammySpanish">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/180/F57C00/ffffff?text=S">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Spanish by Sammy","short_name":"SammySpanish","start_url":".","display":"standalone","background_color":"#0A2647","theme_color":"#0A2647","icons":[{"src":"https://via.placeholder.com/192/F57C00/ffffff?text=S","sizes":"192x192","type":"image/png"},{"src":"https://via.placeholder.com/512/F57C00/ffffff?text=S","sizes":"512x512","type":"image/png"}]}'>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Confetti Library for Celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Hammer.js for Swipe Gestures -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { 900: '#0A2647', 800: '#144272', 700: '#205295' },
                        orange: { 500: '#F57C00', 600: '#E65100' },
                        gray: { 50: '#F9FAFB', 100: '#F3F4F6', 200: '#E5E7EB', 300: '#D9D9D9', 800: '#1F2937' },
                        green: { 500: '#10B981' },
                        gold: { 400: '#FBBF24', 500: '#F59E0B', 600: '#D97706' } 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .grayscale { filter: grayscale(1); }
        /* Body padding removed to allow Nav background to fill the notch area */
        :root {
            --vocab-ring-color: #F57C00;
            --lesson-ring-color: #0A2647;
            --verb-ring-color: #205295;
        }
        body {
            padding-bottom: env(safe-area-inset-bottom);
            background-color: #F9FAFB; /* gray-50 match */
        }
        .notch-padding {
            padding-top: env(safe-area-inset-top);
        }

        /* Extend nav background into safe area above notch */
        nav::before {
            content: '';
            position: absolute;
            top: calc(-1 * env(safe-area-inset-top));
            left: 0;
            right: 0;
            height: env(safe-area-inset-top);
            background-color: #0A2647; /* navy-900 */
            z-index: -1;
        }
        .no-select {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        .page-section {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }
        .page-section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Accordion Animations */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out; /* Standardized timing */
        }
        
        .rotate-chevron {
            transform: rotate(180deg);
            transition: transform 0.3s;
        }
        
        /* Condensed Dashboard Transitions */
        #flashcard-dashboard, #lessons-dashboard, #lessons-search-wrapper {
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
        }

        /* Flash Animation for Jumping */
        @keyframes flashHighlight {
            0% { background-color: rgba(249, 115, 22, 0.1); transform: scale(1); }
            50% { background-color: rgba(249, 115, 22, 0.3); transform: scale(1.02); }
            100% { background-color: transparent; transform: scale(1); }
        }
        
        .flash-highlight {
            animation: flashHighlight 1.5s ease-in-out;
        }

        /* Card Swipe Animations */
        @keyframes swipeRight {
            to { transform: translate3d(120%, 0, 0) rotate(15deg); opacity: 0; }
        }
        @keyframes swipeLeft {
            to { transform: translate3d(-120%, 0, 0) rotate(-15deg); opacity: 0; }
        }
        .animate-swipe-right {
            animation: swipeRight 0.3s ease-out forwards;
            will-change: transform, opacity;
        }
        .animate-swipe-left {
            animation: swipeLeft 0.3s ease-out forwards;
            will-change: transform, opacity;
        }
        .card-container {
            perspective: 1000px;
        }
        
        /* Loading Overlay Style */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(249, 250, 251, 0.7);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            border-top-color: #F57C00;
            border-right-color: transparent;
            border-bottom-color: #F57C00;
            border-left-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Custom Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            border-radius: 2px;
        }
        
        /* Dashboard Slides Logic */
        .dashboard-track {
            display: flex;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            width: 300%; /* Exactly 300% for 3 slides */
        }
        .dashboard-slide {
            width: 33.333%; /* Each slide is 33.333% of the track */
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        /* Scrollbar Styling for Review List */
        .review-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .review-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .review-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .review-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Video Responsive Container */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Chat Message Styles */
        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            line-height: 1.4;
            font-size: 0.95rem;
        }
        .chat-user {
            background-color: #F57C00;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .chat-ai {
            background-color: #F3F4F6;
            color: #1F2937;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #E5E7EB;
        }
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #9CA3AF;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Search Active State Transitions */
        .search-container {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .search-container.search-active {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
            z-index: 60; /* Above nav bar */
            padding-top: calc(env(safe-area-inset-top) + 12px); /* Add padding top */
            padding-right: 12px; /* Add padding right */
            margin: 0;
            border-radius: 0;
        }
        .search-results-condensed {
            padding-left: 1rem;
            padding-right: 1rem;
            padding-bottom: 5rem;
            margin-top: 1rem;
            height: 100%;
            overflow-y: auto;
        }
        /* Search Input Animation in Active Mode */
        .search-active .search-input-wrapper {
            background-color: #f3f4f6; /* gray-100 */
            border-radius: 0.5rem;
            box-shadow: none;
            border: none;
        }
        
        /* ========== FLASHCARD 3D STYLES ========== */
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* Flashcard Transitions */
        .transition-transform-smooth { 
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.35s ease-in-out; 
        }
        .transition-appear { 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        opacity 0.3s ease-out; 
        }
        .transition-flip { transition: transform 0.5s; }
        .no-transition { transition: none !important; }
        
        /* Dictionary Definition Styles */
        .def-content p { margin-bottom: 0.5rem; }
        
        /* Hide Scrollbars (for touch interactions) */
        ::-webkit-scrollbar { display: none; }

        /* ========== MODERN RATING BUTTON STYLES (SAMMY BRANDED) ========== */

        /* CSS Custom Properties for Button Colors - Sammy Aesthetic Palette */
        .rating-btn-again {
            --btn-color: #BE123C; /* Sophisticated Red-Rose */
            --btn-color-dark: #9F1239;
            --btn-color-light: #FB7185;
            --btn-color-rgb: 190, 18, 60;
        }
        .rating-btn-hard {
            --btn-color: #F57C00; /* Sammy Orange Primary */
            --btn-color-dark: #E65100;
            --btn-color-light: #FFB74D;
            --btn-color-rgb: 245, 124, 0;
        }
        .rating-btn-good {
            --btn-color: #205295; /* Sammy Navy 700 */
            --btn-color-dark: #144272;
            --btn-color-light: #3b82f6;
            --btn-color-rgb: 32, 82, 149;
        }
        .rating-btn-easy {
            --btn-color: #059669; /* Balanced Emerald Success */
            --btn-color-dark: #065F46;
            --btn-color-light: #34D399;
            --btn-color-rgb: 5, 150, 105;
        }

        /* Unified Rating Button Base Styled with Option 1 (Gradient) as Default */
        .rating-btn {
            width: 3.5rem; /* Default if tailwind fails */
            height: 3.5rem;
            border-radius: 9999px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.75rem;
            cursor: pointer;
            user-select: none;
            background: linear-gradient(135deg, var(--btn-color) 0%, var(--btn-color-dark) 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @media (min-width: 640px) {
            .rating-btn {
                width: 4rem;
                height: 4rem;
            }
        }
        .rating-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2), 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .rating-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* ========== SKELETON LOADER STYLES ========== */
        .skeleton {
            background: #e2e8f0;
            background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
            border-radius: 5px;
            background-size: 200% 100%;
            animation: shimmer 1.5s linear infinite;
        }
        @keyframes shimmer {
            to {
                background-position-x: -200%;
            }
        }
        @media (prefers-reduced-motion: reduce) {
            .skeleton {
                animation: none;
            }
        }

        /* ========== DICTIONARY ANIMATIONS ========== */
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @keyframes slideDown {
            from { transform: translateY(0); }
            to { transform: translateY(100%); }
        }
        .animate-slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .animate-slide-down {
            animation: slideDown 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .animate-fade-out {
            animation: fadeOut 0.25s ease-out forwards;
        }

        /* ========== TOGGLE SWITCHES ========== */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #F57C00;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* ========== MOBILE MENU DRAWER STYLES ========== */
        #mobile-menu-overlay {
            background-color: rgba(10, 38, 71, 0.5); /* navy-900 with alpha */
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }

        #mobile-menu {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transform: translateX(100%);
            box-shadow: -10px 0 25px -5px rgba(0, 0, 0, 0.1);
        }

        #mobile-menu.active {
            transform: translateX(0);
        }

        .menu-stagger-item {
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        #mobile-menu.active .menu-stagger-item {
            opacity: 1;
            transform: translateX(0);
        }

        /* Staggered Delay for Menu Items */
        #mobile-menu.active .menu-stagger-item:nth-child(1) { transition-delay: 0.1s; }
        #mobile-menu.active .menu-stagger-item:nth-child(2) { transition-delay: 0.15s; }
        #mobile-menu.active .menu-stagger-item:nth-child(3) { transition-delay: 0.2s; }
        #mobile-menu.active .menu-stagger-item:nth-child(4) { transition-delay: 0.25s; }
        #mobile-menu.active .menu-stagger-item:nth-child(5) { transition-delay: 0.3s; }
        #mobile-menu.active .menu-stagger-item:nth-child(6) { transition-delay: 0.35s; }
        #mobile-menu.active .menu-stagger-item:nth-child(7) { transition-delay: 0.4s; }
        #mobile-menu.active .menu-stagger-item:nth-child(8) { transition-delay: 0.45s; }

        /* ========== SESSION REPORT STYLES ========== */
        .donut-segment {
            transition: stroke-dasharray 1s ease-in-out;
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-stats-in {
            animation: fade-in-up 0.5s ease-out forwards;
        }

        /* 3-Ring Styles */
        .rings-svg {
            transform: rotate(-90deg);
        }
        .ring-bg {
            fill: none;
            stroke: #e5e7eb;
        }
        .ring-progress {
            fill: none;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease-in-out;
        }
        .vocab-ring-color { stroke: var(--vocab-ring-color); }
        .lesson-ring-color { stroke: var(--lesson-ring-color); }
        .verb-ring-color { stroke: var(--verb-ring-color); }

        /* Ticket Skeuomorphism Styles */
        .ticket-modern-pass {
            background: white;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #E5E7EB; /* Default subtle border */
        }
        .ticket-modern-pass:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: #F57C00; /* Orange stroke on hover */
        }
        .ticket-modern-pass::before, .ticket-modern-pass::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: #F9FAFB; /* Match body bg */
            border-radius: 50%;
            top: 60%;
            transform: translateY(-50%);
            z-index: 10;
        }
        .ticket-modern-pass::before { left: -12px; }
        .ticket-modern-pass::after { right: -12px; }
        .vertical-divider {
            border-left: 1px dashed #E5E7EB;
        }

        /* Review Ticket Modal Styling */
        #review-ticket-modal-content {
            max-height: 85vh;
            overflow-y: auto;
        }
        .checkbox-pill input:checked + label {
            background-color: #0A2647;
            color: white;
            border-color: #0A2647;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.31.0",
    "d3": "https://aistudiocdn.com/d3@^7.9.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0"
  }
}
</script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans flex flex-col min-h-screen no-select">

    <!-- Navigation -->
    <nav class="bg-navy-900 text-white sticky top-0 z-50 shadow-lg select-none notch-padding transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-14 md:h-16 items-center"> <!-- Reduced height -->
                <!-- Logo -->
                <div class="flex items-center cursor-pointer" onclick="router('dashboard')">
                    <div class="w-8 h-8 bg-orange-500 flex items-center justify-center rounded mr-2 font-serif font-bold text-lg shadow-md border-2 border-white/10">S</div> <!-- Smaller Logo -->
                    <div class="flex flex-col">
                        <span class="font-serif font-bold text-base md:text-lg tracking-wide leading-tight">SPANISH</span>
                        <span class="text-[0.6rem] uppercase tracking-widest text-gray-300 font-light hidden sm:block">by Sammy</span>
                    </div>
                </div>

                <!-- Desktop Menu: SIGNED OUT -->
                <div id="desktop-nav-signed-out" class="hidden md:flex space-x-8 items-center">
                    <a href="#" onclick="router('method')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Method</a>
                    <a href="#" onclick="router('tools-landing')" id="nav-decks" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Decks</a>
                    <a href="#" onclick="router('course')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Courses</a>
                    <a href="#" onclick="router('booking')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Tutoring</a>
                    <button id="nav-login" onclick="router('login')" class="text-gray-300 hover:text-white text-sm">Log In</button>
                    <button id="nav-start-learning" onclick="router('login')" class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-1.5 rounded font-bold transition shadow-lg uppercase text-xs tracking-wider">Start</button>
                </div>

                <!-- Desktop Menu: SIGNED IN -->
                <div id="desktop-nav-signed-in" class="hidden space-x-6 items-center">
                    <a href="#" onclick="router('dashboard')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide font-bold">Dashboard</a>
                    <a href="#" onclick="router('flashcards')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Flashcards</a>
                    <a href="#" onclick="router('tools-conjugation')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Verbs</a>
                    <a href="#" onclick="router('lessons')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Lessons</a>
                    
                    <!-- NEW: Upgrade Button for non-premium users -->
                    <button id="nav-upgrade-btn" onclick="router('subscription')" class="hidden bg-gradient-to-r from-gold-400 to-gold-600 hover:from-gold-500 hover:to-gold-700 text-navy-900 px-3 py-1 rounded font-bold transition shadow-lg uppercase text-[0.65rem] tracking-wider border border-white/20 animate-pulse">
                        Upgrade
                    </button>
                    
                    <!-- New ABOUT Dropdown -->
                    <div class="relative group hidden md:block">
                        <button class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide flex items-center gap-1">
                            About <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </button>
                        <!-- Dropdown Content -->
                        <div class="absolute right-0 top-full mt-0 w-64 bg-white text-gray-800 shadow-xl rounded-lg border border-gray-200 hidden group-hover:block p-4 z-50">
                            <div class="space-y-4">
                                <div>
                                    <h4 class="text-xs font-bold text-navy-900 uppercase mb-2 border-b border-gray-200 pb-1">Method</h4>
                                    <ul class="text-sm space-y-1">
                                        <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-orange-500 block">Why Zipf's Law?</a></li>
                                        <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-orange-500 block">Spaced Repetition</a></li>
                                        <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-orange-500 block">Our Story</a></li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="text-xs font-bold text-navy-900 uppercase mb-2 border-b border-gray-200 pb-1">Resources</h4>
                                    <ul class="text-sm space-y-1">
                                        <li><a href="#" class="hover:text-orange-500 block">Blog</a></li>
                                        <li><a href="#" class="hover:text-orange-500 block">Verb Tables</a></li>
                                        <li><a href="#" class="hover:text-orange-500 block">Student Forum</a></li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="text-xs font-bold text-navy-900 uppercase mb-2 border-b border-gray-200 pb-1">Account</h4>
                                    <ul class="text-sm space-y-1">
                                        <li><a href="#" onclick="router('account')" class="hover:text-orange-500 block">Manage Account</a></li>
                                        <li><a href="#" class="hover:text-orange-500 block text-red-400" onclick="logout()">Log Out</a></li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="text-xs font-bold text-navy-900 uppercase mb-2 border-b border-gray-200 pb-1">Legal</h4>
                                    <ul class="text-sm space-y-1">
                                        <li><a href="#" class="hover:text-orange-500 block">Terms of Service</a></li>
                                        <li><a href="#" class="hover:text-orange-500 block">Privacy Policy</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="nav-logout-desktop" onclick="logout()" class="hidden md:block border border-orange-500 text-orange-500 hover:bg-orange-500 hover:text-white px-3 py-1 rounded font-bold text-xs transition uppercase tracking-wider">Log Out</button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-btn" class="text-gray-300 hover:text-white p-2 relative z-[100]">
                        <i data-lucide="menu" id="hamburger-icon" class="w-6 h-6 transition-transform"></i>
                        <i data-lucide="x" id="close-icon" class="w-6 h-6 absolute top-2 left-2 transition-transform scale-0 opacity-0"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- NEW MODERN MOBILE DRAWER -->
        <div id="mobile-menu-overlay" class="fixed inset-0 z-[80] opacity-0 pointer-events-none" onclick="toggleMobileMenu(false)"></div>
        <div id="mobile-menu" class="fixed top-0 right-0 bottom-0 w-[80%] max-w-sm bg-navy-900 z-[90] flex flex-col pt-20 pb-8 px-6 overflow-y-auto">
            
            <!-- Signed OUT mobile menu -->
            <div id="mobile-menu-signed-out" class="space-y-6">
                <div class="menu-stagger-item">
                    <span class="block text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] mb-4">Discovery</span>
                    <div class="space-y-2">
                        <a href="#" onclick="router('method')" class="flex items-center gap-4 py-3 px-4 bg-white/5 hover:bg-white/10 rounded-xl transition-all">
                            <div class="w-10 h-10 rounded-lg bg-orange-500/20 text-orange-500 flex items-center justify-center"><i data-lucide="compass" class="w-5 h-5"></i></div>
                            <span class="text-lg font-bold text-white">The Method</span>
                        </a>
                        <a href="#" onclick="router('tools-landing')" class="flex items-center gap-4 py-3 px-4 bg-white/5 hover:bg-white/10 rounded-xl transition-all">
                            <div class="w-10 h-10 rounded-lg bg-navy-700 text-blue-400 flex items-center justify-center"><i data-lucide="layers" class="w-5 h-5"></i></div>
                            <span class="text-lg font-bold text-white">Deck Library</span>
                        </a>
                    </div>
                </div>
                
                <div class="menu-stagger-item">
                    <span class="block text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] mb-4">Support</span>
                    <a href="#" onclick="router('booking')" class="flex items-center gap-4 py-3 px-4 bg-white/5 hover:bg-white/10 rounded-xl transition-all">
                        <div class="w-10 h-10 rounded-lg bg-white/10 text-white flex items-center justify-center"><i data-lucide="calendar" class="w-5 h-5"></i></div>
                        <span class="text-lg font-bold text-white">Tutoring</span>
                    </a>
                </div>

                <div class="menu-stagger-item pt-8">
                    <button onclick="router('login')" class="w-full bg-orange-500 text-white py-4 rounded-xl font-black uppercase tracking-wider shadow-lg shadow-orange-500/20 active:scale-95 transition-transform flex items-center justify-center gap-3">
                        Join & Learn <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Signed IN mobile menu -->
            <div id="mobile-menu-signed-in" class="hidden space-y-8">
                
                <!-- Main Learning Section -->
                <div class="menu-stagger-item">
                    <span class="block text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] mb-4">Learning Space</span>
                    <div class="space-y-2">
                        <a href="#" onclick="router('dashboard')" class="flex items-center gap-4 py-3 px-4 bg-white/5 hover:bg-white/10 rounded-xl transition-all">
                            <div class="w-10 h-10 rounded-lg bg-orange-500/20 text-orange-500 flex items-center justify-center"><i data-lucide="layout-dashboard" class="w-5 h-5"></i></div>
                            <span class="text-lg font-bold text-white">Dashboard</span>
                        </a>
                        <a href="#" onclick="router('flashcards')" class="flex items-center gap-4 py-3 px-4 bg-white/5 hover:bg-white/10 rounded-xl transition-all">
                            <div class="w-10 h-10 rounded-lg bg-orange-500 text-white flex items-center justify-center"><i data-lucide="layers" class="w-5 h-5"></i></div>
                            <span class="text-lg font-bold text-white">Flashcards</span>
                        </a>
                         <a href="#" onclick="router('tools-conjugation')" class="flex items-center gap-4 py-3 px-4 bg-white/5 hover:bg-white/10 rounded-xl transition-all">
                            <div class="w-10 h-10 rounded-lg bg-navy-700 text-blue-400 flex items-center justify-center" style="background-color: #205295;"><i data-lucide="pen-tool" class="w-5 h-5 text-white"></i></div>
                            <span class="text-lg font-bold text-white">Verb Lab</span>
                        </a>
                        <a href="#" onclick="router('lessons')" class="flex items-center gap-4 py-3 px-4 bg-white/5 hover:bg-white/10 rounded-xl transition-all">
                            <div class="w-10 h-10 rounded-lg bg-navy-900 text-white flex items-center justify-center border border-white/10"><i data-lucide="book-open" class="w-5 h-5"></i></div>
                            <span class="text-lg font-bold text-white">Lessons</span>
                        </a>
                        <a href="#" onclick="router('account')" class="flex items-center gap-4 py-3 px-4 bg-white/5 hover:bg-white/10 rounded-xl transition-all">
                            <div class="w-10 h-10 rounded-lg bg-navy-700 text-gray-300 flex items-center justify-center"><i data-lucide="user" class="w-5 h-5"></i></div>
                            <span class="text-lg font-bold text-white">Account</span>
                        </a>
                    </div>
                </div>

                <!-- Premium Section -->
                <div class="menu-stagger-item">
                     <a href="#" onclick="router('subscription')" id="mobile-nav-upgrade" class="bg-gradient-to-r from-gold-400 to-gold-600 p-4 rounded-xl flex items-center justify-between group active:scale-95 transition-transform">
                        <div class="flex items-center gap-3">
                            <i data-lucide="star" class="w-6 h-6 text-navy-900 fill-navy-900"></i>
                            <span class="font-black text-navy-900 uppercase tracking-tighter">Go Premium</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-navy-900/50 group-hover:translate-x-1 transition-transform"></i>
                    </a>
                </div>

                <!-- Footer Menu -->
                <div class="menu-stagger-item space-y-4 pt-4 border-t border-white/5">
                    <div class="flex justify-between px-2">
                        <a href="https://spanishbysammy.netlify.app" target="_blank" class="text-xs font-bold text-gray-500 hover:text-white transition">Info</a>
                        <a href="#" class="text-xs font-bold text-gray-500 hover:text-white transition">Community</a>
                        <a href="#" class="text-xs font-bold text-gray-500 hover:text-white transition">Support</a>
                    </div>
                    <button onclick="logout()" class="w-full py-4 text-center text-red-400 font-bold border border-red-500/20 rounded-xl hover:bg-red-500/10 transition-colors">Log Out</button>
                    <div class="text-center text-[10px] text-gray-600 font-bold uppercase tracking-widest pt-4">Brick Wall Method v2.1</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <main id="app-content" class="flex-grow">
        
        <!-- ================= NEW DASHBOARD PAGE ================= -->
        <section id="dashboard" class="page-section">
            <div class="max-w-4xl mx-auto px-4 py-8 pb-24">
                <!-- Header -->
                <div class="mb-8 text-center">
                    <h1 class="text-3xl font-serif font-bold text-navy-900">Hola, <span id="home-user-name">Student</span>!</h1>
                    <div id="dashboard-status-badge" class="inline-flex items-center gap-1 bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mt-2">
                        <span>Free Plan</span>
                    </div>
                    <p class="text-gray-500 mt-2">Ready to build your wall today?</p>
                </div>

                <!-- Stats Grid -->
                <div class="grid md:grid-cols-2 gap-4 mb-8">
                    <!-- Wall Widget (Flashcards) -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-400 text-xs uppercase tracking-wider">Vocabulary Wall</h3>
                            <span class="text-orange-500 font-bold text-lg" id="home-wall-count">0</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-200 overflow-hidden relative mb-2">
                             <div class="absolute inset-0 opacity-10" style="background-image: repeating-linear-gradient(45deg, #000 0, #000 1px, transparent 0, transparent 50%); background-size: 10px 10px;"></div>
                            <div id="home-wall-bar" class="bg-orange-500 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span id="home-streak-display">0 Day Streak</span>
                            <span>10k Goal</span>
                        </div>
                    </div>

                    <!-- Lesson Widget -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-400 text-xs uppercase tracking-wider">Lesson Path</h3>
                            <span class="text-navy-900 font-bold text-lg" id="home-level-display">A1</span>
                        </div>
                        <div class="mb-2">
                            <div class="text-sm font-bold text-navy-900 truncate" id="home-next-lesson">Loading...</div>
                            <div class="text-xs text-gray-500">Next Lesson</div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                            <div id="home-lesson-bar" class="bg-navy-900 h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Main Action -->
                <button onclick="router('tools-conjugation')" class="w-full bg-navy-900 hover:bg-navy-800 text-white p-6 rounded-xl shadow-lg transition transform hover:scale-[1.02] mb-6 flex items-center justify-between group">
                    <div class="text-left">
                        <div class="text-orange-500 font-bold uppercase tracking-wider text-xs mb-1">Daily Drill</div>
                        <div class="text-2xl font-serif font-bold">Practice Conjugation</div>
                        <div class="text-gray-400 text-sm mt-1">Master your verbs</div>
                    </div>
                    <div class="bg-white/10 p-3 rounded-full group-hover:bg-white/20 transition">
                        <i data-lucide="pen-tool" class="w-8 h-8"></i>
                    </div>
                </button>

                <!-- Secondary Actions -->
                <div class="grid grid-cols-2 gap-4 mb-12">
                    <button onclick="router('flashcards')" class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:border-orange-500 transition flex flex-col items-center justify-center gap-2 h-32">
                        <i data-lucide="layers" class="w-8 h-8 text-orange-500"></i>
                        <span class="font-bold text-navy-900">Flashcards</span>
                    </button>
                    <button onclick="router('lessons')" class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:border-orange-500 transition flex flex-col items-center justify-center gap-2 h-32">
                        <i data-lucide="book-open" class="w-8 h-8 text-navy-900"></i>
                        <span class="font-bold text-navy-900">Lessons</span>
                    </button>
                </div>

                <!-- Account Link -->
                <div class="text-center">
                    <button onclick="router('account')" class="text-gray-400 hover:text-navy-900 text-sm font-medium flex items-center justify-center gap-2 mx-auto transition">
                        <i data-lucide="user" class="w-4 h-4"></i> Manage Account
                    </button>
                </div>
            </div>
        </section>

        <!-- ================= ACCOUNT PAGE ================= -->
        <section id="account" class="page-section">
            <div class="max-w-md mx-auto px-4 py-8">
                <button onclick="router('dashboard')" class="text-gray-500 hover:text-navy-900 mb-6 flex items-center gap-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Dashboard
                </button>
                
                <h1 class="text-3xl font-serif font-bold text-navy-900 mb-8">Account</h1>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
                    <div class="p-6 border-b border-gray-100">
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Email</div>
                        <div id="acc-email" class="text-lg font-medium text-navy-900">...</div>
                    </div>
                    <div class="p-6 border-b border-gray-100">
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">User ID</div>
                        <div id="acc-uid" class="text-sm font-mono text-gray-500 break-all">...</div>
                    </div>
                     <div class="p-6 border-b border-gray-100">
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Subscription</div>
                        <div id="acc-subscription" class="text-lg font-medium text-navy-900 flex items-center gap-2">
                            Free Plan <button onclick="router('subscription')" class="text-xs bg-gold-400 text-navy-900 px-2 py-1 rounded font-bold hover:bg-gold-500">UPGRADE</button>
                        </div>
                    </div>
                    <!-- Added Portal Button -->
                    <div id="acc-manage-portal" class="p-6 border-b border-gray-100 hidden">
                        <button onclick="openCustomerPortal()" class="w-full border border-gray-300 text-navy-900 hover:bg-gray-50 font-bold py-2 rounded-lg transition flex items-center justify-center gap-2">
                            <i data-lucide="credit-card" class="w-4 h-4"></i> Manage Subscription
                        </button>
                    </div>
                </div>

                <button onclick="logout()" class="w-full border-2 border-red-100 text-red-500 hover:bg-red-50 hover:border-red-200 font-bold py-3 rounded-lg transition">
                    Log Out
                </button>
            </div>
        </section>

        <!-- ================= SUBSCRIPTION / UPGRADE PAGE ================= -->
        <section id="subscription" class="page-section">
            <div class="bg-navy-900 text-white pb-24 pt-12">
                <div class="max-w-4xl mx-auto px-4 text-center">
                    <button onclick="router('dashboard')" class="absolute left-4 top-24 text-gray-400 hover:text-white flex items-center gap-2 md:hidden">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
                    </button>
                    <span class="text-gold-400 font-bold uppercase tracking-widest text-sm mb-2 block">Premium Membership</span>
                    <h1 class="text-3xl md:text-5xl font-serif font-bold mb-6">Unleash Your Fluency</h1>
                    <p class="text-gray-300 max-w-2xl mx-auto text-lg">Get unlimited access to advanced conjugation drills, AI tutor chats, and offline lessons.</p>
                </div>
            </div>

            <div class="max-w-5xl mx-auto px-4 -mt-16 pb-20">
                <div class="grid md:grid-cols-2 gap-8 items-start">
                    
                    <!-- Monthly Plan -->
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 relative overflow-hidden">
                        <h3 class="text-xl font-bold text-navy-900 mb-2">Monthly Learner</h3>
                        <div class="flex items-baseline mb-6">
                            <span class="text-4xl font-bold text-navy-900">$9.99</span>
                            <span class="text-gray-500 ml-2">/ month</span>
                        </div>
                        <ul class="space-y-4 mb-8">
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-green-500 w-5 h-5"></i> Unlimited Conjugation Drills</li>
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-green-500 w-5 h-5"></i> Unlimited AI Tutor Chats</li>
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-green-500 w-5 h-5"></i> Advanced Stats</li>
                        </ul>
                        <button onclick="handleStripeCheckout('price_monthly')" class="w-full bg-navy-900 hover:bg-navy-800 text-white font-bold py-4 rounded-xl transition shadow-lg flex justify-center items-center gap-2">
                            Start Monthly
                        </button>
                    </div>

                    <!-- Yearly Plan -->
                    <div class="bg-white rounded-2xl shadow-xl border-2 border-gold-400 p-8 relative overflow-hidden transform md:-translate-y-4">
                        <div class="absolute top-0 right-0 bg-gold-400 text-navy-900 text-xs font-bold px-4 py-1 rounded-bl-xl uppercase tracking-wider">
                            Best Value
                        </div>
                        <h3 class="text-xl font-bold text-navy-900 mb-2">Annual Pro</h3>
                        <div class="flex items-baseline mb-6">
                            <span class="text-4xl font-bold text-navy-900">$99.99</span>
                            <span class="text-gray-500 ml-2">/ year</span>
                        </div>
                        <p class="text-green-600 text-sm font-bold mb-6">Save 17% compared to monthly</p>
                        <ul class="space-y-4 mb-8">
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-gold-500 w-5 h-5"></i> <span class="font-bold">Everything in Monthly</span></li>
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-gold-500 w-5 h-5"></i> Priority Support</li>
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-gold-500 w-5 h-5"></i> Early Access to New Features</li>
                        </ul>
                        <button onclick="handleStripeCheckout('price_yearly')" class="w-full bg-gradient-to-r from-gold-400 to-gold-600 hover:from-gold-500 hover:to-gold-700 text-navy-900 font-bold py-4 rounded-xl transition shadow-lg flex justify-center items-center gap-2">
                            Start Yearly Trial <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                        <p class="text-center text-xs text-gray-400 mt-4">Secure payment via Stripe. Cancel anytime.</p>
                    </div>

                </div>
            </div>
        </section>

        <!-- ================= NEW FLASHCARDS PAGE ================= -->
        <section id="flashcards" class="page-section min-h-screen">
            <!-- STICKY HEADER CONDENSED VIEW -->
            <div id="flashcards-sticky-header" class="fixed top-14 left-0 right-0 bg-white/95 backdrop-blur z-40 shadow-md border-b border-gray-200 hidden transition-all duration-300 transform translate-y-0">
                <div class="py-3 px-4 flex items-center justify-between max-w-4xl mx-auto w-full">
                    <div class="flex items-center gap-4 flex-grow min-w-0">
                        <div class="block mr-2 border-r border-gray-200 pr-2 flex-grow min-w-0">
                            <div class="text-[10px] text-gray-500 uppercase font-bold truncate">Daily Progress</div>
                            <div class="text-xs sm:text-sm font-bold text-navy-900 leading-tight truncate">Vocabulary Ring</div>
                        </div>
                        <div class="w-24 bg-gray-200 rounded-full h-2 flex-shrink-0">
                            <div id="sticky-vocab-progress-bar" class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <button onclick="openReviewTicket()" class="bg-navy-900 hover:bg-navy-800 text-white px-4 py-1.5 rounded-md font-bold text-xs uppercase tracking-wide shadow-sm flex-shrink-0 ml-2">
                        Review Ticket
                    </button>
                </div>
            </div>

            <!-- Header -->
            <div class="max-w-4xl mx-auto px-4 pt-8 pb-6">
                <h1 class="text-3xl font-serif font-bold text-navy-900">Flashcards</h1>
            </div>
            
            <!-- NEW UNIFIED DASHBOARD -->
            <div id="dashboard-wrapper" class="relative mb-6 px-4">
                <div class="bg-white rounded-2xl shadow-xl border border-gray-200 mx-auto max-w-4xl p-6 md:p-8">
                    <div class="flex flex-col md:flex-row items-center gap-8">
                        
                        <!-- 3-Ring Visualization (Focused on Vocab for now) -->
                        <div class="relative w-40 h-40 flex-shrink-0">
                            <svg class="rings-svg w-full h-full" viewBox="0 0 100 100">
                                <!-- Background Rings -->
                                <circle class="ring-bg" cx="50" cy="50" r="45" stroke-width="8" />
                                <circle class="ring-bg" cx="50" cy="50" r="35" stroke-width="8" opacity="0.5" />
                                <circle class="ring-bg" cx="50" cy="50" r="25" stroke-width="8" opacity="0.3" />
                                
                                <!-- Progress Rings -->
                                <circle id="ring-vocab" class="ring-progress vocab-ring-color" cx="50" cy="50" r="45" stroke-width="8" stroke-dasharray="282.7" stroke-dashoffset="282.7" />
                                <circle id="ring-lessons" class="ring-progress lesson-ring-color" cx="50" cy="50" r="35" stroke-width="8" stroke-dasharray="219.9" stroke-dashoffset="219.9" />
                                <circle id="ring-verbs" class="ring-progress verb-ring-color" cx="50" cy="50" r="25" stroke-width="8" stroke-dasharray="157.1" stroke-dashoffset="157.1" />
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                                <span class="text-2xl font-black text-navy-900" id="dash-vocab-pct">0%</span>
                                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest bg-white/60 backdrop-blur-sm px-1 rounded">Daily Goal</span>
                            </div>
                        </div>

                        <!-- Dashboard Info & Main Actions -->
                        <div class="flex-grow space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="launchDueReview()" class="text-left bg-gray-50 rounded-xl p-4 border border-gray-100 hover:border-gray-300 transition group">
                                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 group-hover:text-navy-900">Due for Review</div>
                                    <div class="text-2xl font-black text-navy-900" id="dash-due-count">0</div>
                                    <div class="text-[10px] text-gray-500">Cards needing maintenance</div>
                                </button>
                                <div class="bg-orange-50 rounded-xl p-4 border border-orange-100">
                                    <div class="text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-1">Weekly Ring Score</div>
                                    <div class="text-2xl font-black text-orange-500" id="dash-streak-count">0 Days</div>
                                    <div class="text-[10px] text-gray-500">Perfect goal consistency</div>
                                </div>
                            </div>

                    <div class="flex flex-col sm:flex-row gap-3">
                        <button onclick="startLearningNewWords()" class="flex-grow bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                            <i data-lucide="play" class="w-5 h-5 fill-current"></i> Learn New Words
                        </button>
                        <button onclick="openReviewTicket()" class="flex-grow bg-navy-900 hover:bg-navy-800 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                            <i data-lucide="ticket" class="w-5 h-5"></i> Launch Review Ticket
                        </button>
                    </div>
                </div>
                    </div>
                </div>

                <!-- REVIEW TICKET BUILDER MODAL (Refactored) -->
                <div id="review-ticket-builder" class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4">
                    <div id="review-ticket-modal-content" class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden flex flex-col animate-slide-up">
                        <div class="bg-navy-900 text-white p-5 flex justify-between items-center shrink-0">
                            <div class="flex items-center gap-3">
                                <div class="bg-white/10 p-2 rounded-lg">
                                    <i data-lucide="ticket" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h3 id="ticket-modal-title" class="font-black text-lg uppercase tracking-wider">Review Ticket</h3>
                                    <p id="ticket-modal-subtitle" class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Generator 2.0</p>
                                </div>
                            </div>
                            <button onclick="closeReviewTicket()" class="hover:bg-white/10 p-2 rounded-full transition">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <div class="p-6 overflow-y-auto space-y-8 text-sm flex-grow">
                            <!-- Level Selection -->
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-bold text-navy-900 uppercase tracking-widest text-xs">Target Levels</h4>
                                    <div class="flex gap-3">
                                        <button onclick="toggleAllTicketLevels(true)" class="text-[10px] font-black text-orange-500 uppercase">All</button>
                                        <button onclick="toggleAllTicketLevels(false)" class="text-[10px] font-black text-gray-400 uppercase">None</button>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-2" id="ticket-levels-container">
                                    <div class="checkbox-pill">
                                        <input type="checkbox" id="ticket-lvl-A1" class="hidden" checked onchange="updateTicketCounter()">
                                        <label for="ticket-lvl-A1" class="px-4 py-2 rounded-full border border-gray-200 font-bold text-gray-600 cursor-pointer block hover:bg-gray-50 transition">A1</label>
                                    </div>
                                    <div class="checkbox-pill">
                                        <input type="checkbox" id="ticket-lvl-A2" class="hidden" checked onchange="updateTicketCounter()">
                                        <label for="ticket-lvl-A2" class="px-4 py-2 rounded-full border border-gray-200 font-bold text-gray-600 cursor-pointer block hover:bg-gray-50 transition">A2</label>
                                    </div>
                                    <div class="checkbox-pill">
                                        <input type="checkbox" id="ticket-lvl-B1" class="hidden" checked onchange="updateTicketCounter()">
                                        <label for="ticket-lvl-B1" class="px-4 py-2 rounded-full border border-gray-200 font-bold text-gray-600 cursor-pointer block hover:bg-gray-50 transition">B1</label>
                                    </div>
                                    <div class="checkbox-pill">
                                        <input type="checkbox" id="ticket-lvl-B2" class="hidden" checked onchange="updateTicketCounter()">
                                        <label for="ticket-lvl-B2" class="px-4 py-2 rounded-full border border-gray-200 font-bold text-gray-600 cursor-pointer block hover:bg-gray-50 transition">B2</label>
                                    </div>
                                    <div class="checkbox-pill">
                                        <input type="checkbox" id="ticket-lvl-C1" class="hidden" checked onchange="updateTicketCounter()">
                                        <label for="ticket-lvl-C1" class="px-4 py-2 rounded-full border border-gray-200 font-bold text-gray-600 cursor-pointer block hover:bg-gray-50 transition">C1</label>
                                    </div>
                                    <div class="checkbox-pill">
                                        <input type="checkbox" id="ticket-lvl-C2" class="hidden" checked onchange="updateTicketCounter()">
                                        <label for="ticket-lvl-C2" class="px-4 py-2 rounded-full border border-gray-200 font-bold text-gray-600 cursor-pointer block hover:bg-gray-50 transition">C2</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Dynamic Topics container -->
                            <div id="ticket-topics-container" class="hidden">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-bold text-navy-900 uppercase tracking-widest text-xs">Topics</h4>
                                    <div class="flex gap-3">
                                        <button onclick="toggleAllTicketTopics(true)" class="text-[10px] font-black text-orange-500 uppercase">All</button>
                                        <button onclick="toggleAllTicketTopics(false)" class="text-[10px] font-black text-gray-400 uppercase">None</button>
                                    </div>
                                </div>
                            <div id="ticket-topics-grid" class="flex flex-wrap gap-2">
                                <!-- Populated dynamically -->
                            </div>
                        </div>

                        <!-- POS Selector Section (NEW) -->
                        <div id="ticket-pos-container" class="hidden border-t border-gray-100 pt-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-navy-900 uppercase tracking-widest text-xs">Parts of Speech</h4>
                                <div class="flex gap-3">
                                    <button onclick="toggleAllTicketPOS(true)" class="text-[10px] font-black text-orange-500 uppercase">All</button>
                                    <button onclick="toggleAllTicketPOS(false)" class="text-[10px] font-black text-gray-400 uppercase">None</button>
                                </div>
                            </div>
                            <div id="ticket-pos-grid" class="flex flex-wrap gap-2">
                                <!-- Populated dynamically -->
                            </div>
                        </div>

                        <!-- Session Settings -->
                            <div class="grid md:grid-cols-2 gap-8 pt-4 border-t border-gray-100">
                                <div>
                                    <h4 class="font-bold text-navy-900 uppercase tracking-widest text-xs mb-4">Content Strategy</h4>
                                    <div class="space-y-3">
                                        <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition border-2 border-transparent has-[:checked]:border-navy-900/10 has-[:checked]:bg-white">
                                            <input type="radio" name="ticket-type" value="mixed" checked class="w-5 h-5 accent-navy-900" onchange="updateTicketCounter()">
                                            <div>
                                                <span class="font-bold block">Smart Mix</span>
                                                <span class="text-[10px] text-gray-500 uppercase font-bold">New + Due reviews</span>
                                            </div>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition border-2 border-transparent has-[:checked]:border-blue-500/10 has-[:checked]:bg-white">
                                            <input type="radio" name="ticket-type" value="practice" class="w-5 h-5 accent-blue-600" onchange="updateTicketCounter()">
                                            <div>
                                                <span class="font-bold block text-blue-600">Practice Refresh</span>
                                                <span class="text-[10px] text-gray-500 uppercase font-bold">Ignore SRS due dates</span>
                                            </div>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition border-2 border-transparent has-[:checked]:border-red-500/10 has-[:checked]:bg-white">
                                            <input type="radio" name="ticket-type" value="leeches" class="w-5 h-5 accent-red-600" onchange="updateTicketCounter()">
                                            <div>
                                                <span class="font-bold block text-red-600">Focus on Leeches</span>
                                                <span class="text-[10px] text-gray-500 uppercase font-bold">Hardest words only</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-bold text-navy-900 uppercase tracking-widest text-xs mb-4">Session Size</h4>
                                    <div id="ticket-size-grid" class="grid grid-cols-2 gap-2">
                                        <div class="checkbox-pill col-span-2">
                                            <input type="radio" name="ticket-size" id="size-all" value="all" class="hidden" checked>
                                            <label for="size-all" class="px-4 py-3 rounded-xl border border-gray-200 font-bold text-gray-600 cursor-pointer block text-center hover:bg-gray-50 transition">All eligible <span id="size-all-count">...</span></label>
                                        </div>
                                        <div class="checkbox-pill">
                                            <input type="radio" name="ticket-size" id="size-10" value="10" class="hidden">
                                            <label for="size-10" class="px-4 py-3 rounded-xl border border-gray-200 font-bold text-gray-600 cursor-pointer block text-center hover:bg-gray-50 transition">10</label>
                                        </div>
                                        <div class="checkbox-pill">
                                            <input type="radio" name="ticket-size" id="size-20" value="20" class="hidden">
                                            <label for="size-20" class="px-4 py-3 rounded-xl border border-gray-200 font-bold text-gray-600 cursor-pointer block text-center hover:bg-gray-50 transition">20</label>
                                        </div>
                                        <div class="checkbox-pill">
                                            <input type="radio" name="ticket-size" id="size-50" value="50" class="hidden">
                                            <label for="size-50" class="px-4 py-3 rounded-xl border border-gray-200 font-bold text-gray-600 cursor-pointer block text-center hover:bg-gray-50 transition">50</label>
                                        </div>
                                        <div class="checkbox-pill">
                                            <input type="radio" name="ticket-size" id="size-100" value="100" class="hidden">
                                            <label for="size-100" class="px-4 py-3 rounded-xl border border-gray-200 font-bold text-gray-600 cursor-pointer block text-center hover:bg-gray-50 transition">100</label>
                                        </div>
                                        <div class="checkbox-pill">
                                            <input type="radio" name="ticket-size" id="size-150" value="150" class="hidden">
                                            <label for="size-150" class="px-4 py-3 rounded-xl border border-gray-200 font-bold text-gray-600 cursor-pointer block text-center hover:bg-gray-50 transition">150</label>
                                        </div>
                                        <div class="checkbox-pill">
                                            <input type="radio" name="ticket-size" id="size-200" value="200" class="hidden">
                                            <label for="size-200" class="px-4 py-3 rounded-xl border border-gray-200 font-bold text-gray-600 cursor-pointer block text-center hover:bg-gray-50 transition">200</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 bg-gray-50 border-t border-gray-100 shrink-0">
                            <div id="ticket-save-input-container" class="hidden mb-4 animate-fadeIn">
                                <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 ml-1">Ticket Name</label>
                                <div class="flex gap-2">
                                    <input type="text" id="ticket-save-name" placeholder="e.g. My Verb Drills" class="flex-grow p-3 rounded-xl border border-gray-200 focus:outline-none focus:border-navy-900 font-bold text-sm">
                                    <button onclick="confirmSaveTicket()" class="bg-orange-500 text-white px-6 rounded-xl font-bold hover:bg-orange-600 transition">Save</button>
                                    <button onclick="toggleSaveInput(false)" class="bg-gray-200 text-gray-600 px-4 rounded-xl font-bold hover:bg-gray-300 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                                </div>
                            </div>

                            <div class="flex gap-3 items-center">
                                <button id="btn-save-ticket-init" onclick="toggleSaveInput(true)" class="flex-shrink-0 bg-white border-2 border-gray-200 text-gray-400 font-bold px-5 py-5 rounded-2xl hover:border-navy-900 hover:text-navy-900 transition disabled:opacity-50 disabled:cursor-not-allowed" title="Save your current settings as a shortcut">
                                    <i data-lucide="bookmark" class="w-6 h-6"></i>
                                </button>
                                <div class="flex-grow bg-navy-900 rounded-2xl shadow-xl flex items-stretch overflow-hidden">
                                    <div class="flex items-center justify-center px-8 border-r border-white/10 bg-navy-800/50">
                                        <span class="text-2xl font-black text-white leading-none" id="ticket-eligible-count">...</span>
                                    </div>
                                    <button onclick="launchCustomTicket()" class="flex-grow text-white font-black py-5 hover:bg-navy-800 active:scale-[0.98] transition-all flex items-center justify-center gap-3 text-lg uppercase tracking-wider group">
                                        START <i data-lucide="play" class="w-5 h-5 fill-current group-hover:scale-110 transition-transform"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SAVED TICKET SHORTCUTS GRID -->
                <div class="max-w-4xl mx-auto mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest cursor-pointer" onclick="toggleSavedTicketsCollapse()">Saved Review Tickets</h3>
                        <button onclick="toggleSavedTicketsCollapse()" class="text-gray-400 hover:text-navy-900 transition-colors">
                            <i data-lucide="chevron-down" id="icon-saved-tickets-collapse" class="w-5 h-5 transition-transform"></i>
                        </button>
                    </div>
                    <div id="content-saved-tickets-collapse" class="accordion-content">
                        <div id="saved-tickets-container" class="grid grid-cols-2 md:grid-cols-4 gap-6 p-3 transition-all">
                            <!-- Ticket Slots injected by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="max-w-4xl mx-auto px-4 pb-40">
                <!-- Flashcards Container -->
                <div id="flashcards-container" class="space-y-4"></div>
            </div>
        </section>

        <!-- ================= FLASHCARD STUDY VIEW (REBUILT) ================= -->
        <section id="flashcard-study" class="page-section">
            <!-- Top Nav Bar -->
            <div class="bg-navy-900 text-white py-3 sticky top-14 z-40 shadow-md">
                <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
                    <button onclick="exitFlashcardStudy()" class="flex items-center gap-2 text-gray-300 hover:text-white transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                    <div class="flex-grow text-center">
                        <h2 class="font-bold text-sm truncate max-w-[200px] sm:max-w-md mx-auto" id="study-set-title">Study Set</h2>
                        <div class="text-xs text-gray-400" id="study-progress-text">0/0</div>
                    </div>
                    <button onclick="toggleStudySettings()" class="text-gray-300 hover:text-white transition">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Main Study Container -->
            <div class="max-w-2xl mx-auto px-4 py-6 min-h-[80vh] flex flex-col">
                
                <!-- Loading State (Skeleton Loader) -->
                <div id="study-loading" class="flex-grow flex flex-col">
                    <!-- Placeholder Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                        <div class="skeleton h-2 rounded-full" style="width: 30%"></div>
                    </div>

                    <!-- Placeholder Card -->
                    <div class="flex-grow flex items-center justify-center mb-6 relative" style="min-height: 400px;">
                        <div class="relative w-full max-w-md aspect-[3/2.75] bg-white rounded-2xl shadow-xl border-4 border-transparent flex flex-col p-6 items-center justify-center">
                            <!-- Placeholder Rank -->
                            <div class="absolute top-4 right-5 w-8 h-4 skeleton"></div>
                            
                            <!-- Placeholder Main Term -->
                            <div class="w-2/3 h-10 skeleton mb-6"></div>
                            
                            <!-- Placeholder POS Pills -->
                            <div class="flex gap-2 mb-4">
                                <div class="w-20 h-6 skeleton rounded-full"></div>
                                <div class="w-16 h-6 skeleton rounded-full"></div>
                            </div>

                            <!-- Placeholder Example Text -->
                            <div class="mt-auto w-full pt-4 border-t border-slate-100 flex flex-col items-center gap-2">
                                <div class="w-3/4 h-4 skeleton"></div>
                                <div class="w-1/2 h-4 skeleton"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Placeholder Bottom Controls -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-center gap-2 pb-2">
                            <!-- 4 large circular buttons -->
                            <div class="w-14 h-14 md:w-16 md:h-16 rounded-full skeleton"></div>
                            <div class="w-14 h-14 md:w-16 md:h-16 rounded-full skeleton"></div>
                            <!-- 2 small circular buttons -->
                            <div class="w-10 h-10 md:w-12 md:h-12 rounded-full skeleton mx-1"></div>
                            <div class="w-10 h-10 md:w-12 md:h-12 rounded-full skeleton mx-1"></div>
                            <!-- 2 more large circular buttons -->
                            <div class="w-14 h-14 md:w-16 md:h-16 rounded-full skeleton"></div>
                            <div class="w-14 h-14 md:w-16 md:h-16 rounded-full skeleton"></div>
                        </div>
                        <div class="flex justify-center gap-6">
                            <div class="w-16 h-8 skeleton"></div>
                            <div class="w-16 h-8 skeleton"></div>
                        </div>
                    </div>
                </div>

                <!-- Card Study Container -->
                <div id="study-card-container" class="hidden flex-grow flex flex-col">
                    
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                        <div id="study-progress-bar" class="bg-orange-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>

                    <!-- Card Stack Container -->
                    <div class="flex-grow flex items-center justify-center mb-6 relative" style="min-height: 400px;">
                        <!-- Card Deck -->
                        <div id="card-deck" class="relative w-full max-w-md aspect-[3/2.75]">
                            <!-- Cards will be injected here by JS -->
                        </div>
                    </div>

                    <!-- Bottom Controls -->
                    <div class="space-y-4">
                        <!-- Action Buttons Row -->
                        <div class="flex items-center justify-center gap-2 pb-2">
                            <div class="relative">
                                <button onclick="handleCardAction('again')" class="rating-btn rating-btn-again">
                                    <i data-lucide="refresh-ccw" class="w-4 h-4 mb-0.5"></i>
                                    <span class="text-[10px] font-bold">Again</span>
                                </button>
                                <kbd class="kbd-hint hidden absolute -top-2 -left-2 bg-gray-800 text-white border border-gray-600 rounded px-1 text-[10px] font-bold shadow-md z-10">A</kbd>
                            </div>

                            <div class="relative">
                                <button onclick="handleCardAction('hard')" class="rating-btn rating-btn-hard">
                                    <i data-lucide="zap" class="w-4 h-4 mb-0.5"></i>
                                    <span class="text-[10px] font-bold">Hard</span>
                                </button>
                                <kbd class="kbd-hint hidden absolute -top-2 -left-2 bg-gray-800 text-white border border-gray-600 rounded px-1 text-[10px] font-bold shadow-md z-10">W</kbd>
                            </div>

                            <div class="relative">
                                <button onclick="undoLastAction()" id="undo-btn" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                                    <i data-lucide="undo" class="w-4 h-4"></i>
                                </button>
                                <kbd class="kbd-hint hidden absolute -top-1 -left-1 bg-gray-800 text-white border border-gray-600 rounded px-1 text-[10px] font-bold shadow-md z-10">Q</kbd>
                            </div>

                            <div class="relative">
                                <button onclick="speakCurrentFlashcard()" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition transform hover:scale-110">
                                    <i data-lucide="volume-2" class="w-4 h-4"></i>
                                </button>
                                <kbd class="kbd-hint hidden absolute -top-1 -left-1 bg-gray-800 text-white border border-gray-600 rounded px-1 text-[10px] font-bold shadow-md z-10">Shift</kbd>
                            </div>

                            <div class="relative">
                                <button onclick="handleCardAction('good')" class="rating-btn rating-btn-good">
                                    <i data-lucide="smile" class="w-4 h-4 mb-0.5"></i>
                                    <span class="text-[10px] font-bold">Good</span>
                                </button>
                                <kbd class="kbd-hint hidden absolute -top-2 -left-2 bg-gray-800 text-white border border-gray-600 rounded px-1 text-[10px] font-bold shadow-md z-10">D</kbd>
                            </div>

                            <div class="relative">
                                <button onclick="handleCardAction('easy')" class="rating-btn rating-btn-easy">
                                    <i data-lucide="check-circle" class="w-4 h-4 mb-0.5"></i>
                                    <span class="text-[10px] font-bold">Easy</span>
                                </button>
                                <kbd class="kbd-hint hidden absolute -top-2 -left-2 bg-gray-800 text-white border border-gray-600 rounded px-1 text-[10px] font-bold shadow-md z-10">E</kbd>
                            </div>
                        </div>

                        <!-- Stats Row -->
                        <div class="flex justify-center gap-6 text-sm">
                            <div class="text-center">
                                <div class="text-xs text-gray-500 uppercase">Unknown</div>
                                <div class="text-lg font-bold text-red-600" id="unknown-count">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 uppercase">Known</div>
                                <div class="text-lg font-bold text-green-600" id="known-count">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Complete Screen -->
                <div id="study-complete" class="hidden flex-grow flex flex-col items-center justify-center text-center">
                    
                <!-- Session Success Header -->
                <div id="session-header" class="mb-8 scale-0 transition-transform duration-700 delay-300">
                    <div id="res-emoji" class="text-6xl mb-4"></div>
                    <h3 id="res-title" class="text-3xl font-serif font-black text-navy-900 mb-1">Buen Trabajo!</h3>
                    <p id="res-subtitle" class="text-gray-500 font-medium">Session path complete</p>
                </div>

                <!-- Results Grid (Metrics) -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 w-full max-w-xl mb-10">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center animate-stats-in" style="animation-delay: 0.4s">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Duration</span>
                        <span class="text-xl font-black text-navy-900" id="res-duration">0:00</span>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center animate-stats-in" style="animation-delay: 0.5s">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Time / Term</span>
                        <span class="text-xl font-black text-blue-600" id="res-avg-time">0.0s</span>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center animate-stats-in" style="animation-delay: 0.6s">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Learning</span>
                        <span class="text-xl font-black text-orange-500" id="res-learning">0</span>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center animate-stats-in" style="animation-delay: 0.7s">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Mastered</span>
                        <span class="text-xl font-black text-green-600" id="res-mastered">0</span>
                    </div>
                </div>

                <!-- Recursive Study Options -->
                <div class="w-full max-w-sm space-y-4 mb-12">
                    <button id="btn-resume-study" onclick="event.stopPropagation(); resumeStudy()" class="hidden w-full group bg-orange-500 text-white py-4 px-6 rounded-2xl font-black shadow-lg shadow-orange-500/20 transition-all hover:bg-orange-600 hover:translate-y-[-2px] active:translate-y-0 flex items-center justify-between relative z-[60] pointer-events-auto">
                        <span class="flex items-center gap-3">
                            <i data-lucide="play" class="w-5 h-5 fill-current"></i> Resume <kbd class="hidden md:inline ml-2 text-[10px] bg-white/20 border border-white/30 px-1 rounded">Space</kbd>
                        </span>
                        <i data-lucide="arrow-right" class="w-5 h-5 opacity-50"></i>
                    </button>

                    <button id="btn-redo-subset" onclick="event.stopPropagation(); handleRestartSession('redo')" class="hidden w-full group bg-orange-500 text-white py-4 px-6 rounded-2xl font-black shadow-lg shadow-orange-500/20 transition-all hover:bg-orange-600 hover:translate-y-[-2px] active:translate-y-0 flex items-center justify-between relative z-[60] pointer-events-auto">
                        <span class="flex items-center gap-3">
                            <i data-lucide="refresh-ccw" class="w-5 h-5"></i> Redo Previous <kbd class="hidden md:inline ml-2 text-[10px] bg-white/20 border border-white/30 px-1 rounded">Spacebar</kbd>
                        </span>
                        <span class="bg-black/10 px-2 py-0.5 rounded text-xs" id="res-count-redo">0 cards</span>
                    </button>

                    <button id="btn-review-missed" onclick="event.stopPropagation(); handleRestartSession('missed')" class="hidden w-full group bg-orange-500 text-white py-4 px-6 rounded-2xl font-black shadow-lg shadow-orange-500/20 transition-all hover:bg-orange-600 hover:translate-y-[-2px] active:translate-y-0 flex items-center justify-between relative z-[60] pointer-events-auto">
                        <span class="flex items-center gap-3">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i> Review Missed <kbd class="hidden md:inline ml-2 text-[10px] bg-white/20 border border-white/30 px-1 rounded">Spacebar</kbd>
                        </span>
                        <span class="bg-black/10 px-2 py-0.5 rounded text-xs" id="res-count-missed">0 cards</span>
                    </button>

                    <button onclick="event.stopPropagation(); handleRestartSession('all')" class="w-full group bg-white border-2 border-navy-900 text-navy-900 py-4 px-6 rounded-2xl font-black transition-all hover:bg-navy-900 hover:text-white flex items-center justify-between relative z-[60] pointer-events-auto">
                        <span class="flex items-center gap-3">
                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i> Restart All <kbd class="hidden md:inline ml-2 text-[10px] bg-gray-100 border border-gray-300 px-1 rounded group-hover:bg-white/20 group-hover:text-white group-hover:border-white/30 transition-colors">R</kbd>
                        </span>
                        <span class="text-xs opacity-40 group-hover:opacity-100 transition-opacity" id="res-count-all">0 cards</span>
                    </button>
                    
                    <button onclick="event.stopPropagation(); forceExitStudy()" class="w-full text-gray-400 hover:text-navy-900 font-bold py-2 transition-colors flex items-center justify-center gap-2 relative z-[60] pointer-events-auto">
                         Finish & Exit <kbd class="hidden md:inline ml-2 text-[10px] bg-gray-100 border border-gray-300 px-1 rounded font-sans uppercase">Esc</kbd>
                    </button>
                </div>
                </div>
                </div>
            </div>

            <!-- Dictionary Modal -->
            <div id="dictionary-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-end sm:items-center justify-center sm:p-4" onclick="handleDictionaryBackdropClick(event)">
                <div id="dictionary-modal-content" class="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-lg text-navy-900">Dictionary</h3>
                        <button onclick="closeDictionary()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 def-content">
                        <div id="dictionary-content">
                            <!-- Content injected by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Study Settings Modal -->
            <div id="study-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4" onclick="handleSettingsBackdropClick(event)">
                <div id="study-settings-modal-content" class="bg-white rounded-2xl w-full max-w-sm max-h-[85vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-lg text-navy-900">Study Settings</h3>
                        <button onclick="toggleStudySettings()" class="p-1 hover:bg-gray-100 rounded-full transition-colors">
                            <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
                        </button>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 space-y-4">
                        
                        <!-- Mini Guide Accordions -->
                        <div class="bg-navy-50 rounded-xl overflow-hidden border border-navy-100 mb-2">
                            <div onclick="toggleStudyGuide('srs')" class="p-4 cursor-pointer hover:bg-navy-100/50 transition-colors flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="bg-navy-900 text-white p-1.5 rounded-lg">
                                        <i data-lucide="zap" class="w-4 h-4"></i>
                                    </div>
                                    <span class="font-bold text-navy-900 text-sm">Spaced-Repetition?</span>
                                </div>
                                <i data-lucide="chevron-down" id="icon-guide-srs" class="w-4 h-4 text-navy-400 transition-transform"></i>
                            </div>
                            <div id="content-guide-srs" class="accordion-content">
                                <div class="p-4 pt-0 text-sm text-navy-800 leading-relaxed space-y-4 border-t border-navy-100/50">
                                    <h4 class="font-bold text-navy-900 mt-3">How Spaced-Repetition works</h4>
                                    <p>The algorithm handles the heavy lifting of scheduling. It predicts when you're about to forget a word to ensure you review it and move it into your long-term memory.</p>
                                    <ul class="space-y-3 ml-1">
                                        <li class="flex flex-col"><span class="flex gap-2"><b> Again</b> <span class="text-orange-600 font-bold">Review Soon</span></span> <span class="text-xs">Forgot or mispronounced. We'll show it to you again soon so you can practice.</span></li>
                                        <li class="flex flex-col"><span class="flex gap-2"><b> Hard</b> <span class="text-gray-500 font-bold">1-2 Days</span></span> <span class="text-xs">Correct but slow/strained. Schedules review for the coming days.</span></li>
                                        <li class="flex flex-col"><span class="flex gap-2"><b> Good</b> <span class="text-navy-600 font-bold">4-7 Days</span></span> <span class="text-xs">Correct with some focus. We'll review it again in 4-7 days.</span></li>
                                        <li class="flex flex-col"><span class="flex gap-2"><b> Easy</b> <span class="text-green-600 font-bold">7+ Days</span></span> <span class="text-xs">Instant recall & native accent. We'll schedule a review for 7+ days.</span></li>
                                    </ul>
                                    <p class="text-xs italic bg-white/50 p-2 rounded border border-navy-100"> Remember you can always review whenever you would like, so the more often you study the more you will see all your previous terms. SRS will do its best to make sure you see the terms you most need to study, when you need them. Be honest with your ratingsit's the most efficient way to learn!</p>
                                </div>
                            </div>

                            <div onclick="toggleStudyGuide('method')" class="p-4 cursor-pointer hover:bg-navy-100/50 transition-colors flex justify-between items-center border-t border-navy-100/50">
                                <div class="flex items-center gap-3">
                                    <div class="bg-orange-500 text-white p-1.5 rounded-lg">
                                        <i data-lucide="target" class="w-4 h-4"></i>
                                    </div>
                                    <span class="font-bold text-navy-900 text-sm">Recommended Study Path</span>
                                </div>
                                <i data-lucide="chevron-down" id="icon-guide-method" class="w-4 h-4 text-navy-400 transition-transform"></i>
                            </div>
                            <div id="content-guide-method" class="accordion-content">
                                <div class="p-4 pt-0 text-sm text-navy-800 leading-relaxed space-y-4 border-t border-navy-100/50">
                                    <div class="mt-3">
                                        <b class="text-orange-600 block mb-0.5">1. Familiarization Round</b>
                                        <p>On your first time through a deck, rate every card as "Again". Focus purely on committing the terms to memory and mimicking the pronunciation as closely as you hear it.</p>
                                    </div>
                                    <div>
                                        <b class="text-orange-600 block mb-0.5">2. Production Phase</b>
                                        <p>On subsequent rounds, look at the English term and say the Spanish translation out loud <b>before</b> flipping the card. Try to reproduce the pronunciation you heard earlier.</p>
                                    </div>
                                    <div>
                                        <b class="text-orange-600 block mb-0.5">3. Dual Assessment</b>
                                        <p>When you flip, assess yourself on two criteria: Did you remember the correct word, and was your pronunciation native-like? If either is "no", rate it "Again" or "Hard".</p>
                                    </div>
                                    <p class="text-xs italic bg-white/50 p-2 rounded border border-orange-100"> For best results, keep <b>English First</b>, <b>Auto-Speak</b>, and <b>Shuffle</b> enabled.</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors cursor-pointer" onclick="document.getElementById('setting-shuffle').click()">
                            <div>
                                <span class="font-bold text-navy-900 block">Shuffle Cards</span>
                                <span class="text-xs text-gray-500">Mix card order each session</span>
                            </div>
                            <label class="switch" onclick="event.stopPropagation()">
                                <input type="checkbox" id="setting-shuffle" onchange="applyStudySettings()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors cursor-pointer" onclick="document.getElementById('setting-l1-first').click()">
                            <div>
                                <span class="font-bold text-navy-900 block">Start with English</span>
                                <span class="text-xs text-gray-500">Practice English  Spanish</span>
                            </div>
                            <label class="switch" onclick="event.stopPropagation()">
                                <input type="checkbox" id="setting-l1-first" onchange="applyStudySettings()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors cursor-pointer" onclick="document.getElementById('setting-auto-speak').click()">
                            <div>
                                <span class="font-bold text-navy-900 block">Auto-Speak</span>
                                <span class="text-xs text-gray-500">Read cards out loud automatically</span>
                            </div>
                            <label class="switch" onclick="event.stopPropagation()">
                                <input type="checkbox" id="setting-auto-speak" onchange="applyStudySettings()">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <!-- Keyboard Hints Toggle (Desktop focused, but visible on mobile for control) -->
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors cursor-pointer opacity-80" onclick="document.getElementById('setting-show-hints').click()">
                            <div>
                                <span class="font-bold text-navy-900 text-sm block">Keyboard Hints (Desktop)</span>
                                <span class="text-[10px] text-gray-500">Show key controls on buttons</span>
                            </div>
                            <label class="switch scale-75 origin-right" onclick="event.stopPropagation()">
                                <input type="checkbox" id="setting-show-hints" onchange="applyStudySettings()">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <!-- Keyboard Controls (Desktop Only) -->
                        <div class="hidden md:block border-t border-gray-100 pt-4 px-2">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-3">Keyboard Controls</span>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-xs">
                                <div class="flex justify-between items-center"><span class="text-gray-500">Flip/Reveal</span> <kbd class="bg-white border border-gray-300 rounded px-1.5 py-0.5 shadow-sm font-sans font-bold">Space</kbd></div>
                                <div class="flex justify-between items-center"><span class="text-gray-500">Audio</span> <kbd class="bg-white border border-gray-300 rounded px-1.5 py-0.5 shadow-sm font-sans font-bold">LShift</kbd></div>
                                <div class="flex justify-between items-center"><span class="text-gray-500">Again</span> <kbd class="bg-white border border-gray-300 rounded px-1.5 py-0.5 shadow-sm font-sans font-bold">A</kbd></div>
                                <div class="flex justify-between items-center"><span class="text-gray-500">Hard</span> <kbd class="bg-white border border-gray-300 rounded px-1.5 py-0.5 shadow-sm font-sans font-bold">W</kbd></div>
                                <div class="flex justify-between items-center"><span class="text-gray-500">Good</span> <kbd class="bg-white border border-gray-300 rounded px-1.5 py-0.5 shadow-sm font-sans font-bold">D</kbd></div>
                                <div class="flex justify-between items-center"><span class="text-gray-500">Easy</span> <kbd class="bg-white border border-gray-300 rounded px-1.5 py-0.5 shadow-sm font-sans font-bold">E</kbd></div>
                                <div class="flex justify-between items-center"><span class="text-gray-500">Undo</span> <kbd class="bg-white border border-gray-300 rounded px-1.5 py-0.5 shadow-sm font-sans font-bold">Q</kbd></div>
                                <div class="flex justify-between items-center"><span class="text-gray-500">Dictionary</span> <kbd class="bg-white border border-gray-300 rounded px-1.5 py-0.5 shadow-sm font-sans font-bold">Tab</kbd></div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200 bg-gray-50">
                        <button onclick="toggleStudySettings()" class="w-full bg-navy-900 active:scale-95 text-white py-4 rounded-xl font-bold shadow-lg shadow-navy-900/10 transition-transform">
                            Done
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================= NEW LESSONS PAGE ================= -->
        <section id="lessons" class="page-section min-h-[150vh]">
            <!-- Simplified Title -->
            <div class="max-w-4xl mx-auto px-4 pt-10 pb-4">
                <h1 class="text-3xl font-serif font-bold text-navy-900">Lessons</h1>
            </div>

             <!-- Lessons Dashboard -->
            <div id="lessons-dashboard-wrapper" class="relative mb-8">
                <div id="lessons-dashboard" class="bg-white rounded-xl shadow-lg border border-gray-200 mx-auto max-w-4xl w-[95%] sm:w-full z-40 relative transition-none p-4 md:p-6">
                    <div class="grid grid-cols-2 md:flex md:flex-row gap-4 md:gap-6 items-center">
                        
                        <!-- Top Row Mobile / Left & Middle Desktop -->
                        <div class="col-span-1 md:flex-1 text-center md:text-left border-r border-gray-100 pr-2 md:pr-4">
                            <div class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Current Level</div>
                            <div class="text-xl md:text-2xl font-bold text-navy-900" id="dash-lessons-level">A1</div>
                            <div class="text-[10px] md:text-xs text-gray-500" id="dash-lessons-desc">Absolute Beginner</div>
                        </div>

                        <div class="col-span-1 md:flex-1 text-center md:text-right pl-2 md:pl-4">
                            <div class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Next Lesson</div>
                            <div class="text-xs md:text-sm font-medium text-gray-600 mb-2 truncate max-w-[120px] mx-auto md:mx-0" id="dash-lessons-next">Introduction</div>
                            <div class="flex gap-2 justify-center md:justify-end">
                                <button onclick="jumpToNextLesson()" class="bg-gray-100 hover:bg-gray-200 text-navy-900 px-3 py-1.5 md:px-4 md:py-2 rounded-lg font-bold text-xs md:text-sm shadow-sm transition w-auto inline-block">
                                    Jump
                                </button>
                                <button onclick="startNextLesson()" class="bg-navy-900 hover:bg-navy-800 text-white px-3 py-1.5 md:px-4 md:py-2 rounded-lg font-bold text-xs md:text-sm shadow-md transition w-auto inline-block">
                                    Start
                                </button>
                            </div>
                        </div>

                        <!-- Bottom Row Mobile / Right Desktop -->
                        <div class="col-span-2 md:flex-1 text-center border-t md:border-t-0 border-gray-100 pt-4 md:pt-0 md:px-4 md:border-l md:pl-6">
                             <div class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Lessons Completed</div>
                            <div class="text-2xl md:text-3xl font-bold text-orange-500" id="dash-lessons-progress">Loading...</div>
                        </div>

                    </div>
                </div>
                
                <!-- SEARCH BAR (MODIFIED) -->
                <div id="lessons-search-container" class="search-container sticky top-20 z-40 px-4 mb-4 mt-4 transition-all duration-300 pt-2 pr-2"> 
                    <div class="max-w-4xl mx-auto flex items-center gap-2">
                         <button onclick="exitSearchMode('lessons')" id="lessons-back-btn" class="hidden text-gray-500 hover:text-navy-900 p-2">
                            <i data-lucide="arrow-left" class="w-6 h-6"></i>
                        </button>
                        <form action="." onsubmit="event.preventDefault(); document.activeElement.blur();" class="relative flex-grow search-input-wrapper transition-colors rounded-xl bg-gray-50/0">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                            <input type="search" enterkeyhint="search" id="lesson-search-input" onfocus="enterSearchMode('lessons')" oninput="handleLessonSearch()" placeholder="Search lessons..." 
                                class="w-full pl-10 pr-10 py-2 rounded-xl border border-gray-200 shadow-sm focus:outline-none focus:ring-0 focus:border-transparent bg-white focus:bg-transparent text-sm">
                             <button type="button" onclick="dismissKeyboard()" id="lessons-dismiss-btn" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-orange-500 p-1">
                                <i data-lucide="keyboard" class="w-4 h-4"></i>
                            </button>
                        </form>
                    </div>
                     <!-- SEARCH RESULTS CONTAINER (Moved inside for full screen effect) -->
                     <div class="max-w-4xl mx-auto hidden search-results-condensed mt-4" id="lessons-search-results">
                        <!-- Search results injected here -->
                    </div>
                </div>
            </div>
            
            <div class="max-w-4xl mx-auto px-4 pb-20" id="lessons-container">
                <!-- Lessons Accordion injected by JS -->
            </div>
        </section>
        
        <!-- LESSON VIEWER SECTION (Hidden by default) -->
        <section id="lesson-view" class="page-section">
             <div class="bg-navy-900 text-white py-4 sticky top-14 z-40 shadow-md">
                <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
                    <button onclick="router('lessons')" class="flex items-center gap-2 text-gray-300 hover:text-white transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> <span class="hidden sm:inline font-bold">Back to Library</span>
                    </button>
                    <h2 class="font-bold text-lg truncate max-w-[200px] sm:max-w-md" id="player-title">Lesson Title</h2>
                    <div class="w-8"></div> <!-- Spacer for centering -->
                </div>
            </div>

            <div class="max-w-4xl mx-auto px-4 py-8">
                <!-- Video -->
                <div class="video-container bg-black mb-8">
                    <div id="player-video-placeholder" class="w-full h-full flex items-center justify-center text-gray-500">Loading Video...</div>
                    <iframe id="player-iframe" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
                
                <!-- Content -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sm:p-8">
                    <div class="flex justify-between items-start mb-6 border-b border-gray-100 pb-4">
                        <div>
                            <span class="text-xs font-bold text-orange-500 uppercase tracking-wider mb-1 block flex items-center gap-2" id="player-level-container">
                                <span id="player-level">Level A1</span>
                                <span id="player-status-badge" class="hidden bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-[10px] flex items-center gap-1">
                                    <i data-lucide="check-circle" class="w-3 h-3"></i> Done
                                </span>
                            </span>
                            <h1 class="text-3xl font-serif font-bold text-navy-900" id="player-main-title">Lesson Title</h1>
                        </div>
                        <button class="text-gray-400 hover:text-orange-500 transition"><i data-lucide="bookmark" class="w-6 h-6"></i></button>
                    </div>
                    
                    <div class="prose max-w-none text-gray-600 leading-relaxed" id="player-content">
                        <!-- Content Injected Here -->
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-10 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button onclick="startQuiz()" class="flex items-center justify-center gap-2 bg-navy-900 hover:bg-navy-800 text-white py-4 rounded-lg font-bold shadow-md transition group">
                            <i data-lucide="help-circle" class="w-5 h-5 text-orange-500 group-hover:text-white transition"></i> Take Quiz
                        </button>
                        <button onclick="openAIAssistant()" class="flex items-center justify-center gap-2 bg-white border-2 border-gray-200 hover:border-orange-500 text-navy-900 py-4 rounded-lg font-bold transition group">
                            <i data-lucide="message-circle" class="w-5 h-5 text-gray-400 group-hover:text-orange-500 transition"></i> Ask AI Assistant
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- QUIZ VIEW SECTION -->
        <section id="quiz-view" class="page-section">
             <div class="bg-navy-900 text-white py-4 sticky top-14 z-40 shadow-md">
                <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
                    <button onclick="router('lesson-view')" class="flex items-center gap-2 text-gray-300 hover:text-white transition">
                        <i data-lucide="x" class="w-5 h-5"></i> <span class="hidden sm:inline font-bold">Exit Quiz</span>
                    </button>
                    <h2 class="font-bold text-lg">Practice Quiz</h2>
                    <div class="w-8"></div>
                </div>
            </div>
            <div class="max-w-2xl mx-auto px-4 py-12">
                <div id="quiz-loading" class="text-center py-12">
                    <div class="spinner border-4 border-orange-500 border-t-transparent rounded-full w-12 h-12 mx-auto mb-4 animate-spin"></div>
                    <p class="text-gray-600 font-medium">Generating questions with AI...</p>
                </div>
                <div id="quiz-content" class="hidden">
                     <div class="mb-6 flex justify-between items-center">
                        <span class="text-sm font-bold text-gray-500 uppercase tracking-wide">Question <span id="quiz-q-num">1</span>/5</span>
                        <span class="text-sm font-bold text-orange-500" id="quiz-score">Score: 0</span>
                     </div>
                     <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 sm:p-8">
                        <h3 class="text-xl font-bold text-navy-900 mb-6" id="quiz-question-text">Question goes here?</h3>
                        <div class="space-y-3" id="quiz-options">
                            <!-- Options injected here -->
                        </div>
                        <div id="quiz-feedback" class="mt-6 hidden p-4 rounded-lg bg-gray-50 text-sm"></div>
                        <button id="quiz-next-btn" onclick="nextQuestion()" class="mt-6 w-full bg-navy-900 text-white py-3 rounded-lg font-bold hover:bg-navy-800 transition hidden">Next Question</button>
                        <button id="quiz-finish-btn" onclick="finishQuiz()" class="mt-6 w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition hidden">Complete Quiz</button>
                     </div>
                </div>
            </div>
        </section>

        <!-- AI CHAT VIEW SECTION -->
        <section id="ai-chat-view" class="page-section">
             <div class="bg-navy-900 text-white py-4 sticky top-14 z-40 shadow-md">
                <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
                    <button onclick="router('lesson-view')" class="flex items-center gap-2 text-gray-300 hover:text-white transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> <span class="hidden sm:inline font-bold">Back to Lesson</span>
                    </button>
                    <h2 class="font-bold text-lg">AI Tutor</h2>
                    <div class="w-8"></div>
                </div>
            </div>
            <div class="max-w-2xl mx-auto px-4 py-4 h-[calc(100vh-160px)] flex flex-col">
                <div id="chat-history" class="flex-grow overflow-y-auto space-y-4 p-4 bg-white rounded-t-xl border border-gray-200 shadow-inner">
                    <div class="chat-bubble chat-ai">
                        Hola! I'm your AI tutor. I can help you with the lesson you are currently studying. What questions do you have?
                    </div>
                </div>
                <div class="bg-white border border-t-0 border-gray-200 p-4 rounded-b-xl shadow-lg flex gap-2">
                    <input type="text" id="chat-input" class="flex-grow border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:border-orange-500" placeholder="Ask a question..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
                    <button onclick="sendChatMessage()" class="bg-navy-900 text-white p-2 rounded-lg hover:bg-navy-800 transition"><i data-lucide="send" class="w-5 h-5"></i></button>
                </div>
            </div>
        </section>

        <!-- ================= HOME PAGE (Unlinked) ================= -->
        <section id="home" class="page-section">
            <!-- Hero -->
            <div class="bg-navy-900 text-white relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('images/hero-background1.png')] bg-cover bg-center opacity-30"></div>
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 lg:py-32 relative z-10">
                    <div class="lg:w-2/3">
                        <span class="text-orange-500 font-bold tracking-widest uppercase text-sm mb-2 block">No Games. No Gimmicks. Just Structure.</span>
                        <h1 class="text-5xl md:text-6xl font-serif font-black leading-tight mb-6">
                            Build Your Fluency <br>
                            <span class="text-orange-500">Brick by Brick.</span>
                        </h1>
                        <p class="text-xl text-gray-300 mb-10 font-light leading-relaxed max-w-2xl">
                            We provide the structure. Quizlet provides the engine. The <strong class="text-white">Brick Wall Method</strong> organizes high-frequency vocabulary into a rigorous daily path.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button onclick="router('method')" class="bg-orange-500 hover:bg-orange-600 text-white px-8 py-4 rounded font-bold text-lg shadow-lg transition hover:translate-y-[-2px] uppercase tracking-wide text-center">
                                Discover The Method
                            </button>
                            <button onclick="router('tools-landing')" class="border-2 border-white text-white hover:bg-white hover:text-navy-900 px-8 py-4 rounded font-bold text-lg transition hover:translate-y-[-2px] uppercase tracking-wide text-center">
                                Open Deck Library
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
             <div class="bg-white border-b border-gray-200">
                <div class="max-w-7xl mx-auto px-4 py-12 grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
                    <div><div class="text-4xl font-bold text-navy-900">10k+</div><div class="text-sm uppercase tracking-wide text-gray-500 mt-1">Active Students</div></div>
                    <div><div class="text-4xl font-bold text-navy-900">98%</div><div class="text-sm uppercase tracking-wide text-gray-500 mt-1">Retention Rate</div></div>
                    <div><div class="text-4xl font-bold text-navy-900">Top 1%</div><div class="text-sm uppercase tracking-wide text-gray-500 mt-1">Vocabulary Depth</div></div>
                    <div><div class="text-4xl font-bold text-navy-900">24/7</div><div class="text-sm uppercase tracking-wide text-gray-500 mt-1">Access to Tools</div></div>
                </div>
            </div>

            <!-- Method Preview -->
            <div class="py-20 bg-gray-50">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl font-serif font-bold text-navy-900 mb-4">Why Most Apps Fail You</h2>
                        <div class="w-20 h-1 bg-orange-500 mx-auto"></div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-10">
                        <div class="bg-white p-8 rounded border border-gray-200 shadow-sm hover:shadow-md transition">
                            <div class="bg-gray-100 w-12 h-12 rounded flex items-center justify-center mb-6 text-navy-900">
                                <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-3 text-navy-900">Zipf's Law Neglect</h3>
                            <p class="text-gray-600 leading-relaxed">Traditional courses teach "grandmother" before "the". We use frequency analysis to teach the words that make up 80% of conversation first.</p>
                        </div>
                        <div class="bg-white p-8 rounded border border-gray-200 shadow-sm hover:shadow-md transition">
                            <div class="bg-gray-100 w-12 h-12 rounded flex items-center justify-center mb-6 text-navy-900">
                                <i data-lucide="brain-circuit" class="w-6 h-6"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-3 text-navy-900">Lack of Spaced Repetition</h3>
                            <p class="text-gray-600 leading-relaxed">Cramming doesn't work. We structure your reviews to predict exactly when you're about to forget a word.</p>
                        </div>
                        <div class="bg-white p-8 rounded border border-gray-200 shadow-sm hover:shadow-md transition">
                            <div class="bg-gray-100 w-12 h-12 rounded flex items-center justify-center mb-6 text-navy-900">
                                <i data-lucide="hammer" class="w-6 h-6"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-3 text-navy-900">The "Fluency Illusion"</h3>
                            <p class="text-gray-600 leading-relaxed">Gamified apps make you feel productive without challenge. We focus on "Desirable Difficulty" to forge strong neural pathways.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================= METHOD PAGE ================= -->
        <section id="method" class="page-section">
            <div class="bg-navy-900 py-20 text-white">
                <div class="max-w-4xl mx-auto px-4 text-center">
                    <h1 class="text-4xl font-serif font-bold mb-6">The Brick Wall Method</h1>
                    <p class="text-xl text-gray-300">Language acquisition is engineering, not magic.</p>
                </div>
            </div>
            <div class="max-w-5xl mx-auto px-4 py-16">
                <div class="flex flex-col md:flex-row gap-12 items-center mb-20">
                    <div class="md:w-1/2">
                        <div class="text-orange-500 font-bold text-6xl opacity-20 mb-[-20px]">01</div>
                        <h3 class="text-2xl font-bold text-navy-900 mb-4 relative z-10">The Foundation</h3>
                        <p class="text-gray-600 mb-4">We utilize Zipf's Law which states that a small number of words occur incredibly often. The top 1,000 words account for ~75% of spoken Spanish.</p>
                    </div>
                    <div class="md:w-1/2 bg-gray-200 h-64 rounded flex items-center justify-center border-2 border-gray-300">
                         <div class="text-center"><i data-lucide="database" class="w-16 h-16 text-gray-400 mx-auto mb-2"></i><span class="text-gray-500 font-bold">Frequency DB</span></div>
                    </div>
                </div>
                <div class="text-center mt-12">
                    <button onclick="router('course')" class="bg-navy-900 hover:bg-navy-800 text-white px-8 py-4 rounded font-bold shadow-lg transition uppercase tracking-wide">Start Building Your Wall</button>
                </div>
            </div>
        </section>

        <!-- ================= QUIZLET HUB (TOOLS) ================= -->
        <section id="tools-landing" class="page-section">
            <div class="bg-gray-100 py-12 border-b border-gray-200">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="flex justify-between items-end">
                        <div>
                            <h1 class="text-3xl font-serif font-bold text-navy-900">Deck Library</h1>
                            <p class="text-gray-600 mt-2">Access your private Quizlet sets below.</p>
                        </div>
                        <div class="text-right hidden sm:block">
                            <div class="text-sm font-bold text-gray-500 uppercase">Total Progress</div>
                            <div class="text-2xl font-bold text-orange-500"><span id="total-completed">0</span>/<span id="total-decks">2</span> Decks</div>
                        </div>
                    </div>
                     <p class="text-xs text-gray-500 mt-1">User ID: <span id="current-user-id" class="font-mono bg-gray-200 p-0.5 rounded">...</span></p>
                </div>
            </div>

            <div class="max-w-7xl mx-auto px-4 py-12">
                
                <!-- Deck 1 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-4 flex flex-col sm:flex-row items-center gap-6 hover:shadow-md transition">
                    <div class="bg-navy-900 text-white p-4 rounded-lg flex-shrink-0">
                        <i data-lucide="layers" class="w-8 h-8"></i>
                    </div>
                    <div class="flex-grow text-center sm:text-left">
                        <h3 class="text-lg font-bold text-navy-900">Top 10 Essentials</h3>
                        <p class="text-sm text-gray-500 mb-2">The absolute most frequent words in Spanish.</p>
                        <a href="https://quizlet.com/latest" target="_blank" class="inline-flex items-center gap-2 text-orange-500 font-bold hover:underline">
                            Open in Quizlet <i data-lucide="external-link" class="w-4 h-4"></i>
                        </a>
                    </div>
                    <div class="flex-shrink-0">
                        <button id="btn-deck-1" onclick="toggleDeckFirebase('deck-1')" class="border-2 border-gray-300 text-gray-400 px-6 py-2 rounded-full font-bold transition flex items-center gap-2 hover:bg-gray-50">
                            <span class="status-text">Mark Complete</span>
                        </button>
                    </div>
                </div>

                <!-- Deck 2 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-4 flex flex-col sm:flex-row items-center gap-6 hover:shadow-md transition">
                    <div class="bg-navy-900 text-white p-4 rounded-lg flex-shrink-0">
                        <i data-lucide="layers" class="w-8 h-8"></i>
                    </div>
                    <div class="flex-grow text-center sm:text-left">
                        <h3 class="text-lg font-bold text-navy-900">Connector Words</h3>
                        <p class="text-sm text-gray-500 mb-2">Linking words like 'pero', 'y', 'o', 'aunque'.</p>
                        <a href="https://quizlet.com/latest" target="_blank" class="inline-flex items-center gap-2 text-orange-500 font-bold hover:underline">
                            Open in Quizlet <i data-lucide="external-link" class="w-4 h-4"></i>
                        </a>
                    </div>
                    <div class="flex-shrink-0">
                        <button id="btn-deck-2" onclick="toggleDeckFirebase('deck-2')" class="border-2 border-gray-300 text-gray-400 px-6 py-2 rounded-full font-bold transition flex items-center gap-2 hover:bg-gray-50">
                            <span class="status-text">Mark Complete</span>
                        </button>
                    </div>
                </div>

                <div class="mt-12 pt-8 border-t border-gray-200">
                    <h2 class="text-xl font-bold text-navy-900 mb-6">Internal Tools</h2>
                    <div class="grid md:grid-cols-3 gap-6">
                         <!-- Conjugator Link -->
                         <div onclick="router('tools-conjugation')" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:shadow-md hover:border-orange-500 transition group">
                            <div class="flex justify-between items-start mb-4">
                                <div class="bg-gray-100 text-navy-900 p-3 rounded-lg group-hover:bg-navy-900 group-hover:text-white transition">
                                    <i data-lucide="pen-tool" class="w-6 h-6"></i>
                                </div>
                            </div>
                            <h3 class="text-lg font-bold text-navy-900 mb-1">Verb Conjugation Drill</h3>
                            <p class="text-sm text-gray-500">Practice Present, Preterite, and Imperfect tenses.</p>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- ================= CONJUGATION TOOL PAGE (REFACTORED) ================= -->
        <section id="tools-conjugation" class="page-section">
            <div class="max-w-7xl mx-auto px-4 pt-4 pb-8 relative">
                
                <!-- VIEW 1: SELECTION (Search & List) -->
                <div id="verb-selection-view" class="max-w-4xl mx-auto">
                    <div class="mb-6 border-b border-gray-200 pb-4 flex justify-between items-end">
                        <h1 class="text-3xl font-serif font-bold text-navy-900">Verb Lab</h1>
                        <!-- Visual Ticket Cart -->
                        <div id="verb-ticket-cart-indicator" class="hidden animate-fadeIn flex items-center gap-3 bg-white border border-orange-500/30 pl-4 pr-1 py-1 rounded-full shadow-sm">
                             <div class="flex items-center gap-2">
                                <i data-lucide="ticket" class="w-4 h-4 text-orange-500"></i>
                                <span id="cart-count" class="text-sm font-black text-navy-900">0</span>
                             </div>
                             <button onclick="launchVerbTicket()" class="bg-navy-900 text-white px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-navy-800 transition">Launch Ticket</button>
                             <button onclick="clearVerbTicket()" class="text-gray-300 hover:text-red-500 p-1 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>

                    <!-- DASHBOARD RINGS (Mirrored from Flashcards) -->
                    <div id="verb-dashboard-wrapper" class="relative mb-8">
                        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-6 md:p-8">
                            <div class="flex flex-col md:flex-row items-center gap-8">
                                
                                <!-- 3-Ring Visualization (Focused on Verbs) -->
                                <div class="relative w-40 h-40 flex-shrink-0">
                                    <svg class="rings-svg w-full h-full" viewBox="0 0 100 100">
                                        <circle class="ring-bg" cx="50" cy="50" r="45" stroke-width="8" />
                                        <circle class="ring-bg" cx="50" cy="50" r="35" stroke-width="8" opacity="0.5" />
                                        <circle class="ring-bg" cx="50" cy="50" r="25" stroke-width="8" opacity="0.3" />
                                        <circle id="ring-verbs-mastery" class="ring-progress verb-ring-color" cx="50" cy="50" r="45" stroke-width="8" stroke-dasharray="282.7" stroke-dashoffset="282.7" />
                                        <circle id="ring-verbs-daily" class="ring-progress vocab-ring-color" cx="50" cy="50" r="35" stroke-width="8" stroke-dasharray="219.9" stroke-dashoffset="219.9" />
                                        <circle id="ring-verbs-review" class="ring-progress lesson-ring-color" cx="50" cy="50" r="25" stroke-width="8" stroke-dasharray="157.1" stroke-dashoffset="157.1" />
                                    </svg>
                                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                                        <span class="text-2xl font-black text-navy-900" id="dash-verb-pct">0%</span>
                                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest bg-white/60 backdrop-blur-sm px-1 rounded">Verb Goal</span>
                                    </div>
                                </div>

                                <div class="flex-grow space-y-6">
                                    <div class="grid grid-cols-2 gap-4">
                                        <button onclick="launchDueVerbReview()" class="text-left bg-gray-50 rounded-xl p-4 border border-gray-100 hover:border-gray-300 transition group">
                                            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 group-hover:text-navy-900">Due for Maintenance</div>
                                            <div class="text-2xl font-black text-navy-900" id="dash-verb-due-count">0</div>
                                            <div class="text-[10px] text-gray-500">Conjugations to review</div>
                                        </button>
                                        <div class="bg-orange-50 rounded-xl p-4 border border-orange-100">
                                            <div class="text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-1">Consistency Streak</div>
                                            <div class="text-2xl font-black text-orange-500" id="dash-verb-streak-count">0 Days</div>
                                            <div class="text-[10px] text-gray-500">Consecutive days active</div>
                                        </div>
                                    </div>

                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <button onclick="startLearningNewVerbs()" class="flex-grow bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                                            <i data-lucide="play" class="w-5 h-5 fill-current"></i> Learn New Verbs
                                        </button>
                                        <button onclick="openVerbReviewTicket()" class="flex-grow bg-navy-900 hover:bg-navy-800 text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                                            <i data-lucide="ticket" class="w-5 h-5"></i> Launch Verb Ticket
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SAVED TICKETS (Collapsed section) -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest cursor-pointer" onclick="toggleAccordion('saved-verb-tickets')">Saved Review Tickets</h3>
                            <button onclick="toggleAccordion('saved-verb-tickets')" class="text-gray-400 hover:text-navy-900 transition-colors">
                                <i data-lucide="chevron-down" id="icon-saved-verb-tickets" class="w-5 h-5 transition-transform"></i>
                            </button>
                        </div>
                        <div id="content-saved-verb-tickets" class="accordion-content">
                            <div id="saved-verb-tickets-container" class="grid grid-cols-2 md:grid-cols-4 gap-6 p-3">
                                <!-- Placeholder / Empty state -->
                                <div class="col-span-full text-center py-8 text-gray-400 text-sm italic">No saved tickets yet. Create one in the builder!</div>
                            </div>
                        </div>
                    </div>

                    <!-- SEARCH BAR & SORT -->
                    <div id="verb-search-container" class="search-container mb-6 pt-2 pr-2">
                        <div class="flex flex-row gap-2 sm:gap-4 max-w-4xl mx-auto items-center">
                             <div class="flex flex-grow items-center gap-2">
                                <button onclick="exitSearchMode('verbs')" id="verbs-back-btn" class="hidden text-gray-500 hover:text-navy-900 p-2">
                                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                                </button>
                                <form action="." onsubmit="event.preventDefault(); document.activeElement.blur();" class="relative flex-grow search-input-wrapper transition-colors rounded-xl bg-gray-50/0">
                                     <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                                     <input type="search" enterkeyhint="search" id="verb-search-input" onfocus="enterSearchMode('verbs')" oninput="filterVerbList()" placeholder="Search verbs..." 
                                        class="w-full pl-10 pr-10 py-2 rounded-xl border border-gray-200 shadow-sm focus:outline-none focus:ring-0 focus:border-transparent bg-white focus:bg-transparent text-sm">
                                      <button type="button" onclick="dismissKeyboard()" id="verbs-dismiss-btn" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-orange-500 p-1">
                                        <i data-lucide="keyboard" class="w-4 h-4"></i>
                                    </button>
                                </form>
                             </div>
                             
                             <button id="verb-sort-btn" onclick="toggleVerbSort()" class="bg-white border border-gray-200 rounded-xl px-4 py-2 font-bold text-navy-900 shadow-sm hover:border-orange-500 transition flex items-center justify-center gap-2 whitespace-nowrap text-sm h-[42px] self-center">
                                 <span id="verb-sort-label">Freq</span>
                                 <i data-lucide="arrow-down-up" class="w-4 h-4"></i>
                             </button>
                        </div>
                        
                        <div id="verb-list-container" class="bg-white rounded-xl shadow-sm border border-gray-200 divide-y divide-gray-100 overflow-hidden mb-6 mt-4 transition-all">
                            <!-- Verb list injected here -->
                        </div>
                    </div>
                </div>

                <!-- VIEW 1.5: SKELETON LOADER -->
                <div id="verb-skeleton-view" class="hidden animate-fadeIn pb-24">
                    <div class="h-6 w-24 skeleton mb-6"></div> <!-- Back Button -->

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden mb-8">
                        <!-- Hero Section Skeleton -->
                        <div class="bg-slate-50 p-8 relative">
                           <div class="absolute top-4 right-6 w-20 h-6 skeleton rounded-full"></div>
                           <div class="w-48 h-12 skeleton mb-4"></div> <!-- Infinitive -->
                           <div class="w-32 h-6 skeleton"></div> <!-- Translation -->
                           
                           <div class="mt-8 flex flex-wrap gap-4">
                               <div class="w-32 h-12 skeleton rounded-xl"></div>
                               <div class="w-44 h-12 skeleton rounded-xl"></div>
                           </div>
                        </div>

                        <div class="p-6 md:p-8 space-y-10">
                            <div class="grid md:grid-cols-2 gap-8">
                                <div class="space-y-4">
                                    <div class="w-24 h-4 skeleton"></div> <!-- Def Label -->
                                    <div class="w-full h-4 skeleton"></div>
                                    <div class="w-full h-4 skeleton"></div>
                                    <div class="w-3/4 h-4 skeleton"></div>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-6 space-y-4">
                                    <div class="w-32 h-4 skeleton"></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="h-10 skeleton"></div>
                                        <div class="h-10 skeleton"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tables Grid Skeleton -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                <div class="h-64 skeleton rounded-2xl opacity-40"></div>
                                <div class="h-64 skeleton rounded-2xl opacity-40"></div>
                                <div class="h-64 skeleton rounded-2xl opacity-40"></div>
                                <div class="h-64 skeleton rounded-2xl opacity-40"></div>
                                <div class="h-64 skeleton rounded-2xl opacity-40"></div>
                                <div class="h-64 skeleton rounded-2xl opacity-40"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: VERB DETAIL (Wikipedia Style) -->
                <div id="verb-detail-view" class="hidden animate-fadeIn pb-24">
                    <button onclick="exitVerbDetail()" class="text-gray-500 hover:text-navy-900 mb-6 flex items-center gap-2">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Lab
                    </button>

                    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden mb-8">
                        <div class="bg-navy-900 p-8 text-white relative">
                            <div class="absolute top-4 right-6 bg-white/10 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest border border-white/20">
                                Rank #<span id="detail-rank">...</span>
                            </div>
                            <h2 class="text-5xl font-serif font-black mb-2" id="detail-infinitive">Vivir</h2>
                            <div class="flex items-center gap-2">
                                <p class="text-xl text-gray-300 font-light italic" id="detail-translation">to live</p>
                                <div id="detail-verified-icon" class="hidden w-5 h-5 bg-green-500 rounded-full flex items-center justify-center shadow-sm border border-white/20">
                                    <i data-lucide="check" class="w-3 h-3 text-white"></i>
                                </div>
                            </div>
                            
                            <div class="mt-8 flex flex-wrap gap-4">
                                <button onclick="studyCurrentVerb()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-bold transition flex items-center gap-2 shadow-lg shadow-orange-500/20">
                                    <i data-lucide="play" class="w-5 h-5 fill-current"></i> Study Verb
                                </button>
                                <button onclick="addToVerbTicket()" class="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-xl font-bold transition flex items-center gap-2 border border-white/20">
                                    <i data-lucide="ticket" class="w-5 h-5"></i> Create review ticket
                                </button>
                                <!-- Admin Edit Button -->
                                <button id="admin-edit-btn" onclick="openAdminEdit()" class="hidden bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-xl font-bold transition flex items-center gap-2 border border-white/20">
                                    <i data-lucide="edit-3" class="w-5 h-5"></i> Edit Verb
                                </button>
                            </div>
                        </div>

                        <div class="p-6 md:p-8 space-y-10">
                            <!-- Definition & Grammar Info -->
                            <div class="grid md:grid-cols-2 gap-8">
                                <div>
                                    <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4">Definition</h4>
                                    <div id="detail-definition" class="text-gray-700 leading-relaxed space-y-2">
                                        <!-- API content -->
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4">Quick Reference</h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span class="block text-gray-400 text-[10px] uppercase font-bold">Past Participle</span>
                                            <span id="detail-participle" class="font-bold text-navy-900">vivido</span>
                                        </div>
                                        <div>
                                            <span class="block text-gray-400 text-[10px] uppercase font-bold">Gerund</span>
                                            <span id="detail-gerund" class="font-bold text-navy-900">viviendo</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Conjugation Tables -->
                            <div>
                                <div class="flex justify-between items-end mb-6">
                                    <h4 class="text-xs font-black text-gray-400 uppercase tracking-widest">Conjugation Tables</h4>
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <span class="text-xs font-bold text-gray-500 uppercase">Show Vos</span>
                                            <input type="checkbox" id="toggle-vos" onchange="renderVerbTables()" class="w-4 h-4 accent-orange-500">
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <span class="text-xs font-bold text-gray-500 uppercase">Vosotros</span>
                                            <input type="checkbox" id="toggle-vosotros" onchange="renderVerbTables()" class="w-4 h-4 accent-orange-500">
                                        </label>
                                    </div>
                                </div>

                                <div id="tables-container" class="space-y-12">
                                    <!-- Injected via JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW 3: PRACTICE (Card Drill) -->

                <!-- VIEW 2: PRACTICE (Card Drill) -->
                <!-- HEADER REMOVED COMPLETELY FOR SPACE -->
                <div id="verb-practice-view" class="hidden h-[85vh] flex flex-col items-center justify-center">
                    
                    <!-- Header Info -->
                    <div class="text-center mb-6">
                        <h2 class="text-3xl font-serif font-bold text-navy-900 mb-1" id="practice-infinitive">Hablar</h2>
                        <p class="text-gray-500" id="practice-translation">to speak</p>
                    </div>

                    <!-- The Card Area -->
                    <div class="relative w-full max-w-sm aspect-[4/3] card-container mb-6">
                         <!-- The Card -->
                        <div id="practice-card" class="absolute inset-0 bg-white rounded-2xl shadow-xl border-4 border-transparent flex flex-col items-center justify-between p-6 transition-all duration-300 cursor-pointer select-none" onclick="flipCard()">
                            
                            <!-- Tense Pill (Floating) -->
                            <div class="absolute -top-3 bg-orange-500 text-white px-4 py-1 rounded-full shadow-md text-xs font-bold uppercase tracking-wide z-10" id="card-tense">
                                Present
                            </div>

                            <!-- Content -->
                            <div class="flex-grow flex flex-col items-center justify-center w-full">
                                <div class="text-2xl font-bold text-gray-800 mb-6" id="card-subject">Yo</div>
                                
                                <div id="card-answer-area" class="w-full text-center">
                                    <div id="card-hidden" class="text-gray-300 font-mono text-xl">__________________</div>
                                    <div id="card-revealed" class="hidden text-3xl font-bold text-navy-900 animate-fadeIn">hablo</div>
                                </div>
                            </div>
                            
                            <div class="text-[0.65rem] text-gray-400 mt-2 uppercase tracking-widest">Tap to Reveal</div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="w-full max-w-sm flex items-center justify-between px-4">
                        <!-- Left / Incorrect -->
                        <button onclick="handleSwipe('left')" class="w-14 h-14 rounded-full border-2 border-red-500 flex items-center justify-center text-red-500 hover:bg-red-50 transition transform hover:scale-110">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>

                        <!-- Audio -->
                        <button onclick="speakCurrentCard()" class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center text-gray-800 hover:bg-gray-200 transition transform hover:scale-110">
                            <i data-lucide="volume-2" class="w-5 h-5"></i>
                        </button>

                        <!-- Right / Correct -->
                        <button onclick="handleSwipe('right')" class="w-14 h-14 rounded-full border-2 border-green-500 flex items-center justify-center text-green-500 hover:bg-green-50 transition transform hover:scale-110">
                            <i data-lucide="check" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Floating Settings Cog -->
                    <button onclick="toggleSettingsModal()" class="absolute top-2 right-2 p-2 bg-white rounded-full shadow-md text-gray-500 hover:text-navy-900 border border-gray-200">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                     <!-- Back Button -->
                    <button onclick="exitPractice()" class="absolute top-2 left-2 p-2 bg-white rounded-full shadow-md text-gray-500 hover:text-navy-900 border border-gray-200">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full max-h-[85vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-lg text-navy-900">Drill Settings</h3>
                        <button onclick="toggleSettingsModal()"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
                    </div>
                    <div class="overflow-y-auto p-4 space-y-6 flex-grow">
                        <div class="flex items-center justify-between pb-4 border-b border-gray-100">
                            <span class="font-bold text-gray-800">Auto-Speak</span>
                            <input type="checkbox" id="setting-autospeak" class="w-6 h-6 accent-orange-500">
                        </div>
                        
                        <!-- Sections injected via JS -->
                        <div id="settings-tenses-container" class="space-y-6"></div>

                    </div>
                    <div class="p-4 border-t border-gray-100 bg-gray-50">
                        <button onclick="toggleSettingsModal()" class="w-full bg-navy-900 text-white py-3 rounded-lg font-bold">Done</button>
                    </div>
                </div>
            </div>

        </section>

        <!-- ================= COURSES & BOOKING (Simplified) ================= -->
        <section id="course" class="page-section">
             <div class="max-w-7xl mx-auto px-4 py-16 text-center">
                <h2 class="text-3xl font-bold mb-4">Courses Page</h2>
                <p>Content remains similar to previous version...</p>
                <button onclick="router('home')" class="mt-4 text-orange-500 underline">Back Home</button>
             </div>
        </section>
        <section id="booking" class="page-section">
             <div class="max-w-7xl mx-auto px-4 py-16 text-center">
                <h2 class="text-3xl font-bold mb-4">Booking Page</h2>
                <p>Content remains similar to previous version...</p>
                <button onclick="router('home')" class="mt-4 text-orange-500 underline">Back Home</button>
             </div>
        </section>

        <!-- ================= LOGIN / SIGNUP PAGE (Functional) ================= -->
        <section id="login" class="page-section active">
            <div class="min-h-[60vh] flex items-center justify-center p-4">
                <div id="auth-form-container" class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md border border-gray-200">
                    <h2 id="auth-title" class="text-3xl font-serif font-bold text-navy-900 mb-6">Log In</h2>

                    <div class="space-y-4">
                        <input id="auth-email" type="email" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 focus:outline-none" />
                        <input id="auth-password" type="password" placeholder="Password (min 6 characters)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 focus:outline-none" />
                    </div>

                    <button id="auth-submit-btn" onclick="handleAuth(true)" class="mt-6 w-full bg-orange-500 text-white text-lg font-bold px-4 py-3 rounded-lg shadow-md transition duration-150 ease-in-out hover:bg-orange-600 uppercase tracking-wide">
                        Log In
                    </button>

                    <button onclick="toggleAuthMode()" class="mt-4 w-full text-sm text-navy-900 hover:text-orange-500 transition duration-150 underline">
                        Don't have an account? Sign Up
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer id="main-footer" class="bg-navy-900 text-gray-400 py-12 border-t border-navy-800 transition-opacity duration-300">
        <div class="max-w-7xl mx-auto px-4 grid md:grid-cols-4 gap-8">
            <div class="col-span-1 md:col-span-1">
                <div class="flex items-center mb-4 text-white">
                    <div class="w-8 h-8 bg-orange-500 flex items-center justify-center rounded mr-2 font-serif font-bold">S</div>
                    <span class="font-serif font-bold">Spanish by Sammy</span>
                </div>
                <p class="text-sm">Serious tools for serious students.</p>
            </div>
            <div>
                <h4 class="text-white font-bold uppercase tracking-wider text-xs mb-4">Method</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-white">Why Zipf's Law?</a></li>
                    <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-white">Spaced Repetition</a></li>
                    <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-white">Our Story</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-white font-bold uppercase tracking-wider text-xs mb-4">Resources</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" class="hover:text-white">Blog</a></li>
                    <li><a href="#" class="hover:text-white">Verb Tables</a></li>
                    <li><a href="#" class="hover:text-white">Student Forum</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-white font-bold uppercase tracking-wider text-xs mb-4">Legal</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" class="hover:text-white">Terms of Service</a></li>
                    <li><a href="#" class="hover:text-white">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-4 mt-12 pt-8 border-t border-navy-800 text-center text-xs">
            &copy; 2024 Spanish by Sammy. All rights reserved.
        </div>
    </footer>

    <!-- Modals and Overlays -->
    <!-- Admin Edit Modal -->
    <div id="admin-edit-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden flex flex-col animate-slide-up">
            <div class="bg-navy-900 text-white p-5 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white/10 p-2 rounded-lg">
                        <i data-lucide="edit-3" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-lg uppercase tracking-wider">Curation Mode</h3>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">smsewall@gmail.com</p>
                    </div>
                </div>
                <button onclick="closeAdminEdit()" class="hover:bg-white/10 p-2 rounded-full transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Main Translation (Label)</label>
                    <input type="text" id="edit-translation" class="w-full p-3 rounded-xl border border-gray-200 focus:border-navy-900 focus:outline-none font-bold text-navy-900">
                    <p class="text-[10px] text-gray-400 mt-1 italic">Used for search results & card front.</p>
                </div>

                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Frequency Rank</label>
                    <input type="number" id="edit-rank" class="w-full p-3 rounded-xl border border-gray-200 focus:border-navy-900 focus:outline-none font-bold text-navy-900">
                </div>

                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Full Definitions (Separated by ;)</label>
                    <textarea id="edit-definitions" rows="4" class="w-full p-3 rounded-xl border border-gray-200 focus:border-navy-900 focus:outline-none text-sm text-gray-600 leading-relaxed"></textarea>
                </div>

                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                    <div>
                        <span class="font-bold text-navy-900 block text-sm">Verified Status</span>
                        <span class="text-[10px] text-gray-500 uppercase font-black">Protect from API Overwrites</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="edit-verified">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="p-6 bg-gray-50 border-t border-gray-100 flex gap-3">
                <button onclick="closeAdminEdit()" class="flex-1 px-6 py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-200 transition">Cancel</button>
                <button onclick="saveAdminEdit()" class="flex-[2] bg-navy-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-navy-800 transition shadow-lg">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="message-modal" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden items-center justify-center p-4 z-[100]">
        <div id="message-modal-content" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full border-t-4 border-orange-500 transform transition-all duration-300">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-navy-900"></h3>
            <div id="modal-message" class="text-gray-700 mb-6 whitespace-pre-wrap text-sm"></div>
            <div id="modal-actions" class="flex flex-col gap-2">
                <button id="modal-primary-btn" onclick="closeModal()" class="bg-navy-900 text-white px-4 py-2 rounded-lg shadow-md transition duration-150 ease-in-out hover:bg-navy-800 w-full font-semibold">Close</button>
                <button id="modal-secondary-btn" onclick="closeModal()" class="hidden border border-gray-300 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-50 transition w-full font-semibold">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="loading-overlay" class="fixed inset-0 bg-gray-50 bg-opacity-75 hidden items-center justify-center z-[100]">
        <div class="flex flex-col items-center">
            <div class="spinner rounded-full h-12 w-12 border-4 border-solid"></div>
            <p class="mt-4 text-navy-900 font-semibold">Connecting...</p>
        </div>
    </div>
    
    <script type="module">
        // =======================================================
        // ========== FIREBASE CONNECTION & CORE LOGIC ===========
        // =======================================================

        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc,
            getDoc,
            getDocs,
            onSnapshot, 
            collection, 
            query,
            increment,
            updateDoc,
            where,
            limit,
            documentId
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        // --- YOUR HARDCODED FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAXx2DC-frumAv89q4MEDCHRx2mvf69N_o",
            authDomain: "spanishbysammy-6a112.firebaseapp.com",
            projectId: "spanishbysammy-6a112",
            storageBucket: "spanishbysammy-6a112.firebasestorage.app",
            messagingSenderId: "1011893685836",
            appId: "1:1011893685836:web:90e420f4821573bebf2ee9",
            measurementId: "G-SLNTHSFK0G"
        };
        
        // --- STRIPE CONFIG ---
        // TODO: Replace with your actual Stripe Publishable Key
        const STRIPE_PUBLIC_KEY = 'pk_test_51Sa9Xd5qYNpP9LJH9TvMEHLH0ISP06NMxGIACe6m5QTQ1CwLDnnYS81kzg9fE7Ibnb6clgWnqm37X54zsmG5vgGK00cDy9Ghrj';
        // TODO: Replace with your actual Price IDs from Stripe Dashboard
        const STRIPE_PRICE_IDS = {
            'monthly': 'price_1Sa9Za5qYNpP9LJH3yftmL1Q', 
            'yearly': 'price_1Sb93E5qYNpP9LJHnSITAWQa'
        };
        // TODO: Replace with your deployed Firebase Function URL
        const FIREBASE_FUNCTIONS_BASE_URL = "https://us-central1-spanishbysammy-6a112.cloudfunctions.net";

        const initialAuthToken = null;
        const appId = firebaseConfig.projectId; 

        // --- ADMIN CONFIG ---
        const ADMIN_EMAIL = 'smsewall@gmail.com';
        let ALLOW_API_FETCH = true;

        // --- GLOBAL STATE ---
        let app;
        let auth;
        let db;
        let userId = null;
        let isLoginMode = true;
        let userProgress = {};
        let userCardProgress = {}; // NEW: Per-card progress tracking
        let lastStudiedSet = null;
        let previousLevelStates = {};
        let currentDashboardSlide = 0;
        let currentLessonForAI = null;
        let currentQuizQuestions = [];
        let currentQuizIndex = 0;
        let currentQuizScore = 0;
        let justCompletedLesson = false;
        let allLessons = [];
        let flashcardData = [];
        let userSubscriptionStatus = 'free'; // 'free' or 'premium'
        let currentNextLessonId = null; // Used for "Jump" functionality
        let savedTickets = [];
        let currentLoadedTicketId = null;
        let currentLoadedTicketName = null;

        // Modal Specific State
        let cardMetaCache = {}; // Local cache for card metadata for ticket generator
        
        let dailyVocabGoal = 25;
        let todayWordsLearned = 0;


        let stripe;

        
        const USE_CLOUD_FUNCTIONS = false; 
        
        // Mock data for the Spanish Decks
        const SPANISH_DECKS = [
            { id: 'deck-1', name: 'Top 10 Essentials' },
            { id: 'deck-2', name: 'Connector Words' },
        ];

        // --- VERB CONJUGATION DATABASE & LOGIC ---
        
        // 1. Core Data (Infinitive, Translations, Simple Tenses, Rank, Participle, Gerund)
        const VERB_DB_RAW = [
            { 
                infinitive: 'ser', 
                translation: 'to be (permanent)',
                rank: 1, 
                participle: 'sido',
                gerund: 'siendo',
                conjugations: {
                    'Present': { 'yo': 'soy', 't': 'eres', 'l/ella': 'es', 'nosotros': 'somos', 'vosotros': 'sois', 'ellos': 'son' },
                    'Preterite': { 'yo': 'fui', 't': 'fuiste', 'l/ella': 'fue', 'nosotros': 'fuimos', 'vosotros': 'fuisteis', 'ellos': 'fueron' },
                    'Imperfect': { 'yo': 'era', 't': 'eras', 'l/ella': 'era', 'nosotros': 'ramos', 'vosotros': 'erais', 'ellos': 'eran' },
                    'Future': { 'yo': 'ser', 't': 'sers', 'l/ella': 'ser', 'nosotros': 'seremos', 'vosotros': 'seris', 'ellos': 'sern' },
                    'Conditional': { 'yo': 'sera', 't': 'seras', 'l/ella': 'sera', 'nosotros': 'seramos', 'vosotros': 'serais', 'ellos': 'seran' },
                    'Subjunctive Present': { 'yo': 'sea', 't': 'seas', 'l/ella': 'sea', 'nosotros': 'seamos', 'vosotros': 'seis', 'ellos': 'sean' },
                    'Subjunctive Imperfect': { 'yo': 'fuera', 't': 'fueras', 'l/ella': 'fuera', 'nosotros': 'furamos', 'vosotros': 'fuerais', 'ellos': 'fueran' }
                }
            },
            { 
                infinitive: 'estar', 
                translation: 'to be (temporary)',
                rank: 2,
                participle: 'estado',
                gerund: 'estando',
                conjugations: {
                    'Present': { 'yo': 'estoy', 't': 'ests', 'l/ella': 'est', 'nosotros': 'estamos', 'vosotros': 'estis', 'ellos': 'estn' },
                    'Preterite': { 'yo': 'estuve', 't': 'estuviste', 'l/ella': 'estuvo', 'nosotros': 'estuvimos', 'vosotros': 'estuvisteis', 'ellos': 'estuvieron' },
                    'Imperfect': { 'yo': 'estaba', 't': 'estabas', 'l/ella': 'estaba', 'nosotros': 'estbamos', 'vosotros': 'estabais', 'ellos': 'estaban' },
                    'Future': { 'yo': 'estar', 't': 'estars', 'l/ella': 'estar', 'nosotros': 'estaremos', 'vosotros': 'estaris', 'ellos': 'estarn' },
                    'Conditional': { 'yo': 'estara', 't': 'estaras', 'l/ella': 'estara', 'nosotros': 'estaramos', 'vosotros': 'estarais', 'ellos': 'estaran' },
                    'Subjunctive Present': { 'yo': 'est', 't': 'ests', 'l/ella': 'est', 'nosotros': 'estemos', 'vosotros': 'estis', 'ellos': 'estn' },
                    'Subjunctive Imperfect': { 'yo': 'estuviera', 't': 'estuvieras', 'l/ella': 'estuviera', 'nosotros': 'estuviramos', 'vosotros': 'estuvierais', 'ellos': 'estuvieran' }
                }
            },
             { 
                infinitive: 'haber', 
                translation: 'to have (auxiliary)',
                rank: 3,
                participle: 'habido',
                gerund: 'habiendo',
                conjugations: {
                    'Present': { 'yo': 'he', 't': 'has', 'l/ella': 'ha', 'nosotros': 'hemos', 'vosotros': 'habis', 'ellos': 'han' },
                    'Preterite': { 'yo': 'hube', 't': 'hubiste', 'l/ella': 'hubo', 'nosotros': 'hubimos', 'vosotros': 'hubisteis', 'ellos': 'hubieron' },
                    'Imperfect': { 'yo': 'haba', 't': 'habas', 'l/ella': 'haba', 'nosotros': 'habamos', 'vosotros': 'habais', 'ellos': 'haban' },
                    'Future': { 'yo': 'habr', 't': 'habrs', 'l/ella': 'habr', 'nosotros': 'habremos', 'vosotros': 'habris', 'ellos': 'habrn' },
                    'Conditional': { 'yo': 'habra', 't': 'habras', 'l/ella': 'habra', 'nosotros': 'habramos', 'vosotros': 'habrais', 'ellos': 'habran' },
                    'Subjunctive Present': { 'yo': 'haya', 't': 'hayas', 'l/ella': 'haya', 'nosotros': 'hayamos', 'vosotros': 'hayis', 'ellos': 'hayan' },
                    'Subjunctive Imperfect': { 'yo': 'hubiera', 't': 'hubieras', 'l/ella': 'hubiera', 'nosotros': 'hubiramos', 'vosotros': 'hubierais', 'ellos': 'hubieran' }
                }
            },
            { 
                infinitive: 'hablar', 
                translation: 'to speak',
                rank: 50,
                participle: 'hablado',
                gerund: 'hablando',
                conjugations: {
                    'Present': { 'yo': 'hablo', 't': 'hablas', 'l/ella': 'habla', 'nosotros': 'hablamos', 'vosotros': 'hablis', 'ellos': 'hablan' },
                    'Preterite': { 'yo': 'habl', 't': 'hablaste', 'l/ella': 'habl', 'nosotros': 'hablamos', 'vosotros': 'hablasteis', 'ellos': 'hablaron' },
                    'Imperfect': { 'yo': 'hablaba', 't': 'hablabas', 'l/ella': 'hablaba', 'nosotros': 'hablbamos', 'vosotros': 'hablabais', 'ellos': 'hablaban' },
                    'Future': { 'yo': 'hablar', 't': 'hablars', 'l/ella': 'hablar', 'nosotros': 'hablaremos', 'vosotros': 'hablaris', 'ellos': 'hablarn' },
                    'Conditional': { 'yo': 'hablara', 't': 'hablaras', 'l/ella': 'hablara', 'nosotros': 'hablaramos', 'vosotros': 'hablarais', 'ellos': 'hablaran' },
                    'Subjunctive Present': { 'yo': 'hable', 't': 'hables', 'l/ella': 'hable', 'nosotros': 'hablemos', 'vosotros': 'hablis', 'ellos': 'hablen' },
                    'Subjunctive Imperfect': { 'yo': 'hablara', 't': 'hablaras', 'l/ella': 'hablara', 'nosotros': 'hablramos', 'vosotros': 'hablarais', 'ellos': 'hablaran' }
                }
            },
            { 
                infinitive: 'comer', 
                translation: 'to eat',
                rank: 60,
                participle: 'comido',
                gerund: 'comiendo',
                conjugations: {
                    'Present': { 'yo': 'como', 't': 'comes', 'l/ella': 'come', 'nosotros': 'comemos', 'vosotros': 'comis', 'ellos': 'comen' },
                    'Preterite': { 'yo': 'com', 't': 'comiste', 'l/ella': 'comi', 'nosotros': 'comimos', 'vosotros': 'comisteis', 'ellos': 'comieron' },
                    'Imperfect': { 'yo': 'coma', 't': 'comas', 'l/ella': 'coma', 'nosotros': 'comamos', 'vosotros': 'comais', 'ellos': 'coman' },
                     'Future': { 'yo': 'comer', 't': 'comers', 'l/ella': 'comer', 'nosotros': 'comeremos', 'vosotros': 'comeris', 'ellos': 'comern' },
                    'Conditional': { 'yo': 'comera', 't': 'comeras', 'l/ella': 'comera', 'nosotros': 'comeramos', 'vosotros': 'comerais', 'ellos': 'comeran' },
                    'Subjunctive Present': { 'yo': 'coma', 't': 'comas', 'l/ella': 'coma', 'nosotros': 'comamos', 'vosotros': 'comis', 'ellos': 'coman' },
                    'Subjunctive Imperfect': { 'yo': 'comiera', 't': 'comieras', 'l/ella': 'comiera', 'nosotros': 'comiramos', 'vosotros': 'comierais', 'ellos': 'comieran' }
                }
            },
            { 
                infinitive: 'vivir', 
                translation: 'to live',
                rank: 70,
                participle: 'vivido',
                gerund: 'viviendo',
                conjugations: {
                    'Present': { 'yo': 'vivo', 't': 'vives', 'l/ella': 'vive', 'nosotros': 'vivimos', 'vosotros': 'vivs', 'ellos': 'viven' },
                    'Preterite': { 'yo': 'viv', 't': 'viviste', 'l/ella': 'vivi', 'nosotros': 'vivimos', 'vosotros': 'vivisteis', 'ellos': 'vivieron' },
                    'Imperfect': { 'yo': 'viva', 't': 'vivas', 'l/ella': 'viva', 'nosotros': 'vivamos', 'vosotros': 'vivais', 'ellos': 'vivan' },
                    'Future': { 'yo': 'vivir', 't': 'vivirs', 'l/ella': 'vivir', 'nosotros': 'viviremos', 'vosotros': 'viviris', 'ellos': 'vivirn' },
                    'Conditional': { 'yo': 'vivira', 't': 'viviras', 'l/ella': 'vivira', 'nosotros': 'viviramos', 'vosotros': 'vivirais', 'ellos': 'viviran' },
                    'Subjunctive Present': { 'yo': 'viva', 't': 'vivas', 'l/ella': 'viva', 'nosotros': 'vivamos', 'vosotros': 'vivis', 'ellos': 'vivan' },
                    'Subjunctive Imperfect': { 'yo': 'viviera', 't': 'vivieras', 'l/ella': 'viviera', 'nosotros': 'viviramos', 'vosotros': 'vivierais', 'ellos': 'vivieran' }
                }
            }
        ];
        
        let VERB_DB = []; 
        let currentDrillVerb = null;
        let currentDrillCard = null; 
        let isCardRevealed = false;
        let verbSortMode = 'frequency';
        let verbTicketCart = []; // Current verbs selected for a ticket
        let savedVerbListScroll = 0; // Capture scroll position for smooth returns
        let savedSearchEntryScroll = 0; // NEW: Capture scroll before activating search bar
        let drillSourceView = 'selection'; // NEW: Track where drill was started from
        
        const ALL_SUBJECTS = ['yo', 't', 'l/ella', 'nosotros', 'vosotros', 'ellos'];
        const VERB_TICKETS_PATH = (uid) => `artifacts/${appId}/users/${uid}/verbTickets`;
        
        // TENSE SETTINGS HIERARCHY
        const TENSE_HIERARCHY = {
            'Indicative': ['Present', 'Preterite', 'Imperfect', 'Conditional', 'Future'],
            'Subjunctive': ['Subjunctive Present', 'Subjunctive Imperfect'],
            'Perfect': ['Present Perfect', 'Preterite Perfect', 'Imperfect Perfect', 'Conditional Perfect', 'Future Perfect'],
            'Progressive': ['Present Progressive', 'Preterite Progressive', 'Imperfect Progressive', 'Conditional Progressive', 'Future Progressive']
        };

        let enabledTenses = {}; 
        let enabledSubjects = {};

        // --- FLASHCARD STUDY STATE ---
        let currentStudySet = null;
        let currentStudyCards = [];
        let currentStudyIndex = 0;
        let isStudyCardFlipped = false;
        let studySessionStats = { known: 0, learning: 0, unknown: 0 };
        let studyHistory = []; // For undo functionality
        
        // --- Master Session Tracking ---
        let masterSessionCards = []; // Original copies of session cards
        let masterSessionStatus = []; // Latest rating per instance: 'good' | 'easy' | 'hard' | 'again' | null
        let lastSubsetCards = []; // Original cards for "Redo Previous"
        let isRecursiveSubset = false; // Tracking if we are in a sub-session
        let masterSessionID = null;
        let totalMasterStudyTime = 0; // ms
        let currentSessionStartTime = null; // ms for current subset
        let sessionRatingsLog = []; // [{ id: '...', rating: '...' }]
        let learningStack = []; // Cards marked as "learning"
        let studySettings = {
            shuffle: false,
            l1First: false,
            autoSpeak: false,
            showKeyboardHints: false
        };
        let currentHammerInstance = null; // Store Hammer instance for cleanup
        let hasPerformedAction = false; // Track if user has swiped/tapped at least once
        let isActionInProgress = false; // Spam protection for rating buttons/swipes

        // --- CEFR LEVEL SYSTEM ---
        window.getCEFRLevel = (totalWords) => {
            const levels = [
                { level: 'A1', threshold: 0, name: 'Absolute Beginner', description: 'Basic Communication', range: '0-500' },
                { level: 'A2', threshold: 500, name: 'Elementary', description: 'Basic Communication', range: '500-1500' },
                { level: 'B1', threshold: 1500, name: 'Intermediate', description: 'Everyday Conversations', range: '1500-2500' },
                { level: 'B2', threshold: 2500, name: 'Upper Intermediate', description: 'Complex Topics', range: '2500-5000' },
                { level: 'C1', threshold: 5000, name: 'Advanced', description: 'Professional Fluency', range: '5000-9500' },
                { level: 'C2', threshold: 9500, name: 'Mastery', description: 'Native-like Proficiency', range: '9500+' }
            ];

            // Find current level
            let currentLevel = levels[0];
            let nextLevel = null;

            for (let i = levels.length - 1; i >= 0; i--) {
                if (totalWords >= levels[i].threshold) {
                    currentLevel = levels[i];
                    nextLevel = levels[i + 1] || null;
                    break;
                }
            }

            // Calculate progress within current level
            const levelStart = currentLevel.threshold;
            const levelEnd = nextLevel ? nextLevel.threshold : 10000; // Cap at 10k for C2
            const levelProgress = Math.min(100, ((totalWords - levelStart) / (levelEnd - levelStart)) * 100);

            return {
                current: currentLevel,
                next: nextLevel,
                progress: levelProgress,
                totalWords: totalWords,
                wordsToNext: nextLevel ? nextLevel.threshold - totalWords : 0
            };
        };

        window.getCEFRIcon = (level) => {
            const icons = {
                'A1': '', // Seedling
                'A2': '', // Herb
                'B1': '', // Tree
                'B2': '', // Pine tree
                'C1': '', // Mountain
                'C2': ''  // Mountain peak
            };
            return icons[level] || '';
        };

        // --- SMART WORD SELECTION ---
        window.getNextWordsForStudy = async (count = 25) => {
            if (!userId || !db) return [];

            try {
                // Get all available cards (this could be optimized with pagination for large datasets)
                const cardsPath = 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/cards';
                const cardsRef = collection(db, cardsPath);
                const cardsSnapshot = await getDocs(cardsRef);

                // Get user's existing card progress
                const progressRef = collection(db, `artifacts/${appId}/users/${userId}/cardProgress`);
                const progressSnapshot = await getDocs(progressRef);

                // Build progress map
                const progressMap = {};
                progressSnapshot.docs.forEach(doc => {
                    progressMap[doc.id] = doc.data();
                });

                // Filter and sort cards by frequency and learning status
                const now = new Date();
                const availableCards = [];

                cardsSnapshot.docs.forEach(doc => {
                    const cardData = doc.data();
                    const progress = progressMap[doc.id];

                    // Skip if already mastered (good rating multiple times)
                    if (progress && progress.repetitions >= 3 && progress.lastRating === 'easy') {
                        return;
                    }

                    // Check if card is due for review
                    if (progress && progress.nextReview) {
                        const nextReviewDate = new Date(progress.nextReview);
                        if (nextReviewDate > now) {
                            return; // Not due yet
                        }
                    }

                    availableCards.push({
                        id: doc.id,
                        frequency: cardData.frequency || 999,
                        progress: progress,
                        data: cardData
                    });
                });

                // Sort by priority: due cards first, then by frequency rank
                availableCards.sort((a, b) => {
                    // Due reviews get highest priority
                    const aDue = a.progress && new Date(a.progress.nextReview) <= now;
                    const bDue = b.progress && new Date(b.progress.nextReview) <= now;

                    if (aDue && !bDue) return -1;
                    if (!aDue && bDue) return 1;

                    // Then by frequency (lower number = higher frequency = higher priority)
                    if (a.frequency !== b.frequency) {
                        return a.frequency - b.frequency;
                    }

                    // Finally by least recently studied
                    const aLastStudied = a.progress ? new Date(a.progress.lastReviewed) : new Date(0);
                    const bLastStudied = b.progress ? new Date(b.progress.lastReviewed) : new Date(0);
                    return aLastStudied - bLastStudied;
                });

                const selected = availableCards.slice(0, count);
                console.log(`Selected ${selected.length} cards for study:`, selected);
                return selected;
            } catch (error) {
                console.error('Error selecting next words:', error);
                return [];
            }
        };

        window.startLearningNewWords = async () => {
            const sessionTitle = "Learning New Words";
            
            // Immediately transition to skeleton
            document.getElementById('study-set-title').textContent = sessionTitle;
            document.getElementById('flashcards').classList.remove('active');
            document.getElementById('flashcard-study').classList.add('active');
            document.getElementById('study-loading').classList.remove('hidden');
            document.getElementById('study-card-container').classList.add('hidden');
            document.getElementById('study-complete').classList.add('hidden');

            try {
                const wordsToLearn = await getNextWordsForStudy(25);

                if (wordsToLearn.length === 0) {
                    showModal("All Caught Up!", "Congratulations! You've learned all available words. Check back later for new content.");
                    exitFlashcardStudy();
                    return;
                }

                await startFlashcardSession(wordsToLearn.map(w => w.id), sessionTitle);

            } catch (error) {
                console.error('Error starting daily words:', error);
                showModal("Error", "Failed to start learning session.");
                hideLoading();
            }
        };

        // --- FLASHCARD STUDY FUNCTIONS (COMPLETE IMPLEMENTATION) ---

        window.openFlashcardStudy = async (setID) => {
            // Clear results screen state
            document.getElementById('study-complete').classList.add('hidden');
            document.getElementById('study-card-container').classList.remove('hidden');

            // Find the set in flashcardData
            let foundSet = null;
            for (const level of flashcardData) {
                foundSet = level.sets.find(s => s.setID === setID);
                if (foundSet) break;
            }

            if (!foundSet) {
                showModal("Error", "Flashcard set not found.");
                return;
            }

            currentStudySet = foundSet;

            // NEW: Initialize Master Session
            masterSessionID = setID + '-' + Date.now();
            totalMasterStudyTime = 0;
            sessionRatingsLog = [];
            hasPerformedAction = false;
            learningStack = [];

            // Transition to study view
            document.getElementById('flashcards').classList.remove('active');
            document.getElementById('flashcard-study').classList.add('active');
            
            // Show loading
            document.getElementById('study-loading').classList.remove('hidden');
            document.getElementById('study-card-container').classList.add('hidden');
            document.getElementById('study-complete').classList.add('hidden');
            
            // Update title & progress immediately
            document.getElementById('study-set-title').textContent = foundSet.title;
            document.getElementById('study-progress-text').textContent = `0/${foundSet.cards?.length || 0}`;
            
            // Load cards from Firebase
            try {
                if (!foundSet.cards || foundSet.cards.length === 0) {
                    showModal("No Cards", "This set has no flashcards yet.");
                    exitFlashcardStudy();
                    return;
                }
                
                const cardsPath = 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/cards';
                const cardIDs = foundSet.cards;
                const fetchedCards = [];
                const cardsRef = collection(db, cardsPath);
                const CHUNK_SIZE = 30; // Firestore IN query limit

                const loadingArea = document.getElementById('study-loading');
                const skeletonBar = loadingArea.querySelector('.skeleton.h-2.rounded-full');
                if (skeletonBar) skeletonBar.style.width = '0%';
                
                for (let i = 0; i < cardIDs.length; i += CHUNK_SIZE) {
                    const batch = cardIDs.slice(i, i + CHUNK_SIZE);
                    const q = query(cardsRef, where(documentId(), "in", batch));
                    const chunkSnap = await getDocs(q);

                    chunkSnap.forEach(docSnap => {
                        const cardData = docSnap.data();
                        cardData.docId = docSnap.id;
                        fetchedCards.push(cardData);
                    });

                    // Update loading Feedback
                    const progress = Math.min(100, Math.round((fetchedCards.length / cardIDs.length) * 100));
                    if (skeletonBar) skeletonBar.style.width = `${progress}%`;
                }

                if (fetchedCards.length === 0) {
                    showModal("No Cards", "Could not load cards for this set.");
                    exitFlashcardStudy();
                    return;
                }

                // Map cards and apply settings
                currentStudyCards = fetchedCards.map((card, index) => ({
                    spanish: Array.isArray(card.termTarget) ? card.termTarget[0] : card.termTarget,
                    english: card.termSource,
                    id: card.docId, // Use the Firestore document ID for SRS updates
                    masterIndex: index, // CRITICAL: Position-based tracking for the stats report
                    isNew: !userCardProgress[card.docId], // Track if this is first encounter
                    pos: card.pos || [],
                    examples: card.examples || [],
                    dictionaryDefinition: card.dictionaryDefinition || { source: '', target: '' },
                    frequency: card.frequency || 0
                }));
                
                // Store master copies and initialize position-based status tracking
                masterSessionCards = [...currentStudyCards];
                masterSessionStatus = new Array(masterSessionCards.length).fill(null);
                
                startStudySubset();
                
            } catch (error) {
                console.error("Error loading flashcards:", error);
                showModal("Error", "Failed to load flashcards: " + error.message);
                exitFlashcardStudy();
            }
        };

        // NEW: Core Logic for starting/continuing card stack subsets
        window.startStudySubset = (subsetCards = null, isRedo = false) => {
            // Apply subsets if provided, otherwise assume master session initialization
            if (subsetCards) {
                currentStudyCards = [...subsetCards];
                isRecursiveSubset = !isRedo; // redo counts as recursive logic but resets the "redo" trigger
                lastSubsetCards = [...subsetCards];
            } else {
                // If initializing from master and shuffle is enabled
                if (studySettings.shuffle) {
                    currentStudyCards = [...masterSessionCards].sort(() => Math.random() - 0.5);
                } else {
                    currentStudyCards = [...masterSessionCards];
                }
                isRecursiveSubset = false;
                lastSubsetCards = [...currentStudyCards];
            }

            // Reset Subset States
            currentStudyIndex = 0;
            studySessionStats = { known: 0, learning: 0, unknown: 0 };
            studyHistory = [];
            currentSessionStartTime = Date.now();
            
            // Reset UI Visibility
            document.getElementById('study-loading').classList.add('hidden');
            document.getElementById('study-card-container').classList.remove('hidden');
            document.getElementById('study-complete').classList.add('hidden');
            
            updateStudyStats();
            updateStudyProgress();
            renderCardDeck();
            
            // Instructional cleanup
            hasPerformedAction = false;
        };

        window.handleRestartSession = (mode) => {
            if (mode === "all") {
                // Full restart - clears learning stack and log
                learningStack = [];
                sessionRatingsLog = [];
                masterSessionStatus = new Array(masterSessionCards.length).fill(null); // RESET instance tracking
                totalMasterStudyTime = 0; // Reset duration correctly
                startStudySubset();
            } else if (mode === "missed") {
                // Restart subset using only cards in learningStack
                const subset = [...learningStack];
                learningStack = []; // Clear for new subset collection
                startStudySubset(subset);
            } else if (mode === "redo") {
                // Repeat just the previous subset
                const subset = [...lastSubsetCards];
                learningStack = [];
                startStudySubset(subset, true);
            }
        };

        // Helper function to get POS pill color
        window.getPosColor = (pos) => {
            const posLower = pos.toLowerCase();
            if (posLower.includes('noun') || posLower.includes('sustantivo')) {
                return 'bg-yellow-100 text-yellow-800';
            }
            if (posLower.includes('verb') || posLower.includes('verbo')) {
                return 'bg-pink-100 text-pink-800';
            }
            if (posLower.includes('adjective') || posLower.includes('adjetivo')) {
                return 'bg-orange-100 text-orange-800';
            }
            if (posLower.includes('adverb') || posLower.includes('adverbio')) {
                return 'bg-purple-100 text-purple-800';
            }
            if (posLower.includes('preposition') || posLower.includes('preposicin')) {
                return 'bg-blue-100 text-blue-800';
            }
            // Default fallback for any unrecognized POS
            return 'bg-gray-100 text-gray-700';
        };

        // Helper function to render POS pills HTML
        window.renderPosPillsHTML = (posArray) => {
            if (!posArray || posArray.length === 0) return '';
            
            return posArray.map(pos => {
                const colorClass = getPosColor(pos);
                return `<span class="px-3 py-1 text-xs font-bold uppercase rounded-full ${colorClass}">${pos}</span>`;
            }).join('');
        };

        window.renderCardDeck = () => {
            const deck = document.getElementById('card-deck');
            if (!deck) return;

            // Ensure keyboard hints are consistent with settings
            updateKeyboardHintsVisibility();
            
            // Show completion screen if all done
            if (currentStudyIndex >= currentStudyCards.length) {
                showCompletionScreen();
                return;
            }
            
            // Clear and render immediately (no fade delay to prevent janky flashing)
            deck.innerHTML = '';
            renderNewCards();
            
            function renderNewCards() {
                // Render up to 3 cards (current + 2 background)
                const cardsToShow = Math.min(3, currentStudyCards.length - currentStudyIndex);
                
                for (let i = 0; i < cardsToShow; i++) {
                    const cardIndex = currentStudyIndex + i;
                    const card = currentStudyCards[cardIndex];
                    const isTopCard = i === 0;
                    
                    // Create card container with 3D perspective wrapper
                    const cardWrapper = document.createElement('div');
                    cardWrapper.className = `absolute inset-0 perspective-1000 ${isTopCard ? 'z-30' : 'z-' + (20 - i)}`;
                    cardWrapper.id = isTopCard ? 'top-card-wrapper' : `card-wrapper-${i}`;
                    
                    // Inner card with flip capability
                    const cardInner = document.createElement('div');
                    cardInner.className = 'relative w-full h-full preserve-3d transition-flip';
                    cardInner.id = isTopCard ? 'top-card-inner' : `card-inner-${i}`;
                    cardInner.style.transformStyle = 'preserve-3d';
                    // IMPORTANT: Start unflipped
                    cardInner.style.transform = 'rotateY(0deg)';
                    
                    // Card content
                    const showSpanish = !studySettings.l1First;
                    const frontText = showSpanish ? card.spanish : card.english;
                    const backText = showSpanish ? card.english : card.spanish;
                    
                    // Prepare card data based on language direction
                    const frontPos = showSpanish ? card.pos : card.pos;
                    const backPos = card.pos;
                    const frontExample = card.examples?.[0] ? (showSpanish ? card.examples[0].target : card.examples[0].source) : '';
                    const backExample = card.examples?.[0] ? (showSpanish ? card.examples[0].source : card.examples[0].target) : '';
                    const rankBadge = card.frequency > 0 ? `#${card.frequency}` : '';
                    
                    // Front face - Enhanced with POS, Examples, Rank
                    const frontFace = document.createElement('div');
                    frontFace.className = 'absolute inset-0 bg-white rounded-2xl shadow-2xl border-4 border-transparent flex flex-col p-6 backface-hidden study-card';
                    frontFace.id = `card-front-${i}`;
                    frontFace.innerHTML = `
                        <div class="absolute top-4 right-5">
                            <span class="text-xs font-bold text-slate-400">${rankBadge}</span>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center relative">
                            <div class="text-center mb-2">
                                <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 text-center leading-tight" style="font-size: clamp(1.5rem, 4vw, 3rem);">${frontText}</h2>
                            </div>
                            <div class="flex flex-wrap gap-2 justify-center mb-4 items-center">
                                ${renderPosPillsHTML(frontPos)}
                                <button onclick="event.stopPropagation(); openDictionary(${cardIndex}, false)" class="p-2 text-slate-300 hover:text-blue-500 transition-colors rounded-full hover:bg-slate-50">
                                    <i data-lucide="book-open" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        ${frontExample ? `<div class="mt-auto pt-4 border-t border-slate-100">
                            <p class="text-center text-sm sm:text-base text-slate-500 italic font-medium leading-relaxed">${frontExample}</p>
                        </div>` : ''}
                        <div class="text-center mt-2 text-xs text-gray-400 uppercase tracking-wider">
                            ${isTopCard && !hasPerformedAction ? 'Tap to flip' : ''}
                        </div>
                    `;
                    
                    // Back face - Enhanced with POS, Examples, Rank
                    const backFace = document.createElement('div');
                    backFace.className = 'absolute inset-0 bg-white rounded-2xl shadow-2xl border-4 border-transparent flex flex-col p-6 backface-hidden rotate-y-180 study-card';
                    backFace.id = `card-back-${i}`;
                    backFace.innerHTML = `
                        <div class="absolute top-4 right-5">
                            <span class="text-xs font-bold text-slate-400">${rankBadge}</span>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center relative">
                            <div class="text-center mb-2">
                                <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 text-center leading-tight" style="font-size: clamp(1.5rem, 4vw, 3rem);">${backText}</h2>
                            </div>
                            <div class="flex flex-wrap gap-2 justify-center mb-4 items-center">
                                ${renderPosPillsHTML(backPos)}
                                <button onclick="event.stopPropagation(); openDictionary(${cardIndex}, true)" class="p-2 text-slate-300 hover:text-blue-500 transition-colors rounded-full hover:bg-slate-50">
                                    <i data-lucide="book-open" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        ${backExample ? `<div class="mt-auto pt-4 border-t border-slate-100">
                            <p class="text-center text-sm sm:text-base text-slate-500 italic font-medium leading-relaxed">${backExample}</p>
                        </div>` : ''}
                        <div class="text-center mt-2 text-xs text-gray-400 uppercase tracking-wider">
                            ${isTopCard && !hasPerformedAction ? 'Tap to flip back' : ''}
                        </div>
                    `;
                    
                    cardInner.appendChild(frontFace);
                    cardInner.appendChild(backFace);
                    cardWrapper.appendChild(cardInner);
                    
                    // Set initial position for stacked effect
                    if (!isTopCard) {
                        cardWrapper.style.transform = `translateY(${i * 8}px) scale(${1 - i * 0.05})`;
                        cardWrapper.style.opacity = 0; // Hide background cards completely
                        cardWrapper.style.pointerEvents = 'none';
                    } else {
                        // Animate entrance for top card
                        cardWrapper.style.opacity = '0';
                        cardWrapper.style.transform = 'scale(0.8)';
                        
                        requestAnimationFrame(() => {
                            cardWrapper.classList.add('transition-appear');
                            cardWrapper.style.opacity = '1';
                            cardWrapper.style.transform = 'scale(1)';
                        });
                    }
                    
                    deck.appendChild(cardWrapper);
                }
                
                // RE-INITIALIZE GESTURES after rendering new cards
                setTimeout(() => {
                    initializeGestures();
                }, 100);
                
                if (window.lucide) lucide.createIcons();
            }
        };

        window.flipTopCard = () => {
            // Cut off previous side's audio when flipping
            window.speechSynthesis.cancel();

            const cardInner = document.getElementById('top-card-inner');
            if (!cardInner) return;
            
            // Toggle flip state
            isStudyCardFlipped = !isStudyCardFlipped;
            
            // Apply 3D rotation
            if (isStudyCardFlipped) {
                cardInner.style.transform = 'rotateY(180deg)';
                
                // Auto-speak if enabled (now speaks only the term, not UI text)
                if (studySettings.autoSpeak) {
                    setTimeout(() => {
                        speakCurrentFlashcard();
                    }, 250); // Wait for flip animation
                }
            } else {
                cardInner.style.transform = 'rotateY(0deg)';
            }
        };

        window.updateKeyboardHintsVisibility = () => {
            const hints = document.querySelectorAll('.kbd-hint');
            hints.forEach(hint => {
                if (studySettings.showKeyboardHints) {
                    hint.classList.remove('hidden');
                } else {
                    hint.classList.add('hidden');
                }
            });
        };

        window.toggleStudyGuide = (id) => {
            const content = document.getElementById(`content-guide-${id}`);
            const icon = document.getElementById(`icon-guide-${id}`);
            const isOpen = content.classList.contains('open');

            if (isOpen) {
                content.style.maxHeight = content.scrollHeight + "px";
                content.offsetHeight;
                content.style.maxHeight = null;
                content.classList.remove('open');
                icon.classList.remove('rotate-180');
            } else {
                // Close other guide if open
                const otherId = id === 'srs' ? 'method' : 'srs';
                const otherContent = document.getElementById(`content-guide-${otherId}`);
                if (otherContent && otherContent.classList.contains('open')) {
                    toggleStudyGuide(otherId);
                }

                content.classList.add('open');
                icon.classList.add('rotate-180');
                content.style.maxHeight = content.scrollHeight + "px";
                setTimeout(() => {
                    if (content.classList.contains('open')) {
                        content.style.maxHeight = 'none';
                    }
                }, 500);
            }
        };

        window.closeDictionary = () => {
            const modal = document.getElementById('dictionary-modal');
            const content = document.getElementById('dictionary-modal-content');
            
            modal.classList.remove('animate-fade-in');
            modal.classList.add('animate-fade-out');
            
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            
            // Wait for animation to finish before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('animate-fade-out');
            }, 250);
        };

        window.initializeGestures = () => {
            const topCardWrapper = document.getElementById('top-card-wrapper');
            if (!topCardWrapper || !window.Hammer) return;
            
            // CRITICAL: Destroy previous Hammer instance to prevent multiple listeners
            if (currentHammerInstance) {
                currentHammerInstance.destroy();
                currentHammerInstance = null;
            }
            
            currentHammerInstance = new Hammer(topCardWrapper);
            currentHammerInstance.get('pan').set({ direction: Hammer.DIRECTION_ALL, threshold: 0 });
            currentHammerInstance.get('tap').set({ enable: true, time: 250, threshold: 5 });
            
            let dragStarted = false;
            let maxDragDistance = 0;
            const SWIPE_THRESHOLD = 120; // Reduced for easier mobile swiping
            
            // Remove transitions when dragging starts
            currentHammerInstance.on('panstart', () => {
                dragStarted = false;
                maxDragDistance = 0;
                topCardWrapper.classList.remove('transition-transform-smooth', 'transition-appear');
                topCardWrapper.style.transition = 'none';
            });
            
            // Update position, rotation, and visual feedback during drag
            currentHammerInstance.on('panmove', (ev) => {
                const x = ev.deltaX;
                const y = ev.deltaY;
                const distance = Math.sqrt(x * x + y * y);
                
                // Track if user has dragged significantly
                if (distance > 15) {
                    dragStarted = true;
                }
                
                // Track maximum drag distance
                maxDragDistance = Math.max(maxDragDistance, Math.abs(x));
                
                const rotation = x / 20;
                
                // Progressive opacity: starts at 1.0, fades to 0.4 (60% transparent) at swipe threshold
                const opacityProgress = Math.min(Math.abs(x) / SWIPE_THRESHOLD, 1.0);
                const opacity = 1.0 - (opacityProgress * 0.6); // Fade from 100% to 40%
                
                // Update card position and appearance
                topCardWrapper.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg)`;
                topCardWrapper.style.opacity = opacity;
                
                // Progressive border color and width
                const cardFaces = topCardWrapper.querySelectorAll('.study-card');
                cardFaces.forEach(cardFace => {
                    if (Math.abs(x) < 30) {
                        // Dead zone - no border
                        cardFace.style.borderColor = 'transparent';
                        cardFace.style.borderWidth = '4px';
                    } else {
                        // Progressive border intensity
                        const borderProgress = Math.min((Math.abs(x) - 30) / (SWIPE_THRESHOLD - 30), 1.0);
                        const borderWidth = 4 + (borderProgress * 4); // Grows from 4px to 8px
                        
                        if (x < 0) {
                            // Swiping left - Red border (unknown)
                            const alpha = 0.3 + (borderProgress * 0.7); // Fade from 30% to 100%
                            cardFace.style.borderColor = `rgba(239, 68, 68, ${alpha})`;
                        } else {
                            // Swiping right - Green border (known)
                            const alpha = 0.3 + (borderProgress * 0.7);
                            cardFace.style.borderColor = `rgba(16, 185, 129, ${alpha})`;
                        }
                        cardFace.style.borderWidth = `${borderWidth}px`;
                    }
                });
                
                // Animate buttons based on drag direction
                updateButtonScales(x);
            });
            
            // Complete or cancel swipe when drag ends
            currentHammerInstance.on('panend', (ev) => {
                const x = ev.deltaX;
                console.log('Swipe detected, deltaX:', x, 'threshold:', SWIPE_THRESHOLD);

                if (x > SWIPE_THRESHOLD) {
                    // Swiped right far enough - Known (easy rating for SRS)
                    console.log('Right swipe detected - calling handleCardAction(easy)');
                    handleCardAction('easy');
                } else if (x < -SWIPE_THRESHOLD) {
                    // Swiped left far enough - Unknown (again rating for SRS)
                    console.log('Left swipe detected - calling handleCardAction(again)');
                    handleCardAction('again');
                } else {
                    // Didn't swipe far enough - reset card WITHOUT FLIPPING
                    topCardWrapper.classList.add('transition-transform-smooth');
                    topCardWrapper.style.transform = '';
                    topCardWrapper.style.opacity = '1';
                    
                    const cardFaces = topCardWrapper.querySelectorAll('.study-card');
                    cardFaces.forEach(cardFace => {
                        cardFace.style.borderColor = 'transparent';
                        cardFace.style.borderWidth = '4px';
                    });
                    
                    updateButtonScales(0);
                    
                    // CRITICAL FIX: Reset dragStarted so tap works again
                    dragStarted = false;
                    maxDragDistance = 0;
                }
            });
            
            // Tap to flip - ONLY if card is stationary (no significant drag)
            currentHammerInstance.on('tap', (ev) => {
                // Only flip if user did NOT drag the card AND max distance is minimal
                if (!dragStarted && maxDragDistance < 10) {
                    // Check if tapped on a button - if so, don't flip
                    const target = ev.target;
                    if (target && target.closest('button')) {
                        return;
                    }
                    flipTopCard();
                }
            });
        };

        // Helper function to animate buttons during swipe
        window.updateButtonScales = (x) => {
            const knownBtn = document.querySelector('#study-card-container button[onclick*="known"]');
            const unknownBtn = document.querySelector('#study-card-container button[onclick*="unknown"]');
            
            if (!knownBtn || !unknownBtn) return;
            
            if (x === 0) {
                // Reset buttons
                knownBtn.style.transform = 'scale(1)';
                knownBtn.style.backgroundColor = '';
                unknownBtn.style.transform = 'scale(1)';
                unknownBtn.style.backgroundColor = '';
                return;
            }
            
            const progress = Math.min(Math.abs(x) / 150, 1.0);
            
            if (x > 0) {
                // Swiping right - animate known button
                knownBtn.style.transform = `scale(${1 + progress * 0.3})`;
                knownBtn.style.backgroundColor = `rgba(34, 197, 94, ${progress * 0.2})`;
                unknownBtn.style.transform = 'scale(1)';
                unknownBtn.style.backgroundColor = '';
            } else {
                // Swiping left - animate unknown button
                unknownBtn.style.transform = `scale(${1 + progress * 0.3})`;
                unknownBtn.style.backgroundColor = `rgba(239, 68, 68, ${progress * 0.2})`;
                knownBtn.style.transform = 'scale(1)';
                knownBtn.style.backgroundColor = '';
            }
        };

        // Spaced Repetition Algorithm (Anki-inspired)
        window.calculateNextReview = (cardProgress, rating) => {
            // Check if card was newly learned this session
            const isFirstEncounter = !cardProgress || cardProgress.timesReviewed === 0;

            // Initialize default values for new cards or handle missing data
            let easeFactor = 2.1; // Default starting ease factor
            let interval = 1; // Default interval
            let repetitions = 0; // Default repetitions

            // If card exists, use its current values (with fallbacks)
            if (cardProgress) {
                easeFactor = isNaN(cardProgress.easeFactor) ? 2.1 : cardProgress.easeFactor;
                interval = cardProgress.interval || 1;
                repetitions = cardProgress.repetitions || 0;
            }

            // Calculate new values based on rating
            if (isFirstEncounter) {
                // New card intervals
                interval = rating === 'again' ? 0 : // Immediate review
                         rating === 'hard' ? 1 : // 1 day
                         rating === 'good' ? 3 : // 3 days
                         7; // Easy: 7 days
                repetitions = rating === 'again' ? 0 : 1;
            } else {
                // Existing card - update based on performance
                switch (rating) {
                    case 'again':
                        easeFactor = Math.max(1.3, easeFactor - 0.2);
                        repetitions = 0;
                        interval = 0; // Immediate review
                        break;
                    case 'hard':
                        easeFactor = Math.max(1.3, easeFactor - 0.15);
                        repetitions = 0;
                        interval = Math.max(1, Math.round(interval * 0.5)); // Half interval
                        break;
                    case 'good':
                        repetitions++;
                        interval = repetitions === 1 ? 3 :
                                  repetitions === 2 ? 7 :
                                  Math.round(interval * easeFactor);
                        break;
                    case 'easy':
                        easeFactor = Math.min(2.5, easeFactor + 0.15);
                        repetitions++;
                        interval = Math.round(interval * easeFactor * 1.3); // Longer for easy
                        break;
                }
            }

            return {
                easeFactor: easeFactor,
                interval: Math.max(1, interval), // At least 1 day
                repetitions: repetitions,
                nextReview: new Date(Date.now() + interval * 24 * 60 * 60 * 1000).toISOString()
            };
        };

        // Save individual card progress to Firebase
        window.saveCardProgress = async (cardId, rating) => {
            if (!userId || !db) return;
            
            const card = currentStudyCards.find(c => c.id === cardId);

            try {
                const cardProgressRef = doc(db, `artifacts/${appId}/users/${userId}/cardProgress`, cardId);
                const existingDoc = await getDoc(cardProgressRef);
                const existingData = existingDoc.exists() ? existingDoc.data() : null;

                const newData = calculateNextReview(existingData, rating);
                const now = new Date().toISOString();

                await setDoc(cardProgressRef, {
                    userId,
                    cardId,
                    lastRating: rating,
                    lastReviewed: now,
                    timesReviewed: (existingData?.timesReviewed || 0) + 1,
                    timesCorrect: (existingData?.timesCorrect || 0) + (rating !== 'again' ? 1 : 0),
                    timesIncorrect: (existingData?.timesIncorrect || 0) + (rating === 'again' ? 1 : 0),
                    ...newData
                }, { merge: true });

                // If this was a new card learned today (first review Ever), update local count for the ring
                if ((!existingData || (existingData.timesReviewed || 0) === 0) && rating !== 'again') {
                    todayWordsLearned++;
                    
                    if (todayWordsLearned === dailyVocabGoal) {
                        triggerConfetti();
                        showModal("Daily Goal Met! ", "You've learned your 25 new words for today. The Vocab Ring is closed!");
                    }
                }
                
                updateFlashcardDashboard(); // Refresh ring instantly

                console.log(`Card ${cardId} progress saved:`, newData);
            } catch (error) {
                console.error('Failed to save card progress:', error);
            }
        };

        window.handleCardAction = (rating) => {
            // Cut off pending audio immediately when rating/swiping
            window.speechSynthesis.cancel();

            // Spam protection: Ignore if we are currently animating to the next card
            if (isActionInProgress) return;

            const card = currentStudyCards[currentStudyIndex];
            const topCardWrapper = document.getElementById('top-card-wrapper');

            if (!topCardWrapper || !card) return;

            // Set lockout flag
            isActionInProgress = true;

            // TRACKING: Update specific instance status for current session report
            if (card.masterIndex !== undefined) {
                masterSessionStatus[card.masterIndex] = rating;
            }

            // SRS: Update global database progress using card ID
            saveCardProgress(card.id, rating);

            // LOG: Legacy entry for auditing or extra metrics
            sessionRatingsLog.push({ id: card.id, rating: rating });

            // Track that user has performed at least one action
            hasPerformedAction = true;

            // Save to history for undo
            studyHistory.push({
                index: currentStudyIndex,
                rating: rating,
                stats: { ...studySessionStats }
            });

            // Add to learning stack if not known
            if (rating === 'again' || rating === 'hard') {
                // Prevent duplicate IDs in stack
                if (!learningStack.find(c => c.id === card.id)) {
                    learningStack.push(card);
                }
            }

            // Determine animation direction based on rating
            let direction, endX, rotation;
            switch (rating) {
                case 'again':
                    direction = -1;
                    endX = -window.innerWidth * 1.2;
                    rotation = -30;
                    break;
                case 'hard':
                    direction = -0.5;
                    endX = -window.innerWidth * 0.8;
                    rotation = -15;
                    break;
                case 'good':
                    direction = 0.5;
                    endX = window.innerWidth * 0.8;
                    rotation = 15;
                    break;
                case 'easy':
                    direction = 1;
                    endX = window.innerWidth * 1.2;
                    rotation = 30;
                    break;
            }

            // Animate card exit
            topCardWrapper.classList.remove('transition-appear');
            topCardWrapper.classList.add('transition-transform-smooth');
            topCardWrapper.style.transform = `translateX(${endX}px) translateY(50px) rotate(${rotation}deg)`;
            topCardWrapper.style.opacity = '0';

            // Update stats based on rating
            switch (rating) {
                case "again":
                case "hard":
                    studySessionStats.unknown++;
                    break;
                case "good":
                case "easy":
                    studySessionStats.known++;
                    break;
            }

            // Enable undo button
            document.getElementById('undo-btn').disabled = false;

            // Update display
            updateStudyStats();

            // Move to next card after animation
            setTimeout(() => {
                currentStudyIndex++;
                isStudyCardFlipped = false; // Reset flip state
                renderCardDeck();
                updateStudyProgress();

                // Reset lockout flag after new card is ready
                isActionInProgress = false;

                // Auto-speak new card if enabled
                if (studySettings.autoSpeak) {
                    setTimeout(() => {
                        speakCurrentFlashcard();
                    }, 100); // Short delay for render to complete
                    // Note: lockout remains false as speech is non-blocking
                }
            }, 350);
        };

        window.undoLastAction = () => {
            if (studyHistory.length === 0) return;
            
            const lastAction = studyHistory.pop();

            // Reset flip state to Side A
            isStudyCardFlipped = false;
            
            // Restore state
            currentStudyIndex = lastAction.index;
            studySessionStats = { ...lastAction.stats };
            
            // Remove from learning stack if applicable
            if (lastAction.action === 'learning' && learningStack.length > 0) {
                learningStack.pop();
            }
            
            // Disable undo if no more history
            if (studyHistory.length === 0) {
                document.getElementById('undo-btn').disabled = true;
            }
            
            // Re-render
            renderCardDeck();
            updateStudyStats();
            updateStudyProgress();
        };

        window.updateStudyProgress = () => {
            const total = currentStudyCards.length;
            const current = currentStudyIndex;
            const pct = total > 0 ? (current / total) * 100 : 0;
            
            document.getElementById('study-progress-text').textContent = `${current}/${total}`;
            document.getElementById('study-progress-bar').style.width = pct + '%';
        };

        window.updateStudyStats = () => {
            document.getElementById("known-count").textContent = studySessionStats.known;
            document.getElementById("unknown-count").textContent = studySessionStats.unknown;
        };

        window.showCompletionScreen = (mode = "complete") => {
            document.getElementById("study-card-container").classList.add("hidden");
            const completeEl = document.getElementById("study-complete");
            completeEl.classList.remove("hidden");

            // 1. Update Mode UI & Button Visibility
            const emoji = document.getElementById("res-emoji");
            const title = document.getElementById("res-title");
            const subtitle = document.getElementById("res-subtitle");

            const resumeBtn = document.getElementById("btn-resume-study");
            const redoBtn = document.getElementById("btn-redo-subset");
            const missedBtn = document.getElementById("btn-review-missed");

            // Reset buttons
            resumeBtn.classList.add("hidden");
            redoBtn.classList.add("hidden");
            missedBtn.classList.add("hidden");

            if (mode === "exit") {
                emoji.textContent = "";
                title.textContent = "Session Paused";
                subtitle.textContent = "Keep up the momentum!";
                resumeBtn.classList.remove("hidden");
            } else {
                emoji.textContent = "";
                title.textContent = "Buen Trabajo!";
                subtitle.textContent = "Session path complete";
                if (typeof triggerConfetti === "function") triggerConfetti();

                // Logic for recursive results
                if (learningStack.length > 0) {
                    missedBtn.classList.remove("hidden");
                    document.getElementById("res-count-missed").textContent = `${learningStack.length} cards`;
                } else if (isRecursiveSubset) {
                    // Just finished a subset and got them all right
                    redoBtn.classList.remove("hidden");
                    document.getElementById("res-count-redo").textContent = `${lastSubsetCards.length} cards`;
                }
            }

            // 2. Update Metrics
            const sessionDurationMs = Date.now() - currentSessionStartTime;
            totalMasterStudyTime += sessionDurationMs;

            const minutes = Math.floor(totalMasterStudyTime / 60000);
            const seconds = Math.floor((totalMasterStudyTime % 60000) / 1000);
            document.getElementById("res-duration").textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;

            // Calculate Average Time
            const totalSwipes = sessionRatingsLog.length;
            const avgTime = totalSwipes > 0 ? (totalMasterStudyTime / 1000 / totalSwipes).toFixed(1) : "0.0";
            document.getElementById("res-avg-time").textContent = `${avgTime}s`;

            // STATS CALCULATION: Position-Based Unique Tracking
            // This ensures math always equals master deck size (e.g. 21)
            const masteredCount = masterSessionStatus.filter(r => r === "good" || r === "easy").length;
            const learningCount = masterSessionStatus.filter(r => r === "again" || r === "hard").length;

            document.getElementById("res-mastered").textContent = masteredCount;
            document.getElementById("res-learning").textContent = learningCount;

            // 3. Master Count Update
            document.getElementById("res-count-all").textContent = `${masterSessionCards.length} cards`;

            // 4. Decorations
            const header = document.getElementById("session-header");
            header.style.transform = "scale(1)";

            // Save progress to Firebase if completed
            if (mode === "complete") {
                saveStudyProgress();
            }
        };

        window.resumeStudy = () => {
            document.getElementById("study-complete").classList.add("hidden");
            document.getElementById("study-card-container").classList.remove("hidden");
            // Important: restart the timer for this subset path
            currentSessionStartTime = Date.now();
        };

        window.reviewLearningStack = () => {
            // Reset for review session
            currentStudyCards = [...learningStack];
            learningStack = [];
            currentStudyIndex = 0;
            studySessionStats = { known: 0, learning: 0, unknown: 0 };
            studyHistory = [];
            
            // Return to study view
            document.getElementById('study-complete').classList.add('hidden');
            document.getElementById('study-card-container').classList.remove('hidden');
            
            renderCardDeck();
            updateStudyProgress();
        };

        window.saveStudyProgress = async () => {
            if (!userId || !currentStudySet || !currentStudySet.setID) return;
            
            try {
                const docRef = getDeckDocRef(currentStudySet.setID);
                const timestamp = new Date().toISOString();
                
                await setDoc(docRef, {
                    status: 'complete',
                    completedAt: timestamp,
                    userId: userId,
                    stats: studySessionStats,
                    lastStudied: timestamp
                }, { merge: true });
                
                console.log("Study progress saved successfully");
            } catch (error) {
                console.error("Failed to save study progress:", error);
            }
        };

        window.openDictionary = (cardIndex, isFlipped) => {
            const card = currentStudyCards[cardIndex];
            if (!card) return;
            
            const showSpanish = !studySettings.l1First;
            
            // Determine which definition to show based on card state and language setting
            let term, definition;
            
            if (isFlipped) {
                // Back side is showing
                if (showSpanish) {
                    // Back shows English (translation)
                    term = card.english;
                    definition = card.dictionaryDefinition?.source || '<p>No definition available.</p>';
                } else {
                    // Back shows Spanish (when l1First is enabled)
                    term = card.spanish;
                    definition = card.dictionaryDefinition?.target || '<p>No definition available.</p>';
                }
            } else {
                // Front side is showing
                if (showSpanish) {
                    // Front shows Spanish (main term)
                    term = card.spanish;
                    definition = card.dictionaryDefinition?.target || '<p>No definition available.</p>';
                } else {
                    // Front shows English (when l1First is enabled)
                    term = card.english;
                    definition = card.dictionaryDefinition?.source || '<p>No definition available.</p>';
                }
            }
            
            const modal = document.getElementById('dictionary-modal');
            const content = document.getElementById('dictionary-modal-content');
            
            modal.classList.remove('hidden');
            modal.classList.remove('animate-fade-out');
            modal.classList.add('animate-fade-in');
            
            content.classList.remove('animate-slide-down');
            content.classList.add('animate-slide-up');
            
            document.getElementById('dictionary-content').innerHTML = `
                <h3 class="text-2xl font-bold text-navy-900 mb-4">${term}</h3>
                <div class="text-gray-700 leading-relaxed">${definition}</div>
            `;
            if (window.lucide) lucide.createIcons();
        };

        window.closeDictionary = () => {
            const modal = document.getElementById('dictionary-modal');
            const content = document.getElementById('dictionary-modal-content');
            
            modal.classList.remove('animate-fade-in');
            modal.classList.add('animate-fade-out');
            
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            
            // Wait for animation to finish before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('animate-fade-out');
            }, 250);
        };

        window.handleDictionaryBackdropClick = (event) => {
            // Only close if the backdrop itself was clicked, not its children
            if (event.target.id === 'dictionary-modal') {
                closeDictionary();
            }
        };

        window.toggleStudySettings = () => {
            const modal = document.getElementById('study-settings-modal');
            const content = document.getElementById('study-settings-modal-content');
            const isHiding = !modal.classList.contains('hidden');
            
            if (!isHiding) {
                // Ensure accordions are closed when opening
                ['srs', 'method'].forEach(id => {
                    const c = document.getElementById(`content-guide-${id}`);
                    const i = document.getElementById(`icon-guide-${id}`);
                    if (c && i) {
                        c.classList.remove('open');
                        c.style.maxHeight = null;
                        i.classList.remove('rotate-180');
                    }
                });
            }

            if (isHiding) {
                // Dimissal Animation
                modal.classList.remove('animate-fade-in');
                modal.classList.add('animate-fade-out');
                content.classList.remove('animate-slide-up');
                content.classList.add('animate-slide-down');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('animate-fade-out');
                }, 250);
            } else {
                // Opening Animation
                // Load current settings BEFORE showing to avoid flickery toggles
                document.getElementById('setting-shuffle').checked = studySettings.shuffle;
                document.getElementById('setting-l1-first').checked = studySettings.l1First;
                document.getElementById('setting-auto-speak').checked = studySettings.autoSpeak;
                
                const hintToggle = document.getElementById('setting-show-hints');
                if (hintToggle) {
                    hintToggle.checked = studySettings.showKeyboardHints;
                }

                modal.classList.remove('hidden');
                modal.classList.remove('animate-fade-out');
                modal.classList.add('animate-fade-in');
                
                content.classList.remove('animate-slide-down');
                content.classList.add('animate-slide-up');
            }
        };

        window.handleSettingsBackdropClick = (event) => {
            if (event.target.id === 'study-settings-modal') {
                toggleStudySettings();
            }
        };

        window.applyStudySettings = async () => {
            studySettings.shuffle = document.getElementById('setting-shuffle').checked;
            studySettings.l1First = document.getElementById('setting-l1-first').checked;
            studySettings.autoSpeak = document.getElementById('setting-auto-speak').checked;
            
            const hintToggle = document.getElementById('setting-show-hints');
            if (hintToggle) {
                studySettings.showKeyboardHints = hintToggle.checked;
            }
            
            updateKeyboardHintsVisibility();

            // Persist to Firebase if logged in
            if (userId) {
                try {
                    const fRef = getFlashcardSettingsRef();
                    await setDoc(fRef, {
                        ...studySettings,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                } catch (e) {
                    console.error("Failed to persist flashcard settings:", e);
                }
            }
        };

        window.exitFlashcardStudy = () => {
            // INTERCEPT EXIT: If they clicked back while session is active (regardless of swipes)
            const isShowingStats = !document.getElementById("study-complete").classList.contains("hidden");
            const studyActive = document.getElementById("flashcard-study").classList.contains("active");

            if (studyActive && !isShowingStats) {
                showCompletionScreen("exit");
                return;
            }

            // Otherwise, perform actual exit
            forceExitStudy();
        };

        window.forceExitStudy = () => {
            document.getElementById("flashcard-study").classList.remove("active");
            document.getElementById("flashcards").classList.add("active");

            // Reset state
            currentStudySet = null;
            currentStudyCards = [];
            currentStudyIndex = 0;
            isStudyCardFlipped = false;
            studySessionStats = { known: 0, learning: 0, unknown: 0 };
            studyHistory = [];
            learningStack = [];
            hasPerformedAction = false;
            sessionRatingsLog = [];
            totalMasterStudyTime = 0;
        };

        // Speak current flashcard - speaks only the visible side
        window.speakCurrentFlashcard = () => {
            if (currentStudyIndex >= currentStudyCards.length) return;

            // Always cancel pending audio before starting new playback
            window.speechSynthesis.cancel();

            const card = currentStudyCards[currentStudyIndex];
            const showSpanish = !studySettings.l1First;
            const isFlipped = isStudyCardFlipped;

            // Determine which text to speak based on flip state and language setting
            let textToSpeak, langToUse;

            if (isFlipped) {
                // Back side is showing
                if (showSpanish) {
                    // Back shows English when l1First is false
                    textToSpeak = card.english;
                    langToUse = 'en-US';
                } else {
                    // Back shows Spanish when l1First is true
                    textToSpeak = card.spanish;
                    langToUse = 'es-ES';
                }
            } else {
                // Front side is showing
                if (showSpanish) {
                    // Front shows Spanish when l1First is false
                    textToSpeak = card.spanish;
                    langToUse = 'es-ES';
                } else {
                    // Front shows English when l1First is true
                    textToSpeak = card.english;
                    langToUse = 'en-US';
                }
            }

            // Remove text in parentheses before speaking
            textToSpeak = textToSpeak.replace(/\([^)]*\)/g, '').trim();

            // Speak only the visible term
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = langToUse;
            utterance.rate = 0.8; // Slightly slower for clarity

            // Force voice selection for desktop to fix accent issues
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                // Find a voice that matches the language tag
                const bestVoice = voices.find(v => v.lang.startsWith(langToUse.split('-')[0])) || voices[0];
                utterance.voice = bestVoice;
            }

            window.speechSynthesis.speak(utterance);
        };

        window.speakText = (text) => {
            if (!text) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                const esVoice = voices.find(v => v.lang.startsWith('es')) || voices[0];
                utterance.voice = esVoice;
            }
            
            window.speechSynthesis.speak(utterance);
        };


        // --- DUMMY LESSON DATA ---
        const DUMMY_LESSONS = [
            {
                id: 'L-A1-1',
                level: 'A1',
                title: 'Hola y Adis',
                description: 'Master the essential Spanish greetings and farewells.',
                videoId: 'dQw4w9WgXcQ', // Placeholder ID
                thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
                content: `
                    <h3 class="text-xl font-bold text-navy-900 mb-4">Introduction to Greetings</h3>
                    <p class="mb-4">In Spanish, greetings change depending on the time of day and who you are speaking to.</p>
                    <ul class="list-disc pl-5 space-y-2 mb-4">
                        <li><strong>Hola</strong> - Hello (Universal)</li>
                        <li><strong>Buenos das</strong> - Good morning (Until noon)</li>
                        <li><strong>Buenas tardes</strong> - Good afternoon (Until sunset)</li>
                        <li><strong>Buenas noches</strong> - Good evening/night</li>
                    </ul>
                    <p>Practice saying these out loud with the video above!</p>
                `
            },
            {
                id: 'L-A1-2',
                level: 'A1',
                title: 'Ser vs Estar',
                description: 'The eternal struggle: learning when to use which verb for "to be".',
                videoId: 'dQw4w9WgXcQ', 
                thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
                content: '<p>Content for Ser vs Estar...</p>'
            },
            {
                id: 'L-A2-1',
                level: 'A2',
                title: 'Past Tense Basics',
                description: 'Introduction to the Preterite tense for completed actions.',
                videoId: 'dQw4w9WgXcQ',
                thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
                content: '<p>Content for Past Tense...</p>'
            }
        ];


        // --- FLASHCARD HIERARCHY DATA STRUCTURE ---
        const INITIAL_FLASHCARD_SEED_DATA = [
            {
                id: 'A1',
                title: 'Level A1: Absolute Beginner',
                description: 'Start here. The foundational vocabulary for survival.',
                units: [
                    {
                        id: 'A1-U1',
                        title: 'Unit 1: The Basics',
                        reviewUrl: 'https://quizlet.com/latest', // Placeholder
                        sets: [
                            { id: 'A1-U1-S1', name: 'Set 1: Greetings & Introductions', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S2', name: 'Set 2: Numbers 1-20', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S3', name: 'Set 3: Common Objects', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S4', name: 'Set 4: Colors', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S5', name: 'Set 5: Family Members', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S6', name: 'Set 6: Days of the Week', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S7', name: 'Set 7: Basic Verbs', url: 'https://quizlet.com/latest', cardCount: 32 }
                        ]
                    },
                    {
                        id: 'A1-U2',
                        title: 'Unit 2: Daily Life',
                        reviewUrl: 'https://quizlet.com/latest',
                        sets: [
                            { id: 'A1-U2-S1', name: 'Set 1: Food & Drink', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S2', name: 'Set 2: Time', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S3', name: 'Set 3: Daily Routine', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S4', name: 'Set 4: House & Home', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S5', name: 'Set 5: Clothes', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S6', name: 'Set 6: Weather', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S7', name: 'Set 7: Emotions', url: 'https://quizlet.com/latest', cardCount: 32 }
                        ]
                    }
                ]
            },
            {
                id: 'A2',
                title: 'Level A2: Elementary',
                description: 'Expanding your world. Describing past events and future plans.',
                units: [
                    {
                        id: 'A2-U1',
                        title: 'Unit 1: Travel & Places',
                        reviewUrl: 'https://quizlet.com/latest',
                        sets: [
                            { id: 'A2-U1-S1', name: 'Set 1: At the Airport', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S2', name: 'Set 2: Directions', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S3', name: 'Set 3: Hotels', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S4', name: 'Set 4: City Buildings', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S5', name: 'Set 5: Transport', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S6', name: 'Set 6: Nature', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S7', name: 'Set 7: Countries', url: 'https://quizlet.com/latest', cardCount: 32 }
                        ]
                    }
                ]
            },
            {
                id: 'B1',
                title: 'Level B1: Intermediate',
                description: 'Dealing with most situations while travelling.',
                units: [
                    {
                        id: 'B1-U1',
                        title: 'Unit 1: Opinions & Culture',
                        reviewUrl: 'https://quizlet.com/latest',
                        sets: [
                             { id: 'B1-U1-S1', name: 'Set 1: Abstract Nouns', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S2', name: 'Set 2: Politics', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S3', name: 'Set 3: Art', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S4', name: 'Set 4: Media', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S5', name: 'Set 5: Technology', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S6', name: 'Set 6: Work', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S7', name: 'Set 7: Education', url: 'https://quizlet.com/latest', cardCount: 32 }
                        ]
                    }
                ]
            }
        ];


        // --- UTILITIES & UI HELPERS ---
        const $ = selector => document.querySelector(selector);
        
        const showLoading = (message = "Connecting...") => {
            $('#loading-overlay').querySelector('p').textContent = message;
            $('#loading-overlay').style.display = 'flex';
        }
        const hideLoading = () => $('#loading-overlay').style.display = 'none';

        window.showModal = (title, message) => {
            const modal = document.getElementById('message-modal');
            const content = document.getElementById('message-modal-content');
            
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message.replace(/\n/g, '<br>');
            
            // Reset buttons to default
            const primaryBtn = document.getElementById('modal-primary-btn');
            const secondaryBtn = document.getElementById('modal-secondary-btn');
            primaryBtn.textContent = "Close";
            primaryBtn.onclick = closeModal;
            primaryBtn.className = "bg-navy-900 text-white px-4 py-2 rounded-lg shadow-md transition duration-150 ease-in-out hover:bg-navy-800 w-full font-semibold";
            secondaryBtn.classList.add('hidden');

            modal.style.display = 'flex';
            modal.classList.remove('animate-fade-out');
            modal.classList.add('animate-fade-in');
            content.classList.remove('animate-slide-down');
            content.classList.add('animate-slide-up');
        };

        window.showConfirmModal = (title, message, onConfirm, confirmText = "Confirm", isDestructive = false) => {
            const modal = document.getElementById('message-modal');
            const content = document.getElementById('message-modal-content');
            
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message.replace(/\n/g, '<br>');
            
            const primaryBtn = document.getElementById('modal-primary-btn');
            const secondaryBtn = document.getElementById('modal-secondary-btn');

            primaryBtn.textContent = confirmText;
            primaryBtn.onclick = () => {
                onConfirm();
                closeModal();
            };
            
            if (isDestructive) {
                primaryBtn.className = "bg-red-500 text-white px-4 py-2 rounded-lg shadow-md transition duration-150 ease-in-out hover:bg-red-600 w-full font-semibold";
            } else {
                primaryBtn.className = "bg-navy-900 text-white px-4 py-2 rounded-lg shadow-md transition duration-150 ease-in-out hover:bg-navy-800 w-full font-semibold";
            }

            secondaryBtn.textContent = "Cancel";
            secondaryBtn.onclick = closeModal;
            secondaryBtn.classList.remove('hidden');

            modal.style.display = 'flex';
            modal.classList.remove('animate-fade-out');
            modal.classList.add('animate-fade-in');
            content.classList.remove('animate-slide-down');
            content.classList.add('animate-slide-up');
        };

        window.closeModal = () => {
            const modal = document.getElementById('message-modal');
            const content = document.getElementById('message-modal-content');
            
            modal.classList.remove('animate-fade-in');
            modal.classList.add('animate-fade-out');
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');

            setTimeout(() => {
                modal.style.display = 'none';
            }, 250);
        };

        const getProgressPath = () => {
            if (!userId) return null;
            return `artifacts/${appId}/users/${userId}/decks`;
        };

        const getDeckDocRef = (deckId) => {
            if (!db || !userId) return null;
            return doc(db, getProgressPath(), deckId);
        };
        
        // Updates the navigation links based on auth state
        const updateNav = (loggedIn) => {
            const signedOutDesktop = $('#desktop-nav-signed-out');
            const signedInDesktop = $('#desktop-nav-signed-in');
            const signedOutMobile = $('#mobile-menu-signed-out');
            const signedInMobile = $('#mobile-menu-signed-in');
            const footer = $('#main-footer');
            const upgradeBtn = $('#nav-upgrade-btn');
            
            if (loggedIn) {
                signedInDesktop?.classList.add('hidden', 'md:flex');
                signedOutDesktop?.classList.add('hidden');
                signedOutDesktop?.classList.remove('md:flex'); 
                signedOutMobile?.classList.add('hidden');
                signedInMobile?.classList.remove('hidden');
                footer?.classList.add('hidden');

                const activePageId = document.querySelector('.page-section.active')?.id;
                if (activePageId === 'home' || activePageId === 'login') {
                     router('dashboard'); 
                }

                // Show upgrade button if not premium
                if (upgradeBtn && userSubscriptionStatus !== 'premium') {
                    upgradeBtn.classList.remove('hidden');
                } else if (upgradeBtn) {
                    upgradeBtn.classList.add('hidden');
                }

            } else {
                signedOutDesktop?.classList.add('hidden', 'md:flex');
                signedInDesktop?.classList.add('hidden');
                signedInDesktop?.classList.remove('md:flex');
                signedOutMobile?.classList.remove('hidden');
                signedInMobile?.classList.add('hidden');
                footer?.classList.remove('hidden');
                if (upgradeBtn) upgradeBtn.classList.add('hidden');
                
                // Unlink Homepage: Redirect home/protected pages to login
                const activePageId = document.querySelector('.page-section.active')?.id;
                if (['home', 'dashboard', 'flashcards', 'lessons', 'tools-landing', 'tools-conjugation', 'account', 'subscription'].includes(activePageId)) {
                    router('login'); 
                }
            }
            $('#current-user-id').textContent = loggedIn ? userId : 'Not Logged In';
        };

        // --- AUTH LOGIC ---

        const initializeFirebase = async () => {
            if (!firebaseConfig.apiKey) {
                showModal("Setup Error", "Firebase configuration is missing. Check your keys.");
                return;
            }
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Initialize Stripe if key is present (not placeholder)
            if (!STRIPE_PUBLIC_KEY.includes('REPLACE')) {
                stripe = Stripe(STRIPE_PUBLIC_KEY);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    
                    // Fetch user subscription status
                    const userDoc = await getDoc(doc(db, `artifacts/${appId}/users`, user.uid));
                    if (userDoc.exists()) {
                        userSubscriptionStatus = userDoc.data().subscriptionStatus || 'free';
                        updateSubscriptionUI();
                    } else {
                        // Create basic doc if doesn't exist
                        await setDoc(doc(db, `artifacts/${appId}/users`, user.uid), {
                            email: user.email,
                            createdAt: new Date().toISOString(),
                            subscriptionStatus: 'free'
                        });
                    }

                    fetchSavedTickets();

                    // --- CHECK FOR PAYMENT SUCCESS RETURN ---
                    // This handles the redirect back from Stripe
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('payment_success') === 'true') {
                        console.log("Payment success detected!");
                        
                        // 1. Optimistically update status (Instant Premium UI)
                        userSubscriptionStatus = 'premium';
                        
                        // 2. Clean the URL (remove ?payment_success=true so it doesn't re-trigger on refresh)
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        // 3. Show celebration
                        setTimeout(() => {
                            if (typeof triggerConfetti === 'function') triggerConfetti();
                            showModal("Excelente! ", "Your payment was successful.\n\nWelcome to Premium! You now have unlimited access to AI Tutoring and advanced drills.");
                        }, 500);
                    }

                    updateNav(true);
                    listenForUserProgress();
                    updateVerbDashboard(); // Ensure rings are fresh
                    await loadSettings();
                } else {
                    userId = null;
                    userProgress = {}; 
                    userSubscriptionStatus = 'free';
                    updateNav(false);
                }
                
                hideLoading();
            });
            
            // Initial fetch of public data
            fetchLessons();
            fetchFlashcards();
            
            hydrateVerbData(VERB_DB_RAW);
            fetchVerbsDatabase();

            showLoading("Checking authentication...");
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Custom token sign-in failed:", e));
            } else if (!auth.currentUser) {
                 await signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed:", e));
            }
        };

        const updateSubscriptionUI = () => {
            const badge = document.getElementById('dashboard-status-badge');
            const mobileUpgrade = document.getElementById('mobile-nav-upgrade');
            const accSub = document.getElementById('acc-subscription');
            const accUpgradeBtn = document.getElementById('acc-upgrade-btn');
            const portalSection = document.getElementById('acc-manage-portal');

            if (userSubscriptionStatus === 'premium') {
                if(badge) {
                    badge.className = "inline-flex items-center gap-1 bg-gradient-to-r from-gold-400 to-gold-600 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mt-2 shadow-sm";
                    badge.innerHTML = `<i data-lucide="star" class="w-3 h-3 fill-white"></i> Premium Member`;
                }
                if(mobileUpgrade) mobileUpgrade.classList.add('hidden');
                if(accSub) {
                    accSub.innerHTML = `<span class="text-gold-600 font-bold flex items-center gap-1"><i data-lucide="star" class="w-4 h-4 fill-gold-600"></i> Premium Active</span>`;
                }
                if (portalSection) portalSection.classList.remove('hidden'); // Show manage button for premium
            } else {
                if(badge) {
                     badge.className = "inline-flex items-center gap-1 bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mt-2";
                     badge.innerHTML = `<span>Free Plan</span>`;
                }
                if(mobileUpgrade) mobileUpgrade.classList.remove('hidden');
                if (portalSection) portalSection.classList.add('hidden');
                // Re-inject upgrade button if missing
                if(accSub && !accSub.querySelector('button')) {
                     accSub.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span>Free Plan</span>
                            <button onclick="router('subscription')" class="text-xs bg-gold-400 text-navy-900 px-2 py-1 rounded font-bold hover:bg-gold-500">UPGRADE</button>
                        </div>
                     `;
                }
            }
            updateNav(!!userId);
            if(window.lucide) lucide.createIcons();
        };

        // --- STRIPE PAYMENT LOGIC (BACKEND INTEGRATED) ---
        window.handleStripeCheckout = async (planKey, forceSimulation = false) => {
            // --- CONFIGURATION ---
            // HARDCODED URL BASED ON YOUR DEPLOYMENT LOGS
            const PROJECT_ID = "spanishbysammy-6a112"; 
            const REGION = "us-central1";
            const FUNCTION_URL = `https://${REGION}-${PROJECT_ID}.cloudfunctions.net`;

            // 0. CHECK FOR FILE PROTOCOL OR LOCALHOST SIMULATION
            const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isFile = window.location.protocol === 'file:';

            // Function to run the simulation (Success effect)
            const runSimulation = async () => {
                showLoading("Simulating Stripe...");
                await new Promise(resolve => setTimeout(resolve, 1500));
                hideLoading();
                if (typeof triggerConfetti === 'function') triggerConfetti();
                try {
                    userSubscriptionStatus = 'premium';
                    updateSubscriptionUI(); // Ensure full UI refresh
                    if (typeof updateNav === 'function') updateNav(true);
                } catch (e) { console.warn("Sim update failed", e); }
                showModal("Simulation Success! ", "Payment simulated successfully.\n\n(Note: In a real environment, you would be redirected to Stripe hosted checkout.)");
            };

            if (forceSimulation || isFile) {
                await runSimulation();
                return;
            }

            // 1. Check if logged in
            if (!userId) {
                router('login');
                return;
            }

            // 2. Check Configuration (Public Key)
            if (typeof STRIPE_PUBLIC_KEY === 'undefined' || STRIPE_PUBLIC_KEY.includes('REPLACE')) {
                showModal("Setup Required", "You haven't added your Stripe Public Key to index.html yet.\n\nSearch for 'STRIPE_PUBLIC_KEY' in the code (around line 1700) and replace the placeholder.");
                return;
            }

            // 3. Normalize Plan Key
            let normalizedKey = planKey;
            if (planKey.includes('monthly')) normalizedKey = 'monthly';
            if (planKey.includes('yearly')) normalizedKey = 'yearly';

            const priceId = STRIPE_PRICE_IDS[normalizedKey];
            
            // 4. Check Configuration (Price IDs)
            if (!priceId || priceId.includes('REPLACE')) {
                showModal("Setup Required", "You haven't added your Stripe Price IDs to index.html yet.\n\n1. Create products in Stripe Dashboard\n2. Copy the Price IDs (price_...)\n3. Update STRIPE_PRICE_IDS in index.html");
                return;
            }

            showLoading("Redirecting to secure checkout...");

            try {
                // Call the Cloud Function to create a checkout session
                const targetEndpoint = `${FUNCTION_URL}/createCheckoutSession`;
                console.log(`Attempting to connect to backend: ${targetEndpoint}`);
                
                const response = await fetch(targetEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        priceId: priceId,
                        userId: userId,
                        successUrl: window.location.origin + window.location.pathname + '?payment_success=true',
                        cancelUrl: window.location.origin + window.location.pathname
                    })
                });

                // --- SMART DIAGNOSTICS FOR HTTP ERRORS ---
                if (!response.ok) {
                    const text = await response.text();
                    let errorMessage = `Server Error: ${response.status}`;
                    try {
                        const json = JSON.parse(text);
                        errorMessage = json.error || errorMessage;
                    } catch (e) { errorMessage = text || errorMessage; }

                    if (response.status === 404) {
                        throw new Error(`FUNCTION_NOT_FOUND: The URL ${targetEndpoint} returned 404.`);
                    }
                    
                    throw new Error(errorMessage);
                }

                const { url } = await response.json();
                
                // Redirect to the Stripe hosted checkout page
                window.location.href = url;

            } catch (error) {
                console.error("Stripe Checkout Error:", error);
                hideLoading();
                
                let title = "Checkout Error";
                let message = error.message;
                let showSimulateButton = true; // Always allow simulation on error to unblock testing

                // --- INTERPRET THE ERROR ---
                
                if (error.message.includes("FUNCTION_NOT_FOUND")) {
                    title = "Backend URL Error ";
                    message = `We tried to reach: ${FUNCTION_URL}/createCheckoutSession\n\nBut the server said "Not Found".\n\n1. Check your Firebase Console to ensure the function name is exactly 'createCheckoutSession'.\n2. Check if the Region is correct (us-central1).`;
                }
                else if (error.message === 'Failed to fetch' || error.message.includes('NetworkError')) {
                    title = "Connection Failed";
                    message = `Could not reach ${FUNCTION_URL}.\n\nIt seems the frontend cannot see the backend. This might be a CORS issue or internet connectivity.`;
                } 
                else if (error.message.includes('Invalid API Key')) {
                    title = "Backend Config Error";
                    message = "Your Cloud Function has the wrong Stripe Secret Key. Please fix 'STRIPE_SECRET_KEY' in functions/index.js and run 'firebase deploy --only functions' again.";
                }

                // Show the modal with Simulate button
                const modal = document.getElementById('message-modal');
                const titleEl = document.getElementById('modal-title');
                const msgEl = document.getElementById('modal-message');
                
                titleEl.textContent = title;
                msgEl.innerHTML = `<div class="whitespace-pre-wrap text-sm">${message}</div>`;
                
                if (showSimulateButton) {
                    msgEl.innerHTML += `
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="font-bold text-sm mb-2 text-slate-700">Want to test the UI anyway?</p>
                            <button id="sim-btn-error" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded shadow transition">
                                Simulate Success
                            </button>
                        </div>
                    `;
                    setTimeout(() => {
                        const btn = document.getElementById('sim-btn-error');
                        if(btn) btn.onclick = () => { closeModal(); runSimulation(); };
                    }, 100);
                }

                modal.style.display = 'flex';
            }
        };

        // --- CUSTOMER PORTAL LOGIC (BACKEND INTEGRATED) ---
        window.openCustomerPortal = async () => {
            if (!userId) return;
            
            // HARDCODED URL
            const PROJECT_ID = "spanishbysammy-6a112"; 
            const REGION = "us-central1";
            const FUNCTION_URL = `https://${REGION}-${PROJECT_ID}.cloudfunctions.net`;

            showLoading("Opening portal...");

            try {
                const response = await fetch(`${FUNCTION_URL}/createPortalSession`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        returnUrl: window.location.origin + window.location.pathname
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || "Failed to open portal");
                }

                const { url } = await response.json();
                window.location.href = url;

            } catch (error) {
                console.error("Portal Error:", error);
                showModal("Portal Error", error.message);
                hideLoading();
            }
        };

        window.handleAuth = async (isLogin) => {
            const email = $('#auth-email').value;
            const password = $('#auth-password').value;
            const submitBtn = $('#auth-submit-btn');
            submitBtn.disabled = true;
            showLoading(isLogin ? "Logging in..." : "Creating account...");

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                    showModal("Welcome Back!", "Successfully logged in.");
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    await setDoc(doc(db, `artifacts/${appId}/users`, user.uid), {
                        email: user.email,
                        createdAt: new Date().toISOString(),
                        subscriptionStatus: 'free'
                    });
                    showModal("Success!", "Account created and logged in! Welcome to Spanish by Sammy.");
                }
                router('dashboard'); 

            } catch (error) {
                console.error("Auth Error:", error.message);
                showModal(isLogin ? "Login Failed" : "Signup Failed", error.message);
            } finally {
                submitBtn.disabled = false;
                hideLoading();
            }
        };
        
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            const title = $('#auth-title');
            const submitBtn = $('#auth-submit-btn');
            const switchBtn = document.querySelector('#login button:last-child');
            
            if (isLoginMode) {
                title.textContent = "Log In";
                submitBtn.textContent = "LOG IN";
                submitBtn.onclick = () => handleAuth(true);
                switchBtn.textContent = "Don't have an account? Sign Up";
            } else {
                title.textContent = "Create New Account";
                submitBtn.textContent = "SIGN UP";
                submitBtn.onclick = () => handleAuth(false);
                switchBtn.textContent = "Already have an account? Log In";
            }
        };


        window.logout = async () => {
            showLoading("Logging out...");
            try {
                await signOut(auth);
                // Redirect to landing page on successful logout
                window.location.href = "https://spanishbysammy.netlify.app/";
            } catch (error) {
                console.error("Logout Error:", error.message);
                showModal("Logout Failed", "Could not log out: " + error.message);
                // Fallback to internal login screen if redirect or signout logic hiccups but user stays in app
                router('login');
            } finally {
                hideLoading();
            }
        };
        
        window.seedFlashcardsDatabase = async () => {
            if (!confirm("Are you sure you want to upload flashcards to the database?")) return;
            if (!userId) {
                 alert("Please log in first.");
                 return;
            }
            
            showLoading("Seeding Flashcards...");
            const flashcardsRef = collection(db, `artifacts/${appId}/public/data/flashcards`);
            
            try {
                for (const level of INITIAL_FLASHCARD_SEED_DATA) {
                     await setDoc(doc(flashcardsRef, level.id), level);
                }
                alert("Flashcards seeded successfully!");
                fetchFlashcards();
            } catch (error) {
                console.error("Seeding Error:", error);
                alert("Error seeding: " + error.message);
            } finally {
                hideLoading();
            }
        };

        // --- FIREBASE DATA LOGIC (REPLACING LOCAL STORAGE) ---
        
        const fetchLessons = async () => {
             try {
                const lessonsRef = collection(db, `artifacts/${appId}/public/data/lessons`);
                const snapshot = await getDocs(lessonsRef);
                
                if (snapshot.empty) {
                    allLessons = DUMMY_LESSONS;
                } else {
                    allLessons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allLessons.sort((a, b) => a.id.localeCompare(b.id));
                }

                if (document.getElementById('lessons').classList.contains('active')) {
                    renderLessonLibrary();
                    updateLessonsDashboard();
                } else {
                    updateLessonsDashboard();
                }
                
             } catch (error) {
                 console.error("Error fetching lessons:", error);
                 allLessons = DUMMY_LESSONS;
                 updateLessonsDashboard();
             }
        };

        const fetchFlashcards = async () => {
             console.log(" fetchFlashcards() called");
             try {
                const setsRef = collection(db, 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/definedSets');
                console.log(" Fetching from:", 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/definedSets');
                const snapshot = await getDocs(setsRef);
                console.log(" Snapshot received. Empty?", snapshot.empty, "Doc count:", snapshot.docs.length);
                
                if (snapshot.empty) {
                    console.warn(" No documents found in definedSets!");
                    flashcardData = [];
                } else {
                    const rawSets = snapshot.docs.map(doc => doc.data());
                    console.log(" Raw sets data:", rawSets);
                    flashcardData = transformSetsToLevels(rawSets);
                    console.log(" Transformed flashcardData:", flashcardData);
                }

                if (document.getElementById('flashcards').classList.contains('active')) {
                    console.log(" Flashcards page is active, calling renderFlashcards()");
                    renderFlashcards();
                    updateFlashcardDashboard();
                } else {
                    console.log(" Flashcards page not active, updating dashboard only");
                    updateFlashcardDashboard();
                }
                
             } catch (error) {
                 console.error(" Error fetching flashcards:", error);
                 flashcardData = [];
                 updateFlashcardDashboard();
             }
        };

        function transformSetsToLevels(rawSets) {
            const levelMap = {};
            
            rawSets.forEach(set => {
                const level = set.level.toUpperCase();
                if (!levelMap[level]) {
                    levelMap[level] = {
                        id: level,
                        title: `Level ${level}`,
                        description: getLevelDescription(level),
                        sets: []
                    };
                }
                levelMap[level].sets.push(set);
            });
            
            return Object.values(levelMap).sort((a, b) => a.id.localeCompare(b.id));
        }

        function getLevelDescription(level) {
            const descriptions = {
                'A1': 'Absolute Beginner - Essential Foundation',
                'A2': 'Elementary - Basic Communication',
                'B1': 'Intermediate - Everyday Conversations',
                'B2': 'Upper Intermediate - Complex Topics',
                'C1': 'Advanced - Professional Fluency',
                'C2': 'Mastery - Native-like Proficiency'
            };
            return descriptions[level] || 'Learning Spanish';
        }

        const listenForUserProgress = () => {
            if (!db || !userId) {
                userProgress = {};
                renderDeckProgress();
                return;
            }
            
            const progressCollectionRef = collection(db, getProgressPath());
            
            onSnapshot(query(progressCollectionRef), (snapshot) => {
                const newProgress = {};
                snapshot.forEach((doc) => {
                    newProgress[doc.id] = doc.data();
                });
                
                userProgress = newProgress;
                
                renderDeckProgress();
                if (document.getElementById('flashcards').classList.contains('active')) {
                    renderFlashcards();
                }
                if (document.getElementById('lessons').classList.contains('active')) {
                    renderLessonLibrary();
                }
                updateFlashcardDashboard();
                updateLessonsDashboard();

            }, (error) => {
                console.error("Error listening to progress:", error.message);
            });
        };

        window.toggleDeckFirebase = async (deckId) => {
            if (!userId || auth.currentUser.isAnonymous) {
                showModal("Access Denied", "Please create a full account to save your permanent progress.");
                return;
            }
            const fromFlashcards = deckId.startsWith('A') || deckId.startsWith('B');
            
            if(!fromFlashcards) showLoading("Saving progress...");

            const docRef = getDeckDocRef(deckId);
            const isCompleted = userProgress[deckId]?.status === 'complete';
            
            try {
                if (isCompleted) {
                    await setDoc(docRef, { status: 'incomplete', completedAt: null, userId: userId });
                    if(!fromFlashcards) showModal("Progress Reset", `Deck ${deckId} status was reset to incomplete.`);
                } else {
                    const timestamp = new Date().toISOString();
                    await setDoc(docRef, { status: 'complete', completedAt: timestamp, userId: userId });
                    if(!fromFlashcards) showModal("Deck Complete!", `Congratulations! Progress saved.`);
                }
            } catch (error) {
                console.error("Toggle Completion Error:", error.message);
                showModal("Save Failed", "Could not update progress: " + error.message);
            } finally {
               if(!fromFlashcards) hideLoading();
            }
        };

        window.handleReviewUnit = async (unitId, url) => {
            if (!userId) return;
            window.open(url, '_blank');
            const docRef = getDeckDocRef(unitId);
            const timestamp = new Date().toISOString();
            
            try {
                await setDoc(docRef, { 
                    lastReviewed: timestamp, 
                    reviewCount: increment(1),
                    userId: userId 
                }, { merge: true });
                
            } catch (error) {
                console.error("Review Update Failed:", error);
            }
        };
        
        const LEVEL_DESCRIPTIONS = {
            'A1': 'Absolute Beginner',
            'A2': 'Beginner',
            'B1': 'Low Intermediate',
            'B2': 'High Intermediate',
            'C1': 'Proficient',
            'C2': 'Expert'
        };

        window.updateLessonsDashboard = () => {
             let totalLessons = allLessons.length;
             let completedCount = 0;
             let firstIncomplete = null;
             
             allLessons.forEach(l => {
                 const isDone = userProgress[l.id]?.status === 'complete';
                 if (isDone) completedCount++;
                 else if (!firstIncomplete) firstIncomplete = l;
             });
             
             const progressEl = document.getElementById('dash-lessons-progress');
             if (progressEl) progressEl.textContent = `${completedCount}/${totalLessons}`;
             
             let levelText = 'A1';
             let descText = 'Absolute Beginner';
             let nextLessonTitle = 'Introduction';
             let pct = 0;

             if (firstIncomplete) {
                 levelText = firstIncomplete.level;
                 descText = LEVEL_DESCRIPTIONS[firstIncomplete.level] || 'Learning';
                 nextLessonTitle = firstIncomplete.title;
                 pct = totalLessons > 0 ? (completedCount / totalLessons) * 100 : 0;
                 currentNextLessonId = firstIncomplete.id;
             } else if(totalLessons > 0) {
                 levelText = "C2+";
                 descText = "Mastery";
                 nextLessonTitle = "All Complete!";
                 pct = 100;
                 currentNextLessonId = null;
             }

             if(progressEl) {
                 document.getElementById('dash-lessons-level').textContent = levelText;
                 document.getElementById('dash-lessons-desc').textContent = descText;
                 document.getElementById('dash-lessons-next').textContent = nextLessonTitle;
             }

             const homeLevel = document.getElementById('home-level-display');
             if (homeLevel) {
                 homeLevel.textContent = levelText;
                 document.getElementById('home-next-lesson').textContent = nextLessonTitle;
                 document.getElementById('home-lesson-bar').style.width = pct + "%";
             }
        }

        window.renderLessonLibrary = () => {
            const container = document.getElementById('lessons-container');
            if(!container) return;
            container.innerHTML = '';
            
            const levels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            let nextIncompleteLesson = null;
            
            levels.forEach(level => {
                const levelLessons = allLessons.filter(l => l.level === level);
                const totalLevel = levelLessons.length;
                const completedLevel = levelLessons.filter(l => userProgress[l.id]?.status === 'complete').length;
                const isLevelComplete = totalLevel > 0 && totalLevel === completedLevel;

                const levelDiv = document.createElement('div');
                levelDiv.className = 'bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-4';
                
                const headerBg = isLevelComplete ? 'bg-gray-100' : 'bg-navy-900';
                const headerText = isLevelComplete ? 'text-gray-500' : 'text-white';
                const check = isLevelComplete ? `<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>` : '';

                levelDiv.innerHTML = `
                    <div onclick="toggleAccordion('lvl-${level}')" class="${headerBg} ${headerText} p-4 cursor-pointer flex justify-between items-center hover:opacity-90 transition">
                        <div class="flex items-center gap-2">
                            ${check}
                            <h2 class="text-lg font-bold">Level ${level}</h2>
                        </div>
                        <i data-lucide="chevron-down" class="w-5 h-5 transform transition-transform" id="icon-lvl-${level}"></i>
                    </div>
                    <div id="content-lvl-${level}" class="accordion-content bg-gray-50">
                        <div class="p-2 space-y-2">
                            ${levelLessons.length ? '' : '<div class="p-4 text-gray-400 text-sm italic text-center">No lessons available yet.</div>'}
                        </div>
                    </div>
                `;
                container.appendChild(levelDiv);

                if (levelLessons.length > 0) {
                    const contentDiv = levelDiv.querySelector(`#content-lvl-${level} > div`);
                    levelLessons.forEach(lesson => {
                        const lessonItem = document.createElement('div');
                        lessonItem.className = 'bg-white border border-gray-200 rounded overflow-hidden';
                        const isCompleted = userProgress[lesson.id]?.status === 'complete';
                        
                        if (!isCompleted && !nextIncompleteLesson) {
                            nextIncompleteLesson = lesson;
                        }
                        
                        const completedStyles = isCompleted ? 'text-gray-400' : 'text-navy-900';
                        const checkIcon = isCompleted ? `<i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>` : '';

                        lessonItem.innerHTML = `
                            <div onclick="toggleAccordion('${lesson.id}')" class="p-3 cursor-pointer hover:bg-gray-50 transition flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    ${checkIcon}
                                    <span class="font-medium ${completedStyles}">${lesson.title}</span>
                                </div>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 transform transition-transform" id="icon-${lesson.id}"></i>
                            </div>
                            <div id="content-${lesson.id}" class="accordion-content">
                                <div class="p-4 border-t border-gray-100 flex flex-col sm:flex-row gap-4">
                                    <div class="w-full sm:w-32 h-20 bg-gray-200 rounded flex-shrink-0 overflow-hidden relative">
                                        <img src="${lesson.thumbnail}" class="w-full h-full object-cover opacity-80" alt="Thumbnail">
                                        <div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play-circle" class="w-8 h-8 text-white"></i></div>
                                    </div>
                                    <div class="flex-grow">
                                        <p class="text-sm text-gray-600 mb-3">${lesson.description}</p>
                                        <button onclick="openLesson('${lesson.id}')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-1.5 rounded text-xs font-bold uppercase tracking-wide transition shadow-sm w-full sm:w-auto">
                                            ${isCompleted ? 'Review Lesson' : 'Start Lesson'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        contentDiv.appendChild(lessonItem);
                    });
                }
            });
            
            if(window.lucide) lucide.createIcons();

            if (nextIncompleteLesson) {
                setTimeout(() => {
                    const lvlId = `lvl-${nextIncompleteLesson.level}`;
                    const lvlContent = document.getElementById(`content-${lvlId}`);
                    if(lvlContent && !lvlContent.classList.contains('open')) {
                        toggleAccordion(lvlId);
                    }
                    setTimeout(() => {
                         const lessId = nextIncompleteLesson.id;
                         const lessContent = document.getElementById(`content-${lessId}`);
                         if(lessContent && !lessContent.classList.contains('open')) {
                             toggleAccordion(lessId);
                         }
                    }, 300);
                }, 100);
            }
        };
        
        window.jumpToNextLesson = () => {
             if (currentNextLessonId) {
                 jumpToLesson(currentNextLessonId);
             } else {
                 alert("All lessons completed!");
             }
        };

        window.jumpToLesson = (lessonId) => {
            const lesson = allLessons.find(l => l.id === lessonId);
            if (!lesson) return;
            
            exitSearchMode('lessons');

            const lvlId = `lvl-${lesson.level}`;
            const lvlContent = document.getElementById(`content-${lvlId}`);
            if(lvlContent && !lvlContent.classList.contains('open')) {
                toggleAccordion(lvlId);
            }

            setTimeout(() => {
                const lessonContent = document.getElementById(`content-${lesson.id}`);
                if(lessonContent && !lessonContent.classList.contains('open')) {
                    toggleAccordion(lesson.id);
                }
                
                const element = document.getElementById(`content-${lesson.id}`).parentNode;
                if(element) {
                     element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300);
        };

        // --- SEARCH BAR LOGIC (NEW) ---
        window.enterSearchMode = (sectionId) => {
            const containerId = sectionId === 'lessons' ? 'lessons-search-container' : 'verb-search-container';
            const container = document.getElementById(containerId);
            const backBtn = document.getElementById(`${sectionId}-back-btn`);
            const dismissBtn = document.getElementById(`${sectionId}-dismiss-btn`);
            
            if(container) {
                // Capture scroll before entering modal view
                if (sectionId === 'verbs') {
                    savedSearchEntryScroll = window.scrollY;
                }

                container.classList.add('search-active');
                
                // Immediately swap to condensed view for verbs
                if (sectionId === 'verbs') {
                    filterVerbList();
                }

                if(backBtn) backBtn.classList.remove('hidden');
                if(dismissBtn) dismissBtn.classList.remove('hidden');
                
                // Show results container immediately in search mode
                if(sectionId === 'lessons') {
                     document.getElementById('lessons-search-results').classList.remove('hidden');
                     document.getElementById('lessons-container').classList.add('hidden');
                     document.getElementById('lessons-dashboard-wrapper').style.marginBottom = '0';
                }
                if (sectionId === 'verbs') {
                     // For verbs, the list container is already inside/adjacent. We might move it if it's not inside.
                     // The structure provided puts verb-list-container inside or adjacent. 
                     // In the modified HTML, it is inside or near. We just ensure it's visible.
                     // Actually, for full screen effect on verbs, we ensure the container fills the space.
                     // The layout handles overflow-y auto on results if designed that way.
                }
            }
        };

        window.exitSearchMode = (sectionId) => {
            const containerId = sectionId === 'lessons' ? 'lessons-search-container' : 'verb-search-container';
            const container = document.getElementById(containerId);
            const backBtn = document.getElementById(`${sectionId}-back-btn`);
            const dismissBtn = document.getElementById(`${sectionId}-dismiss-btn`);
            const input = document.getElementById(sectionId === 'lessons' ? 'lesson-search-input' : 'verb-search-input');

            if(container) {
                container.classList.remove('search-active');
                if(backBtn) backBtn.classList.add('hidden');
                if(dismissBtn) dismissBtn.classList.add('hidden');
                if(input) {
                    input.value = '';
                    input.blur();
                }

                if(sectionId === 'lessons') {
                    // Reset View
                     document.getElementById('lessons-search-results').classList.add('hidden');
                     document.getElementById('lessons-container').classList.remove('hidden');
                     document.getElementById('lessons-dashboard-wrapper').style.marginBottom = '';
                }
                if (sectionId === 'verbs') {
                     filterVerbList(); // Reset list
                     
                     // Restore scroll position
                     window.scrollTo({
                         top: savedSearchEntryScroll,
                         behavior: 'auto'
                     });
                }
            }
        };

        window.dismissKeyboard = () => {
             if(document.activeElement) {
                 document.activeElement.blur();
             }
        };

        window.handleLessonSearch = () => {
            const queryText = document.getElementById('lesson-search-input').value.toLowerCase();
            const resultsContainer = document.getElementById('lessons-search-results');
            
            // In search mode, results are always shown (even if empty, showing empty state)
            resultsContainer.innerHTML = '';
            
            const filtered = allLessons.filter(l => 
                l.title.toLowerCase().includes(queryText) || 
                l.description.toLowerCase().includes(queryText)
            );
            
            if (filtered.length === 0) {
                resultsContainer.innerHTML = '<div class="text-center text-gray-500 py-8">No lessons found.</div>';
                return;
            }
            
            filtered.forEach(lesson => {
                const isCompleted = userProgress[lesson.id]?.status === 'complete';
                const card = document.createElement('div');
                // Condensed styling
                card.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-2 mb-2 flex flex-row gap-3 items-center';
                const checkIcon = isCompleted ? `<i data-lucide="check-circle" class="w-3 h-3 text-green-500 inline mr-1"></i>` : '';
                
                card.innerHTML = `
                    <div class="w-12 h-12 bg-gray-200 rounded flex-shrink-0 overflow-hidden relative">
                        <img src="${lesson.thumbnail}" class="w-full h-full object-cover opacity-80" alt="Thumb">
                        <div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play" class="w-4 h-4 text-white fill-white"></i></div>
                    </div>
                    <div class="flex-grow min-w-0">
                        <h3 class="font-bold text-navy-900 text-sm leading-tight truncate">${checkIcon}${lesson.level} - ${lesson.title}</h3>
                        <p class="text-xs text-gray-500 truncate">${lesson.description}</p>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="jumpToLesson('${lesson.id}')" class="bg-gray-100 hover:bg-gray-200 text-navy-900 px-2 py-1 rounded text-xs font-bold whitespace-nowrap border border-gray-200">
                            Jump
                        </button>
                        <button onclick="openLesson('${lesson.id}')" class="bg-orange-500 text-white px-3 py-1 rounded text-xs font-bold whitespace-nowrap">
                            ${isCompleted ? 'Review' : 'Start'}
                        </button>
                    </div>
                `;
                resultsContainer.appendChild(card);
            });
             if(window.lucide) lucide.createIcons();
        };

        window.viewLessonInPlan = (lessonId, levelId) => {
             // Logic to expand accordions (unchanged, but triggered differently if needed)
             // ... existing implementation ...
        };

        window.startNextLesson = () => {
            let nextIncompleteLesson = null;
             for (const lesson of allLessons) {
                 const isCompleted = userProgress[lesson.id]?.status === 'complete';
                 if (!isCompleted) {
                     nextIncompleteLesson = lesson;
                     break;
                 }
             }
             if (nextIncompleteLesson) {
                 openLesson(nextIncompleteLesson.id);
             } else {
                 alert("All lessons complete! Great job!");
             }
        };

        window.openLesson = (lessonId) => {
            // ... existing logic ...
            exitSearchMode('lessons'); // Exit search if active
            const lesson = allLessons.find(l => l.id === lessonId);
            if(!lesson) return;

            justCompletedLesson = false;
            document.getElementById('player-status-badge').classList.add('hidden');

            currentLessonForAI = lesson;

            document.getElementById('player-level').textContent = `Level ${lesson.level}`;
            document.getElementById('player-main-title').textContent = lesson.title;
            document.getElementById('player-title').textContent = lesson.title;
            document.getElementById('player-content').innerHTML = lesson.content;
            
            if(userProgress[lesson.id]?.status === 'complete') {
                document.getElementById('player-status-badge').classList.remove('hidden');
            }
            
            document.getElementById('player-iframe').src = `https://www.youtube.com/embed/${lesson.videoId}?rel=0`;
            document.getElementById('player-video-placeholder').style.display = 'none';

            document.getElementById('lessons').classList.remove('active');
            document.getElementById('lesson-view').classList.add('active');
            window.scrollTo(0,0);
        };
        
        // --- AI & QUIZ LOGIC ---
        const apiKey = ""; 

        async function callGemini(prompt, systemPrompt) {
            if (!USE_CLOUD_FUNCTIONS) {
                if (!apiKey) {
                    alert("API Key is missing for local testing! Please add it to the code.");
                    throw new Error("API Key Missing");
                }

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                const delays = [1000, 2000, 4000, 8000, 16000];
                for (let i = 0; i <= delays.length; i++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const data = await response.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text;
                    } catch (error) {
                        if (i === delays.length) throw error;
                        await new Promise(resolve => setTimeout(resolve, delays[i]));
                    }
                }
            } else {
                alert("Production mode enabled but Cloud Functions not yet deployed.");
                throw new Error("Cloud Functions Not Ready");
            }
        }

        window.startQuiz = async () => {
            if (!currentLessonForAI) return;
            document.getElementById('lesson-view').classList.remove('active');
            document.getElementById('quiz-view').classList.add('active');
            document.getElementById('quiz-loading').classList.remove('hidden');
            document.getElementById('quiz-content').classList.add('hidden');

            await generateQuizQuestions();
        }

        window.generateQuizQuestions = async () => {
            const level = currentLessonForAI.level;
            let languageInstruction = "The user is a beginner student. Ask the questions in English, but provide the multiple choice answers in Spanish.";
            
            if (['C1', 'C2'].includes(level)) {
                languageInstruction = "The user is an advanced student. Ask the questions in Spanish and provide the multiple choice answers in Spanish.";
            } else if (['B1', 'B2'].includes(level)) {
                 languageInstruction = "The user is an intermediate student. Ask the questions in English, but provide the multiple choice answers in Spanish.";
            }

            const systemPrompt = `You are a Spanish language teacher. Create a quiz based on the provided lesson text.
            ${languageInstruction}
            Output STRICT JSON format: { "questions": [ { "question": "...", "options": ["A", "B", "C", "D"], "correctAnswerIndex": 0, "explanation": "..." } ] }`;
            
            const userPrompt = `Using the text and title of this lesson, identify the grammar principle being taught and generate 5 multiple choice questions the user can use to practice that topic.
            Title: ${currentLessonForAI.title}
            Content: ${currentLessonForAI.content.replace(/<[^>]*>/g, '')}`;

            try {
                const jsonString = await callGemini(userPrompt, systemPrompt);
                const cleanJson = jsonString.replace(/```json|```/g, '').trim();
                const data = JSON.parse(cleanJson);
                
                currentQuizQuestions = data.questions;
                currentQuizIndex = 0;
                currentQuizScore = 0;
                renderQuizQuestion();
                document.getElementById('quiz-loading').classList.add('hidden');
                document.getElementById('quiz-content').classList.remove('hidden');
            } catch (error) {
                console.error("Quiz Generation Error:", error);
                alert("Failed to generate quiz. Please try again.");
                router('lesson-view');
            }
        }
        
        window.renderQuizQuestion = () => {
            const q = currentQuizQuestions[currentQuizIndex];
            document.getElementById('quiz-q-num').textContent = currentQuizIndex + 1;
            document.getElementById('quiz-score').textContent = `Score: ${currentQuizScore}`;
            document.getElementById('quiz-question-text').textContent = q.question;
            
            const optionsDiv = document.getElementById('quiz-options');
            optionsDiv.innerHTML = '';
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-4 rounded-lg border border-gray-200 hover:bg-gray-50 transition flex items-center gap-3 group';
                btn.onclick = () => handleAnswer(idx, btn);
                btn.innerHTML = `
                    <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center group-hover:border-orange-500 text-xs font-bold text-gray-500 group-hover:text-orange-500 transition">
                        ${String.fromCharCode(65 + idx)}
                    </div>
                    <span class="text-gray-700 group-hover:text-navy-900">${opt}</span>
                `;
                optionsDiv.appendChild(btn);
            });

            document.getElementById('quiz-feedback').classList.add('hidden');
            document.getElementById('quiz-next-btn').classList.add('hidden');
            document.getElementById('quiz-finish-btn').classList.add('hidden');
        }

        window.handleAnswer = (selectedIndex, btnElement) => {
            const q = currentQuizQuestions[currentQuizIndex];
            const isCorrect = selectedIndex === q.correctAnswerIndex;
            const feedbackEl = document.getElementById('quiz-feedback');
            const allBtns = document.querySelectorAll('#quiz-options button');
            allBtns.forEach(b => b.disabled = true);

            if (isCorrect) {
                btnElement.classList.add('bg-green-100', 'border-green-500');
                currentQuizScore++;
                feedbackEl.className = "mt-6 p-4 rounded-lg bg-green-50 text-green-800 text-sm border border-green-200";
                feedbackEl.innerHTML = `<strong>Correct!</strong> ${q.explanation}`;
            } else {
                btnElement.classList.add('bg-red-100', 'border-red-500');
                allBtns[q.correctAnswerIndex].classList.add('bg-green-50', 'border-green-500');
                feedbackEl.className = "mt-6 p-4 rounded-lg bg-red-50 text-red-800 text-sm border border-red-200";
                feedbackEl.innerHTML = `<strong>Incorrect.</strong> The correct answer was ${String.fromCharCode(65 + q.correctAnswerIndex)}. ${q.explanation}`;
            }
            
            feedbackEl.classList.remove('hidden');
            
            if (currentQuizIndex < 4) {
                document.getElementById('quiz-next-btn').classList.remove('hidden');
            } else {
                document.getElementById('quiz-finish-btn').classList.remove('hidden');
            }
            document.getElementById('quiz-score').textContent = `Score: ${currentQuizScore}`;
        }

        window.nextQuestion = () => {
            currentQuizIndex++;
            renderQuizQuestion();
        }

        window.finishQuiz = async () => {
            if (currentQuizScore >= 4) {
                await toggleDeckFirebase(currentLessonForAI.id); 
                justCompletedLesson = true;
                alert("Quiz Passed! Lesson Completed.");
            } else {
                alert(`You scored ${currentQuizScore}/5. You need at least 4/5 to pass. Try again!`);
            }
            
            document.getElementById('quiz-view').classList.remove('active');
            document.getElementById('lesson-view').classList.add('active');
            
            if (justCompletedLesson) {
                triggerConfetti();
                document.getElementById('player-status-badge').classList.remove('hidden');
                renderLessonLibrary();
            }
        }

        // --- AI CHAT LOGIC ---
        window.openAIAssistant = () => {
             if (!currentLessonForAI) return;
             if (userSubscriptionStatus !== 'premium') {
                 showModal("Premium Feature", "AI Tutor Chat is a Premium feature. Please upgrade to Pro.");
                 router('subscription');
                 return;
             }
             
             document.getElementById('lesson-view').classList.remove('active');
             document.getElementById('ai-chat-view').classList.add('active');
             
             const history = document.getElementById('chat-history');
             history.innerHTML = `
                <div class="chat-bubble chat-ai">
                    Hola! I'm your AI tutor. I can help you with the lesson you are currently studying. What questions do you have?
                </div>
             `;
        }

        window.sendChatMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            const history = document.getElementById('chat-history');
            
            history.innerHTML += `<div class="chat-bubble chat-user">${text}</div>`;
            input.value = '';
            history.scrollTop = history.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            history.innerHTML += `
                <div id="${loadingId}" class="chat-bubble chat-ai typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            history.scrollTop = history.scrollHeight;

            const systemPrompt = `You are a helpful, encouraging Spanish tutor. 
            The user is currently studying a lesson titled: "${currentLessonForAI.title}".
            Here is the content of the lesson they are looking at: "${currentLessonForAI.content.replace(/<[^>]*>/g, '')}".
            Answer their questions specifically about this content, or Spanish grammar/vocab in general. Keep answers concise and helpful.`;

            try {
                const responseText = await callGemini(text, systemPrompt);
                document.getElementById(loadingId).remove();
                const formattedText = responseText.replace(/\n/g, '<br>');
                history.innerHTML += `<div class="chat-bubble chat-ai">${formattedText}</div>`;
                
            } catch (error) {
                console.error("Chat Error:", error);
                document.getElementById(loadingId).remove();
                history.innerHTML += `<div class="chat-bubble chat-ai text-red-500">Lo siento, I'm having trouble connecting. Please try again.</div>`;
            }
            history.scrollTop = history.scrollHeight;
        }

        // --- NEW: CONJUGATION DRILL LOGIC ---

        // 2. Data Hydration Logic 
        window.hydrateVerbData = (sourceData = VERB_DB_RAW) => {
            const haber = sourceData.find(v => v.infinitive === 'haber') || VERB_DB_RAW.find(v => v.infinitive === 'haber');
            const estar = sourceData.find(v => v.infinitive === 'estar') || VERB_DB_RAW.find(v => v.infinitive === 'estar');
            
            if (!haber || !estar) {
                console.error("Auxiliary verbs missing in source data!");
                VERB_DB = sourceData;
                return;
            }

            VERB_DB = sourceData.map(verb => {
                const hydrated = JSON.parse(JSON.stringify(verb)); 
                const perfectMapping = {
                    'Present': 'Present Perfect',
                    'Preterite': 'Preterite Perfect',
                    'Imperfect': 'Imperfect Perfect',
                    'Future': 'Future Perfect',
                    'Conditional': 'Conditional Perfect',
                    'Subjunctive Present': 'Present Perfect Subjunctive',
                    'Subjunctive Imperfect': 'Past Perfect Subjunctive' 
                };
                const progressiveMapping = {
                    'Present': 'Present Progressive',
                    'Preterite': 'Preterite Progressive',
                    'Imperfect': 'Imperfect Progressive',
                    'Future': 'Future Progressive',
                    'Conditional': 'Conditional Progressive'
                };

                ALL_SUBJECTS.forEach(sub => {
                    for (const [auxTense, targetTense] of Object.entries(perfectMapping)) {
                        if (haber.conjugations[auxTense] && haber.conjugations[auxTense][sub]) {
                            if (!hydrated.conjugations[targetTense]) hydrated.conjugations[targetTense] = {};
                            hydrated.conjugations[targetTense][sub] = `${haber.conjugations[auxTense][sub]} ${verb.participle}`;
                        }
                    }
                    for (const [auxTense, targetTense] of Object.entries(progressiveMapping)) {
                        if (estar.conjugations[auxTense] && estar.conjugations[auxTense][sub]) {
                            if (!hydrated.conjugations[targetTense]) hydrated.conjugations[targetTense] = {};
                            hydrated.conjugations[targetTense][sub] = `${estar.conjugations[auxTense][sub]} ${verb.gerund}`;
                        }
                    }
                });
                return hydrated;
            });
            console.log("Hydrated Verb DB:", VERB_DB);
            if(document.getElementById('tools-conjugation').classList.contains('active')) {
                filterVerbList();
            }
        }

        // 3. Settings Management (Firestore Persistence)
        const getSettingsRef = () => {
            if(!db || !userId) return null;
            return doc(db, `artifacts/${appId}/users/${userId}/settings/conjugation`);
        }

        const getFlashcardSettingsRef = () => {
            if(!db || !userId) return null;
            return doc(db, `artifacts/${appId}/users/${userId}/settings/flashcards`);
        }

        window.loadSettings = async () => {
            // --- Conjugation Defaults ---
            enabledTenses = {};
            Object.values(TENSE_HIERARCHY).flat().forEach(t => enabledTenses[t] = false);
            enabledTenses['Present'] = true;
            enabledSubjects = {};
            ALL_SUBJECTS.forEach(s => enabledSubjects[s] = true);

            // --- Flashcard Defaults ---
            studySettings = {
                shuffle: true,
                l1First: true,
                autoSpeak: true,
                showKeyboardHints: false
            };

            if (!userId) return;

            // Load Conjugation Settings
            try {
                const ref = getSettingsRef();
                const snapshot = await getDoc(ref);
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    if (data.tenses) enabledTenses = { ...enabledTenses, ...data.tenses };
                    if (data.subjects) enabledSubjects = { ...enabledSubjects, ...data.subjects };
                }
            } catch (e) {
                console.error("Failed to load conjugation settings:", e);
            }

            // Load Flashcard Settings
            try {
                const fRef = getFlashcardSettingsRef();
                const fSnapshot = await getDoc(fRef);
                if (fSnapshot.exists()) {
                    const fData = fSnapshot.data();
                    studySettings = { ...studySettings, ...fData };
                }
            } catch (e) {
                console.error("Failed to load flashcard settings:", e);
            }
        }

        window.saveSettings = async () => {
            if (userId) {
                try {
                    const ref = getSettingsRef();
                    await setDoc(ref, {
                        tenses: enabledTenses,
                        subjects: enabledSubjects,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                } catch (e) {
                    console.error("Failed to save conjugation settings:", e);
                }
            }
            alert("Settings saved!");
            toggleSettingsModal();
        }

        window.toggleVerbSort = () => {
            verbSortMode = verbSortMode === 'frequency' ? 'alphabetical' : 'frequency';
            const btnLabel = document.getElementById('verb-sort-label');
            if (verbSortMode === 'frequency') {
                btnLabel.textContent = "Freq";
            } else {
                btnLabel.textContent = "A-Z";
            }
            filterVerbList();
        }

        window.filterVerbList = () => {
            const containerId = 'verb-list-container';
            const queryInput = document.getElementById('verb-search-input');
            const query = queryInput ? queryInput.value.toLowerCase() : '';
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const isSearchMode = document.getElementById('verb-search-container').classList.contains('search-active');
            
            container.innerHTML = '';
            
            // In search mode, ensure container is styled for overlay scroll if needed
            if (isSearchMode) {
                container.className = "search-results-condensed"; // Use fixed/scroll style
            } else {
                container.className = "bg-white rounded-xl shadow-sm border border-gray-200 divide-y divide-gray-100 overflow-hidden mb-6 mt-4 transition-all";
            }

            const sortedVerbs = [...VERB_DB].sort((a,b) => {
                if (verbSortMode === 'frequency') {
                    if (a.rank === b.rank) return a.infinitive.localeCompare(b.infinitive);
                    return a.rank - b.rank;
                } else {
                    return a.infinitive.localeCompare(b.infinitive);
                }
            });
            
            const filtered = sortedVerbs.filter(v => 
                v.infinitive.toLowerCase().includes(query) || 
                v.translation.toLowerCase().includes(query)
            );
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center">
                        <p class="text-gray-500 italic mb-4">No local matches for "${query}"</p>
                        <button onclick="fetchVerbDetail('${query}')" class="bg-navy-900 text-white px-6 py-2 rounded-xl font-bold hover:bg-navy-800 transition shadow-lg flex items-center gap-2 mx-auto">
                            <i data-lucide="search" class="w-4 h-4"></i> Search API & Master 1000
                        </button>
                    </div>
                `;
                if(window.lucide) lucide.createIcons();
                return;
            }
            
            filtered.forEach(verb => {
                const rankBadge = `<span class="text-[10px] font-mono bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">#${verb.rank}</span>`;
                const div = document.createElement('div');
                
                if (isSearchMode) {
                    // CONDENSED FORMAT: Exclusive to Search Mode
                    div.className = "p-2 border-b border-gray-100 flex justify-between items-center hover:bg-gray-50 cursor-pointer transition";
                    div.innerHTML = `
                        <div class="flex items-center gap-2">
                            ${rankBadge}
                            <div class="flex items-baseline gap-2">
                                <div class="font-bold text-base text-navy-900 capitalize">${verb.infinitive}</div>
                                <div class="text-xs text-gray-500 truncate max-w-[150px]">${verb.translation}</div>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                    `;
                } else {
                    // EXPANDED FORMAT: Exclusive to Main List
                    div.className = "p-4 flex justify-between items-center hover:bg-gray-50 cursor-pointer transition";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            ${rankBadge}
                            <div>
                                <div class="font-bold text-lg text-navy-900 capitalize">${verb.infinitive}</div>
                                <div class="text-sm text-gray-500">${verb.translation}</div>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300"></i>
                    `;
                }

                div.onclick = () => {
                     // Note: exitSearchMode inside will trigger scroll restoration if in search
                     if (isSearchMode) {
                         exitSearchMode('verbs');
                     }
                     fetchVerbDetail(verb.infinitive);
                };
                container.appendChild(div);
            });
            if(window.lucide) lucide.createIcons();
        }

        window.startDrill = (verbKey) => {
            currentDrillVerb = VERB_DB.find(v => v.infinitive === verbKey);
            if (!currentDrillVerb) return;
            
            // Capture source view to know where to return to
            drillSourceView = document.getElementById('verb-detail-view').classList.contains('hidden') ? 'selection' : 'detail';

            // HIDE EVERYTHING ELSE (Wikipedia and List)
            document.getElementById('verb-selection-view').classList.add('hidden');
            document.getElementById('verb-detail-view').classList.add('hidden');
            document.getElementById('verb-skeleton-view').classList.add('hidden');

            document.getElementById('verb-practice-view').classList.remove('hidden');
            
            document.getElementById('practice-infinitive').textContent = currentDrillVerb.infinitive.charAt(0).toUpperCase() + currentDrillVerb.infinitive.slice(1);
            document.getElementById('practice-translation').textContent = currentDrillVerb.translation;

            renderSettingsCheckboxes(); 
            nextCard();
        }

        window.exitPractice = () => {
             document.getElementById('verb-practice-view').classList.add('hidden');
             
             // Restore correct view based on source
             if (drillSourceView === 'detail') {
                 document.getElementById('verb-detail-view').classList.remove('hidden');
             } else {
                 document.getElementById('verb-selection-view').classList.remove('hidden');
                 filterVerbList();
             }
        }

        window.nextCard = () => {
             const card = document.getElementById('practice-card');
             card.classList.remove('animate-swipe-left', 'animate-swipe-right');
             void card.offsetWidth; 
             
             // If we are in a ticket drill, pick a random verb from the cart
             if (verbTicketCart.length > 0) {
                 const randomVerb = verbTicketCart[Math.floor(Math.random() * verbTicketCart.length)];
                 currentDrillVerb = randomVerb;
                 document.getElementById('practice-infinitive').textContent = currentDrillVerb.infinitive.charAt(0).toUpperCase() + currentDrillVerb.infinitive.slice(1);
                 document.getElementById('practice-translation').textContent = currentDrillVerb.translation;
             }

             const activeTenses = Object.keys(enabledTenses).filter(k => enabledTenses[k]);
             
             if (activeTenses.length === 0) {
                 alert("Please enable at least one tense in settings!");
                 toggleSettingsModal();
                 return;
             }

             // Find available tenses for THIS specific verb that are also enabled
             const availableEnabledTenses = activeTenses.filter(t => currentDrillVerb.conjugations[t]);
             
             if (availableEnabledTenses.length === 0) {
                 // Try to pick another verb from the ticket if applicable
                 console.warn(`Verb ${currentDrillVerb.infinitive} has no enabled tenses.`);
                 return nextCard(); 
             }

             const randomTense = availableEnabledTenses[Math.floor(Math.random() * availableEnabledTenses.length)];
             
             const activeSubjects = ALL_SUBJECTS.filter(s => enabledSubjects[s]);
             if (activeSubjects.length === 0) {
                 alert("Please enable at least one subject in settings!");
                 toggleSettingsModal();
                 return;
             }
             
             // Filter subjects that actually have conjugations for this tense
             const availableSubjects = activeSubjects.filter(sub => currentDrillVerb.conjugations[randomTense][sub]);
             
             if (availableSubjects.length === 0) return nextCard();

             const randomSubject = availableSubjects[Math.floor(Math.random() * availableSubjects.length)];
             const answer = currentDrillVerb.conjugations[randomTense][randomSubject];
             
             currentDrillCard = {
                 subject: randomSubject,
                 answer: answer,
                 tense: randomTense
             };
             
             isCardRevealed = false;
             updateCardUI();
        }

        window.updateCardUI = () => {
             document.getElementById('card-tense').textContent = currentDrillCard.tense;
             document.getElementById('card-subject').textContent = currentDrillCard.subject;
             
             const hiddenEl = document.getElementById('card-hidden');
             const revealedEl = document.getElementById('card-revealed');
             
             if (isCardRevealed) {
                 hiddenEl.classList.add('hidden');
                 revealedEl.classList.remove('hidden');
                 revealedEl.textContent = currentDrillCard.answer;
                 
                 if (document.getElementById('setting-autospeak').checked) {
                     speakText(currentDrillCard.answer);
                 }
             } else {
                 hiddenEl.classList.remove('hidden');
                 revealedEl.classList.add('hidden');
             }
        }

        window.flipCard = () => {
            if (!isCardRevealed) {
                isCardRevealed = true;
                updateCardUI();
            }
        }

        window.handleSwipe = async (direction) => {
             const card = document.getElementById('practice-card');
             const isCorrect = (direction === 'right');
             
             // Track progress in Firestore
             if (userId && currentDrillVerb) {
                 const progressRef = doc(db, `artifacts/${appId}/users/${userId}/verbProgress`, currentDrillVerb.infinitive);
                 try {
                     await setDoc(progressRef, {
                         infinitive: currentDrillVerb.infinitive,
                         lastDrilled: new Date().toISOString(),
                         timesCorrect: increment(isCorrect ? 1 : 0),
                         timesReviewed: increment(1),
                         sessionCorrectCount: increment(isCorrect ? 1 : 0), // Used for daily goal
                         nextReview: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // Stub SRS
                     }, { merge: true });
                 } catch (e) { console.warn("Verb Progress Save Failed", e); }
             }

             if (direction === 'left') {
                 card.classList.add('animate-swipe-left');
             } else {
                 card.classList.add('animate-swipe-right');
             }

             setTimeout(() => {
                 nextCard();
                 updateVerbDashboard(); // Sync dashboard after each conjugation
             }, 350);
        }

        window.speakCurrentCard = () => {
            if (isCardRevealed) {
                speakText(currentDrillCard.answer);
            } else {
                speakText(currentDrillCard.subject);
            }
        }

        window.speakText = (text) => {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES'; 
            window.speechSynthesis.speak(utterance);
        }

        // --- SETTINGS MODAL LOGIC ---
        window.toggleSettingsModal = () => {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
        }

        window.renderSettingsCheckboxes = () => {
             const container = document.getElementById('settings-tenses-container');
             container.innerHTML = '';
             
             // --- 1. SUBJECTS SECTION ---
             const subjectSection = document.createElement('div');
             const allSubjectsEnabled = ALL_SUBJECTS.every(s => enabledSubjects[s]);
             subjectSection.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wide">Subjects</h4>
                    <button onclick="toggleAllSubjects(${!allSubjectsEnabled})" class="text-xs font-bold text-orange-500 hover:text-orange-600">
                        ${allSubjectsEnabled ? 'Disable All' : 'Enable All'}
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2 pl-2 border-l-2 border-gray-100" id="subjects-list"></div>
             `;
             container.appendChild(subjectSection);
             const subList = subjectSection.querySelector('#subjects-list');
             
             ALL_SUBJECTS.forEach(sub => {
                 const div = document.createElement('div');
                 div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100 transition';
                 div.innerHTML = `
                    <span class="text-sm font-medium text-navy-900">${sub}</span>
                    <input type="checkbox" onchange="updateSubjectSetting('${sub}', this.checked)" ${enabledSubjects[sub] ? 'checked' : ''} class="w-5 h-5 accent-navy-900">
                 `;
                 subList.appendChild(div);
             });
             
             container.appendChild(document.createElement('hr')); 

             // --- 2. TENSES SECTIONS ---
             for (const [category, tenses] of Object.entries(TENSE_HIERARCHY)) {
                 const section = document.createElement('div');
                 
                 const allEnabled = tenses.every(t => enabledTenses[t]);
                 
                 section.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wide">${category}</h4>
                        <button onclick="toggleCategory('${category}', ${!allEnabled})" class="text-xs font-bold text-orange-500 hover:text-orange-600">
                            ${allEnabled ? 'Disable All' : 'Enable All'}
                        </button>
                    </div>
                    <div class="space-y-2 pl-2 border-l-2 border-gray-100" id="cat-${category}">
                        <!-- Tenses -->
                    </div>
                 `;
                 container.appendChild(section);
                 
                 const list = section.querySelector(`#cat-${category}`);
                 tenses.forEach(tense => {
                     if (enabledTenses[tense] === undefined) enabledTenses[tense] = false;

                     const div = document.createElement('div');
                     div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100 transition';
                     div.innerHTML = `
                        <span class="text-sm font-medium text-navy-900">${tense}</span>
                        <input type="checkbox" onchange="updateTenseSetting('${tense}', this.checked)" ${enabledTenses[tense] ? 'checked' : ''} class="w-5 h-5 accent-navy-900">
                     `;
                     list.appendChild(div);
                 });
             }
             
             const modalBtn = document.querySelector('#settings-modal button.bg-navy-900');
             modalBtn.onclick = saveSettings; 
        }

        window.toggleAllSubjects = (shouldEnable) => {
            ALL_SUBJECTS.forEach(s => enabledSubjects[s] = shouldEnable);
            renderSettingsCheckboxes();
        }

        window.updateSubjectSetting = (subject, isChecked) => {
            enabledSubjects[subject] = isChecked;
        }

        window.toggleCategory = (category, shouldEnable) => {
            const tenses = TENSE_HIERARCHY[category];
            tenses.forEach(t => enabledTenses[t] = shouldEnable);
            renderSettingsCheckboxes(); 
        }

        window.updateTenseSetting = (tense, isChecked) => {
            enabledTenses[tense] = isChecked;
        }

        // --- VERB API & CACHING ENGINE ---

        window.fetchVerbDetail = async (infinitive) => {
            // Capture scroll before entering
            savedVerbListScroll = window.scrollY;

            // Transition to Skeleton Loader immediately with fade-in
            const skeleton = document.getElementById('verb-skeleton-view');
            skeleton.classList.remove('hidden');
            skeleton.classList.remove('animate-fade-out');
            skeleton.classList.add('animate-fade-in');

            document.getElementById('verb-selection-view').classList.add('hidden');
            document.getElementById('verb-detail-view').classList.add('hidden');
            
            window.scrollTo({ top: 0, behavior: 'auto' });

            const normalized = infinitive.toLowerCase().trim();
            console.log(`[Verb Lab] Triggered fetch for: ${normalized}`);

            const storagePath = `artifacts/spanishbysammy-6a112/public/data/verbs`;

            try {
                // 1. Check shared public cache first
                const cacheRef = doc(db, storagePath, normalized);
                const cacheSnap = await getDoc(cacheRef);

                if (cacheSnap.exists()) {
                    console.log(`[Cache] Found ${normalized} in public cache.`);
                    const cachedData = cacheSnap.data();

                    // PROTECT VERIFIED VERBS: If it's verified, don't even check the API
                    if (cachedData.verified) {
                        console.log(`[Curation] ${normalized} is VERIFIED. Skipping API check.`);
                        displayVerbDetail(cachedData);
                        return;
                    }

                    displayVerbDetail(cachedData);
                } else {
                    // 2. Local Fallback (Static List check before API)
                    const staticMatch = VERB_DB_RAW.find(v => v.infinitive.toLowerCase() === normalized);
                    if (staticMatch) {
                        console.log(`[Local] Found ${normalized} in static/initial drill list.`);
                        displayVerbDetail(staticMatch);
                        return;
                    }

                    // 3. API Fetch (Only if allowed)
                    if (!ALLOW_API_FETCH) {
                        throw new Error(`Verb "${infinitive}" not in curated database and API fetching is disabled.`);
                    }

                    console.log(`[API] Fetching ${normalized} from dictionary API...`);
                    const apiData = await fetchVerbFromAPI(normalized);
                    
                    if (apiData) {
                        // 4. Save to shared public cache
                        try {
                            await setDoc(cacheRef, apiData);
                            console.log(`[Cache] Successfully cached ${normalized} to ${storagePath}`);
                            
                            if (!VERB_DB.find(v => v.infinitive === apiData.infinitive)) {
                                VERB_DB.push(apiData);
                            }
                        } catch (err) { console.warn("[Cache] Storage write failed:", err); }
                        
                        displayVerbDetail(apiData);
                    } else {
                        throw new Error(`Verb "${infinitive}" not found in Dictionary API.`);
                    }
                }
            } catch (error) {
                console.error("[Verb Detail Error]", error);
                showModal("Dictionary Missing", error.message || "We couldn't find that verb right now.");
                // Return to selection on error
                document.getElementById('verb-skeleton-view').classList.add('hidden');
                document.getElementById('verb-selection-view').classList.remove('hidden');
            }
        };

        window.toggleAllowApiFetch = (checked) => {
            ALLOW_API_FETCH = checked;
            showModal("API Config", `Real-time dictionary fetching is now ${ALLOW_API_FETCH ? 'ENABLED' : 'DISABLED'} for this session.`);
        };

        const fetchVerbFromAPI = async (word) => {
            const url = `https://freedictionaryapi.com/api/v1/entries/es/${word}`;
            console.log(`[API Fetch] Requesting: ${url}`);
            const response = await fetch(url);
            if (!response.ok) {
                console.error(`[API Error] Failed to fetch ${word}: ${response.status}`);
                return null;
            }

            const data = await response.json();
            if (!data.entries || data.entries.length === 0) {
                console.warn(`[API Warning] No entries found for ${word}`);
                return null;
            }

            // Map the complex Wiktionary-style JSON to our flat structure
            return mapAPIResponseToVerb(data);
        };

        const mapAPIResponseToVerb = (apiData) => {
            const entry = apiData.entries.find(e => e.partOfSpeech === 'verb') || apiData.entries[0];
            const senses = entry.senses || [];
            
            // 1. Score each sense based on how likely it is to be the "main" meaning
            const scoredSenses = senses.map(s => {
                const def = s.definition.replace(/\[\[|\]\]/g, '').trim();
                const tags = (s.tags || []).map(t => t.toLowerCase());
                
                let score = 0;
                
                // Boost multi-word common usages in Spanish
                if (tags.includes('intransitive')) score += 20;
                if (tags.includes('reflexive')) score += 15;
                if (tags.includes('impersonal')) score += 10;
                
                // Penalize obscure usages
                if (tags.includes('archaic')) score -= 100;
                if (tags.includes('obsolete')) score -= 100;
                if (tags.includes('regional')) score -= 10;
                if (tags.includes('rare')) score -= 50;
                
                // Penalize purely transitive if they are short (often archaic/specific)
                if (tags.includes('transitive') && !tags.includes('intransitive')) {
                    score -= 5;
                }

                // Keyword boosts for highly common but grammatically distinct meanings
                if (def.toLowerCase().includes('to like') || def.toLowerCase().includes('to please')) score += 30;
                if (def.toLowerCase().includes('to be')) score += 30;
                if (def.toLowerCase().includes('to have')) score += 30;

                return { def, score };
            });

            // Sort by score (descending)
            scoredSenses.sort((a, b) => b.score - a.score);
            
            const allDefinitions = scoredSenses.map(s => s.def);
            
            // 2. Determine "Main Translation" (Clean Label) from top scored results
            const cleanDefinitions = allDefinitions.map(def => {
                return def.replace(/^\((transitive|intransitive|reflexive|takes a dative|impersonal|auxiliary)[^)]*\)\s*/i, '');
            });

            // Join the first two cleaned definitions as the translation
            const mainTranslation = cleanDefinitions.slice(0, 2).join('; ');

            const verbObj = {
                infinitive: apiData.word,
                translation: mainTranslation || "no definition",
                rank: 9999, // default rank for dynamic ones
                participle: findForm(entry.forms, ['participle', 'past', 'singular', 'masculine']) || findForm(entry.forms, ['participle', 'past']),
                gerund: findForm(entry.forms, ['gerund']),
                definition: allDefinitions.join('; '), // Semi-colon separated full raw definitions
                conjugations: {}
            };

            const tenseMap = {
                'Indicative': {
                    'Present': ['indicative', 'present'],
                    'Preterite': ['indicative', 'preterite'],
                    'Imperfect': ['indicative', 'imperfect'],
                    'Future': ['indicative', 'future'],
                    'Conditional': ['indicative', 'conditional']
                },
                'Subjunctive': {
                    'Subjunctive Present': ['subjunctive', 'present'],
                    'Subjunctive Imperfect': ['subjunctive', 'imperfect']
                }
            };

            const subjectsTags = {
                'yo': ['first-person', 'singular'],
                't': ['second-person', 'singular'], // Removed 'informal' requirement for broader matching
                'l/ella': ['third-person', 'singular'],
                'nosotros': ['first-person', 'plural'],
                'vosotros': ['second-person', 'plural'],
                'ellos': ['third-person', 'plural'],
                'vos': ['second-person', 'singular', 'vos-form']
            };

            // Loop through moods and tenses to build table
            for (const [mood, tenses] of Object.entries(tenseMap)) {
                for (const [tenseName, tags] of Object.entries(tenses)) {
                    // Specific Handling for Subjunctive Imperfect to get both versions
                    if (tenseName === 'Subjunctive Imperfect') {
                        const raTenseName = 'Subjunctive Imperfect (-ra)';
                        const seTenseName = 'Subjunctive Imperfect (-se)';
                        verbObj.conjugations[raTenseName] = {};
                        verbObj.conjugations[seTenseName] = {};

                        for (const [subject, subTags] of Object.entries(subjectsTags)) {
                            // Find -ra form (standard tags)
                            const raMatch = findForm(entry.forms, [...tags, ...subTags], ['vos-form', 'imperfect-se']);
                            if (raMatch) verbObj.conjugations[raTenseName][subject] = raMatch;

                            // Find -se form (must include imperfect-se tag)
                            const seMatch = findForm(entry.forms, [...tags, ...subTags, 'imperfect-se'], ['vos-form']);
                            if (seMatch) verbObj.conjugations[seTenseName][subject] = seMatch;
                        }
                        
                        // Fallback: If only RA was found, copy it to standard Subjunctive Imperfect for hydration,
                        // but normally hydration handles perfect/progressive based on mood names.
                        if (Object.keys(verbObj.conjugations[raTenseName]).length > 0) {
                            verbObj.conjugations['Subjunctive Imperfect'] = verbObj.conjugations[raTenseName];
                        }
                    } else {
                        verbObj.conjugations[tenseName] = {};
                        for (const [subject, subTags] of Object.entries(subjectsTags)) {
                            // Rule: Match required tags, but avoid vos-form if searching for 't' (second-person singular)
                            const exclusions = subject === 't' ? ['vos-form'] : [];
                            const match = findForm(entry.forms, [...tags, ...subTags], exclusions);
                            if (match) verbObj.conjugations[tenseName][subject] = match;
                        }
                    }
                }
            }

            return verbObj;
        };

        const findForm = (forms, requiredTags, exclusionTags = []) => {
            if (!forms) return null;
            // Find forms that have ALL required tags and NONE of the exclusion tags
            const found = forms.find(f => {
                const hasAllRequired = requiredTags.every(tag => f.tags.includes(tag));
                const hasAnyExcluded = exclusionTags.some(tag => f.tags.includes(tag));
                return hasAllRequired && !hasAnyExcluded;
            });
            return found ? (Array.isArray(found.word) ? found.word[0].replace(/\[\[|\]\]/g, '') : found.word.replace(/\[\[|\]\]/g, '')) : null;
        };

        // Store for verbs fetched from Firestore to ensure they persist across re-hydrations
        let firestoreVerbsCache = [];

        window.fetchVerbsDatabase = async () => {
            console.log("[Verb Lab] initializing Database listener...");
            
            // Immediately populate list with static data if cache is empty
            if (firestoreVerbsCache.length === 0) {
                hydrateVerbData(VERB_DB_RAW);
                if (document.getElementById('tools-conjugation').classList.contains('active')) {
                    filterVerbList();
                }
            }

            try {
                const storagePath = `artifacts/spanishbysammy-6a112/public/data/verbs`;
                const verbsRef = collection(db, storagePath);
                
                onSnapshot(verbsRef, (snapshot) => {
                    firestoreVerbsCache = [];
                    snapshot.forEach((doc) => {
                        firestoreVerbsCache.push(doc.data());
                    });

                    console.log(`[Verb Lab] Sync complete. ${firestoreVerbsCache.length} cached verbs found.`);

                    // Build merged source
                    const combined = [...VERB_DB_RAW];
                    firestoreVerbsCache.forEach(v => {
                        if (!combined.find(c => c.infinitive === v.infinitive)) {
                            combined.push(v);
                        }
                    });

                    // Trigger heavy hydration once
                    hydrateVerbData(combined);
                    
                    // Re-render list if the tab is open
                    if (document.getElementById('tools-conjugation').classList.contains('active')) {
                        filterVerbList();
                    }
                });

            } catch (e) {
                console.error("Error setting up verbs listener:", e);
                hydrateVerbData(VERB_DB_RAW);
            }
        };

        // --- VERB DETAIL UI LOGIC ---

        window.displayVerbDetail = (verbData) => {
            // Decouple Detail logic from global DB state management
            const newsource = [...VERB_DB_RAW];
            firestoreVerbsCache.forEach(v => {
                if (!newsource.find(n => n.infinitive === v.infinitive)) newsource.push(v);
            });
            if (verbData && !newsource.find(v => v.infinitive === verbData.infinitive)) newsource.push(verbData);
            hydrateVerbData(newsource);

            const fullVerb = VERB_DB.find(v => v.infinitive === verbData.infinitive);
            currentDrillVerb = fullVerb || verbData;

            // Final switch: Cross-fade from skeleton to actual data
            const skeleton = document.getElementById('verb-skeleton-view');
            const detailView = document.getElementById('verb-detail-view');

            detailView.classList.remove('hidden');
            detailView.classList.remove('animate-fade-out');
            detailView.classList.add('animate-fade-in');

            // Hide skeleton immediately as detailView fades in over it
            skeleton.classList.add('hidden');
            skeleton.classList.remove('animate-fade-in');

            document.getElementById('verb-selection-view').classList.add('hidden');

            document.getElementById('detail-infinitive').textContent = currentDrillVerb.infinitive;
            document.getElementById('detail-translation').textContent = currentDrillVerb.translation;
            document.getElementById('detail-rank').textContent = currentDrillVerb.rank || '...';
            document.getElementById('detail-participle').textContent = currentDrillVerb.participle || '...';
            document.getElementById('detail-gerund').textContent = currentDrillVerb.gerund || '...';
            
            // ADMIN UI: Show Edit Button & Verified Badge
            const isAdmin = auth.currentUser && auth.currentUser.email === ADMIN_EMAIL;
            const editBtn = document.getElementById('admin-edit-btn');
            const verifiedIcon = document.getElementById('detail-verified-icon');
            
            if (editBtn) editBtn.classList.toggle('hidden', !isAdmin);
            if (verifiedIcon) verifiedIcon.classList.toggle('hidden', !currentDrillVerb.verified);

            // Enhanced Definition Rendering: Split the joined definitions into a list
            let defHtml = `<p class="italic text-gray-400 mb-2">Definitions:</p><ul class="space-y-3">`;
            
            const rawDefinition = currentDrillVerb.definition || currentDrillVerb.translation || "No definition available";
            const parts = rawDefinition.split(';');
            
            parts.forEach(p => {
                if (p.trim()) {
                    let cleaned = p.trim();
                    // Optional: highlight tech tags within the list items
                    cleaned = cleaned.replace(/^(\([^)]+\))/i, '<span class="text-xs font-bold text-gray-400 mr-1">$1</span>');
                    defHtml += `<li class="flex gap-2 text-sm leading-relaxed"><span class="text-orange-500 font-bold"></span><div>${cleaned}</div></li>`;
                }
            });
            defHtml += `</ul>`;
            document.getElementById('detail-definition').innerHTML = defHtml;

            renderVerbTables();
            window.scrollTo(0,0);
            if(window.lucide) lucide.createIcons();
        };

        window.exitVerbDetail = () => {
             const detailView = document.getElementById('verb-detail-view');
             detailView.classList.remove('animate-fade-in');
             detailView.classList.add('animate-fade-out');

             setTimeout(() => {
                 detailView.classList.add('hidden');
                 detailView.classList.remove('animate-fade-out');
                 
                 document.getElementById('verb-selection-view').classList.remove('hidden');
                 
                 // Restore scroll position
                 window.scrollTo({
                     top: savedVerbListScroll,
                     behavior: 'auto'
                 });
                 
                 filterVerbList();
             }, 250);
        };

        window.renderVerbTables = () => {
            const container = document.getElementById('tables-container');
            const showVos = document.getElementById('toggle-vos').checked;
            const showVosotros = document.getElementById('toggle-vosotros').checked;
            const verbData = currentDrillVerb;
            
            if (!verbData || !verbData.conjugations) return;
            
            container.innerHTML = '';

            for (const [category, tenses] of Object.entries(TENSE_HIERARCHY)) {
                const hasAnyTense = tenses.some(t => verbData.conjugations[t]);
                if (!hasAnyTense) continue;

                const sectionEl = document.createElement('div');
                sectionEl.className = "space-y-6";
                sectionEl.innerHTML = `<h5 class="font-black text-navy-900 border-b-2 border-orange-500/20 pb-2 mb-4 uppercase text-[10px] tracking-[0.2em]">${category}</h5>`;
                
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-12 lg:gap-x-16 gap-y-10 items-start";

                tenses.forEach(tense => {
                    let displayTenseName = tense;
                    let conjPool = verbData.conjugations[tense];
                    let secondaryPool = null;

                    if (tense === 'Subjunctive Imperfect') {
                        conjPool = verbData.conjugations['Subjunctive Imperfect (-ra)'];
                        secondaryPool = verbData.conjugations['Subjunctive Imperfect (-se)'];
                        if (!conjPool) conjPool = verbData.conjugations['Subjunctive Imperfect'];
                        displayTenseName = "Subj. Imperfect (-ra / -se)";
                    }

                    if (!conjPool) return;
                    
                    const tenseBox = document.createElement('div');
                    tenseBox.className = "min-w-[280px] mb-4";
                    tenseBox.innerHTML = `
                        <h6 class="font-black text-sm text-navy-900 mb-4 flex items-center gap-2 px-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-orange-500"></span>
                            ${displayTenseName}
                        </h6>
                    `;
                    
                    const list = document.createElement('div');
                    list.className = "space-y-1";
                    
                    let subjects = [
                        { id: 'yo', label: 'yo' },
                        { id: 't', label: 't' },
                        { id: 'l/ella', label: 'l/ella/ud.' },
                        { id: 'nosotros', label: 'nosotros' },
                        { id: 'ellos', label: 'ellos/as/uds.' }
                    ];

                    if (showVos && conjPool['vos']) subjects.splice(2, 0, { id: 'vos', label: 'vos' });
                    if (showVosotros && (conjPool['vosotros'] || (secondaryPool && secondaryPool['vosotros']))) 
                        subjects.splice(subjects.findIndex(s => s.id === 'nosotros') + 1, 0, { id: 'vosotros', label: 'vosotros' });

                    subjects.forEach((subObj) => {
                        const sub = subObj.id;
                        const label = subObj.label;
                        const word1 = conjPool[sub] || '---';
                        const word2 = secondaryPool ? (secondaryPool[sub] || null) : null;
                        
                        const item = document.createElement('div');
                        item.className = "flex justify-between items-center border-b border-gray-200 py-1.5 last:border-0 h-10 group/row";
                        
                        const buildFormHtml = (word) => {
                            if (word === '---') return `<span class="text-gray-300">---</span>`;
                            return `
                                <div class="flex items-center gap-2 cursor-pointer group/audio" onclick="speakText('${word}')">
                                    <i data-lucide="volume-2" class="w-3 h-3 text-gray-300 group-hover/audio:text-orange-500 transition-colors"></i>
                                    <span class="text-navy-900 font-bold group-hover/audio:text-orange-600 transition-colors underline-offset-4">${word}</span>
                                </div>
                            `;
                        };

                        let wordsHtml = '';
                        if (word2) {
                            wordsHtml = `
                                <div class="flex flex-grow justify-end gap-3 items-center ml-4">
                                    ${buildFormHtml(word1)}
                                    <span class="text-gray-200 text-xs">/</span>
                                    ${buildFormHtml(word2)}
                                </div>
                            `;
                        } else {
                            wordsHtml = `
                                <div class="flex flex-grow justify-end ml-4">
                                    ${buildFormHtml(word1)}
                                </div>
                            `;
                        }

                        item.innerHTML = `
                            <span class="text-gray-400 font-bold lowercase w-28 text-[10px] sm:text-xs tracking-tight flex-shrink-0">${label}</span>
                            ${wordsHtml}
                        `;
                        list.appendChild(item);
                    });

                    tenseBox.appendChild(list);
                    grid.appendChild(tenseBox);
                });

                sectionEl.appendChild(grid);
                container.appendChild(sectionEl);
            }
            if (window.lucide) lucide.createIcons();
        };

        // --- VERB DASHBOARD & PROGRESS LOGIC ---

        window.updateVerbDashboard = async () => {
            if (!userId) return;
            // ring-verbs-mastery: Progress toward "Master 1,000" (Total unique verbs conjugated correctly at least once)
            // ring-verbs-daily: Daily conjugation session goal
            // ring-verbs-review: Verb Spaced Repetition (VRS) coverage
            
            try {
                const progressPath = `artifacts/${appId}/users/${userId}/verbProgress`;
                const progressRef = collection(db, progressPath);
                const snapshot = await getDocs(progressRef);
                
                let uniqueVerbsDrilled = 0;
                let todayConjugations = 0;
                let dueVRS = 0;
                const now = new Date();
                const todayStart = new Date();
                todayStart.setHours(0,0,0,0);

                const activityDates = new Set();

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    
                    // Increment mastery if this verb has been drilled ever
                    if (data.timesCorrect > 0 || data.timesReviewed > 0) uniqueVerbsDrilled++;
                    
                    // Daily goal check
                    if (data.lastDrilled && new Date(data.lastDrilled) >= todayStart) {
                        todayConjugations += (data.sessionCorrectCount || 1); // If we track per session
                        activityDates.add(new Date(data.lastDrilled).toDateString());
                    }

                    // VRS Check
                    if (data.nextReview && new Date(data.nextReview) <= now) {
                        dueVRS++;
                    }
                });

                // Update UI Labels
                const verbStreak = calculateStreakFromDates(Array.from(activityDates));
                document.getElementById('dash-verb-due-count').textContent = dueVRS;
                document.getElementById('dash-verb-streak-count').textContent = `${verbStreak} Days`;
                
                // Mastery Ring based on 1,000 verb goal
                const masteryGoal = 1000;
                const masteryPct = Math.min(100, (uniqueVerbsDrilled / masteryGoal) * 100);
                document.getElementById('dash-verb-pct').textContent = Math.round(masteryPct) + "%";
                updateRing('ring-verbs-mastery', masteryPct, 45);

                // Daily Goal Ring (e.g. 50 conjugations per day)
                const dailyGoal = 50;
                const dailyPct = Math.min(100, (todayConjugations / dailyGoal) * 100);
                updateRing('ring-verbs-daily', dailyPct, 35);

                // Review Maintenance Ring
                // (Total Drilled - Due) / Total Drilled = Survival Rate
                let reviewPct = 100;
                if (uniqueVerbsDrilled > 0) {
                    reviewPct = Math.max(0, ((uniqueVerbsDrilled - dueVRS) / uniqueVerbsDrilled) * 100);
                }
                updateRing('ring-verbs-review', reviewPct, 25);

            } catch (e) { 
                console.error("Verb Dashboard Error:", e);
                // Fallback UI reset
                updateRing('ring-verbs-mastery', 0, 45);
                updateRing('ring-verbs-daily', 0, 35);
                updateRing('ring-verbs-review', 0, 25);
            }
        };

        window.openAdminEdit = () => {
            if (!currentDrillVerb) return;
            const modal = document.getElementById('admin-edit-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            
            document.getElementById('edit-translation').value = currentDrillVerb.translation || '';
            document.getElementById('edit-rank').value = currentDrillVerb.rank || 9999;
            document.getElementById('edit-definitions').value = currentDrillVerb.definition || currentDrillVerb.translation || '';
            document.getElementById('edit-verified').checked = currentDrillVerb.verified || false;
        };

        window.closeAdminEdit = () => {
            const modal = document.getElementById('admin-edit-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        };

        window.saveAdminEdit = async () => {
            if (!currentDrillVerb || !db || !userId) return;
            
            const newTranslation = document.getElementById('edit-translation').value.trim();
            const newRank = parseInt(document.getElementById('edit-rank').value) || 9999;
            const newDefinitions = document.getElementById('edit-definitions').value.trim();
            const isVerified = document.getElementById('edit-verified').checked;

            showLoading("Saving curated data...");
            
            try {
                const storagePath = `artifacts/spanishbysammy-6a112/public/data/verbs`;
                const verbRef = doc(db, storagePath, currentDrillVerb.infinitive);
                
                const updatePayload = {
                    translation: newTranslation,
                    rank: newRank,
                    definition: newDefinitions,
                    verified: isVerified,
                    lastCuratedAt: new Date().toISOString(),
                    curatedBy: userId
                };

                await setDoc(verbRef, updatePayload, { merge: true });
                
                // Update local state instantly
                Object.assign(currentDrillVerb, updatePayload);
                
                // Refresh View
                displayVerbDetail(currentDrillVerb);
                closeAdminEdit();
                showModal("Success", `"${currentDrillVerb.infinitive}" has been curated and marked as ${isVerified ? 'VERIFIED' : 'updated'}.`);
            } catch (e) {
                console.error("Curation Save Error:", e);
                showModal("Error", "Failed to save curated data.");
            } finally {
                hideLoading();
            }
        };

        window.addToVerbTicket = () => {
            if (!currentDrillVerb) return;
            
            const existing = verbTicketCart.find(v => v.infinitive === currentDrillVerb.infinitive);
            if (existing) {
                showModal("Already Added", `"${currentDrillVerb.infinitive}" is already in your ticket cart.`);
                return;
            }

            verbTicketCart.push(currentDrillVerb);
            updateCartUI();
            
            // Visual feedback on the button
            const btn = document.querySelector('button[onclick="addToVerbTicket()"]');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i> Added!`;
            btn.classList.add('bg-green-500');
            btn.classList.remove('bg-white/10');
            if(window.lucide) lucide.createIcons();

            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('bg-green-500');
                btn.classList.add('bg-white/10');
                if(window.lucide) lucide.createIcons();
                exitVerbDetail(); // Optional flow: go back to selection
            }, 1000);
        };

        window.updateCartUI = () => {
            const indicator = document.getElementById('verb-ticket-cart-indicator');
            const countEl = document.getElementById('cart-count');
            
            if (verbTicketCart.length > 0) {
                indicator.classList.remove('hidden');
                countEl.textContent = verbTicketCart.length;
            } else {
                indicator.classList.add('hidden');
            }
            if(window.lucide) lucide.createIcons();
        };

        window.clearVerbTicket = () => {
            verbTicketCart = [];
            updateCartUI();
        };

        window.launchVerbTicket = () => {
             if (verbTicketCart.length === 0) return;
             
             // Pick standard tenses for the ticket run
             ["Present", "Preterite", "Imperfect"].forEach(t => enabledTenses[t] = true);
             
             // Custom Drill logic that takes a list
             startTicketDrill();
        };

        window.startTicketDrill = () => {
            document.getElementById('verb-selection-view').classList.add('hidden');
            document.getElementById('verb-practice-view').classList.remove('hidden');
            
            // For a ticket, startDrill needs to cycle through ALL verbs in cart
            // We'll modify nextCard to prioritize the ticket list if it exists
            nextCard();
        };

        window.launchDueVerbReview = () => {
             showModal("Coming Soon", "Verb Maintenance (VRS) is being initialized.");
        };

        window.startLearningNewVerbs = () => {
             // Logic to pick un-drilled verbs from the Master 1000 and launch a ticket
             showModal("Verb Path", "Launching the directed learning path for your level.");
        };

        window.openVerbReviewTicket = () => {
             showModal("Builder", "Verb Ticket Builder is being implemented.");
        };

        window.studyCurrentVerb = () => {
            if (!currentDrillVerb) return;
            // standard subjects/tenses or all? For single verb study, let's enable all common indicative/subjunctive
            ["Present", "Preterite", "Imperfect"].forEach(t => enabledTenses[t] = true);
            startDrill(currentDrillVerb.infinitive);
        };

        window.seedVerbsDatabase = async () => {
            if (!userId) return alert("Please log in first to seed the database.");
            if(!confirm("Are you sure you want to upload all local verbs to the database?")) return;

            showLoading("Seeding Verbs Database...");
            try {
                const verbsCollectionPath = `artifacts/${appId}/public/data/verbs`;
                const verbsRef = collection(db, verbsCollectionPath);
                
                let count = 0;
                for (const verb of VERB_DB_RAW) {
                    await setDoc(doc(verbsRef, verb.infinitive), verb);
                    count++;
                }
                
                alert(`Successfully seeded ${count} verbs to Firestore!`);
                fetchVerbsDatabase();
                
            } catch (error) {
                console.error("Seeding Error:", error);
                alert("Error seeding database: " + error.message);
            } finally {
                hideLoading();
            }
        }

        // --- RENDERING & ROUTING ---

        const renderDeckProgress = () => {
            let completedCount = 0;
            SPANISH_DECKS.forEach(deck => {
                const btn = document.getElementById('btn-' + deck.id);
                if (!btn) return;
                const isCompleted = userProgress[deck.id]?.status === 'complete';
                if (isCompleted) {
                    completedCount++;
                    btn.classList.remove('border-gray-300', 'text-gray-400', 'hover:bg-gray-50');
                    btn.classList.add('bg-green-500', 'text-white', 'border-green-500', 'hover:bg-green-600');
                    btn.querySelector('.status-text').textContent = "Completed";
                } else {
                    btn.classList.remove('bg-green-500', 'text-white', 'border-green-500', 'hover:bg-green-600');
                    btn.classList.add('border-2', 'border-gray-300', 'text-gray-400', 'hover:bg-gray-50');
                    btn.querySelector('.status-text').textContent = "Mark Complete";
                }
            });
            const totalEl = document.getElementById('total-completed');
            if(totalEl) totalEl.textContent = completedCount;
        }

        window.handleSetOpen = (setId, setName) => {
            lastStudiedSet = { id: setId, name: setName };
            updateFlashcardDashboard();
        }

        window.showZipfInfo = () => {
            showModal("Zipf's Law & Fluency", 
                "Linguist George Zipf discovered that a small number of words are used very frequently. \n\n" +
                " Top 1,000 words  80% of daily speech.\n" +
                " Top 3,000 words  95% of daily speech.\n\n" +
                "Your 'Wall' progress tracks how close you are to mastering these high-frequency terms."
            );
        };

        window.showReviewInfo = () => {
            showModal("Maintenance & SRS", 
                "We use Spaced Repetition (SRS) to schedule your reviews. \n\n" +
                " 1st Review: Due in 3 days\n" +
                " 2nd Review: Due in 7 days\n" +
                " 3rd Review: Due in 15 days\n" +
                " 4th Review: Due in 30 days\n" +
                " 5+ Reviews: Due in 60 days\n\n" +
                "Colors indicate urgency:\n" +
                " Green: Fresh (Safe)\n" +
                " Yellow: Review Soon\n" +
                " Red: Review Now!"
            );
        };

        // --- DASHBOARD CAROUSEL LOGIC ---
        window.switchDashboardView = (direction) => {
            currentDashboardSlide += direction;
            if (currentDashboardSlide < 0) currentDashboardSlide = 0;
            if (currentDashboardSlide > 2) currentDashboardSlide = 2;

            const track = document.getElementById('dashboard-track');
            const prevBtn = document.getElementById('dash-nav-prev');
            const nextBtn = document.getElementById('dash-nav-next');
            const studyBtn = document.getElementById('dash-nav-study');
            const reviewBtn = document.getElementById('dash-nav-review');
            const reportsBtn = document.getElementById('dash-nav-reports');

            track.style.transform = `translateX(-${currentDashboardSlide * 33.333}%)`;

            // Update navigation buttons
            if (studyBtn) studyBtn.classList.toggle('bg-orange-500', currentDashboardSlide === 0);
            if (studyBtn) studyBtn.classList.toggle('text-white', currentDashboardSlide === 0);
            if (studyBtn) studyBtn.classList.toggle('bg-gray-200', currentDashboardSlide !== 0);
            if (studyBtn) studyBtn.classList.toggle('text-gray-700', currentDashboardSlide !== 0);

            if (reviewBtn) reviewBtn.classList.toggle('bg-orange-500', currentDashboardSlide === 1);
            if (reviewBtn) reviewBtn.classList.toggle('text-white', currentDashboardSlide === 1);
            if (reviewBtn) reviewBtn.classList.toggle('bg-gray-200', currentDashboardSlide !== 1);
            if (reviewBtn) reviewBtn.classList.toggle('text-gray-700', currentDashboardSlide !== 1);

            if (reportsBtn) reportsBtn.classList.toggle('bg-orange-500', currentDashboardSlide === 2);
            if (reportsBtn) reportsBtn.classList.toggle('text-white', currentDashboardSlide === 2);
            if (reportsBtn) reportsBtn.classList.toggle('bg-gray-200', currentDashboardSlide !== 2);
            if (reportsBtn) reportsBtn.classList.toggle('text-gray-700', currentDashboardSlide !== 2);

            // Hide prev/next buttons at extremes
            if (prevBtn) prevBtn.style.display = currentDashboardSlide === 0 ? 'none' : 'block';
            if (nextBtn) nextBtn.style.display = currentDashboardSlide === 2 ? 'none' : 'block';
        };

        const getDaysAgo = (dateString) => {
            if (!dateString) return null;
            const diff = new Date() - new Date(dateString);
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

        // --- SAVED TICKETS LOGIC ---

        window.toggleSaveInput = (show) => {
            const container = document.getElementById('ticket-save-input-container');
            if (show) {
                container.classList.remove('hidden');
                document.getElementById('ticket-save-name').focus();
            } else {
                container.classList.add('hidden');
                document.getElementById('ticket-save-name').value = '';
            }
        };

        window.confirmSaveTicket = async () => {
            const name = document.getElementById('ticket-save-name').value.trim();
            if (!name) {
                alert("Please enter a name for your ticket.");
                return;
            }

            if (!userId) {
                alert("You must be logged in to save tickets.");
                return;
            }

            // Limit check (only for new tickets)
            if (!currentLoadedTicketId && savedTickets.length >= 4) {
                alert("Maximum of 4 saved tickets allowed. Delete or edit an existing one.");
                return;
            }

            const ticketData = getTicketModalData();
            ticketData.name = name;
            
            // Capture eligible count at time of save
            const counterEl = document.getElementById('ticket-eligible-count');
            ticketData.eligibleCount = counterEl ? parseInt(counterEl.textContent) || 0 : 0;

            showLoading("Saving shortcut...");
            console.log("Attempting to save ticket...", { userId, appId, currentLoadedTicketId, ticketData });

            try {
                const ticketsRef = collection(db, `artifacts/${appId}/users/${userId}/savedTickets`);
                const docRef = currentLoadedTicketId ? doc(ticketsRef, currentLoadedTicketId) : doc(ticketsRef);
                
                await setDoc(docRef, {
                    ...ticketData,
                    updatedAt: new Date().toISOString(),
                    lastUsedAt: currentLoadedTicketId ? (savedTickets.find(t => t.id === currentLoadedTicketId)?.lastUsedAt || null) : null,
                    deleted: false
                }, { merge: true });

                console.log("Ticket saved successfully. ID:", docRef.id);
                currentLoadedTicketId = docRef.id;
                toggleSaveInput(false);
                hideLoading();
                showModal("Success", "Review ticket saved successfully!");
                fetchSavedTickets();
            } catch (e) {
                console.error("Save failed specifically:", e);
                alert("Failed to save ticket. Check console for details.");
                hideLoading();
            }
        };

        window.fetchSavedTickets = async () => {
            if (!userId) return;
            try {
                const ticketsRef = collection(db, `artifacts/${appId}/users/${userId}/savedTickets`);
                const snapshot = await getDocs(ticketsRef);
                savedTickets = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(t => t.deleted !== true);
                
                renderSavedTicketShortcuts();
                
                // NEW: Trigger live count updates for all saved tickets
                updateAllSavedTicketCounts();
            } catch (e) {
                console.warn("Failed to fetch tickets:", e);
            }
        };

        window.updateAllSavedTicketCounts = async () => {
            if (!userId || !savedTickets.length) return;
            
            console.log(" Starting live update for saved ticket counts...");
            
            // Optimization: Fetch shared data once for all tickets
            const progressRef = collection(db, `artifacts/${appId}/users/${userId}/cardProgress`);
            const progressSnapshot = await getDocs(progressRef);
            const progressMap = {};
            progressSnapshot.docs.forEach(doc => progressMap[doc.id] = { id: doc.id, ...doc.data() });

            for (const ticket of savedTickets) {
                try {
                    // Reuse getEligibleReviewCards but pass our pre-fetched progressMap for speed
                    // We modify the helper slightly or just let it fetch (cached mostly)
                    // For now we'll call it normally as it's most reliable
                    const ids = await getEligibleReviewCards(ticket);
                    
                    const countEl = document.getElementById(`saved-ticket-count-${ticket.id}`);
                    if (countEl) {
                        countEl.textContent = ids.length;
                        countEl.classList.remove('animate-pulse', 'text-gray-400');
                        countEl.classList.add('text-navy-900');
                    }
                    
                    // Optional: Persist new count to DB if it changed significantly
                    if (ticket.eligibleCount !== ids.length) {
                        const ticketsRef = collection(db, `artifacts/${appId}/users/${userId}/savedTickets`);
                        await setDoc(doc(ticketsRef, ticket.id), { eligibleCount: ids.length }, { merge: true });
                    }
                } catch (e) {
                    console.error(`Failed to update count for ticket ${ticket.id}`, e);
                }
            }
        };

        window.toggleSavedTicketsCollapse = () => {
            toggleAccordion('saved-tickets-collapse');
            const icon = document.getElementById('saved-tickets-chevron');
            // chevron rotation handled by toggleAccordion via icon ID mapping
        };

        window.renderSavedTicketShortcuts = () => {
            const container = document.getElementById('saved-tickets-container');
            const collapseContainer = document.getElementById('content-saved-tickets-collapse');
            if (!container) return;

            // 1. COLLAPSE LOGIC: Expand if tickets exist and it's currently closed
            if (savedTickets.length > 0 && collapseContainer && !collapseContainer.classList.contains('open')) {
                toggleSavedTicketsCollapse();
            }

            // 2. SORT: By lastUsedAt (desc)
            const sorted = [...savedTickets].sort((a,b) => {
                const timeA = b.lastUsedAt ? new Date(b.lastUsedAt) : new Date(0);
                const timeB = a.lastUsedAt ? new Date(a.lastUsedAt) : new Date(0);
                if (timeA - timeB !== 0) return timeA - timeB;
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            });
            
            let html = '';

            // Render existing tickets
            sorted.slice(0, 4).forEach(ticket => {
                const dateStr = ticket.lastUsedAt ? new Date(ticket.lastUsedAt).toLocaleDateString() : 'Never';
                
                html += `
                    <div class="ticket-slot ticket-modern-pass flex flex-col h-40 overflow-hidden rounded-xl" onclick="openSavedTicket('${ticket.id}')">
                        <div class="h-2/3 p-4 flex flex-col justify-center items-center text-center">
                            <i data-lucide="ticket" class="w-8 h-8 text-navy-900 mb-2 opacity-10 group-hover:opacity-20 transition"></i>
                            <span class="text-[10px] md:text-xs font-black uppercase tracking-tight text-navy-900 line-clamp-1 h-8 flex items-center">${ticket.name}</span>
                            <div class="flex items-center gap-1 mt-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                                <span class="text-[8px] font-bold text-gray-400 uppercase tracking-widest">Active</span>
                            </div>
                        </div>
                        <div class="h-1/3 bg-gray-50 border-t border-dashed border-gray-200 p-3 flex items-center justify-between px-4">
                            <div class="flex flex-col">
                                <span class="text-[7px] font-bold text-gray-400 uppercase">Items</span>
                                <span id="saved-ticket-count-${ticket.id}" class="text-[10px] font-black text-navy-900 italic leading-none animate-pulse text-gray-400">${ticket.eligibleCount || '...'}</span>
                            </div>
                            <div class="vertical-divider h-full mx-1"></div>
                            <div class="flex flex-col items-end">
                                <span class="text-[7px] font-bold text-gray-400 uppercase">Last Run</span>
                                <span class="text-[8px] font-black text-navy-900 uppercase leading-none">${dateStr}</span>
                            </div>
                        </div>

                        <!-- Actions Layer -->
                        <div class="absolute top-1 right-1 z-20">
                            <button onclick="event.stopPropagation(); deleteSavedTicket('${ticket.id}')" class="text-gray-200 hover:text-red-500 p-1.5 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            // 3. NEW TICKET BUTTON (Only if < 4)
            if (sorted.length < 4) {
                html += `
                    <div class="ticket-slot border-2 border-dashed border-gray-200 rounded-2xl flex flex-col items-center justify-center p-4 h-40 text-gray-400 hover:border-navy-900 hover:text-navy-900 cursor-pointer transition group" onclick="openReviewTicket()">
                        <i data-lucide="plus-circle" class="w-8 h-8 mb-2 group-hover:scale-110 transition"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">New Ticket</span>
                    </div>
                `;
                
                // Add remaining empty slots
                const emptyCount = 4 - sorted.length - 1;
                for (let i = 0; i < emptyCount; i++) {
                    html += `
                        <div class="ticket-slot border-2 border-dashed border-gray-50 rounded-2xl h-40 flex items-center justify-center text-gray-100">
                            <i data-lucide="lock" class="w-6 h-6 opacity-30"></i>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
            if (window.lucide) lucide.createIcons();
            
            // Limit Save UI in Modal
            const saveBtnInit = document.getElementById('btn-save-ticket-init');
            if (saveBtnInit) {
                if (savedTickets.length >= 4) {
                    saveBtnInit.disabled = true;
                    saveBtnInit.title = "Max 4 tickets reached";
                } else {
                    saveBtnInit.disabled = false;
                }
            }
        };

        window.openSavedTicket = async (id) => {
            const ticket = savedTickets.find(t => t.id === id);
            if (!ticket) return;
            
            // Record usage
            try {
                const ticketsRef = collection(db, `artifacts/${appId}/users/${userId}/savedTickets`);
                await setDoc(doc(ticketsRef, id), { lastUsedAt: new Date().toISOString() }, { merge: true });
                // We'll update state locally eventually but launch takes priority
            } catch (e) { console.error("Usage tracking failed:", e); }

            openReviewTicket(ticket);
        };

        window.deleteSavedTicket = (id) => {
            showConfirmModal(
                "Delete Shortcut?",
                "Are you sure you want to remove this saved ticket? This action cannot be undone.",
                async () => {
                    try {
                        const ticketsRef = collection(db, `artifacts/${appId}/users/${userId}/savedTickets`);
                        await setDoc(doc(ticketsRef, id), { deleted: true }, { merge: true });
                        savedTickets = savedTickets.filter(t => t.id !== id);
                        renderSavedTicketShortcuts();
                    } catch (e) { 
                        console.error("Del failed:", e);
                        showModal("Error", "Failed to delete ticket.");
                    }
                },
                "Delete",
                true
            );
        };

        window.getTicketModalData = () => {
            const selectedLevels = [];
            ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'].forEach(lvl => {
                const el = document.getElementById(`ticket-lvl-${lvl}`);
                if (el && el.checked) selectedLevels.push(lvl);
            });

            const selectedTopics = [];
            document.querySelectorAll('#ticket-topics-grid input:checked').forEach(input => {
                selectedTopics.push(input.id.replace('ticket-topic-', ''));
            });

            const selectedPOS = [];
            document.querySelectorAll('#ticket-pos-grid input:checked').forEach(input => {
                selectedPOS.push(input.id.replace('ticket-pos-', ''));
            });

            const strategyEl = document.querySelector('input[name="ticket-type"]:checked');
            const sizeEl = document.querySelector('input[name="ticket-size"]:checked');

            let sessionSize = 20;
            if (sizeEl) {
                sessionSize = sizeEl.value === 'all' ? 'all' : parseInt(sizeEl.value);
            }

            return {
                levels: selectedLevels,
                topics: selectedTopics,
                pos: selectedPOS,
                strategy: strategyEl ? strategyEl.value : 'mixed',
                size: sessionSize
            };
        };

        window.openReviewTicket = (prefill = null) => {
            console.log("Opening Review Ticket Modal...", prefill);
            const builder = document.getElementById('review-ticket-builder');
            const content = document.getElementById('review-ticket-modal-content');
            if (!builder || !content) return;

            // Update Header dynamically
            const titleEl = document.getElementById('ticket-modal-title');
            const subEl = document.getElementById('ticket-modal-subtitle');
            if (titleEl && subEl) {
                if (prefill) {
                    titleEl.textContent = "SAVED TICKET";
                    subEl.textContent = prefill.name || "Custom Ticket";
                } else {
                    titleEl.textContent = "REVIEW TICKET";
                    subEl.textContent = "Generator 2.0";
                }
            }

            builder.classList.remove('hidden', 'animate-fade-out');
            builder.classList.add('animate-fade-in');
            builder.style.display = 'flex';

            content.classList.remove('animate-slide-down');
            content.classList.add('animate-slide-up');

            currentLoadedTicketId = prefill ? prefill.id : null;
            currentLoadedTicketName = prefill ? prefill.name : null;
            toggleSaveInput(false); // Reset save UI

            try {
                // 1. POPULATE TOPICS & POS Dynamic grids
                const topicsGrid = document.getElementById('ticket-topics-grid');
                const posGrid = document.getElementById('ticket-pos-grid');
                
                if (flashcardData && flashcardData.length) {
                    const uniqueTopics = new Set();
                    const uniquePOS = new Set();

                    // Scanner logic: Only show topics for sets the user has COMPLETED
                    flashcardData.forEach(l => {
                        l.sets?.forEach(s => {
                            const isCompleted = userProgress[s.setID]?.status === 'complete';
                            if (isCompleted) {
                                let topic = s.title;
                                if (s.title.includes(':')) {
                                    const parts = s.title.split(':');
                                    topic = parts[1].split('&')[0].trim();
                                }
                                if (topic) uniqueTopics.add(topic);
                            }
                        });
                    });

                    // Comprehensive POS list based on typical dictionary data
                    ['Noun', 'Verb', 'Adjective', 'Adverb', 'Pronoun', 'Preposition', 'Conjunction', 'Article', 'Determiner'].forEach(p => uniquePOS.add(p));

                    if (topicsGrid) {
                        const sortedTopics = Array.from(uniqueTopics).sort();
                        topicsGrid.innerHTML = sortedTopics.map(topic => `
                            <div class="checkbox-pill">
                                <input type="checkbox" id="ticket-topic-${topic}" class="hidden" 
                                    ${(prefill && prefill.topics.includes(topic)) ? 'checked' : ''} onchange="updateTicketCounter()">
                                <label for="ticket-topic-${topic}" class="px-3 py-1.5 rounded-full border border-gray-200 font-bold text-gray-500 cursor-pointer block hover:bg-gray-50 transition text-xs">${topic}</label>
                            </div>
                        `).join('');
                        document.getElementById('ticket-topics-container').classList.remove('hidden');
                    }

                    if (posGrid) {
                        posGrid.innerHTML = Array.from(uniquePOS).map(p => `
                            <div class="checkbox-pill">
                                <input type="checkbox" id="ticket-pos-${p}" class="hidden" 
                                    ${(prefill && prefill.pos.includes(p)) ? 'checked' : ''} onchange="updateTicketCounter()">
                                <label for="ticket-pos-${p}" class="px-3 py-1.5 rounded-full border border-gray-200 font-bold text-gray-500 cursor-pointer block hover:bg-gray-50 transition text-xs">${p}</label>
                            </div>
                        `).join('');
                        document.getElementById('ticket-pos-container').classList.remove('hidden');
                    }
                }

                // 2. APPLY DEFAULTS OR PREFILLS (Levels, Strategy, Size)
                if (prefill) {
                    ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'].forEach(lvl => {
                        const el = document.getElementById(`ticket-lvl-${lvl}`);
                        if (el) el.checked = prefill.levels.includes(lvl);
                    });
                    
                    const stratEl = document.querySelector(`input[name="ticket-type"][value="${prefill.strategy}"]`);
                    if (stratEl) stratEl.checked = true;

                    const sizeEl = document.querySelector(`input[name="ticket-size"][value="${prefill.size}"]`);
                    if (sizeEl) sizeEl.checked = true;
                } else {
                    // Standard Defaults for New Tickets
                    ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'].forEach(lvl => {
                        const el = document.getElementById(`ticket-lvl-${lvl}`);
                        if (el) el.checked = true;
                    });
                    
                    const stratEl = document.querySelector(`input[name="ticket-type"][value="mixed"]`);
                    if (stratEl) stratEl.checked = true;

                    const sizeEl = document.querySelector(`input[name="ticket-size"][value="all"]`);
                    if (sizeEl) sizeEl.checked = true;
                }
                
                updateTicketCounter();
                
            } catch (e) { console.warn("Discovery failed:", e); }

            if (window.lucide) lucide.createIcons();
        };

        window.toggleAllTicketLevels = (shouldEnable) => {
            ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'].forEach(lvl => {
                const el = document.getElementById(`ticket-lvl-${lvl}`);
                if (el) el.checked = shouldEnable;
            });
            updateTicketCounter();
        };

        window.toggleAllTicketTopics = (shouldEnable) => {
            document.querySelectorAll('#ticket-topics-grid input[type="checkbox"]').forEach(el => {
                el.checked = shouldEnable;
            });
            updateTicketCounter();
        };

        window.toggleAllTicketPOS = (shouldEnable) => {
            document.querySelectorAll('#ticket-pos-grid input[type="checkbox"]').forEach(el => {
                el.checked = shouldEnable;
            });
            updateTicketCounter();
        };

        /**
         * CORE LOGIC HELPER: getEligibleReviewCards
         * Calculates the pool based on: ((Level AND POS AND Seen) OR SelectedCompletedTopics) AND Strategy
         */
        window.getEligibleReviewCards = async (ticketData) => {
            try {
                const { levels: selectedLevels, topics: selectedTopics, pos: selectedPOS, strategy: ticketType } = ticketData;
                const now = new Date();

                console.log(" DEBUG: getEligibleReviewCards triggered (V3)", { 
                    selectedLevels, 
                    selectedTopics, 
                    selectedPOS, 
                    ticketType 
                });

                // 1. Fetch User Progress (Card Level) - We need this for Level/POS filtering
                const progressPath = `artifacts/${appId}/users/${userId}/cardProgress`;
                const progressRef = collection(db, progressPath);
                const progressSnapshot = await getDocs(progressRef);
                const progressMap = {};
                progressSnapshot.docs.forEach(doc => progressMap[doc.id] = { id: doc.id, ...doc.data() });

                console.log(` DEBUG: Found ${Object.keys(progressMap).length} progress records.`);

                // 2. Build Level & POS Pool (From PUBLIC CARDS)
                let levelIntersectPool = new Set();
                if (selectedLevels.length > 0) {
                    const cardsCollectionPath = 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/cards';
                    const cardsRef = collection(db, cardsCollectionPath);
                    
                    // Optimization: determination of POS filtering necessity
                    const allPOSCheckboxes = document.querySelectorAll('#ticket-pos-grid input[type="checkbox"]');
                    const isAllPOSSelected = selectedPOS.length === allPOSCheckboxes.length;
                    const skipPOSFilter = selectedPOS.length === 0 || isAllPOSSelected;

                    // Normalization: Lowercase global selection for matching lowercase DB tags
                    const normalizedSelectedPOS = selectedPOS.map(p => p.toLowerCase());

                    console.log(` Querying PUBLIC cards for levels: ${selectedLevels}. Skip POS? ${skipPOSFilter}`);

                    // Firestore 'in' queries are limited to 10 items. Our levels are 6 (A1-C2).
                    const q = query(cardsRef, where('level', 'in', selectedLevels));
                    const publicCardsSnap = await getDocs(q);

                    console.log(` Found ${publicCardsSnap.docs.length} cards matching levels: ${selectedLevels}`);

                    publicCardsSnap.docs.forEach(docSnap => {
                        const cardId = docSnap.id;
                        const cardData = docSnap.data();
                        
                        // Condition A: Must be in user's seen/rated progress
                        const prog = progressMap[cardId];
                        if (prog && (prog.timesReviewed || 0) > 0) {
                            
                            // Condition B: Match POS if filter active
                            if (skipPOSFilter) {
                                levelIntersectPool.add(cardId);
                            } else {
                                const cardPOSArray = Array.isArray(cardData.pos) ? cardData.pos : [cardData.pos];
                                const hasMatchingPOS = cardPOSArray.some(p => {
                                    if (!p) return false;
                                    return normalizedSelectedPOS.includes(p.toLowerCase());
                                });

                                if (hasMatchingPOS) {
                                    levelIntersectPool.add(cardId);
                                }
                            }
                        }
                    });
                }

                // 3. Build Topic Union Pool (From definedSets, added regardless of level/POS)
                let topicUnionPool = new Set();
                if (selectedTopics.length > 0) {
                    console.log(` Selected topics: ${selectedTopics}`);
                    
                    // We'll gather card IDs from completed topics first
                    let topicCardsToFetchMeta = [];
                    
                    flashcardData.forEach(l => {
                        l.sets.forEach(s => {
                            let topicName = s.title;
                            if (s.title.includes(':')) {
                                topicName = s.title.split(':')[1].split('&')[0].trim();
                            }
                            
                            if (selectedTopics.includes(topicName)) {
                                // REQUIREMENT: Deck must be complete for user
                                if (userProgress[s.setID]?.status === 'complete') {
                                    console.log(` Topic Set FOUND & COMPLETE: ${s.setID} (${topicName}). Adding all cards (Union).`);
                                    (s.cards || []).forEach(cid => {
                                        topicUnionPool.add(cid);
                                        if (!progressMap[cid]) topicCardsToFetchMeta.push(cid);
                                    });
                                }
                            }
                        });
                    });

                    // FETCH MISSING META for Topic Cards (needed if we require progress later or just to be safe)
                    if (topicCardsToFetchMeta.length > 0) {
                        const cardsCollectionPath = 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/cards';
                        const missing = topicCardsToFetchMeta.filter(id => !progressMap[id]); // Actually we need cards collection not progress
                        // Wait, progressMap is user data. Topic union cards might NOT be in progressMap. 
                        // If they aren't, the strategy filter "Mixed" might need their info.
                        // For now, if they are in the union, condition 5 handles them.
                    }
                }

                // 4. Final Global Pool (Level Intersection UNION Topic Union)
                const globalPoolIds = [...new Set([...levelIntersectPool, ...topicUnionPool])];
                console.log(` DEBUG: Level Pool: ${levelIntersectPool.size}, Topic Pool: ${topicUnionPool.size}, Global Pool: ${globalPoolIds.length}`);

                // 5. Apply Strategy Filter
                const filteredPool = globalPoolIds.filter(id => {
                    // REQUIREMENT: Topic Union cards bypass progress check and strategy checks.
                    // If card is from Topic Union, it's already eligible and must be shown.
                    if (topicUnionPool.has(id)) return true;

                    // Otherwise, it came from the Level/POS pool which REQUIRES seen/rated status
                    const data = progressMap[id];
                    if (!data) return false;

                    if (ticketType === 'leeches') {
                        return (data.timesIncorrect || 0) >= 3;
                    } else if (ticketType === 'mixed') {
                        const isDue = data.nextReview && new Date(data.nextReview) <= now;
                        const isLearning = (data.repetitions || 0) < 3;
                        return isDue || isLearning;
                    } else {
                        return true;
                    }
                });

                return filteredPool;
            } catch (error) {
                console.error(" ERROR in getEligibleReviewCards:", error);
                throw error;
            }
        };

        window.updateTicketCounter = async () => {
            const counterEl = document.getElementById('ticket-eligible-count');
            const allCountEl = document.getElementById('size-all-count');
            if (!counterEl) return;
            
            console.log(" Counter Update: Starting...");
            counterEl.textContent = "...";
            if (allCountEl) allCountEl.textContent = "(...)";

            try {
                const ticketData = getTicketModalData();
                const eligibleIds = await getEligibleReviewCards(ticketData);
                const count = eligibleIds.length;

                console.log(` Counter Update: Result = ${count}`);
                counterEl.textContent = count;
                if (allCountEl) allCountEl.textContent = `(${count})`;

                // DYNAMIC SESSION SIZE LOGIC
                const sizeInputs = document.querySelectorAll('input[name="ticket-size"]');
                let currentSelected = document.querySelector('input[name="ticket-size"]:checked');
                let highestAvailableVal = 0;
                let highestAvailableInput = null;

                sizeInputs.forEach(input => {
                    const val = input.value;
                    const label = document.querySelector(`label[for="${input.id}"]`);
                    
                    if (val === 'all') {
                        // All is always available if count > 0
                        input.disabled = count === 0;
                        if (label) label.style.opacity = count === 0 ? '0.4' : '1';
                        if (label) label.style.pointerEvents = count === 0 ? 'none' : 'auto';
                        
                        if (count > 0) {
                            highestAvailableInput = input;
                        }
                    } else {
                        const numericVal = parseInt(val);
                        const isDisabled = numericVal > count;
                        input.disabled = isDisabled;
                        
                        if (label) {
                            if (isDisabled) {
                                label.classList.add('opacity-40', 'pointer-events-none', 'grayscale');
                                label.classList.remove('hover:bg-gray-50');
                            } else {
                                label.classList.remove('opacity-40', 'pointer-events-none', 'grayscale');
                                label.classList.add('hover:bg-gray-50');
                                
                                if (numericVal > highestAvailableVal) {
                                    highestAvailableVal = numericVal;
                                    highestAvailableInput = input;
                                }
                            }
                        }
                    }
                });

                // FORCE default to "All eligible" if available, or current becomes disabled
                const allInput = document.getElementById('size-all');
                if (allInput && !allInput.disabled) {
                    allInput.checked = true;
                } else if (currentSelected && currentSelected.disabled && highestAvailableInput) {
                    highestAvailableInput.checked = true;
                }

            } catch (error) {
                console.error(" Counter update failed:", error);
                counterEl.textContent = "Error";
            }
        };

        window.closeReviewTicket = () => {
            const builder = document.getElementById('review-ticket-builder');
            const content = document.getElementById('review-ticket-modal-content');
            if (!builder || !content) return;

            builder.classList.remove('animate-fade-in');
            builder.classList.add('animate-fade-out');
            
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');

            setTimeout(() => {
                builder.classList.add('hidden');
                builder.style.display = 'none';
            }, 250);
        };

        window.updateFlashcardDashboard = async () => {
            if (!userId || !flashcardData.length) return;

            let totalVocabLearned = 0;
            let dueCount = 0;
            const now = new Date();
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);

            const todayKey = new Date().toDateString();
            const activityDates = new Set();

            try {
                // 1. Fetch User Progress Summary
                const progressRef = collection(db, `artifacts/${appId}/users/${userId}/cardProgress`);
                const progressSnapshot = await getDocs(progressRef);
                
                todayWordsLearned = 0;
                
                progressSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    totalVocabLearned++;
                    
                    // Track unique study dates
                    if (data.lastReviewed) {
                        const lastRev = new Date(data.lastReviewed);
                        activityDates.add(lastRev.toDateString());
                        
                        // Check if learned today (first review today)
                        if (lastRev >= todayStart && data.timesReviewed === 1) {
                            todayWordsLearned++;
                        }
                    }
                    
                    // Check if card is due
                    if (data.nextReview && new Date(data.nextReview) <= now) {
                        dueCount++;
                    }
                });

                // 2. Update UI Metrics
                document.getElementById('dash-due-count').textContent = dueCount;
                
                // STREAK CALCULATION
                const streakCount = calculateStreakFromDates(Array.from(activityDates));
                document.getElementById('dash-streak-count').textContent = `${streakCount} Days`;
                
                // 3. Update Rings
                const vocabPct = Math.min(100, (todayWordsLearned / dailyVocabGoal) * 100);
                document.getElementById('dash-vocab-pct').textContent = Math.round(vocabPct) + "%";
                
                updateRing('ring-vocab', vocabPct, 45); // r=45
                
                // Sticky Header Update
                const stickyProgBar = document.getElementById('sticky-vocab-progress-bar');
                if (stickyProgBar) stickyProgBar.style.width = vocabPct + "%";

                // 4. Update Home Dashboard Stats
                const homeWallCount = document.getElementById('home-wall-count');
                if (homeWallCount) homeWallCount.textContent = totalVocabLearned.toLocaleString();
                
                const wallTotal = 10000;
                const wallPct = Math.min(100, Math.round((totalVocabLearned / wallTotal) * 100));
                const homeWallBar = document.getElementById('home-wall-bar');
                if (homeWallBar) homeWallBar.style.width = wallPct + "%";
                
                const homeStreakDisplay = document.getElementById('home-streak-display');
                if (homeStreakDisplay) homeStreakDisplay.textContent = `${streakCount} Day Streak`;

                // 5. Update CEFR
                const cefrLevel = getCEFRLevel(totalVocabLearned);
                const homeLevel = document.getElementById('home-level-display');
                if (homeLevel) homeLevel.textContent = cefrLevel.current.level;

            } catch (error) {
                console.error("Error updating flashcard dashboard:", error);
            }
        };

        function calculateStreakFromDates(dateStrings) {
            if (dateStrings.length === 0) return 0;
            
            const dates = dateStrings.map(d => new Date(d).setHours(0,0,0,0)).sort((a,b) => b-a);
            const today = new Date().setHours(0,0,0,0);
            const yesterday = today - 86400000;
            
            // Check if user has studied today or yesterday to maintain streak
            if (dates[0] < yesterday) return 0;
            
            let currentStreak = 1;
            for (let i = 0; i < dates.length - 1; i++) {
                if (dates[i] - dates[i+1] === 86400000) {
                    currentStreak++;
                } else if (dates[i] === dates[i+1]) {
                    continue;
                } else {
                    break;
                }
            }
            return currentStreak;
        }

        function updateRing(id, percent, radius) {
            const circle = document.getElementById(id);
            if (!circle) return;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDasharray = circumference;
            circle.style.strokeDashoffset = offset;
        }

        window.launchDueReview = async () => {
            if (parseInt(document.getElementById('dash-due-count').textContent) === 0) {
                alert("No cards are currently due for review! Good job!");
                return;
            }
            
            // Immediately transition to skeleton with "Maintenance" title
            document.getElementById('study-set-title').textContent = "Maintenance";
            document.getElementById('flashcards').classList.remove('active');
            document.getElementById('flashcard-study').classList.add('active');
            document.getElementById('study-loading').classList.remove('hidden');
            document.getElementById('study-card-container').classList.add('hidden');
            document.getElementById('study-complete').classList.add('hidden');

            try {
                const now = new Date();
                const progressRef = collection(db, `artifacts/${appId}/users/${userId}/cardProgress`);
                const progressSnapshot = await getDocs(progressRef);
                
                const dueIds = [];
                progressSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.nextReview && new Date(data.nextReview) <= now) {
                        dueIds.push(doc.id);
                    }
                });

                if (dueIds.length === 0) {
                    alert("No cards are currently due for review!");
                    exitFlashcardStudy();
                    return;
                }

                // Pick up to 50 due cards
                const pool = dueIds.sort(() => 0.5 - Math.random()).slice(0, 50);
                await startFlashcardSession(pool, "Maintenance");
            } catch (error) {
                console.error("Error launching due review:", error);
                alert("Failed to build review session.");
                exitFlashcardStudy();
            }
        };

        async function startFlashcardSession(cardIds, title) {
            // Immediately transition to study view with loading state
            document.getElementById('study-set-title').textContent = title;
            document.getElementById('study-progress-text').textContent = `0/${cardIds.length}`;
            document.getElementById('flashcards').classList.remove('active');
            document.getElementById('flashcard-study').classList.add('active');
            
            const loadingArea = document.getElementById('study-loading');
            const skeletonBar = loadingArea.querySelector('.skeleton.h-2.rounded-full');
            if (skeletonBar) skeletonBar.style.width = '0%';

            loadingArea.classList.remove('hidden');
            document.getElementById('study-card-container').classList.add('hidden');
            document.getElementById('study-complete').classList.add('hidden');

            const cardsPath = 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/cards';
            const fetchedCards = [];
            
            try {
                const cardsRef = collection(db, cardsPath);
                const CHUNK_SIZE = 30; // Firestore IN query limit

                for (let i = 0; i < cardIds.length; i += CHUNK_SIZE) {
                    const chunk = cardIds.slice(i, i + CHUNK_SIZE);
                    const q = query(cardsRef, where(documentId(), "in", chunk));
                    const chunkSnap = await getDocs(q);
                    
                    chunkSnap.forEach(docSnap => {
                        const cardData = docSnap.data();
                        cardData.docId = docSnap.id;
                        fetchedCards.push(cardData);
                    });

                    // Update loading feedback
                    const progress = Math.min(100, Math.round((fetchedCards.length / cardIds.length) * 100));
                    if (skeletonBar) skeletonBar.style.width = `${progress}%`;
                }

                currentStudyCards = fetchedCards.map((card, index) => ({
                    spanish: Array.isArray(card.termTarget) ? card.termTarget[0] : card.termTarget,
                    english: card.termSource,
                    id: card.docId,
                    masterIndex: index,
                    pos: card.pos || [],
                    examples: card.examples || [],
                    dictionaryDefinition: card.dictionaryDefinition || { source: '', target: '' },
                    frequency: card.frequency || 0
                }));

                currentStudySet = { title: title };
                masterSessionCards = [...currentStudyCards];
                masterSessionStatus = new Array(masterSessionCards.length).fill(null);
                
                startStudySubset();
            } catch (error) {
                console.error("Error loading flashcards:", error);
                showModal("Error", "Failed to load flashcards: " + error.message);
                exitFlashcardStudy();
            }
        }

        window.launchCustomTicket = async () => {
            const ticketData = getTicketModalData();
            const { strategy: ticketType, size: sessionSize } = ticketData;

            if (ticketData.levels.length === 0 && ticketData.topics.length === 0) {
                alert("Please select at least one level or topic!");
                return;
            }

            const sessionTitle = currentLoadedTicketName || "Review";

            // Immediately transition to skeleton
            document.getElementById('study-set-title').textContent = sessionTitle;
            document.getElementById('flashcards').classList.remove('active');
            document.getElementById('flashcard-study').classList.add('active');
            document.getElementById('study-loading').classList.remove('hidden');
            document.getElementById('study-card-container').classList.add('hidden');
            document.getElementById('study-complete').classList.add('hidden');
            
            closeReviewTicket();

            try {
                // 1. Get accurate pool IDs using centralized helper
                const eligibleIds = await getEligibleReviewCards(ticketData);

                if (eligibleIds.length === 0) {
                    alert("No cards found matching your criteria.");
                    exitFlashcardStudy();
                    return;
                }

                // 2. Shuffle and limit to Ticket Size
                let limit = sessionSize === 'all' ? eligibleIds.length : sessionSize;
                
                const finalCardIds = eligibleIds
                    .sort(() => 0.5 - Math.random())
                    .slice(0, limit);

                // 3. Load data and start
                await startFlashcardSession(finalCardIds, sessionTitle);

            } catch (error) {
                console.error("Error launching ticket:", error);
                alert("Failed to build ticket: " + error.message);
                exitFlashcardStudy();
            }
        };

        window.jumpToNext = () => {
            if(!window.nextUnitTarget) return;
            
            const levelContent = document.getElementById(`content-${window.nextUnitTarget.levelId}`);
            if(levelContent && !levelContent.classList.contains('open')) {
                toggleAccordion(window.nextUnitTarget.levelId);
            }

            setTimeout(() => {
                const unitContent = document.getElementById(`content-${window.nextUnitTarget.unitId}`);
                if(unitContent && !unitContent.classList.contains('open')) {
                    toggleAccordion(window.nextUnitTarget.unitId);
                }
                
                const unitElement = document.getElementById(`content-${window.nextUnitTarget.unitId}`).parentNode;
                unitElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        window.triggerConfetti = () => {
            if (window.confetti) {
                window.confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        window.renderFlashcards = () => {
            const container = document.getElementById('flashcards-container');
            if(!container) return;

            const currentlyOpen = new Set();
            document.querySelectorAll('.accordion-content.open').forEach(el => {
                currentlyOpen.add(el.id);
            });

            container.innerHTML = ''; 

            flashcardData.forEach(level => {
                const totalSets = level.sets.length;
                const completedSets = level.sets.filter(s => userProgress[s.setID]?.status === 'complete').length;
                const isLevelComplete = totalSets > 0 && completedSets === totalSets;
                
                if (isLevelComplete && previousLevelStates[level.id] === false) {
                    triggerConfetti();
                    if(currentlyOpen.has(`content-${level.id}`)) {
                        currentlyOpen.delete(`content-${level.id}`);
                    }
                }
                previousLevelStates[level.id] = isLevelComplete;

                const levelCard = document.createElement('div');
                levelCard.className = 'bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden';
                
                const headerBg = isLevelComplete ? 'bg-gray-200' : 'bg-navy-900';
                const titleColor = isLevelComplete ? 'text-gray-500' : 'text-white';
                const subTextColor = isLevelComplete ? 'text-gray-400' : 'text-gray-300';
                const chevronColor = isLevelComplete ? 'text-gray-500' : 'text-white';
                const checkMark = isLevelComplete ? `<i data-lucide="check-circle-2" class="w-6 h-6 text-green-600 mr-2"></i>` : '';

                levelCard.innerHTML = `
                    <div onclick="toggleAccordion('${level.id}')" class="${headerBg} p-6 cursor-pointer flex justify-between items-center transition hover:opacity-90">
                        <div class="flex items-center">
                            ${checkMark}
                            <div>
                                <h2 class="text-xl font-bold ${titleColor}">${level.title}</h2>
                                <p class="text-sm mt-1 ${subTextColor}">${level.description}</p>
                            </div>
                        </div>
                        <i data-lucide="chevron-down" class="w-6 h-6 transform transition-transform duration-300 ${chevronColor}" id="icon-${level.id}"></i>
                    </div>
                    
                    <div id="content-${level.id}" class="accordion-content bg-gray-50">
                        <div class="p-2">
                            <ul class="divide-y divide-gray-100" id="sets-${level.id}"></ul>
                        </div>
                    </div>
                `;

                container.appendChild(levelCard);

                const setsList = levelCard.querySelector(`#sets-${level.id}`);
                
                level.sets.forEach(set => {
                    const isCompleted = userProgress[set.setID]?.status === 'complete';
                    
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-3 hover:bg-gray-50 transition';
                    li.innerHTML = `
                        <div class="flex items-center gap-3">
                            <button onclick="toggleDeckFirebase('${set.setID}')" class="focus:outline-none transition transform hover:scale-110">
                                <i data-lucide="check-circle" class="w-6 h-6 ${isCompleted ? 'text-green-500' : 'text-gray-300'}"></i>
                            </button>
                            <span class="font-medium text-gray-700 ${isCompleted ? 'line-through opacity-50' : ''}">${set.title}</span>
                        </div>
                        <button onclick="openFlashcardStudy('${set.setID}')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-1.5 rounded text-xs font-bold uppercase">
                            Study
                        </button>
                    `;
                    setsList.appendChild(li);
                });
            });
            
            if(window.lucide) lucide.createIcons();

            currentlyOpen.forEach(id => {
                const el = document.getElementById(id);
                const icon = document.getElementById(id.replace('content-', 'icon-'));
                if (el) {
                    el.classList.add('open');
                    el.style.maxHeight = 'none';
                }
                if (icon) {
                    icon.classList.add('rotate-180');
                }
            });
        };

        window.toggleAccordion = (id) => {
            const content = document.getElementById(`content-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            const isOpen = content.classList.contains('open');
        
            if (isOpen) {
                content.style.maxHeight = content.scrollHeight + "px";
                content.offsetHeight; 
                content.style.maxHeight = null;
                content.classList.remove('open');
                icon.classList.remove('rotate-180');
            } else {
                content.classList.add('open');
                icon.classList.add('rotate-180');
                content.style.maxHeight = content.scrollHeight + "px";
                setTimeout(() => {
                    if (content.classList.contains('open')) {
                        content.style.maxHeight = 'none';
                    }
                }, 500);
            }
        };


        window.router = (pageId) => {
            const protectedPages = ['dashboard', 'flashcards', 'lessons', 'tools-landing', 'tools-conjugation', 'account', 'subscription'];
            if (protectedPages.includes(pageId) && !userId) {
                pageId = 'login';
            }

            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            const target = document.getElementById(pageId);
            if(target) {
                target.classList.add('active');
                window.scrollTo(0,0);
            }
            
            setTimeout(() => { 
                if (window.lucide) lucide.createIcons();
                if (pageId === 'tools-landing') {
                    renderDeckProgress(); 
                }
            if (pageId === 'flashcards') {
                renderFlashcards(); 
                updateFlashcardDashboard();
                fetchSavedTickets(); // NEW: Trigger fresh counts for saved tickets
                updateKeyboardHintsVisibility(); // Refresh study view state
            }
                if (pageId === 'lessons') {
                    renderLessonLibrary();
                    updateLessonsDashboard();
                }
                if (pageId === 'tools-conjugation') {
                     // HARD RESET: Clear all sub-layers when entering Lab from main Nav
                     document.getElementById('verb-detail-view').classList.add('hidden');
                     document.getElementById('verb-practice-view').classList.add('hidden');
                     document.getElementById('verb-skeleton-view').classList.add('hidden');
                     document.getElementById('verb-selection-view').classList.remove('hidden');
                     
                     filterVerbList(); 
                }
                if (pageId === 'account') {
                    if(auth.currentUser) {
                        document.getElementById('acc-email').textContent = auth.currentUser.email || 'Anonymous';
                        document.getElementById('acc-uid').textContent = auth.currentUser.uid;
                    }
                }
            }, 50);

            // Always close menu on navigation
            toggleMobileMenu(false);
        }

        window.toggleMobileMenu = (forceState = null) => {
            const menu = document.getElementById('mobile-menu');
            const overlay = document.getElementById('mobile-menu-overlay');
            const burger = document.getElementById('hamburger-icon');
            const closer = document.getElementById('close-icon');
            
            if (!menu) return;
            
            const isOpen = forceState !== null ? forceState : !menu.classList.contains('active');
            
            if (isOpen) {
                menu.classList.add('active');
                overlay.classList.add('opacity-100', 'pointer-events-auto');
                overlay.classList.remove('opacity-0', 'pointer-events-none');
                
                // Animate Burger to X
                burger.classList.add('scale-0', 'opacity-0', 'rotate-90');
                closer.classList.remove('scale-0', 'opacity-0');
                closer.classList.add('scale-100', 'opacity-100', 'rotate-0');
                
                document.body.style.overflow = 'hidden'; // Lock scroll
            } else {
                menu.classList.remove('active');
                overlay.classList.add('opacity-0', 'pointer-events-none');
                overlay.classList.remove('opacity-100', 'pointer-events-auto');
                
                // Animate X back to Burger
                burger.classList.remove('scale-0', 'opacity-0', 'rotate-90');
                closer.classList.add('scale-0', 'opacity-0');
                closer.classList.remove('scale-100', 'opacity-100', 'rotate-0');
                
                document.body.style.overflow = ''; // Unlock scroll
            }
        };

        document.getElementById('mobile-menu-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMobileMenu();
        });

        window.addEventListener('scroll', () => {
            const flashcardsSection = document.getElementById('flashcards');
            if (!flashcardsSection || !flashcardsSection.classList.contains('active')) return;

            const stickyHeader = document.getElementById('flashcards-sticky-header');
            const cardsContainer = document.getElementById('flashcards-container');
            const dashboard = document.getElementById('flashcard-dashboard');

            if (!stickyHeader || !cardsContainer) return;
            
            // Get position of the FIRST CARD inside the container relative to viewport
            // We use the first child of the container as the trigger point
            const firstCard = cardsContainer.firstElementChild;
            
            if (firstCard) {
                const rect = firstCard.getBoundingClientRect();
                const triggerPoint = 80; // Approximate top nav height + padding
                
                // If the top of the first card scrolls ABOVE the trigger point, show sticky header
                if (rect.top < triggerPoint) {
                    if (stickyHeader.classList.contains('hidden')) {
                         stickyHeader.classList.remove('hidden');
                    }
                } else {
                    if (!stickyHeader.classList.contains('hidden')) {
                        stickyHeader.classList.add('hidden');
                    }
                }
            } else {
                 // Fallback if no cards loaded yet
                 stickyHeader.classList.add('hidden');
            }
        });

        window.onload = () => {
            initializeFirebase();
        };

        // --- KEYBOARD CONTROLS FOR STUDY VIEW ---
        window.addEventListener('keydown', (e) => {
            const studySection = document.getElementById('flashcard-study');
            if (!studySection.classList.contains('active')) return;
            
            // Or if an input is focused
            if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;

            const key = e.key.toLowerCase();
            const shift = e.shiftKey;

            // SPECIAL CASE: Dictionary Modal Toggle
            const dictModal = document.getElementById('dictionary-modal');
            if (!dictModal.classList.contains('hidden')) {
                if (key === 'tab') {
                    e.preventDefault();
                    closeDictionary();
                }
                return; // Ignore all other keys when dictionary is open
            }

            // Don't trigger if settings is open
            if (!document.getElementById('study-settings-modal').classList.contains('hidden')) return;

            // Study view must be active and not showing the results screen
            const isShowingStats = !document.getElementById("study-complete").classList.contains("hidden");
            
            if (isShowingStats) {
                // RESULTS/PAUSE MENU Bindings
                switch (key) {
                    case ' ': // Spacebar -> Resume/Redo/Review
                        e.preventDefault();
                        const resumeBtn = document.getElementById('btn-resume-study');
                        const redoBtn = document.getElementById('btn-redo-subset');
                        const missedBtn = document.getElementById('btn-review-missed');
                        
                        if (!resumeBtn.classList.contains('hidden')) resumeStudy();
                        else if (!missedBtn.classList.contains('hidden')) handleRestartSession('missed');
                        else if (!redoBtn.classList.contains('hidden')) handleRestartSession('redo');
                        break;
                    case 'r': // R -> Restart All
                        handleRestartSession('all');
                        break;
                    case 'escape': // Esc -> Exit
                        forceExitStudy();
                        break;
                }
                return;
            }

            // MAIN STUDY Bindings
            switch (key) {
                case ' ': // Spacebar
                    e.preventDefault();
                    flipTopCard();
                    break;
                case 'shift':
                    if (e.location === 1) { // Left Shift
                        speakCurrentFlashcard();
                    }
                    break;
                case 'a':
                    handleCardAction('again');
                    break;
                case 'w':
                    handleCardAction('hard');
                    break;
                case 'd':
                    handleCardAction('good');
                    break;
                case 'e':
                    handleCardAction('easy');
                    break;
                case 'q':
                    undoLastAction();
                    break;
                case 'tab':
                    e.preventDefault();
                    openDictionary(currentStudyIndex, isStudyCardFlipped);
                    break;
                case 'escape':
                    exitFlashcardStudy();
                    break;
            }
        });

    </script>
</body>
</html>
