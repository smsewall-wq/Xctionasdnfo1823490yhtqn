<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport updated for "Notch" support on mobile phones -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Spanish by Sammy</title>

    <!-- ================= PWA SETTINGS ================= -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SammySpanish">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/180/F57C00/ffffff?text=S">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Spanish by Sammy","short_name":"SammySpanish","start_url":".","display":"standalone","background_color":"#0A2647","theme_color":"#0A2647","icons":[{"src":"https://via.placeholder.com/192/F57C00/ffffff?text=S","sizes":"192x192","type":"image/png"},{"src":"https://via.placeholder.com/512/F57C00/ffffff?text=S","sizes":"512x512","type":"image/png"}]}'>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Confetti Library for Celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Hammer.js for Swipe Gestures -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { 900: '#0A2647', 800: '#144272', 700: '#205295' },
                        orange: { 500: '#F57C00', 600: '#E65100' },
                        gray: { 50: '#F9FAFB', 100: '#F3F4F6', 200: '#E5E7EB', 300: '#D9D9D9', 800: '#1F2937' },
                        green: { 500: '#10B981' },
                        gold: { 400: '#FBBF24', 500: '#F59E0B', 600: '#D97706' } 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Body padding removed to allow Nav background to fill the notch area */
        body {
            padding-bottom: env(safe-area-inset-bottom);
            background-color: #F9FAFB; /* gray-50 match */
        }
        .notch-padding {
            padding-top: env(safe-area-inset-top);
        }

        /* Extend nav background into safe area above notch */
        nav::before {
            content: '';
            position: absolute;
            top: calc(-1 * env(safe-area-inset-top));
            left: 0;
            right: 0;
            height: env(safe-area-inset-top);
            background-color: #0A2647; /* navy-900 */
            z-index: -1;
        }
        .no-select {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        .page-section {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }
        .page-section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Accordion Animations */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out; /* Standardized timing */
        }
        
        .rotate-chevron {
            transform: rotate(180deg);
            transition: transform 0.3s;
        }
        
        /* Condensed Dashboard Transitions */
        #flashcard-dashboard, #lessons-dashboard, #lessons-search-wrapper {
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
        }

        /* Flash Animation for Jumping */
        @keyframes flashHighlight {
            0% { background-color: rgba(249, 115, 22, 0.1); transform: scale(1); }
            50% { background-color: rgba(249, 115, 22, 0.3); transform: scale(1.02); }
            100% { background-color: transparent; transform: scale(1); }
        }
        
        .flash-highlight {
            animation: flashHighlight 1.5s ease-in-out;
        }

        /* Card Swipe Animations */
        @keyframes swipeRight {
            to { transform: translate3d(120%, 0, 0) rotate(15deg); opacity: 0; }
        }
        @keyframes swipeLeft {
            to { transform: translate3d(-120%, 0, 0) rotate(-15deg); opacity: 0; }
        }
        .animate-swipe-right {
            animation: swipeRight 0.3s ease-out forwards;
            will-change: transform, opacity;
        }
        .animate-swipe-left {
            animation: swipeLeft 0.3s ease-out forwards;
            will-change: transform, opacity;
        }
        .card-container {
            perspective: 1000px;
        }
        
        /* Loading Overlay Style */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(249, 250, 251, 0.7);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            border-top-color: #F57C00;
            border-right-color: transparent;
            border-bottom-color: #F57C00;
            border-left-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Custom Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            border-radius: 2px;
        }
        
        /* Dashboard Slides Logic */
        .dashboard-track {
            display: flex;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            width: 300%; /* Exactly 300% for 3 slides */
        }
        .dashboard-slide {
            width: 33.333%; /* Each slide is 33.333% of the track */
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        /* Scrollbar Styling for Review List */
        .review-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .review-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .review-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .review-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Video Responsive Container */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Chat Message Styles */
        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            line-height: 1.4;
            font-size: 0.95rem;
        }
        .chat-user {
            background-color: #F57C00;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .chat-ai {
            background-color: #F3F4F6;
            color: #1F2937;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #E5E7EB;
        }
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #9CA3AF;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Search Active State Transitions */
        .search-container {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .search-container.search-active {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
            z-index: 60; /* Above nav bar */
            padding-top: calc(env(safe-area-inset-top) + 12px); /* Add padding top */
            padding-right: 12px; /* Add padding right */
            margin: 0;
            border-radius: 0;
        }
        .search-results-condensed {
            padding-left: 1rem;
            padding-right: 1rem;
            padding-bottom: 5rem;
            margin-top: 1rem;
            height: 100%;
            overflow-y: auto;
        }
        /* Search Input Animation in Active Mode */
        .search-active .search-input-wrapper {
            background-color: #f3f4f6; /* gray-100 */
            border-radius: 0.5rem;
            box-shadow: none;
            border: none;
        }
        
        /* ========== FLASHCARD 3D STYLES ========== */
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* Flashcard Transitions */
        .transition-transform-smooth { 
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.35s ease-in-out; 
        }
        .transition-appear { 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        opacity 0.3s ease-out; 
        }
        .transition-flip { transition: transform 0.5s; }
        .no-transition { transition: none !important; }
        
        /* Dictionary Definition Styles */
        .def-content p { margin-bottom: 0.5rem; }
        
        /* Hide Scrollbars (for touch interactions) */
        ::-webkit-scrollbar { display: none; }

        /* ========== MODERN RATING BUTTON STYLES (SAMMY BRANDED) ========== */

        /* CSS Custom Properties for Button Colors - Sammy Aesthetic Palette */
        .rating-btn-again {
            --btn-color: #BE123C; /* Sophisticated Red-Rose */
            --btn-color-dark: #9F1239;
            --btn-color-light: #FB7185;
            --btn-color-rgb: 190, 18, 60;
        }
        .rating-btn-hard {
            --btn-color: #F57C00; /* Sammy Orange Primary */
            --btn-color-dark: #E65100;
            --btn-color-light: #FFB74D;
            --btn-color-rgb: 245, 124, 0;
        }
        .rating-btn-good {
            --btn-color: #205295; /* Sammy Navy 700 */
            --btn-color-dark: #144272;
            --btn-color-light: #3b82f6;
            --btn-color-rgb: 32, 82, 149;
        }
        .rating-btn-easy {
            --btn-color: #059669; /* Balanced Emerald Success */
            --btn-color-dark: #065F46;
            --btn-color-light: #34D399;
            --btn-color-rgb: 5, 150, 105;
        }

        /* Unified Rating Button Base Styled with Option 1 (Gradient) as Default */
        .rating-btn {
            width: 3.5rem; /* Default if tailwind fails */
            height: 3.5rem;
            border-radius: 9999px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.75rem;
            cursor: pointer;
            user-select: none;
            background: linear-gradient(135deg, var(--btn-color) 0%, var(--btn-color-dark) 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @media (min-width: 640px) {
            .rating-btn {
                width: 4rem;
                height: 4rem;
            }
        }
        .rating-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2), 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .rating-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* ========== SKELETON LOADER STYLES ========== */
        .skeleton {
            background: #e2e8f0;
            background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
            border-radius: 5px;
            background-size: 200% 100%;
            animation: shimmer 1.5s linear infinite;
        }
        @keyframes shimmer {
            to {
                background-position-x: -200%;
            }
        }
        @media (prefers-reduced-motion: reduce) {
            .skeleton {
                animation: none;
            }
        }

        /* ========== DICTIONARY ANIMATIONS ========== */
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @keyframes slideDown {
            from { transform: translateY(0); }
            to { transform: translateY(100%); }
        }
        .animate-slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .animate-slide-down {
            animation: slideDown 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .animate-fade-out {
            animation: fadeOut 0.25s ease-out forwards;
        }

        /* ========== TOGGLE SWITCHES ========== */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #F57C00;
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* ========== SESSION REPORT STYLES ========== */
        .donut-segment {
            transition: stroke-dasharray 1s ease-in-out;
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-stats-in {
            animation: fade-in-up 0.5s ease-out forwards;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.31.0",
    "d3": "https://aistudiocdn.com/d3@^7.9.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0"
  }
}
</script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans flex flex-col min-h-screen no-select">

    <!-- Navigation -->
    <nav class="bg-navy-900 text-white sticky top-0 z-50 shadow-lg select-none notch-padding transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-14 md:h-16 items-center"> <!-- Reduced height -->
                <!-- Logo -->
                <div class="flex items-center cursor-pointer" onclick="router('dashboard')">
                    <div class="w-8 h-8 bg-orange-500 flex items-center justify-center rounded mr-2 font-serif font-bold text-lg shadow-md border-2 border-white/10">S</div> <!-- Smaller Logo -->
                    <div class="flex flex-col">
                        <span class="font-serif font-bold text-base md:text-lg tracking-wide leading-tight">SPANISH</span>
                        <span class="text-[0.6rem] uppercase tracking-widest text-gray-300 font-light hidden sm:block">by Sammy</span>
                    </div>
                </div>

                <!-- Desktop Menu: SIGNED OUT -->
                <div id="desktop-nav-signed-out" class="hidden md:flex space-x-8 items-center">
                    <a href="#" onclick="router('method')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Method</a>
                    <a href="#" onclick="router('tools-landing')" id="nav-decks" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Decks</a>
                    <a href="#" onclick="router('course')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Courses</a>
                    <a href="#" onclick="router('booking')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Tutoring</a>
                    <button id="nav-login" onclick="router('login')" class="text-gray-300 hover:text-white text-sm">Log In</button>
                    <button id="nav-start-learning" onclick="router('login')" class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-1.5 rounded font-bold transition shadow-lg uppercase text-xs tracking-wider">Start</button>
                </div>

                <!-- Desktop Menu: SIGNED IN -->
                <div id="desktop-nav-signed-in" class="hidden space-x-6 items-center">
                    <a href="#" onclick="router('dashboard')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide font-bold">Dashboard</a>
                    <a href="#" onclick="router('flashcards')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Flashcards</a>
                    <a href="#" onclick="router('tools-conjugation')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Verbs</a>
                    <a href="#" onclick="router('lessons')" class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide">Lessons</a>
                    
                    <!-- NEW: Upgrade Button for non-premium users -->
                    <button id="nav-upgrade-btn" onclick="router('subscription')" class="hidden bg-gradient-to-r from-gold-400 to-gold-600 hover:from-gold-500 hover:to-gold-700 text-navy-900 px-3 py-1 rounded font-bold transition shadow-lg uppercase text-[0.65rem] tracking-wider border border-white/20 animate-pulse">
                        Upgrade
                    </button>
                    
                    <!-- New ABOUT Dropdown -->
                    <div class="relative group hidden md:block">
                        <button class="hover:text-orange-500 transition-colors text-sm font-medium uppercase tracking-wide flex items-center gap-1">
                            About <i data-lucide="chevron-down" class="w-3 h-3"></i>
                        </button>
                        <!-- Dropdown Content -->
                        <div class="absolute right-0 top-full mt-0 w-64 bg-white text-gray-800 shadow-xl rounded-lg border border-gray-200 hidden group-hover:block p-4 z-50">
                            <div class="space-y-4">
                                <div>
                                    <h4 class="text-xs font-bold text-navy-900 uppercase mb-2 border-b border-gray-200 pb-1">Method</h4>
                                    <ul class="text-sm space-y-1">
                                        <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-orange-500 block">Why Zipf's Law?</a></li>
                                        <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-orange-500 block">Spaced Repetition</a></li>
                                        <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-orange-500 block">Our Story</a></li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="text-xs font-bold text-navy-900 uppercase mb-2 border-b border-gray-200 pb-1">Resources</h4>
                                    <ul class="text-sm space-y-1">
                                        <li><a href="#" class="hover:text-orange-500 block">Blog</a></li>
                                        <li><a href="#" class="hover:text-orange-500 block">Verb Tables</a></li>
                                        <li><a href="#" class="hover:text-orange-500 block">Student Forum</a></li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="text-xs font-bold text-navy-900 uppercase mb-2 border-b border-gray-200 pb-1">Legal</h4>
                                    <ul class="text-sm space-y-1">
                                        <li><a href="#" class="hover:text-orange-500 block">Terms of Service</a></li>
                                        <li><a href="#" class="hover:text-orange-500 block">Privacy Policy</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="nav-logout-desktop" onclick="logout()" class="hidden md:block border border-orange-500 text-orange-500 hover:bg-orange-500 hover:text-white px-3 py-1 rounded font-bold text-xs transition uppercase tracking-wider">Log Out</button>
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-btn" class="text-gray-300 hover:text-white p-2">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu Dropdown -->
        <div id="mobile-menu" class="hidden md:hidden bg-navy-800 border-t border-navy-700 max-h-[90vh] overflow-y-auto absolute w-full shadow-2xl">
            <!-- Signed OUT mobile menu -->
            <div id="mobile-menu-signed-out" class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="#" onclick="router('method')" class="block px-3 py-4 text-gray-300 hover:text-white hover:bg-navy-700 rounded-md text-lg font-medium border-b border-navy-700">The Method</a>
                <a href="#" onclick="router('tools-landing')" class="block px-3 py-4 text-gray-300 hover:text-white hover:bg-navy-700 rounded-md text-lg font-medium border-b border-navy-700">Decks (Quizlet)</a>
                <a href="#" onclick="router('booking')" class="block px-3 py-4 text-gray-300 hover:text-white hover:bg-navy-700 rounded-md text-lg font-medium">Tutoring</a>
                <button id="mobile-nav-auth" onclick="router('login')" class="w-full text-left px-3 py-4 text-orange-500 font-bold border-t border-navy-700">Log In / Sign Up</button>
            </div>

            <!-- Signed IN mobile menu -->
            <div id="mobile-menu-signed-in" class="hidden px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="#" onclick="router('dashboard')" class="block px-3 py-4 text-white hover:text-white hover:bg-navy-700 rounded-md text-lg font-bold border-b border-navy-700">Dashboard</a>
                <a href="#" onclick="router('flashcards')" class="block px-3 py-4 text-gray-300 hover:text-white hover:bg-navy-700 rounded-md text-lg font-medium border-b border-navy-700">Flashcards</a>
                <a href="#" onclick="router('tools-conjugation')" class="block px-3 py-4 text-gray-300 hover:text-white hover:bg-navy-700 rounded-md text-lg font-medium border-b border-navy-700">Conjugation</a>
                <a href="#" onclick="router('lessons')" class="block px-3 py-4 text-gray-300 hover:text-white hover:bg-navy-700 rounded-md text-lg font-medium border-b border-navy-700">Lessons</a>
                <a href="#" onclick="router('subscription')" id="mobile-nav-upgrade" class="block px-3 py-4 text-gold-400 hover:text-gold-300 rounded-md text-lg font-bold border-b border-navy-700">Upgrade to Pro ‚≠ê</a>
                
                <!-- About Section in Mobile Menu -->
                <div class="px-3 py-4 border-b border-navy-700">
                    <span class="block text-orange-500 font-bold uppercase text-xs mb-3 tracking-wider">About</span>
                    
                    <div class="ml-2 space-y-4">
                        <div>
                            <span class="text-gray-400 text-xs font-bold uppercase block mb-1">Method</span>
                            <a href="https://spanishbysammy.netlify.app/" class="block text-gray-300 hover:text-white py-1">Why Zipf's Law?</a>
                            <a href="https://spanishbysammy.netlify.app/" class="block text-gray-300 hover:text-white py-1">Spaced Repetition</a>
                            <a href="https://spanishbysammy.netlify.app/" class="block text-gray-300 hover:text-white py-1">Our Story</a>
                        </div>
                        <div>
                             <span class="text-gray-400 text-xs font-bold uppercase block mb-1">Resources</span>
                            <a href="#" class="block text-gray-300 hover:text-white py-1">Blog</a>
                            <a href="#" class="block text-gray-300 hover:text-white py-1">Verb Tables</a>
                            <a href="#" class="block text-gray-300 hover:text-white py-1">Student Forum</a>
                        </div>
                        <div>
                             <span class="text-gray-400 text-xs font-bold uppercase block mb-1">Legal</span>
                            <a href="#" class="block text-gray-300 hover:text-white py-1">Terms of Service</a>
                            <a href="#" class="block text-gray-300 hover:text-white py-1">Privacy Policy</a>
                        </div>
                    </div>
                </div>

                <button id="mobile-nav-logout" onclick="logout()" class="w-full text-left px-3 py-4 text-orange-500 font-bold border-t border-navy-700">Log Out</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <main id="app-content" class="flex-grow">
        
        <!-- ================= NEW DASHBOARD PAGE ================= -->
        <section id="dashboard" class="page-section">
            <div class="max-w-4xl mx-auto px-4 py-8 pb-24">
                <!-- Header -->
                <div class="mb-8 text-center">
                    <h1 class="text-3xl font-serif font-bold text-navy-900">Hola, <span id="home-user-name">Student</span>!</h1>
                    <div id="dashboard-status-badge" class="inline-flex items-center gap-1 bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mt-2">
                        <span>Free Plan</span>
                    </div>
                    <p class="text-gray-500 mt-2">Ready to build your wall today?</p>
                </div>

                <!-- Stats Grid -->
                <div class="grid md:grid-cols-2 gap-4 mb-8">
                    <!-- Wall Widget (Flashcards) -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-400 text-xs uppercase tracking-wider">Vocabulary Wall</h3>
                            <span class="text-orange-500 font-bold text-lg" id="home-wall-count">0</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-200 overflow-hidden relative mb-2">
                             <div class="absolute inset-0 opacity-10" style="background-image: repeating-linear-gradient(45deg, #000 0, #000 1px, transparent 0, transparent 50%); background-size: 10px 10px;"></div>
                            <div id="home-wall-bar" class="bg-orange-500 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span id="home-streak-display">0 Day Streak</span>
                            <span>10k Goal</span>
                        </div>
                    </div>

                    <!-- Lesson Widget -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-400 text-xs uppercase tracking-wider">Lesson Path</h3>
                            <span class="text-navy-900 font-bold text-lg" id="home-level-display">A1</span>
                        </div>
                        <div class="mb-2">
                            <div class="text-sm font-bold text-navy-900 truncate" id="home-next-lesson">Loading...</div>
                            <div class="text-xs text-gray-500">Next Lesson</div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                            <div id="home-lesson-bar" class="bg-navy-900 h-1.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Main Action -->
                <button onclick="router('tools-conjugation')" class="w-full bg-navy-900 hover:bg-navy-800 text-white p-6 rounded-xl shadow-lg transition transform hover:scale-[1.02] mb-6 flex items-center justify-between group">
                    <div class="text-left">
                        <div class="text-orange-500 font-bold uppercase tracking-wider text-xs mb-1">Daily Drill</div>
                        <div class="text-2xl font-serif font-bold">Practice Conjugation</div>
                        <div class="text-gray-400 text-sm mt-1">Master your verbs</div>
                    </div>
                    <div class="bg-white/10 p-3 rounded-full group-hover:bg-white/20 transition">
                        <i data-lucide="pen-tool" class="w-8 h-8"></i>
                    </div>
                </button>

                <!-- Secondary Actions -->
                <div class="grid grid-cols-2 gap-4 mb-12">
                    <button onclick="router('flashcards')" class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:border-orange-500 transition flex flex-col items-center justify-center gap-2 h-32">
                        <i data-lucide="layers" class="w-8 h-8 text-orange-500"></i>
                        <span class="font-bold text-navy-900">Flashcards</span>
                    </button>
                    <button onclick="router('lessons')" class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:border-orange-500 transition flex flex-col items-center justify-center gap-2 h-32">
                        <i data-lucide="book-open" class="w-8 h-8 text-navy-900"></i>
                        <span class="font-bold text-navy-900">Lessons</span>
                    </button>
                </div>

                <!-- Account Link -->
                <div class="text-center">
                    <button onclick="router('account')" class="text-gray-400 hover:text-navy-900 text-sm font-medium flex items-center justify-center gap-2 mx-auto transition">
                        <i data-lucide="user" class="w-4 h-4"></i> Manage Account
                    </button>
                </div>
            </div>
        </section>

        <!-- ================= ACCOUNT PAGE ================= -->
        <section id="account" class="page-section">
            <div class="max-w-md mx-auto px-4 py-8">
                <button onclick="router('dashboard')" class="text-gray-500 hover:text-navy-900 mb-6 flex items-center gap-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Dashboard
                </button>
                
                <h1 class="text-3xl font-serif font-bold text-navy-900 mb-8">Account</h1>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
                    <div class="p-6 border-b border-gray-100">
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Email</div>
                        <div id="acc-email" class="text-lg font-medium text-navy-900">...</div>
                    </div>
                    <div class="p-6 border-b border-gray-100">
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">User ID</div>
                        <div id="acc-uid" class="text-sm font-mono text-gray-500 break-all">...</div>
                    </div>
                     <div class="p-6 border-b border-gray-100">
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Subscription</div>
                        <div id="acc-subscription" class="text-lg font-medium text-navy-900 flex items-center gap-2">
                            Free Plan <button onclick="router('subscription')" class="text-xs bg-gold-400 text-navy-900 px-2 py-1 rounded font-bold hover:bg-gold-500">UPGRADE</button>
                        </div>
                    </div>
                    <!-- Added Portal Button -->
                    <div id="acc-manage-portal" class="p-6 border-b border-gray-100 hidden">
                        <button onclick="openCustomerPortal()" class="w-full border border-gray-300 text-navy-900 hover:bg-gray-50 font-bold py-2 rounded-lg transition flex items-center justify-center gap-2">
                            <i data-lucide="credit-card" class="w-4 h-4"></i> Manage Subscription
                        </button>
                    </div>
                </div>

                <button onclick="logout()" class="w-full border-2 border-red-100 text-red-500 hover:bg-red-50 hover:border-red-200 font-bold py-3 rounded-lg transition">
                    Log Out
                </button>
            </div>
        </section>

        <!-- ================= SUBSCRIPTION / UPGRADE PAGE ================= -->
        <section id="subscription" class="page-section">
            <div class="bg-navy-900 text-white pb-24 pt-12">
                <div class="max-w-4xl mx-auto px-4 text-center">
                    <button onclick="router('dashboard')" class="absolute left-4 top-24 text-gray-400 hover:text-white flex items-center gap-2 md:hidden">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
                    </button>
                    <span class="text-gold-400 font-bold uppercase tracking-widest text-sm mb-2 block">Premium Membership</span>
                    <h1 class="text-3xl md:text-5xl font-serif font-bold mb-6">Unleash Your Fluency</h1>
                    <p class="text-gray-300 max-w-2xl mx-auto text-lg">Get unlimited access to advanced conjugation drills, AI tutor chats, and offline lessons.</p>
                </div>
            </div>

            <div class="max-w-5xl mx-auto px-4 -mt-16 pb-20">
                <div class="grid md:grid-cols-2 gap-8 items-start">
                    
                    <!-- Monthly Plan -->
                    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 p-8 relative overflow-hidden">
                        <h3 class="text-xl font-bold text-navy-900 mb-2">Monthly Learner</h3>
                        <div class="flex items-baseline mb-6">
                            <span class="text-4xl font-bold text-navy-900">$9.99</span>
                            <span class="text-gray-500 ml-2">/ month</span>
                        </div>
                        <ul class="space-y-4 mb-8">
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-green-500 w-5 h-5"></i> Unlimited Conjugation Drills</li>
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-green-500 w-5 h-5"></i> Unlimited AI Tutor Chats</li>
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-green-500 w-5 h-5"></i> Advanced Stats</li>
                        </ul>
                        <button onclick="handleStripeCheckout('price_monthly')" class="w-full bg-navy-900 hover:bg-navy-800 text-white font-bold py-4 rounded-xl transition shadow-lg flex justify-center items-center gap-2">
                            Start Monthly
                        </button>
                    </div>

                    <!-- Yearly Plan -->
                    <div class="bg-white rounded-2xl shadow-xl border-2 border-gold-400 p-8 relative overflow-hidden transform md:-translate-y-4">
                        <div class="absolute top-0 right-0 bg-gold-400 text-navy-900 text-xs font-bold px-4 py-1 rounded-bl-xl uppercase tracking-wider">
                            Best Value
                        </div>
                        <h3 class="text-xl font-bold text-navy-900 mb-2">Annual Pro</h3>
                        <div class="flex items-baseline mb-6">
                            <span class="text-4xl font-bold text-navy-900">$99.99</span>
                            <span class="text-gray-500 ml-2">/ year</span>
                        </div>
                        <p class="text-green-600 text-sm font-bold mb-6">Save 17% compared to monthly</p>
                        <ul class="space-y-4 mb-8">
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-gold-500 w-5 h-5"></i> <span class="font-bold">Everything in Monthly</span></li>
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-gold-500 w-5 h-5"></i> Priority Support</li>
                            <li class="flex items-center text-gray-700 gap-3"><i data-lucide="check" class="text-gold-500 w-5 h-5"></i> Early Access to New Features</li>
                        </ul>
                        <button onclick="handleStripeCheckout('price_yearly')" class="w-full bg-gradient-to-r from-gold-400 to-gold-600 hover:from-gold-500 hover:to-gold-700 text-navy-900 font-bold py-4 rounded-xl transition shadow-lg flex justify-center items-center gap-2">
                            Start Yearly Trial <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                        <p class="text-center text-xs text-gray-400 mt-4">Secure payment via Stripe. Cancel anytime.</p>
                    </div>

                </div>
            </div>
        </section>

        <!-- ================= NEW FLASHCARDS PAGE ================= -->
        <section id="flashcards" class="page-section min-h-[150vh]">
             <!-- STICKY HEADER CONDENSED VIEW (Hidden initially) -->
            <div id="flashcards-sticky-header" class="fixed top-14 left-0 right-0 bg-white/95 backdrop-blur z-40 shadow-md border-b border-gray-200 hidden transition-all duration-300 transform translate-y-0">
                 <div class="py-3 px-4 flex items-center justify-between max-w-4xl mx-auto w-full">
                    <div class="flex items-center gap-4 flex-grow min-w-0"> <!-- min-w-0 critical for flex child truncation -->
                        <div class="block mr-2 border-r border-gray-200 pr-2 flex-grow min-w-0">
                            <div class="text-[10px] sm:text-xs text-gray-500 uppercase font-bold truncate" id="sticky-subtitle">Level - Unit</div>
                            <div class="text-xs sm:text-sm font-bold text-navy-900 leading-tight truncate" id="sticky-title">Unit Title</div>
                        </div>

                        <div class="hidden sm:block w-24 bg-gray-200 rounded-full h-2 dark:bg-gray-200 flex-shrink-0">
                            <div id="sticky-progress-bar" class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <span id="sticky-progress-text" class="hidden sm:inline text-xs text-gray-500 font-mono">0/0</span>
                    </div>
                    <button onclick="jumpToNext()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-1.5 rounded-md font-bold text-xs uppercase tracking-wide shadow-sm flex-shrink-0 ml-2">
                        Next Set
                    </button>
                </div>
            </div>

            <!-- Simplified Title -->
            <div class="max-w-4xl mx-auto px-4 pt-6 pb-2">
                <h1 id="flashcards-main-title" class="text-3xl font-serif font-bold text-navy-900">Flashcards</h1>
            </div>
            
            <!-- Dashboard Wrapper for Sticky Logic -->
            <div id="dashboard-wrapper" class="relative mb-8">
                <!-- Main Dashboard Box -->
                <div id="flashcard-dashboard" class="bg-white rounded-xl shadow-lg border border-gray-200 mx-auto max-w-4xl w-[95%] sm:w-full z-40 transition-none relative overflow-hidden">
                    
                    <!-- View A: Expanded (Default) -->
                    <!-- UPDATED: padding removed from parent to ensure 200% width track fits perfectly without bleed -->
                    <div id="view-expanded" class="overflow-hidden w-full transition-all duration-300"> 
                        <div class="dashboard-track" id="dashboard-track">
                            
                            <!-- SLIDE 1: STUDY STATS -->
                            <!-- Added padding inside the slide -->
                            <div class="dashboard-slide p-4 md:p-6">
                                <h3 class="text-center font-bold text-navy-900 text-sm uppercase tracking-widest mb-4 md:hidden">Study Overview</h3>
                                
                                <!-- Mobile Grid / Desktop Flex Layout -->
                                <div class="grid grid-cols-2 md:flex md:flex-row justify-between items-stretch gap-4 md:gap-6">
                                    
                                    <!-- Stat 1: Study Streak -->
                                    <div class="col-span-1 md:flex-1 text-center md:text-left w-full md:border-r border-gray-100 md:pr-4 flex flex-col justify-center">
                                        <div class="flex justify-between items-center mb-2">
                                            <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Study Streak</div>
                                            <div class="text-xs font-bold text-orange-500 bg-orange-100 px-2 py-0.5 rounded-full" id="streak-badge">0 Days</div>
                                        </div>
                                        <!-- Calendar Grid -->
                                        <div class="calendar-grid mb-2" id="streak-calendar">
                                            <!-- Days populated by JS -->
                                        </div>
                                        <div class="text-[10px] sm:text-xs text-gray-500 text-center" id="streak-msg">Logging in...</div>
                                    </div>

                                    <!-- Stat 3: Next Action (Moved UP for Mobile Visibility) -->
                                    <div class="col-span-1 md:flex-1 md:order-3 text-center md:text-right w-full md:pl-4 flex flex-col justify-center h-full">
                                        <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Next Up</div>
                                        <div id="dash-next-set" class="text-sm font-medium text-gray-600 mb-3 truncate">Loading...</div>
                                        <div class="flex flex-col gap-2">
                                            <button onclick="startLearningNewWords()" class="bg-orange-500 hover:bg-orange-600 text-white px-2 py-2 sm:px-6 rounded-lg font-bold text-xs sm:text-sm shadow-md transition transform hover:scale-105 w-full md:w-auto self-center md:self-end">
                                                üéØ Learn Today's Words
                                            </button>
                                        </div>
                                    </div>

                                    <!-- CEFR Level Display -->
                                    <div class="col-span-2 md:col-span-1 md:flex-1 text-center w-full md:border-r border-gray-100 md:px-4 flex flex-col justify-center">
                                        <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">CEFR Level</div>
                                        <div id="cefr-level-display" class="text-sm font-bold text-navy-900 flex items-center justify-center gap-1">
                                            <span id="cefr-level-icon">üå±</span>
                                            <span>Loading...</span>
                                        </div>
                                        <div id="cefr-description" class="text-xs text-gray-500">Absolute Beginner</div>
                                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                            <div id="cefr-progress-bar" class="bg-orange-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1"><span id="cefr-words-to-next">0</span> to next level</div>
                                        <div class="text-xs text-gray-400 mt-1">
                                            <span id="cefr-current-range">0-500</span> words
                                        </div>
                                            <button onclick="jumpToNext()" class="bg-gray-100 hover:bg-gray-200 text-navy-900 px-2 py-2 sm:px-6 rounded-lg font-bold text-xs sm:text-sm shadow-md transition transform hover:scale-105 w-full md:w-auto self-center md:self-end">
                                                Go to Next Set
                                            </button>
                                    </div>

                                    <!-- Stat 2: Current Unit Progress (Spans 2 cols on mobile) -->
                                    <div class="col-span-2 md:col-span-1 md:flex-1 text-center w-full md:border-r border-gray-100 md:px-4 flex flex-col justify-center">
                                        <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Current Unit Progress</div>
                                        <!-- UPDATED: Shows Level ID + Unit Title -->
                                        <div id="dash-current-unit-title" class="text-sm font-bold text-navy-900 mb-1">Loading...</div>
                                        <!-- Progress Bar -->
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-200 mb-1">
                                            <div id="dash-progress-bar" class="bg-orange-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                                        </div>
                                        <div class="text-xs text-gray-500 text-right"><span id="dash-progress-text">0/0</span> Sets</div>
                                    </div>

                                </div>

                                <!-- The Wall Progress Bar -->
                                <div class="mt-4 md:mt-6 pt-4 border-t border-gray-100">
                                    <div class="flex justify-between items-end mb-2">
                                        <div>
                                            <h4 class="text-xs md:text-sm font-bold text-navy-900 uppercase tracking-wide">Building Your Wall</h4>
                                            <div class="text-[10px] md:text-xs text-gray-500" id="zipf-fluency-text">0% Conversational Fluency Achieved</div>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-sm md:text-lg font-bold text-orange-500" id="wall-vocab-count">0</span>
                                            <span class="text-[10px] md:text-xs text-gray-400">/ 10,000 Words</span>
                                            <button onclick="showZipfInfo()" class="ml-2 text-gray-400 hover:text-navy-900 transition"><i data-lucide="info" class="w-3 h-3 md:w-4 md:h-4 inline"></i></button>
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3 md:h-4 dark:bg-gray-200 overflow-hidden relative">
                                        <!-- Background Pattern for "Bricks" effect -->
                                        <div class="absolute inset-0 opacity-10" style="background-image: repeating-linear-gradient(45deg, #000 0, #000 1px, transparent 0, transparent 50%); background-size: 10px 10px;"></div>
                                        <div id="wall-progress-bar" class="bg-gradient-to-r from-orange-400 to-orange-600 h-3 md:h-4 rounded-full transition-all duration-1000 relative" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- SLIDE 2: REVIEW MAINTENANCE -->
                            <!-- Added padding inside the slide -->
                            <div class="dashboard-slide p-4 md:p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-center font-bold text-navy-900 text-sm uppercase tracking-widest flex-grow">Review Maintenance</h3>
                                    <button onclick="showReviewInfo()" class="text-gray-400 hover:text-navy-900 p-1"><i data-lucide="info" class="w-4 h-4"></i></button>
                                </div>

                                <!-- Stats Bar -->
                                <div class="grid grid-cols-4 gap-2 mb-4 text-center text-xs">
                                    <div class="bg-gray-50 rounded p-1 border border-gray-100">
                                        <div class="font-bold text-navy-900 text-lg" id="rev-stat-total">0</div>
                                        <div class="text-[10px] text-gray-500 uppercase">Total</div>
                                    </div>
                                    <div class="bg-red-50 rounded p-1 border border-red-100">
                                        <div class="font-bold text-red-600 text-lg" id="rev-stat-red">0</div>
                                        <div class="text-[10px] text-red-400 uppercase">Due</div>
                                    </div>
                                    <div class="bg-yellow-50 rounded p-1 border border-yellow-100">
                                        <div class="font-bold text-yellow-600 text-lg" id="rev-stat-yellow">0</div>
                                        <div class="text-[10px] text-yellow-400 uppercase">Soon</div>
                                    </div>
                                    <div class="bg-green-50 rounded p-1 border border-green-100">
                                        <div class="font-bold text-green-600 text-lg" id="rev-stat-green">0</div>
                                        <div class="text-[10px] text-green-400 uppercase">Good</div>
                                    </div>
                                </div>

                                <div class="text-center mb-4 text-sm text-gray-500" id="review-empty-state">
                                    No completed units yet. Finish a unit to unlock reviews!
                                </div>

                                <!-- List of Units needing review -->
                                <div id="review-list-container" class="space-y-2 max-h-[150px] overflow-y-auto px-1 review-scroll">
                                    <!-- Populated by JS -->
                                </div>
                            </div>

                            <!-- SLIDE 3: REPORTS & STATS -->
                            <div class="dashboard-slide p-4 md:p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-center font-bold text-navy-900 text-sm uppercase tracking-widest flex-grow">Reports & Stats</h3>
                                    <button onclick="showReportsInfo()" class="text-gray-400 hover:text-navy-900 p-1"><i data-lucide="info" class="w-4 h-4"></i></button>
                                </div>

                                <!-- Weekly Summary -->
                                <div class="bg-gradient-to-r from-navy-50 to-orange-50 rounded-lg p-4 mb-4 border border-navy-100">
                                    <h4 class="font-bold text-navy-900 mb-2 flex items-center gap-2">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                        This Week's Progress
                                    </h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <div class="text-gray-500">Study Sessions</div>
                                            <div class="text-2xl font-bold text-navy-900" id="weekly-sessions">12</div>
                                        </div>
                                        <div>
                                            <div class="text-gray-500">Words Learned</div>
                                            <div class="text-2xl font-bold text-orange-500" id="weekly-words">147</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Study Calendar -->
                                <div class="mb-4">
                                    <h4 class="font-bold text-navy-900 mb-2 flex items-center gap-2">
                                        <i data-lucide="flame" class="w-4 h-4"></i>
                                        Study Streak
                                    </h4>
                                    <div class="calendar-grid mb-2" id="reports-calendar">
                                        <!-- Days populated by JS -->
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-500">
                                        <span>Current: <span class="font-bold text-orange-500" id="reports-current-streak">5 days</span></span>
                                        <span>Best: <span class="font-bold text-green-600" id="reports-best-streak">12 days</span></span>
                                    </div>
                                </div>

                                <!-- Performance Insights -->
                                <div class="space-y-2">
                                    <h4 class="font-bold text-navy-900 flex items-center gap-2">
                                        <i data-lucide="trending-up" class="w-4 h-4"></i>
                                        Insights
                                    </h4>
                                    <div class="text-xs text-gray-600 space-y-1" id="performance-insights">
                                        <div class="flex items-start gap-2">
                                            <span class="text-green-500 mt-[-2px]">‚úì</span>
                                            <span>Excellent progress in B1 verbs (+95 words)</span>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <span class="text-green-500 mt-[-2px]">‚úì</span>
                                            <span>Strong retention in food vocabulary (92%)</span>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <span class="text-red-500 mt-[-2px]">‚ö†</span>
                                            <span>B2 adjectives need review (68% retention)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

                <!-- CENTERED BOTTOM NAV FOR CAROUSEL (Moved Outside Main Box) -->
                <div class="flex justify-center items-center gap-2 py-2 mb-6 transition-opacity duration-300" id="dashboard-nav-container">
                    <button onclick="switchDashboardView(-1)" class="focus:outline-none group" id="dash-nav-prev" style="display:none;">
                        <div class="flex items-center gap-2 bg-white shadow-sm border border-gray-200 rounded-full px-4 py-1.5 text-gray-500 group-hover:text-navy-900 group-hover:border-orange-500 transition">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            <span class="text-xs font-bold uppercase tracking-wide">Prev</span>
                        </div>
                    </button>

                    <!-- Tab Navigation -->
                    <div class="flex bg-gray-100 rounded-full p-1">
                        <button onclick="switchDashboardView(0 - currentDashboardSlide)" class="focus:outline-none px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide transition bg-gray-200 text-gray-700" id="dash-nav-study">
                            Study
                        </button>
                        <button onclick="switchDashboardView(1 - currentDashboardSlide)" class="focus:outline-none px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide transition bg-gray-200 text-gray-700" id="dash-nav-review">
                            Review
                        </button>
                        <button onclick="switchDashboardView(2 - currentDashboardSlide)" class="focus:outline-none px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide transition bg-gray-200 text-gray-700" id="dash-nav-reports">
                            Reports
                        </button>
                    </div>

                    <button onclick="switchDashboardView(1)" class="focus:outline-none group" id="dash-nav-next">
                        <div class="flex items-center gap-2 bg-white shadow-sm border border-gray-200 rounded-full px-4 py-1.5 text-gray-500 group-hover:text-navy-900 group-hover:border-orange-500 transition">
                            <span class="text-xs font-bold uppercase tracking-wide">Next</span>
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </div>
                    </button>
                </div>
            </div>

            <div class="max-w-4xl mx-auto px-4 pb-40">
                <!-- Flashcards Container -->
                <div id="flashcards-container" class="space-y-4"></div>
            </div>
        </section>

        <!-- ================= FLASHCARD STUDY VIEW (REBUILT) ================= -->
        <section id="flashcard-study" class="page-section">
            <!-- Top Nav Bar -->
            <div class="bg-navy-900 text-white py-3 sticky top-14 z-40 shadow-md">
                <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
                    <button onclick="exitFlashcardStudy()" class="flex items-center gap-2 text-gray-300 hover:text-white transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                    <div class="flex-grow text-center">
                        <h2 class="font-bold text-sm truncate max-w-[200px] sm:max-w-md mx-auto" id="study-set-title">Study Set</h2>
                        <div class="text-xs text-gray-400" id="study-progress-text">0/0</div>
                    </div>
                    <button onclick="toggleStudySettings()" class="text-gray-300 hover:text-white transition">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Main Study Container -->
            <div class="max-w-2xl mx-auto px-4 py-6 min-h-[80vh] flex flex-col">
                
                <!-- Loading State (Skeleton Loader) -->
                <div id="study-loading" class="flex-grow flex flex-col">
                    <!-- Placeholder Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                        <div class="skeleton h-2 rounded-full" style="width: 30%"></div>
                    </div>

                    <!-- Placeholder Card -->
                    <div class="flex-grow flex items-center justify-center mb-6 relative" style="min-height: 400px;">
                        <div class="relative w-full max-w-md aspect-[3/2.75] bg-white rounded-2xl shadow-xl border-4 border-transparent flex flex-col p-6 items-center justify-center">
                            <!-- Placeholder Rank -->
                            <div class="absolute top-4 right-5 w-8 h-4 skeleton"></div>
                            
                            <!-- Placeholder Main Term -->
                            <div class="w-2/3 h-10 skeleton mb-6"></div>
                            
                            <!-- Placeholder POS Pills -->
                            <div class="flex gap-2 mb-4">
                                <div class="w-20 h-6 skeleton rounded-full"></div>
                                <div class="w-16 h-6 skeleton rounded-full"></div>
                            </div>

                            <!-- Placeholder Example Text -->
                            <div class="mt-auto w-full pt-4 border-t border-slate-100 flex flex-col items-center gap-2">
                                <div class="w-3/4 h-4 skeleton"></div>
                                <div class="w-1/2 h-4 skeleton"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Placeholder Bottom Controls -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-center gap-2 pb-2">
                            <!-- 4 large circular buttons -->
                            <div class="w-14 h-14 md:w-16 md:h-16 rounded-full skeleton"></div>
                            <div class="w-14 h-14 md:w-16 md:h-16 rounded-full skeleton"></div>
                            <!-- 2 small circular buttons -->
                            <div class="w-10 h-10 md:w-12 md:h-12 rounded-full skeleton mx-1"></div>
                            <div class="w-10 h-10 md:w-12 md:h-12 rounded-full skeleton mx-1"></div>
                            <!-- 2 more large circular buttons -->
                            <div class="w-14 h-14 md:w-16 md:h-16 rounded-full skeleton"></div>
                            <div class="w-14 h-14 md:w-16 md:h-16 rounded-full skeleton"></div>
                        </div>
                        <div class="flex justify-center gap-6">
                            <div class="w-16 h-8 skeleton"></div>
                            <div class="w-16 h-8 skeleton"></div>
                        </div>
                    </div>
                </div>

                <!-- Card Study Container -->
                <div id="study-card-container" class="hidden flex-grow flex flex-col">
                    
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                        <div id="study-progress-bar" class="bg-orange-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>

                    <!-- Card Stack Container -->
                    <div class="flex-grow flex items-center justify-center mb-6 relative" style="min-height: 400px;">
                        <!-- Card Deck -->
                        <div id="card-deck" class="relative w-full max-w-md aspect-[3/2.75]">
                            <!-- Cards will be injected here by JS -->
                        </div>
                    </div>

                    <!-- Bottom Controls -->
                    <div class="space-y-4">
                        <!-- Action Buttons Row -->
                        <div class="flex items-center justify-center gap-2 pb-2">
                            <button onclick="handleCardAction('again')" class="rating-btn rating-btn-again">
                                <i data-lucide="refresh-ccw" class="w-4 h-4 mb-0.5"></i>
                                <span class="text-[10px] font-bold">Again</span>
                            </button>

                            <button onclick="handleCardAction('hard')" class="rating-btn rating-btn-hard">
                                <i data-lucide="zap" class="w-4 h-4 mb-0.5"></i>
                                <span class="text-[10px] font-bold">Hard</span>
                            </button>

                            <button onclick="undoLastAction()" id="undo-btn" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition disabled:opacity-30 disabled:cursor-not-allowed" disabled>
                                <i data-lucide="undo" class="w-4 h-4"></i>
                            </button>

                            <button onclick="speakCurrentFlashcard()" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition transform hover:scale-110">
                                <i data-lucide="volume-2" class="w-4 h-4"></i>
                            </button>

                            <button onclick="handleCardAction('good')" class="rating-btn rating-btn-good">
                                <i data-lucide="smile" class="w-4 h-4 mb-0.5"></i>
                                <span class="text-[10px] font-bold">Good</span>
                            </button>

                            <button onclick="handleCardAction('easy')" class="rating-btn rating-btn-easy">
                                <i data-lucide="check-circle" class="w-4 h-4 mb-0.5"></i>
                                <span class="text-[10px] font-bold">Easy</span>
                            </button>
                        </div>

                        <!-- Stats Row -->
                        <div class="flex justify-center gap-6 text-sm">
                            <div class="text-center">
                                <div class="text-xs text-gray-500 uppercase">Unknown</div>
                                <div class="text-lg font-bold text-red-600" id="unknown-count">0</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500 uppercase">Known</div>
                                <div class="text-lg font-bold text-green-600" id="known-count">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Complete Screen -->
                <div id="study-complete" class="hidden flex-grow flex flex-col items-center justify-center text-center">
                    
                <!-- Session Success Header -->
                <div id="session-header" class="mb-8 scale-0 transition-transform duration-700 delay-300">
                    <div id="res-emoji" class="text-6xl mb-4">üèÜ</div>
                    <h3 id="res-title" class="text-3xl font-serif font-black text-navy-900 mb-1">¬°Buen Trabajo!</h3>
                    <p id="res-subtitle" class="text-gray-500 font-medium">Session path complete</p>
                </div>

                <!-- Results Grid (Metrics) -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 w-full max-w-xl mb-10">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center animate-stats-in" style="animation-delay: 0.4s">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Duration</span>
                        <span class="text-xl font-black text-navy-900" id="res-duration">0:00</span>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center animate-stats-in" style="animation-delay: 0.5s">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Time / Term</span>
                        <span class="text-xl font-black text-blue-600" id="res-avg-time">0.0s</span>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center animate-stats-in" style="animation-delay: 0.6s">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Learning</span>
                        <span class="text-xl font-black text-orange-500" id="res-learning">0</span>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center animate-stats-in" style="animation-delay: 0.7s">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Mastered</span>
                        <span class="text-xl font-black text-green-600" id="res-mastered">0</span>
                    </div>
                </div>

                <!-- Recursive Study Options -->
                <div class="w-full max-w-sm space-y-4 mb-12">
                    <button id="btn-resume-study" onclick="event.stopPropagation(); resumeStudy()" class="hidden w-full group bg-orange-500 text-white py-4 px-6 rounded-2xl font-black shadow-lg shadow-orange-500/20 transition-all hover:bg-orange-600 hover:translate-y-[-2px] active:translate-y-0 flex items-center justify-between relative z-[60] pointer-events-auto">
                        <span class="flex items-center gap-3">
                            <i data-lucide="play" class="w-5 h-5 fill-current"></i> Resume
                        </span>
                        <i data-lucide="arrow-right" class="w-5 h-5 opacity-50"></i>
                    </button>

                    <button id="btn-redo-subset" onclick="event.stopPropagation(); handleRestartSession('redo')" class="hidden w-full group bg-orange-500 text-white py-4 px-6 rounded-2xl font-black shadow-lg shadow-orange-500/20 transition-all hover:bg-orange-600 hover:translate-y-[-2px] active:translate-y-0 flex items-center justify-between relative z-[60] pointer-events-auto">
                        <span class="flex items-center gap-3">
                            <i data-lucide="refresh-ccw" class="w-5 h-5"></i> Redo Previous
                        </span>
                        <span class="bg-black/10 px-2 py-0.5 rounded text-xs" id="res-count-redo">0 cards</span>
                    </button>

                    <button id="btn-review-missed" onclick="event.stopPropagation(); handleRestartSession('missed')" class="hidden w-full group bg-orange-500 text-white py-4 px-6 rounded-2xl font-black shadow-lg shadow-orange-500/20 transition-all hover:bg-orange-600 hover:translate-y-[-2px] active:translate-y-0 flex items-center justify-between relative z-[60] pointer-events-auto">
                        <span class="flex items-center gap-3">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i> Review Missed
                        </span>
                        <span class="bg-black/10 px-2 py-0.5 rounded text-xs" id="res-count-missed">0 cards</span>
                    </button>

                    <button onclick="event.stopPropagation(); handleRestartSession('all')" class="w-full group bg-white border-2 border-navy-900 text-navy-900 py-4 px-6 rounded-2xl font-black transition-all hover:bg-navy-900 hover:text-white flex items-center justify-between relative z-[60] pointer-events-auto">
                        <span class="flex items-center gap-3">
                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i> Restart All
                        </span>
                        <span class="text-xs opacity-40 group-hover:opacity-100 transition-opacity" id="res-count-all">0 cards</span>
                    </button>
                    
                    <button onclick="event.stopPropagation(); forceExitStudy()" class="w-full text-gray-400 hover:text-navy-900 font-bold py-2 transition-colors flex items-center justify-center gap-2 relative z-[60] pointer-events-auto">
                         Finish & Exit
                    </button>
                </div>
                </div>
                </div>
            </div>

            <!-- Dictionary Modal -->
            <div id="dictionary-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-end sm:items-center justify-center sm:p-4" onclick="handleDictionaryBackdropClick(event)">
                <div id="dictionary-modal-content" class="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-lg text-navy-900">Dictionary</h3>
                        <button onclick="closeDictionary()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 def-content">
                        <div id="dictionary-content">
                            <!-- Content injected by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Study Settings Modal -->
            <div id="study-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onclick="handleSettingsBackdropClick(event)">
                <div id="study-settings-modal-content" class="bg-white rounded-2xl w-full max-w-sm max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-lg text-navy-900">Study Settings</h3>
                        <button onclick="toggleStudySettings()" class="p-1 hover:bg-gray-100 rounded-full transition-colors">
                            <i data-lucide="x" class="w-5 h-5 text-gray-400"></i>
                        </button>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 space-y-4">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors cursor-pointer" onclick="document.getElementById('setting-shuffle').click()">
                            <div>
                                <span class="font-bold text-navy-900 block">Shuffle Cards</span>
                                <span class="text-xs text-gray-500">Mix card order each session</span>
                            </div>
                            <label class="switch" onclick="event.stopPropagation()">
                                <input type="checkbox" id="setting-shuffle" onchange="applyStudySettings()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors cursor-pointer" onclick="document.getElementById('setting-l1-first').click()">
                            <div>
                                <span class="font-bold text-navy-900 block">Start with English</span>
                                <span class="text-xs text-gray-500">Practice English ‚Üí Spanish</span>
                            </div>
                            <label class="switch" onclick="event.stopPropagation()">
                                <input type="checkbox" id="setting-l1-first" onchange="applyStudySettings()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors cursor-pointer" onclick="document.getElementById('setting-auto-speak').click()">
                            <div>
                                <span class="font-bold text-navy-900 block">Auto-Speak</span>
                                <span class="text-xs text-gray-500">Read cards out loud automatically</span>
                            </div>
                            <label class="switch" onclick="event.stopPropagation()">
                                <input type="checkbox" id="setting-auto-speak" onchange="applyStudySettings()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200 bg-gray-50">
                        <button onclick="toggleStudySettings()" class="w-full bg-navy-900 active:scale-95 text-white py-4 rounded-xl font-bold shadow-lg shadow-navy-900/10 transition-transform">
                            Done
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================= NEW LESSONS PAGE ================= -->
        <section id="lessons" class="page-section min-h-[150vh]">
            <!-- Simplified Title -->
            <div class="max-w-4xl mx-auto px-4 pt-10 pb-4">
                <h1 class="text-3xl font-serif font-bold text-navy-900">Lessons</h1>
            </div>

             <!-- Lessons Dashboard -->
            <div id="lessons-dashboard-wrapper" class="relative mb-8">
                <div id="lessons-dashboard" class="bg-white rounded-xl shadow-lg border border-gray-200 mx-auto max-w-4xl w-[95%] sm:w-full z-40 relative transition-none p-4 md:p-6">
                    <div class="grid grid-cols-2 md:flex md:flex-row gap-4 md:gap-6 items-center">
                        
                        <!-- Top Row Mobile / Left & Middle Desktop -->
                        <div class="col-span-1 md:flex-1 text-center md:text-left border-r border-gray-100 pr-2 md:pr-4">
                            <div class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Current Level</div>
                            <div class="text-xl md:text-2xl font-bold text-navy-900" id="dash-lessons-level">A1</div>
                            <div class="text-[10px] md:text-xs text-gray-500" id="dash-lessons-desc">Absolute Beginner</div>
                        </div>

                        <div class="col-span-1 md:flex-1 text-center md:text-right pl-2 md:pl-4">
                            <div class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Next Lesson</div>
                            <div class="text-xs md:text-sm font-medium text-gray-600 mb-2 truncate max-w-[120px] mx-auto md:mx-0" id="dash-lessons-next">Introduction</div>
                            <div class="flex gap-2 justify-center md:justify-end">
                                <button onclick="jumpToNextLesson()" class="bg-gray-100 hover:bg-gray-200 text-navy-900 px-3 py-1.5 md:px-4 md:py-2 rounded-lg font-bold text-xs md:text-sm shadow-sm transition w-auto inline-block">
                                    Jump
                                </button>
                                <button onclick="startNextLesson()" class="bg-navy-900 hover:bg-navy-800 text-white px-3 py-1.5 md:px-4 md:py-2 rounded-lg font-bold text-xs md:text-sm shadow-md transition w-auto inline-block">
                                    Start
                                </button>
                            </div>
                        </div>

                        <!-- Bottom Row Mobile / Right Desktop -->
                        <div class="col-span-2 md:flex-1 text-center border-t md:border-t-0 border-gray-100 pt-4 md:pt-0 md:px-4 md:border-l md:pl-6">
                             <div class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Lessons Completed</div>
                            <div class="text-2xl md:text-3xl font-bold text-orange-500" id="dash-lessons-progress">Loading...</div>
                        </div>

                    </div>
                </div>
                
                <!-- SEARCH BAR (MODIFIED) -->
                <div id="lessons-search-container" class="search-container sticky top-20 z-40 px-4 mb-4 mt-4 transition-all duration-300 pt-2 pr-2"> 
                    <div class="max-w-4xl mx-auto flex items-center gap-2">
                         <button onclick="exitSearchMode('lessons')" id="lessons-back-btn" class="hidden text-gray-500 hover:text-navy-900 p-2">
                            <i data-lucide="arrow-left" class="w-6 h-6"></i>
                        </button>
                        <form action="." onsubmit="event.preventDefault(); document.activeElement.blur();" class="relative flex-grow search-input-wrapper transition-colors rounded-xl bg-gray-50/0">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                            <input type="search" enterkeyhint="search" id="lesson-search-input" onfocus="enterSearchMode('lessons')" oninput="handleLessonSearch()" placeholder="Search lessons..." 
                                class="w-full pl-10 pr-10 py-2 rounded-xl border border-gray-200 shadow-sm focus:outline-none focus:ring-0 focus:border-transparent bg-white focus:bg-transparent text-sm">
                             <button type="button" onclick="dismissKeyboard()" id="lessons-dismiss-btn" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-orange-500 p-1">
                                <i data-lucide="keyboard" class="w-4 h-4"></i>
                            </button>
                        </form>
                    </div>
                     <!-- SEARCH RESULTS CONTAINER (Moved inside for full screen effect) -->
                     <div class="max-w-4xl mx-auto hidden search-results-condensed mt-4" id="lessons-search-results">
                        <!-- Search results injected here -->
                    </div>
                </div>
            </div>
            
            <div class="max-w-4xl mx-auto px-4 pb-20" id="lessons-container">
                <!-- Lessons Accordion injected by JS -->
            </div>
        </section>
        
        <!-- LESSON VIEWER SECTION (Hidden by default) -->
        <section id="lesson-view" class="page-section">
             <div class="bg-navy-900 text-white py-4 sticky top-14 z-40 shadow-md">
                <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
                    <button onclick="router('lessons')" class="flex items-center gap-2 text-gray-300 hover:text-white transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> <span class="hidden sm:inline font-bold">Back to Library</span>
                    </button>
                    <h2 class="font-bold text-lg truncate max-w-[200px] sm:max-w-md" id="player-title">Lesson Title</h2>
                    <div class="w-8"></div> <!-- Spacer for centering -->
                </div>
            </div>

            <div class="max-w-4xl mx-auto px-4 py-8">
                <!-- Video -->
                <div class="video-container bg-black mb-8">
                    <div id="player-video-placeholder" class="w-full h-full flex items-center justify-center text-gray-500">Loading Video...</div>
                    <iframe id="player-iframe" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
                
                <!-- Content -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sm:p-8">
                    <div class="flex justify-between items-start mb-6 border-b border-gray-100 pb-4">
                        <div>
                            <span class="text-xs font-bold text-orange-500 uppercase tracking-wider mb-1 block flex items-center gap-2" id="player-level-container">
                                <span id="player-level">Level A1</span>
                                <span id="player-status-badge" class="hidden bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-[10px] flex items-center gap-1">
                                    <i data-lucide="check-circle" class="w-3 h-3"></i> Done
                                </span>
                            </span>
                            <h1 class="text-3xl font-serif font-bold text-navy-900" id="player-main-title">Lesson Title</h1>
                        </div>
                        <button class="text-gray-400 hover:text-orange-500 transition"><i data-lucide="bookmark" class="w-6 h-6"></i></button>
                    </div>
                    
                    <div class="prose max-w-none text-gray-600 leading-relaxed" id="player-content">
                        <!-- Content Injected Here -->
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-10 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button onclick="startQuiz()" class="flex items-center justify-center gap-2 bg-navy-900 hover:bg-navy-800 text-white py-4 rounded-lg font-bold shadow-md transition group">
                            <i data-lucide="help-circle" class="w-5 h-5 text-orange-500 group-hover:text-white transition"></i> Take Quiz
                        </button>
                        <button onclick="openAIAssistant()" class="flex items-center justify-center gap-2 bg-white border-2 border-gray-200 hover:border-orange-500 text-navy-900 py-4 rounded-lg font-bold transition group">
                            <i data-lucide="message-circle" class="w-5 h-5 text-gray-400 group-hover:text-orange-500 transition"></i> Ask AI Assistant
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- QUIZ VIEW SECTION -->
        <section id="quiz-view" class="page-section">
             <div class="bg-navy-900 text-white py-4 sticky top-14 z-40 shadow-md">
                <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
                    <button onclick="router('lesson-view')" class="flex items-center gap-2 text-gray-300 hover:text-white transition">
                        <i data-lucide="x" class="w-5 h-5"></i> <span class="hidden sm:inline font-bold">Exit Quiz</span>
                    </button>
                    <h2 class="font-bold text-lg">Practice Quiz</h2>
                    <div class="w-8"></div>
                </div>
            </div>
            <div class="max-w-2xl mx-auto px-4 py-12">
                <div id="quiz-loading" class="text-center py-12">
                    <div class="spinner border-4 border-orange-500 border-t-transparent rounded-full w-12 h-12 mx-auto mb-4 animate-spin"></div>
                    <p class="text-gray-600 font-medium">Generating questions with AI...</p>
                </div>
                <div id="quiz-content" class="hidden">
                     <div class="mb-6 flex justify-between items-center">
                        <span class="text-sm font-bold text-gray-500 uppercase tracking-wide">Question <span id="quiz-q-num">1</span>/5</span>
                        <span class="text-sm font-bold text-orange-500" id="quiz-score">Score: 0</span>
                     </div>
                     <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 sm:p-8">
                        <h3 class="text-xl font-bold text-navy-900 mb-6" id="quiz-question-text">Question goes here?</h3>
                        <div class="space-y-3" id="quiz-options">
                            <!-- Options injected here -->
                        </div>
                        <div id="quiz-feedback" class="mt-6 hidden p-4 rounded-lg bg-gray-50 text-sm"></div>
                        <button id="quiz-next-btn" onclick="nextQuestion()" class="mt-6 w-full bg-navy-900 text-white py-3 rounded-lg font-bold hover:bg-navy-800 transition hidden">Next Question</button>
                        <button id="quiz-finish-btn" onclick="finishQuiz()" class="mt-6 w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition hidden">Complete Quiz</button>
                     </div>
                </div>
            </div>
        </section>

        <!-- AI CHAT VIEW SECTION -->
        <section id="ai-chat-view" class="page-section">
             <div class="bg-navy-900 text-white py-4 sticky top-14 z-40 shadow-md">
                <div class="max-w-4xl mx-auto px-4 flex justify-between items-center">
                    <button onclick="router('lesson-view')" class="flex items-center gap-2 text-gray-300 hover:text-white transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> <span class="hidden sm:inline font-bold">Back to Lesson</span>
                    </button>
                    <h2 class="font-bold text-lg">AI Tutor</h2>
                    <div class="w-8"></div>
                </div>
            </div>
            <div class="max-w-2xl mx-auto px-4 py-4 h-[calc(100vh-160px)] flex flex-col">
                <div id="chat-history" class="flex-grow overflow-y-auto space-y-4 p-4 bg-white rounded-t-xl border border-gray-200 shadow-inner">
                    <div class="chat-bubble chat-ai">
                        Hola! I'm your AI tutor. I can help you with the lesson you are currently studying. What questions do you have?
                    </div>
                </div>
                <div class="bg-white border border-t-0 border-gray-200 p-4 rounded-b-xl shadow-lg flex gap-2">
                    <input type="text" id="chat-input" class="flex-grow border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:border-orange-500" placeholder="Ask a question..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
                    <button onclick="sendChatMessage()" class="bg-navy-900 text-white p-2 rounded-lg hover:bg-navy-800 transition"><i data-lucide="send" class="w-5 h-5"></i></button>
                </div>
            </div>
        </section>

        <!-- ================= HOME PAGE (Unlinked) ================= -->
        <section id="home" class="page-section">
            <!-- Hero -->
            <div class="bg-navy-900 text-white relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('images/hero-background1.png')] bg-cover bg-center opacity-30"></div>
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 lg:py-32 relative z-10">
                    <div class="lg:w-2/3">
                        <span class="text-orange-500 font-bold tracking-widest uppercase text-sm mb-2 block">No Games. No Gimmicks. Just Structure.</span>
                        <h1 class="text-5xl md:text-6xl font-serif font-black leading-tight mb-6">
                            Build Your Fluency <br>
                            <span class="text-orange-500">Brick by Brick.</span>
                        </h1>
                        <p class="text-xl text-gray-300 mb-10 font-light leading-relaxed max-w-2xl">
                            We provide the structure. Quizlet provides the engine. The <strong class="text-white">Brick Wall Method‚Ñ¢</strong> organizes high-frequency vocabulary into a rigorous daily path.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button onclick="router('method')" class="bg-orange-500 hover:bg-orange-600 text-white px-8 py-4 rounded font-bold text-lg shadow-lg transition hover:translate-y-[-2px] uppercase tracking-wide text-center">
                                Discover The Method
                            </button>
                            <button onclick="router('tools-landing')" class="border-2 border-white text-white hover:bg-white hover:text-navy-900 px-8 py-4 rounded font-bold text-lg transition hover:translate-y-[-2px] uppercase tracking-wide text-center">
                                Open Deck Library
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
             <div class="bg-white border-b border-gray-200">
                <div class="max-w-7xl mx-auto px-4 py-12 grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
                    <div><div class="text-4xl font-bold text-navy-900">10k+</div><div class="text-sm uppercase tracking-wide text-gray-500 mt-1">Active Students</div></div>
                    <div><div class="text-4xl font-bold text-navy-900">98%</div><div class="text-sm uppercase tracking-wide text-gray-500 mt-1">Retention Rate</div></div>
                    <div><div class="text-4xl font-bold text-navy-900">Top 1%</div><div class="text-sm uppercase tracking-wide text-gray-500 mt-1">Vocabulary Depth</div></div>
                    <div><div class="text-4xl font-bold text-navy-900">24/7</div><div class="text-sm uppercase tracking-wide text-gray-500 mt-1">Access to Tools</div></div>
                </div>
            </div>

            <!-- Method Preview -->
            <div class="py-20 bg-gray-50">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl font-serif font-bold text-navy-900 mb-4">Why Most Apps Fail You</h2>
                        <div class="w-20 h-1 bg-orange-500 mx-auto"></div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-10">
                        <div class="bg-white p-8 rounded border border-gray-200 shadow-sm hover:shadow-md transition">
                            <div class="bg-gray-100 w-12 h-12 rounded flex items-center justify-center mb-6 text-navy-900">
                                <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-3 text-navy-900">Zipf's Law Neglect</h3>
                            <p class="text-gray-600 leading-relaxed">Traditional courses teach "grandmother" before "the". We use frequency analysis to teach the words that make up 80% of conversation first.</p>
                        </div>
                        <div class="bg-white p-8 rounded border border-gray-200 shadow-sm hover:shadow-md transition">
                            <div class="bg-gray-100 w-12 h-12 rounded flex items-center justify-center mb-6 text-navy-900">
                                <i data-lucide="brain-circuit" class="w-6 h-6"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-3 text-navy-900">Lack of Spaced Repetition</h3>
                            <p class="text-gray-600 leading-relaxed">Cramming doesn't work. We structure your reviews to predict exactly when you're about to forget a word.</p>
                        </div>
                        <div class="bg-white p-8 rounded border border-gray-200 shadow-sm hover:shadow-md transition">
                            <div class="bg-gray-100 w-12 h-12 rounded flex items-center justify-center mb-6 text-navy-900">
                                <i data-lucide="hammer" class="w-6 h-6"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-3 text-navy-900">The "Fluency Illusion"</h3>
                            <p class="text-gray-600 leading-relaxed">Gamified apps make you feel productive without challenge. We focus on "Desirable Difficulty" to forge strong neural pathways.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================= METHOD PAGE ================= -->
        <section id="method" class="page-section">
            <div class="bg-navy-900 py-20 text-white">
                <div class="max-w-4xl mx-auto px-4 text-center">
                    <h1 class="text-4xl font-serif font-bold mb-6">The Brick Wall Method‚Ñ¢</h1>
                    <p class="text-xl text-gray-300">Language acquisition is engineering, not magic.</p>
                </div>
            </div>
            <div class="max-w-5xl mx-auto px-4 py-16">
                <div class="flex flex-col md:flex-row gap-12 items-center mb-20">
                    <div class="md:w-1/2">
                        <div class="text-orange-500 font-bold text-6xl opacity-20 mb-[-20px]">01</div>
                        <h3 class="text-2xl font-bold text-navy-900 mb-4 relative z-10">The Foundation</h3>
                        <p class="text-gray-600 mb-4">We utilize Zipf's Law which states that a small number of words occur incredibly often. The top 1,000 words account for ~75% of spoken Spanish.</p>
                    </div>
                    <div class="md:w-1/2 bg-gray-200 h-64 rounded flex items-center justify-center border-2 border-gray-300">
                         <div class="text-center"><i data-lucide="database" class="w-16 h-16 text-gray-400 mx-auto mb-2"></i><span class="text-gray-500 font-bold">Frequency DB</span></div>
                    </div>
                </div>
                <div class="text-center mt-12">
                    <button onclick="router('course')" class="bg-navy-900 hover:bg-navy-800 text-white px-8 py-4 rounded font-bold shadow-lg transition uppercase tracking-wide">Start Building Your Wall</button>
                </div>
            </div>
        </section>

        <!-- ================= QUIZLET HUB (TOOLS) ================= -->
        <section id="tools-landing" class="page-section">
            <div class="bg-gray-100 py-12 border-b border-gray-200">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="flex justify-between items-end">
                        <div>
                            <h1 class="text-3xl font-serif font-bold text-navy-900">Deck Library</h1>
                            <p class="text-gray-600 mt-2">Access your private Quizlet sets below.</p>
                        </div>
                        <div class="text-right hidden sm:block">
                            <div class="text-sm font-bold text-gray-500 uppercase">Total Progress</div>
                            <div class="text-2xl font-bold text-orange-500"><span id="total-completed">0</span>/<span id="total-decks">2</span> Decks</div>
                        </div>
                    </div>
                     <p class="text-xs text-gray-500 mt-1">User ID: <span id="current-user-id" class="font-mono bg-gray-200 p-0.5 rounded">...</span></p>
                </div>
            </div>

            <div class="max-w-7xl mx-auto px-4 py-12">
                
                <!-- Deck 1 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-4 flex flex-col sm:flex-row items-center gap-6 hover:shadow-md transition">
                    <div class="bg-navy-900 text-white p-4 rounded-lg flex-shrink-0">
                        <i data-lucide="layers" class="w-8 h-8"></i>
                    </div>
                    <div class="flex-grow text-center sm:text-left">
                        <h3 class="text-lg font-bold text-navy-900">Top 10 Essentials</h3>
                        <p class="text-sm text-gray-500 mb-2">The absolute most frequent words in Spanish.</p>
                        <a href="https://quizlet.com/latest" target="_blank" class="inline-flex items-center gap-2 text-orange-500 font-bold hover:underline">
                            Open in Quizlet <i data-lucide="external-link" class="w-4 h-4"></i>
                        </a>
                    </div>
                    <div class="flex-shrink-0">
                        <button id="btn-deck-1" onclick="toggleDeckFirebase('deck-1')" class="border-2 border-gray-300 text-gray-400 px-6 py-2 rounded-full font-bold transition flex items-center gap-2 hover:bg-gray-50">
                            <span class="status-text">Mark Complete</span>
                        </button>
                    </div>
                </div>

                <!-- Deck 2 -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-4 flex flex-col sm:flex-row items-center gap-6 hover:shadow-md transition">
                    <div class="bg-navy-900 text-white p-4 rounded-lg flex-shrink-0">
                        <i data-lucide="layers" class="w-8 h-8"></i>
                    </div>
                    <div class="flex-grow text-center sm:text-left">
                        <h3 class="text-lg font-bold text-navy-900">Connector Words</h3>
                        <p class="text-sm text-gray-500 mb-2">Linking words like 'pero', 'y', 'o', 'aunque'.</p>
                        <a href="https://quizlet.com/latest" target="_blank" class="inline-flex items-center gap-2 text-orange-500 font-bold hover:underline">
                            Open in Quizlet <i data-lucide="external-link" class="w-4 h-4"></i>
                        </a>
                    </div>
                    <div class="flex-shrink-0">
                        <button id="btn-deck-2" onclick="toggleDeckFirebase('deck-2')" class="border-2 border-gray-300 text-gray-400 px-6 py-2 rounded-full font-bold transition flex items-center gap-2 hover:bg-gray-50">
                            <span class="status-text">Mark Complete</span>
                        </button>
                    </div>
                </div>

                <div class="mt-12 pt-8 border-t border-gray-200">
                    <h2 class="text-xl font-bold text-navy-900 mb-6">Internal Tools</h2>
                    <div class="grid md:grid-cols-3 gap-6">
                         <!-- Conjugator Link -->
                         <div onclick="router('tools-conjugation')" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 cursor-pointer hover:shadow-md hover:border-orange-500 transition group">
                            <div class="flex justify-between items-start mb-4">
                                <div class="bg-gray-100 text-navy-900 p-3 rounded-lg group-hover:bg-navy-900 group-hover:text-white transition">
                                    <i data-lucide="pen-tool" class="w-6 h-6"></i>
                                </div>
                            </div>
                            <h3 class="text-lg font-bold text-navy-900 mb-1">Verb Conjugation Drill</h3>
                            <p class="text-sm text-gray-500">Practice Present, Preterite, and Imperfect tenses.</p>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- ================= CONJUGATION TOOL PAGE (UPDATED) ================= -->
        <section id="tools-conjugation" class="page-section">
            <div class="max-w-4xl mx-auto px-4 pt-4 pb-8 relative">
                
                <!-- VIEW 1: SELECTION (Search & List) -->
                <div id="verb-selection-view">
                    <!-- Moved header inside Selection View so it disappears on practice -->
                    <div class="mb-6 border-b border-gray-200 pb-4">
                        <h1 class="text-3xl font-serif font-bold text-navy-900">Verb Lab</h1>
                    </div>

                    <!-- SEARCH BAR (MODIFIED) -->
                    <div id="verb-search-container" class="search-container mb-6 pt-2 pr-2">
                        <div class="flex flex-col sm:flex-row gap-4 max-w-4xl mx-auto items-stretch">
                             <div class="flex flex-grow items-center gap-2">
                                <button onclick="exitSearchMode('verbs')" id="verbs-back-btn" class="hidden text-gray-500 hover:text-navy-900 p-2">
                                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                                </button>
                                <form action="." onsubmit="event.preventDefault(); document.activeElement.blur();" class="relative flex-grow search-input-wrapper transition-colors rounded-xl bg-gray-50/0">
                                     <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                                     <input type="search" enterkeyhint="search" id="verb-search-input" onfocus="enterSearchMode('verbs')" oninput="filterVerbList()" placeholder="Search verbs..." 
                                        class="w-full pl-10 pr-10 py-2 rounded-xl border border-gray-200 shadow-sm focus:outline-none focus:ring-0 focus:border-transparent bg-white focus:bg-transparent text-sm">
                                      <button type="button" onclick="dismissKeyboard()" id="verbs-dismiss-btn" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-orange-500 p-1">
                                        <i data-lucide="keyboard" class="w-4 h-4"></i>
                                    </button>
                                </form>
                             </div>
                             
                             <button id="verb-sort-btn" onclick="toggleVerbSort()" class="bg-white border border-gray-200 rounded-xl px-4 py-2 font-bold text-navy-900 shadow-sm hover:border-orange-500 transition flex items-center justify-center gap-2 whitespace-nowrap text-sm h-[42px] self-center">
                                 <span id="verb-sort-label">Freq</span>
                                 <i data-lucide="arrow-down-up" class="w-4 h-4"></i>
                             </button>
                        </div>
                        
                        <!-- Verb list injected here, or inside container during search mode -->
                        <div id="verb-list-container" class="bg-white rounded-xl shadow-sm border border-gray-200 divide-y divide-gray-100 overflow-hidden mb-6 mt-4 transition-all">
                            <!-- Verb list injected here -->
                        </div>
                    </div>
                </div>

                <!-- VIEW 2: PRACTICE (Card Drill) -->
                <!-- HEADER REMOVED COMPLETELY FOR SPACE -->
                <div id="verb-practice-view" class="hidden h-[85vh] flex flex-col items-center justify-center">
                    
                    <!-- Header Info -->
                    <div class="text-center mb-6">
                        <h2 class="text-3xl font-serif font-bold text-navy-900 mb-1" id="practice-infinitive">Hablar</h2>
                        <p class="text-gray-500" id="practice-translation">to speak</p>
                    </div>

                    <!-- The Card Area -->
                    <div class="relative w-full max-w-sm aspect-[4/3] card-container mb-6">
                         <!-- The Card -->
                        <div id="practice-card" class="absolute inset-0 bg-white rounded-2xl shadow-xl border-4 border-transparent flex flex-col items-center justify-between p-6 transition-all duration-300 cursor-pointer select-none" onclick="flipCard()">
                            
                            <!-- Tense Pill (Floating) -->
                            <div class="absolute -top-3 bg-orange-500 text-white px-4 py-1 rounded-full shadow-md text-xs font-bold uppercase tracking-wide z-10" id="card-tense">
                                Present
                            </div>

                            <!-- Content -->
                            <div class="flex-grow flex flex-col items-center justify-center w-full">
                                <div class="text-2xl font-bold text-gray-800 mb-6" id="card-subject">Yo</div>
                                
                                <div id="card-answer-area" class="w-full text-center">
                                    <div id="card-hidden" class="text-gray-300 font-mono text-xl">__________________</div>
                                    <div id="card-revealed" class="hidden text-3xl font-bold text-navy-900 animate-fadeIn">hablo</div>
                                </div>
                            </div>
                            
                            <div class="text-[0.65rem] text-gray-400 mt-2 uppercase tracking-widest">Tap to Reveal</div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="w-full max-w-sm flex items-center justify-between px-4">
                        <!-- Left / Incorrect -->
                        <button onclick="handleSwipe('left')" class="w-14 h-14 rounded-full border-2 border-red-500 flex items-center justify-center text-red-500 hover:bg-red-50 transition transform hover:scale-110">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>

                        <!-- Audio -->
                        <button onclick="speakCurrentCard()" class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center text-gray-800 hover:bg-gray-200 transition transform hover:scale-110">
                            <i data-lucide="volume-2" class="w-5 h-5"></i>
                        </button>

                        <!-- Right / Correct -->
                        <button onclick="handleSwipe('right')" class="w-14 h-14 rounded-full border-2 border-green-500 flex items-center justify-center text-green-500 hover:bg-green-50 transition transform hover:scale-110">
                            <i data-lucide="check" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Floating Settings Cog -->
                    <button onclick="toggleSettingsModal()" class="absolute top-2 right-2 p-2 bg-white rounded-full shadow-md text-gray-500 hover:text-navy-900 border border-gray-200">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                     <!-- Back Button -->
                    <button onclick="exitPractice()" class="absolute top-2 left-2 p-2 bg-white rounded-full shadow-md text-gray-500 hover:text-navy-900 border border-gray-200">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full max-h-[85vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-lg text-navy-900">Drill Settings</h3>
                        <button onclick="toggleSettingsModal()"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
                    </div>
                    <div class="overflow-y-auto p-4 space-y-6 flex-grow">
                        <div class="flex items-center justify-between pb-4 border-b border-gray-100">
                            <span class="font-bold text-gray-800">Auto-Speak</span>
                            <input type="checkbox" id="setting-autospeak" class="w-6 h-6 accent-orange-500">
                        </div>
                        
                        <!-- Sections injected via JS -->
                        <div id="settings-tenses-container" class="space-y-6"></div>

                    </div>
                    <div class="p-4 border-t border-gray-100 bg-gray-50">
                        <button onclick="toggleSettingsModal()" class="w-full bg-navy-900 text-white py-3 rounded-lg font-bold">Done</button>
                    </div>
                </div>
            </div>

        </section>

        <!-- ================= COURSES & BOOKING (Simplified) ================= -->
        <section id="course" class="page-section">
             <div class="max-w-7xl mx-auto px-4 py-16 text-center">
                <h2 class="text-3xl font-bold mb-4">Courses Page</h2>
                <p>Content remains similar to previous version...</p>
                <button onclick="router('home')" class="mt-4 text-orange-500 underline">Back Home</button>
             </div>
        </section>
        <section id="booking" class="page-section">
             <div class="max-w-7xl mx-auto px-4 py-16 text-center">
                <h2 class="text-3xl font-bold mb-4">Booking Page</h2>
                <p>Content remains similar to previous version...</p>
                <button onclick="router('home')" class="mt-4 text-orange-500 underline">Back Home</button>
             </div>
        </section>

        <!-- ================= LOGIN / SIGNUP PAGE (Functional) ================= -->
        <section id="login" class="page-section active">
            <div class="min-h-[60vh] flex items-center justify-center p-4">
                <div id="auth-form-container" class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md border border-gray-200">
                    <h2 id="auth-title" class="text-3xl font-serif font-bold text-navy-900 mb-6">Log In</h2>

                    <div class="space-y-4">
                        <input id="auth-email" type="email" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 focus:outline-none" />
                        <input id="auth-password" type="password" placeholder="Password (min 6 characters)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 focus:outline-none" />
                    </div>

                    <button id="auth-submit-btn" onclick="handleAuth(true)" class="mt-6 w-full bg-orange-500 text-white text-lg font-bold px-4 py-3 rounded-lg shadow-md transition duration-150 ease-in-out hover:bg-orange-600 uppercase tracking-wide">
                        Log In
                    </button>

                    <button onclick="toggleAuthMode()" class="mt-4 w-full text-sm text-navy-900 hover:text-orange-500 transition duration-150 underline">
                        Don't have an account? Sign Up
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer id="main-footer" class="bg-navy-900 text-gray-400 py-12 border-t border-navy-800 transition-opacity duration-300">
        <div class="max-w-7xl mx-auto px-4 grid md:grid-cols-4 gap-8">
            <div class="col-span-1 md:col-span-1">
                <div class="flex items-center mb-4 text-white">
                    <div class="w-8 h-8 bg-orange-500 flex items-center justify-center rounded mr-2 font-serif font-bold">S</div>
                    <span class="font-serif font-bold">Spanish by Sammy</span>
                </div>
                <p class="text-sm">Serious tools for serious students.</p>
            </div>
            <div>
                <h4 class="text-white font-bold uppercase tracking-wider text-xs mb-4">Method</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-white">Why Zipf's Law?</a></li>
                    <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-white">Spaced Repetition</a></li>
                    <li><a href="https://spanishbysammy.netlify.app/" class="hover:text-white">Our Story</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-white font-bold uppercase tracking-wider text-xs mb-4">Resources</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" class="hover:text-white">Blog</a></li>
                    <li><a href="#" class="hover:text-white">Verb Tables</a></li>
                    <li><a href="#" class="hover:text-white">Student Forum</a></li>
                </ul>
            </div>
            <div>
                <h4 class="text-white font-bold uppercase tracking-wider text-xs mb-4">Legal</h4>
                <ul class="space-y-2 text-sm">
                    <li><a href="#" class="hover:text-white">Terms of Service</a></li>
                    <li><a href="#" class="hover:text-white">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-4 mt-12 pt-8 border-t border-navy-800 text-center text-xs">
            &copy; 2024 Spanish by Sammy. All rights reserved.
        </div>
    </footer>

    <!-- Modals and Overlays -->
    <div id="message-modal" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden items-center justify-center p-4 z-[100]">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full border-t-4 border-orange-500">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-navy-900"></h3>
            <div id="modal-message" class="text-gray-700 mb-6 whitespace-pre-wrap"></div>
            <button onclick="closeModal()" class="bg-navy-900 text-white px-4 py-2 rounded-lg shadow-md transition duration-150 ease-in-out hover:bg-navy-800 w-full font-semibold">Close</button>
        </div>
    </div>
    
    <div id="loading-overlay" class="fixed inset-0 bg-gray-50 bg-opacity-75 hidden items-center justify-center z-[100]">
        <div class="flex flex-col items-center">
            <div class="spinner rounded-full h-12 w-12 border-4 border-solid"></div>
            <p class="mt-4 text-navy-900 font-semibold">Connecting...</p>
        </div>
    </div>
    
    <script type="module">
        // =======================================================
        // ========== FIREBASE CONNECTION & CORE LOGIC ===========
        // =======================================================

        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            addDoc,
            getDoc,
            getDocs,
            onSnapshot, 
            collection, 
            query,
            increment,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        // --- YOUR HARDCODED FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAXx2DC-frumAv89q4MEDCHRx2mvf69N_o",
            authDomain: "spanishbysammy-6a112.firebaseapp.com",
            projectId: "spanishbysammy-6a112",
            storageBucket: "spanishbysammy-6a112.firebasestorage.app",
            messagingSenderId: "1011893685836",
            appId: "1:1011893685836:web:90e420f4821573bebf2ee9",
            measurementId: "G-SLNTHSFK0G"
        };
        
        // --- STRIPE CONFIG ---
        // TODO: Replace with your actual Stripe Publishable Key
        const STRIPE_PUBLIC_KEY = 'pk_test_51Sa9Xd5qYNpP9LJH9TvMEHLH0ISP06NMxGIACe6m5QTQ1CwLDnnYS81kzg9fE7Ibnb6clgWnqm37X54zsmG5vgGK00cDy9Ghrj';
        // TODO: Replace with your actual Price IDs from Stripe Dashboard
        const STRIPE_PRICE_IDS = {
            'monthly': 'price_1Sa9Za5qYNpP9LJH3yftmL1Q', 
            'yearly': 'price_1Sb93E5qYNpP9LJHnSITAWQa'
        };
        // TODO: Replace with your deployed Firebase Function URL
        const FIREBASE_FUNCTIONS_BASE_URL = "https://us-central1-spanishbysammy-6a112.cloudfunctions.net";

        const initialAuthToken = null;
        const appId = firebaseConfig.projectId; 

        // --- GLOBAL STATE ---
        let app;
        let auth;
        let db;
        let userId = null;
        let isLoginMode = true;
        let userProgress = {};
        let userCardProgress = {}; // NEW: Per-card progress tracking
        let lastStudiedSet = null;
        let previousLevelStates = {};
        let currentDashboardSlide = 0;
        let currentLessonForAI = null;
        let currentQuizQuestions = [];
        let currentQuizIndex = 0;
        let currentQuizScore = 0;
        let justCompletedLesson = false;
        let allLessons = [];
        let flashcardData = [];
        let userSubscriptionStatus = 'free'; // 'free' or 'premium'
        let currentNextLessonId = null; // Used for "Jump" functionality


        let stripe;

        
        const USE_CLOUD_FUNCTIONS = false; 
        
        // Mock data for the Spanish Decks
        const SPANISH_DECKS = [
            { id: 'deck-1', name: 'Top 10 Essentials' },
            { id: 'deck-2', name: 'Connector Words' },
        ];

        // --- VERB CONJUGATION DATABASE & LOGIC ---
        
        // 1. Core Data (Infinitive, Translations, Simple Tenses, Rank, Participle, Gerund)
        const VERB_DB_RAW = [
            { 
                infinitive: 'ser', 
                translation: 'to be (permanent)',
                rank: 1, 
                participle: 'sido',
                gerund: 'siendo',
                conjugations: {
                    'Present': { 'yo': 'soy', 't√∫': 'eres', '√©l/ella': 'es', 'nosotros': 'somos', 'vosotros': 'sois', 'ellos': 'son' },
                    'Preterite': { 'yo': 'fui', 't√∫': 'fuiste', '√©l/ella': 'fue', 'nosotros': 'fuimos', 'vosotros': 'fuisteis', 'ellos': 'fueron' },
                    'Imperfect': { 'yo': 'era', 't√∫': 'eras', '√©l/ella': 'era', 'nosotros': '√©ramos', 'vosotros': 'erais', 'ellos': 'eran' },
                    'Future': { 'yo': 'ser√©', 't√∫': 'ser√°s', '√©l/ella': 'ser√°', 'nosotros': 'seremos', 'vosotros': 'ser√©is', 'ellos': 'ser√°n' },
                    'Conditional': { 'yo': 'ser√≠a', 't√∫': 'ser√≠as', '√©l/ella': 'ser√≠a', 'nosotros': 'ser√≠amos', 'vosotros': 'ser√≠ais', 'ellos': 'ser√≠an' },
                    'Subjunctive Present': { 'yo': 'sea', 't√∫': 'seas', '√©l/ella': 'sea', 'nosotros': 'seamos', 'vosotros': 'se√°is', 'ellos': 'sean' },
                    'Subjunctive Imperfect': { 'yo': 'fuera', 't√∫': 'fueras', '√©l/ella': 'fuera', 'nosotros': 'fu√©ramos', 'vosotros': 'fuerais', 'ellos': 'fueran' }
                }
            },
            { 
                infinitive: 'estar', 
                translation: 'to be (temporary)',
                rank: 2,
                participle: 'estado',
                gerund: 'estando',
                conjugations: {
                    'Present': { 'yo': 'estoy', 't√∫': 'est√°s', '√©l/ella': 'est√°', 'nosotros': 'estamos', 'vosotros': 'est√°is', 'ellos': 'est√°n' },
                    'Preterite': { 'yo': 'estuve', 't√∫': 'estuviste', '√©l/ella': 'estuvo', 'nosotros': 'estuvimos', 'vosotros': 'estuvisteis', 'ellos': 'estuvieron' },
                    'Imperfect': { 'yo': 'estaba', 't√∫': 'estabas', '√©l/ella': 'estaba', 'nosotros': 'est√°bamos', 'vosotros': 'estabais', 'ellos': 'estaban' },
                    'Future': { 'yo': 'estar√©', 't√∫': 'estar√°s', '√©l/ella': 'estar√°', 'nosotros': 'estaremos', 'vosotros': 'estar√©is', 'ellos': 'estar√°n' },
                    'Conditional': { 'yo': 'estar√≠a', 't√∫': 'estar√≠as', '√©l/ella': 'estar√≠a', 'nosotros': 'estar√≠amos', 'vosotros': 'estar√≠ais', 'ellos': 'estar√≠an' },
                    'Subjunctive Present': { 'yo': 'est√©', 't√∫': 'est√©s', '√©l/ella': 'est√©', 'nosotros': 'estemos', 'vosotros': 'est√©is', 'ellos': 'est√©n' },
                    'Subjunctive Imperfect': { 'yo': 'estuviera', 't√∫': 'estuvieras', '√©l/ella': 'estuviera', 'nosotros': 'estuvi√©ramos', 'vosotros': 'estuvierais', 'ellos': 'estuvieran' }
                }
            },
             { 
                infinitive: 'haber', 
                translation: 'to have (auxiliary)',
                rank: 3,
                participle: 'habido',
                gerund: 'habiendo',
                conjugations: {
                    'Present': { 'yo': 'he', 't√∫': 'has', '√©l/ella': 'ha', 'nosotros': 'hemos', 'vosotros': 'hab√©is', 'ellos': 'han' },
                    'Preterite': { 'yo': 'hube', 't√∫': 'hubiste', '√©l/ella': 'hubo', 'nosotros': 'hubimos', 'vosotros': 'hubisteis', 'ellos': 'hubieron' },
                    'Imperfect': { 'yo': 'hab√≠a', 't√∫': 'hab√≠as', '√©l/ella': 'hab√≠a', 'nosotros': 'hab√≠amos', 'vosotros': 'hab√≠ais', 'ellos': 'hab√≠an' },
                    'Future': { 'yo': 'habr√©', 't√∫': 'habr√°s', '√©l/ella': 'habr√°', 'nosotros': 'habremos', 'vosotros': 'habr√©is', 'ellos': 'habr√°n' },
                    'Conditional': { 'yo': 'habr√≠a', 't√∫': 'habr√≠as', '√©l/ella': 'habr√≠a', 'nosotros': 'habr√≠amos', 'vosotros': 'habr√≠ais', 'ellos': 'habr√≠an' },
                    'Subjunctive Present': { 'yo': 'haya', 't√∫': 'hayas', '√©l/ella': 'haya', 'nosotros': 'hayamos', 'vosotros': 'hay√°is', 'ellos': 'hayan' },
                    'Subjunctive Imperfect': { 'yo': 'hubiera', 't√∫': 'hubieras', '√©l/ella': 'hubiera', 'nosotros': 'hubi√©ramos', 'vosotros': 'hubierais', 'ellos': 'hubieran' }
                }
            },
            { 
                infinitive: 'hablar', 
                translation: 'to speak',
                rank: 50,
                participle: 'hablado',
                gerund: 'hablando',
                conjugations: {
                    'Present': { 'yo': 'hablo', 't√∫': 'hablas', '√©l/ella': 'habla', 'nosotros': 'hablamos', 'vosotros': 'habl√°is', 'ellos': 'hablan' },
                    'Preterite': { 'yo': 'habl√©', 't√∫': 'hablaste', '√©l/ella': 'habl√≥', 'nosotros': 'hablamos', 'vosotros': 'hablasteis', 'ellos': 'hablaron' },
                    'Imperfect': { 'yo': 'hablaba', 't√∫': 'hablabas', '√©l/ella': 'hablaba', 'nosotros': 'habl√°bamos', 'vosotros': 'hablabais', 'ellos': 'hablaban' },
                    'Future': { 'yo': 'hablar√©', 't√∫': 'hablar√°s', '√©l/ella': 'hablar√°', 'nosotros': 'hablaremos', 'vosotros': 'hablar√©is', 'ellos': 'hablar√°n' },
                    'Conditional': { 'yo': 'hablar√≠a', 't√∫': 'hablar√≠as', '√©l/ella': 'hablar√≠a', 'nosotros': 'hablar√≠amos', 'vosotros': 'hablar√≠ais', 'ellos': 'hablar√≠an' },
                    'Subjunctive Present': { 'yo': 'hable', 't√∫': 'hables', '√©l/ella': 'hable', 'nosotros': 'hablemos', 'vosotros': 'habl√©is', 'ellos': 'hablen' },
                    'Subjunctive Imperfect': { 'yo': 'hablara', 't√∫': 'hablaras', '√©l/ella': 'hablara', 'nosotros': 'habl√°ramos', 'vosotros': 'hablarais', 'ellos': 'hablaran' }
                }
            },
            { 
                infinitive: 'comer', 
                translation: 'to eat',
                rank: 60,
                participle: 'comido',
                gerund: 'comiendo',
                conjugations: {
                    'Present': { 'yo': 'como', 't√∫': 'comes', '√©l/ella': 'come', 'nosotros': 'comemos', 'vosotros': 'com√©is', 'ellos': 'comen' },
                    'Preterite': { 'yo': 'com√≠', 't√∫': 'comiste', '√©l/ella': 'comi√≥', 'nosotros': 'comimos', 'vosotros': 'comisteis', 'ellos': 'comieron' },
                    'Imperfect': { 'yo': 'com√≠a', 't√∫': 'com√≠as', '√©l/ella': 'com√≠a', 'nosotros': 'com√≠amos', 'vosotros': 'com√≠ais', 'ellos': 'com√≠an' },
                     'Future': { 'yo': 'comer√©', 't√∫': 'comer√°s', '√©l/ella': 'comer√°', 'nosotros': 'comeremos', 'vosotros': 'comer√©is', 'ellos': 'comer√°n' },
                    'Conditional': { 'yo': 'comer√≠a', 't√∫': 'comer√≠as', '√©l/ella': 'comer√≠a', 'nosotros': 'comer√≠amos', 'vosotros': 'comer√≠ais', 'ellos': 'comer√≠an' },
                    'Subjunctive Present': { 'yo': 'coma', 't√∫': 'comas', '√©l/ella': 'coma', 'nosotros': 'comamos', 'vosotros': 'com√°is', 'ellos': 'coman' },
                    'Subjunctive Imperfect': { 'yo': 'comiera', 't√∫': 'comieras', '√©l/ella': 'comiera', 'nosotros': 'comi√©ramos', 'vosotros': 'comierais', 'ellos': 'comieran' }
                }
            },
            { 
                infinitive: 'vivir', 
                translation: 'to live',
                rank: 70,
                participle: 'vivido',
                gerund: 'viviendo',
                conjugations: {
                    'Present': { 'yo': 'vivo', 't√∫': 'vives', '√©l/ella': 'vive', 'nosotros': 'vivimos', 'vosotros': 'viv√≠s', 'ellos': 'viven' },
                    'Preterite': { 'yo': 'viv√≠', 't√∫': 'viviste', '√©l/ella': 'vivi√≥', 'nosotros': 'vivimos', 'vosotros': 'vivisteis', 'ellos': 'vivieron' },
                    'Imperfect': { 'yo': 'viv√≠a', 't√∫': 'viv√≠as', '√©l/ella': 'viv√≠a', 'nosotros': 'viv√≠amos', 'vosotros': 'viv√≠ais', 'ellos': 'viv√≠an' },
                    'Future': { 'yo': 'vivir√©', 't√∫': 'vivir√°s', '√©l/ella': 'vivir√°', 'nosotros': 'viviremos', 'vosotros': 'vivir√©is', 'ellos': 'vivir√°n' },
                    'Conditional': { 'yo': 'vivir√≠a', 't√∫': 'vivir√≠as', '√©l/ella': 'vivir√≠a', 'nosotros': 'vivir√≠amos', 'vosotros': 'vivir√≠ais', 'ellos': 'vivir√≠an' },
                    'Subjunctive Present': { 'yo': 'viva', 't√∫': 'vivas', '√©l/ella': 'viva', 'nosotros': 'vivamos', 'vosotros': 'viv√°is', 'ellos': 'vivan' },
                    'Subjunctive Imperfect': { 'yo': 'viviera', 't√∫': 'vivieras', '√©l/ella': 'viviera', 'nosotros': 'vivi√©ramos', 'vosotros': 'vivierais', 'ellos': 'vivieran' }
                }
            }
        ];
        
        let VERB_DB = []; 
        let currentDrillVerb = null;
        let currentDrillCard = null; 
        let isCardRevealed = false;
        let verbSortMode = 'frequency'; 
        
        const ALL_SUBJECTS = ['yo', 't√∫', '√©l/ella', 'nosotros', 'vosotros', 'ellos'];
        
        // TENSE SETTINGS HIERARCHY
        const TENSE_HIERARCHY = {
            'Indicative': ['Present', 'Preterite', 'Imperfect', 'Conditional', 'Future'],
            'Subjunctive': ['Subjunctive Present', 'Subjunctive Imperfect'],
            'Perfect': ['Present Perfect', 'Preterite Perfect', 'Imperfect Perfect', 'Conditional Perfect', 'Future Perfect'],
            'Progressive': ['Present Progressive', 'Preterite Progressive', 'Imperfect Progressive', 'Conditional Progressive', 'Future Progressive']
        };

        let enabledTenses = {}; 
        let enabledSubjects = {};

        // --- FLASHCARD STUDY STATE ---
        let currentStudySet = null;
        let currentStudyCards = [];
        let currentStudyIndex = 0;
        let isStudyCardFlipped = false;
        let studySessionStats = { known: 0, learning: 0, unknown: 0 };
        let studyHistory = []; // For undo functionality
        
        // --- Master Session Tracking ---
        let masterSessionCards = []; // Original copies of session cards
        let masterSessionStatus = []; // Latest rating per instance: 'good' | 'easy' | 'hard' | 'again' | null
        let lastSubsetCards = []; // Original cards for "Redo Previous"
        let isRecursiveSubset = false; // Tracking if we are in a sub-session
        let masterSessionID = null;
        let totalMasterStudyTime = 0; // ms
        let currentSessionStartTime = null; // ms for current subset
        let sessionRatingsLog = []; // [{ id: '...', rating: '...' }]
        let learningStack = []; // Cards marked as "learning"
        let studySettings = {
            shuffle: false,
            l1First: false,
            autoSpeak: false
        };
        let currentHammerInstance = null; // Store Hammer instance for cleanup
        let hasPerformedAction = false; // Track if user has swiped/tapped at least once
        let isActionInProgress = false; // Spam protection for rating buttons/swipes

        // --- CEFR LEVEL SYSTEM ---
        window.getCEFRLevel = (totalWords) => {
            const levels = [
                { level: 'A1', threshold: 0, name: 'Absolute Beginner', description: 'Basic Communication', range: '0-500' },
                { level: 'A2', threshold: 500, name: 'Elementary', description: 'Basic Communication', range: '500-1500' },
                { level: 'B1', threshold: 1500, name: 'Intermediate', description: 'Everyday Conversations', range: '1500-2500' },
                { level: 'B2', threshold: 2500, name: 'Upper Intermediate', description: 'Complex Topics', range: '2500-5000' },
                { level: 'C1', threshold: 5000, name: 'Advanced', description: 'Professional Fluency', range: '5000-9500' },
                { level: 'C2', threshold: 9500, name: 'Mastery', description: 'Native-like Proficiency', range: '9500+' }
            ];

            // Find current level
            let currentLevel = levels[0];
            let nextLevel = null;

            for (let i = levels.length - 1; i >= 0; i--) {
                if (totalWords >= levels[i].threshold) {
                    currentLevel = levels[i];
                    nextLevel = levels[i + 1] || null;
                    break;
                }
            }

            // Calculate progress within current level
            const levelStart = currentLevel.threshold;
            const levelEnd = nextLevel ? nextLevel.threshold : 10000; // Cap at 10k for C2
            const levelProgress = Math.min(100, ((totalWords - levelStart) / (levelEnd - levelStart)) * 100);

            return {
                current: currentLevel,
                next: nextLevel,
                progress: levelProgress,
                totalWords: totalWords,
                wordsToNext: nextLevel ? nextLevel.threshold - totalWords : 0
            };
        };

        window.getCEFRIcon = (level) => {
            const icons = {
                'A1': 'üå±', // Seedling
                'A2': 'üåø', // Herb
                'B1': 'üå≥', // Tree
                'B2': 'üå≤', // Pine tree
                'C1': 'üèîÔ∏è', // Mountain
                'C2': 'üèîÔ∏è'  // Mountain peak
            };
            return icons[level] || 'üìö';
        };

        // --- SMART WORD SELECTION ---
        window.getNextWordsForStudy = async (count = 25) => {
            if (!userId || !db) return [];

            try {
                // Get all available cards (this could be optimized with pagination for large datasets)
                const cardsPath = 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/cards';
                const cardsRef = collection(db, cardsPath);
                const cardsSnapshot = await getDocs(cardsRef);

                // Get user's existing card progress
                const progressRef = collection(db, `artifacts/${appId}/users/${userId}/cardProgress`);
                const progressSnapshot = await getDocs(progressRef);

                // Build progress map
                const progressMap = {};
                progressSnapshot.docs.forEach(doc => {
                    progressMap[doc.id] = doc.data();
                });

                // Filter and sort cards by frequency and learning status
                const now = new Date();
                const availableCards = [];

                cardsSnapshot.docs.forEach(doc => {
                    const cardData = doc.data();
                    const progress = progressMap[doc.id];

                    // Skip if already mastered (good rating multiple times)
                    if (progress && progress.repetitions >= 3 && progress.lastRating === 'easy') {
                        return;
                    }

                    // Check if card is due for review
                    if (progress && progress.nextReview) {
                        const nextReviewDate = new Date(progress.nextReview);
                        if (nextReviewDate > now) {
                            return; // Not due yet
                        }
                    }

                    availableCards.push({
                        id: doc.id,
                        frequency: cardData.frequency || 999,
                        progress: progress,
                        data: cardData
                    });
                });

                // Sort by priority: due cards first, then by frequency rank
                availableCards.sort((a, b) => {
                    // Due reviews get highest priority
                    const aDue = a.progress && new Date(a.progress.nextReview) <= now;
                    const bDue = b.progress && new Date(b.progress.nextReview) <= now;

                    if (aDue && !bDue) return -1;
                    if (!aDue && bDue) return 1;

                    // Then by frequency (lower number = higher frequency = higher priority)
                    if (a.frequency !== b.frequency) {
                        return a.frequency - b.frequency;
                    }

                    // Finally by least recently studied
                    const aLastStudied = a.progress ? new Date(a.progress.lastReviewed) : new Date(0);
                    const bLastStudied = b.progress ? new Date(b.progress.lastReviewed) : new Date(0);
                    return aLastStudied - bLastStudied;
                });

                return availableCards.slice(0, count);
            } catch (error) {
                console.error('Error selecting next words:', error);
                return [];
            }
        };

        window.startLearningNewWords = async () => {
            showLoading("Selecting your next words...");

            try {
                const wordsToLearn = await getNextWordsForStudy(25);

                if (wordsToLearn.length === 0) {
                    showModal("All Caught Up!", "Congratulations! You've learned all available words. Check back later for new content.");
                    hideLoading();
                    return;
                }

                // Create a temporary study set
                const tempSet = {
                    setID: 'daily-words-' + Date.now(),
                    title: `Today's Words (${wordsToLearn.length})`,
                    cards: wordsToLearn.map(w => w.id)
                };

                // Load the cards into current study session
                const cardsPath = 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/cards';
                const fetchedCards = [];

                for (const word of wordsToLearn) {
                    const docSnap = await getDoc(doc(db, cardsPath, word.id));
                    if (docSnap.exists()) {
                        fetchedCards.push(docSnap.data());
                    }
                }

                if (fetchedCards.length === 0) {
                    showModal("Error", "Could not load selected words.");
                    hideLoading();
                    return;
                }

                // Set up study session
                currentStudySet = tempSet;
                studySessionStats = { known: 0, learning: 0, unknown: 0 };
                studyHistory = [];
                learningStack = [];
                currentStudyIndex = 0;
                hasPerformedAction = false;

                // Map cards
                currentStudyCards = fetchedCards.map(card => ({
                    spanish: Array.isArray(card.termTarget) ? card.termTarget[0] : card.termTarget,
                    english: card.termSource,
                    id: card.id || Math.random().toString(36),
                    pos: card.pos || [],
                    examples: card.examples || [],
                    dictionaryDefinition: card.dictionaryDefinition || { source: '', target: '' },
                    frequency: card.frequency || 0
                }));

                // Transition to study view
                document.getElementById('flashcards').classList.remove('active');
                document.getElementById('flashcard-study').classList.add('active');

                // Initialize study interface
                renderCardDeck();
                initializeGestures();
                updateStudyProgress();

                hideLoading();

            } catch (error) {
                console.error('Error starting daily words:', error);
                showModal("Error", "Failed to start learning session.");
                hideLoading();
            }
        };

        // --- FLASHCARD STUDY FUNCTIONS (COMPLETE IMPLEMENTATION) ---

        window.openFlashcardStudy = async (setID) => {
            // Find the set in flashcardData
            let foundSet = null;
            for (const level of flashcardData) {
                foundSet = level.sets.find(s => s.setID === setID);
                if (foundSet) break;
            }

            if (!foundSet) {
                showModal("Error", "Flashcard set not found.");
                return;
            }

            currentStudySet = foundSet;

            // NEW: Initialize Master Session
            masterSessionID = setID + '-' + Date.now();
            totalMasterStudyTime = 0;
            sessionRatingsLog = [];
            hasPerformedAction = false;
            learningStack = [];

            // Transition to study view
            document.getElementById('flashcards').classList.remove('active');
            document.getElementById('flashcard-study').classList.add('active');
            
            // Show loading
            document.getElementById('study-loading').classList.remove('hidden');
            document.getElementById('study-card-container').classList.add('hidden');
            document.getElementById('study-complete').classList.add('hidden');
            
            // Update title
            document.getElementById('study-set-title').textContent = foundSet.title;
            
            // Load cards from Firebase
            try {
                if (!foundSet.cards || foundSet.cards.length === 0) {
                    showModal("No Cards", "This set has no flashcards yet.");
                    exitFlashcardStudy();
                    return;
                }
                
                const cardsPath = 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/cards';
                const cardIDs = foundSet.cards;
                const fetchedCards = [];
                
                // Batch queries in groups of 10
                for (let i = 0; i < cardIDs.length; i += 10) {
                    const batch = cardIDs.slice(i, i + 10);
                    const batchDocs = await Promise.all(
                        batch.map(cardID => getDoc(doc(db, cardsPath, cardID)))
                    );

                    batchDocs.forEach(docSnap => {
                        if (docSnap.exists()) {
                            const cardData = docSnap.data();
                            cardData.docId = docSnap.id; // Include the Firestore document ID
                            fetchedCards.push(cardData);
                        }
                    });
                }

                if (fetchedCards.length === 0) {
                    showModal("No Cards", "Could not load cards for this set.");
                    exitFlashcardStudy();
                    return;
                }

                // Map cards and apply settings
                currentStudyCards = fetchedCards.map((card, index) => ({
                    spanish: Array.isArray(card.termTarget) ? card.termTarget[0] : card.termTarget,
                    english: card.termSource,
                    id: card.docId, // Use the Firestore document ID for SRS updates
                    masterIndex: index, // CRITICAL: Position-based tracking for the stats report
                    pos: card.pos || [],
                    examples: card.examples || [],
                    dictionaryDefinition: card.dictionaryDefinition || { source: '', target: '' },
                    frequency: card.frequency || 0
                }));
                
                // Store master copies and initialize position-based status tracking
                masterSessionCards = [...currentStudyCards];
                masterSessionStatus = new Array(masterSessionCards.length).fill(null);
                
                startStudySubset();
                
            } catch (error) {
                console.error("Error loading flashcards:", error);
                showModal("Error", "Failed to load flashcards: " + error.message);
                exitFlashcardStudy();
            }
        };

        // NEW: Core Logic for starting/continuing card stack subsets
        window.startStudySubset = (subsetCards = null, isRedo = false) => {
            // Apply subsets if provided, otherwise assume master session initialization
            if (subsetCards) {
                currentStudyCards = [...subsetCards];
                isRecursiveSubset = !isRedo; // redo counts as recursive logic but resets the "redo" trigger
                lastSubsetCards = [...subsetCards];
            } else {
                // If initializing from master and shuffle is enabled
                if (studySettings.shuffle) {
                    currentStudyCards = [...masterSessionCards].sort(() => Math.random() - 0.5);
                } else {
                    currentStudyCards = [...masterSessionCards];
                }
                isRecursiveSubset = false;
                lastSubsetCards = [...currentStudyCards];
            }

            // Reset Subset States
            currentStudyIndex = 0;
            studySessionStats = { known: 0, learning: 0, unknown: 0 };
            studyHistory = [];
            currentSessionStartTime = Date.now();
            
            // Reset UI Visibility
            document.getElementById('study-loading').classList.add('hidden');
            document.getElementById('study-card-container').classList.remove('hidden');
            document.getElementById('study-complete').classList.add('hidden');
            
            updateStudyStats();
            updateStudyProgress();
            renderCardDeck();
            
            // Instructional cleanup
            hasPerformedAction = false;
        };

        window.handleRestartSession = (mode) => {
            if (mode === "all") {
                // Full restart - clears learning stack and log
                learningStack = [];
                sessionRatingsLog = [];
                masterSessionStatus = new Array(masterSessionCards.length).fill(null); // RESET instance tracking
                totalMasterStudyTime = 0; // Reset duration correctly
                startStudySubset();
            } else if (mode === "missed") {
                // Restart subset using only cards in learningStack
                const subset = [...learningStack];
                learningStack = []; // Clear for new subset collection
                startStudySubset(subset);
            } else if (mode === "redo") {
                // Repeat just the previous subset
                const subset = [...lastSubsetCards];
                learningStack = [];
                startStudySubset(subset, true);
            }
        };

        // Helper function to get POS pill color
        window.getPosColor = (pos) => {
            const posLower = pos.toLowerCase();
            if (posLower.includes('noun') || posLower.includes('sustantivo')) {
                return 'bg-yellow-100 text-yellow-800';
            }
            if (posLower.includes('verb') || posLower.includes('verbo')) {
                return 'bg-pink-100 text-pink-800';
            }
            if (posLower.includes('adjective') || posLower.includes('adjetivo')) {
                return 'bg-orange-100 text-orange-800';
            }
            if (posLower.includes('adverb') || posLower.includes('adverbio')) {
                return 'bg-purple-100 text-purple-800';
            }
            if (posLower.includes('preposition') || posLower.includes('preposici√≥n')) {
                return 'bg-blue-100 text-blue-800';
            }
            // Default fallback for any unrecognized POS
            return 'bg-gray-100 text-gray-700';
        };

        // Helper function to render POS pills HTML
        window.renderPosPillsHTML = (posArray) => {
            if (!posArray || posArray.length === 0) return '';
            
            return posArray.map(pos => {
                const colorClass = getPosColor(pos);
                return `<span class="px-3 py-1 text-xs font-bold uppercase rounded-full ${colorClass}">${pos}</span>`;
            }).join('');
        };

        window.renderCardDeck = () => {
            const deck = document.getElementById('card-deck');
            if (!deck) return;
            
            // Show completion screen if all done
            if (currentStudyIndex >= currentStudyCards.length) {
                showCompletionScreen();
                return;
            }
            
            // Clear and render immediately (no fade delay to prevent janky flashing)
            deck.innerHTML = '';
            renderNewCards();
            
            function renderNewCards() {
                // Render up to 3 cards (current + 2 background)
                const cardsToShow = Math.min(3, currentStudyCards.length - currentStudyIndex);
                
                for (let i = 0; i < cardsToShow; i++) {
                    const cardIndex = currentStudyIndex + i;
                    const card = currentStudyCards[cardIndex];
                    const isTopCard = i === 0;
                    
                    // Create card container with 3D perspective wrapper
                    const cardWrapper = document.createElement('div');
                    cardWrapper.className = `absolute inset-0 perspective-1000 ${isTopCard ? 'z-30' : 'z-' + (20 - i)}`;
                    cardWrapper.id = isTopCard ? 'top-card-wrapper' : `card-wrapper-${i}`;
                    
                    // Inner card with flip capability
                    const cardInner = document.createElement('div');
                    cardInner.className = 'relative w-full h-full preserve-3d transition-flip';
                    cardInner.id = isTopCard ? 'top-card-inner' : `card-inner-${i}`;
                    cardInner.style.transformStyle = 'preserve-3d';
                    // IMPORTANT: Start unflipped
                    cardInner.style.transform = 'rotateY(0deg)';
                    
                    // Card content
                    const showSpanish = !studySettings.l1First;
                    const frontText = showSpanish ? card.spanish : card.english;
                    const backText = showSpanish ? card.english : card.spanish;
                    
                    // Prepare card data based on language direction
                    const frontPos = showSpanish ? card.pos : card.pos;
                    const backPos = card.pos;
                    const frontExample = card.examples?.[0] ? (showSpanish ? card.examples[0].target : card.examples[0].source) : '';
                    const backExample = card.examples?.[0] ? (showSpanish ? card.examples[0].source : card.examples[0].target) : '';
                    const rankBadge = card.frequency > 0 ? `#${card.frequency}` : '';
                    
                    // Front face - Enhanced with POS, Examples, Rank
                    const frontFace = document.createElement('div');
                    frontFace.className = 'absolute inset-0 bg-white rounded-2xl shadow-2xl border-4 border-transparent flex flex-col p-6 backface-hidden study-card';
                    frontFace.id = `card-front-${i}`;
                    frontFace.innerHTML = `
                        <div class="absolute top-4 right-5">
                            <span class="text-xs font-bold text-slate-400">${rankBadge}</span>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center relative">
                            <div class="text-center mb-2">
                                <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 text-center leading-tight" style="font-size: clamp(1.5rem, 4vw, 3rem);">${frontText}</h2>
                            </div>
                            <div class="flex flex-wrap gap-2 justify-center mb-4 items-center">
                                ${renderPosPillsHTML(frontPos)}
                                <button onclick="event.stopPropagation(); openDictionary(${cardIndex}, false)" class="p-2 text-slate-300 hover:text-blue-500 transition-colors rounded-full hover:bg-slate-50">
                                    <i data-lucide="book-open" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        ${frontExample ? `<div class="mt-auto pt-4 border-t border-slate-100">
                            <p class="text-center text-sm sm:text-base text-slate-500 italic font-medium leading-relaxed">${frontExample}</p>
                        </div>` : ''}
                        <div class="text-center mt-2 text-xs text-gray-400 uppercase tracking-wider">
                            ${isTopCard && !hasPerformedAction ? 'Tap to flip' : ''}
                        </div>
                    `;
                    
                    // Back face - Enhanced with POS, Examples, Rank
                    const backFace = document.createElement('div');
                    backFace.className = 'absolute inset-0 bg-white rounded-2xl shadow-2xl border-4 border-transparent flex flex-col p-6 backface-hidden rotate-y-180 study-card';
                    backFace.id = `card-back-${i}`;
                    backFace.innerHTML = `
                        <div class="absolute top-4 right-5">
                            <span class="text-xs font-bold text-slate-400">${rankBadge}</span>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center relative">
                            <div class="text-center mb-2">
                                <h2 class="text-2xl sm:text-3xl font-bold text-slate-800 text-center leading-tight" style="font-size: clamp(1.5rem, 4vw, 3rem);">${backText}</h2>
                            </div>
                            <div class="flex flex-wrap gap-2 justify-center mb-4 items-center">
                                ${renderPosPillsHTML(backPos)}
                                <button onclick="event.stopPropagation(); openDictionary(${cardIndex}, true)" class="p-2 text-slate-300 hover:text-blue-500 transition-colors rounded-full hover:bg-slate-50">
                                    <i data-lucide="book-open" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        ${backExample ? `<div class="mt-auto pt-4 border-t border-slate-100">
                            <p class="text-center text-sm sm:text-base text-slate-500 italic font-medium leading-relaxed">${backExample}</p>
                        </div>` : ''}
                        <div class="text-center mt-2 text-xs text-gray-400 uppercase tracking-wider">
                            ${isTopCard && !hasPerformedAction ? 'Tap to flip back' : ''}
                        </div>
                    `;
                    
                    cardInner.appendChild(frontFace);
                    cardInner.appendChild(backFace);
                    cardWrapper.appendChild(cardInner);
                    
                    // Set initial position for stacked effect
                    if (!isTopCard) {
                        cardWrapper.style.transform = `translateY(${i * 8}px) scale(${1 - i * 0.05})`;
                        cardWrapper.style.opacity = 0; // Hide background cards completely
                        cardWrapper.style.pointerEvents = 'none';
                    } else {
                        // Animate entrance for top card
                        cardWrapper.style.opacity = '0';
                        cardWrapper.style.transform = 'scale(0.8)';
                        
                        requestAnimationFrame(() => {
                            cardWrapper.classList.add('transition-appear');
                            cardWrapper.style.opacity = '1';
                            cardWrapper.style.transform = 'scale(1)';
                        });
                    }
                    
                    deck.appendChild(cardWrapper);
                }
                
                // RE-INITIALIZE GESTURES after rendering new cards
                setTimeout(() => {
                    initializeGestures();
                }, 100);
                
                if (window.lucide) lucide.createIcons();
            }
        };

        window.flipTopCard = () => {
            const cardInner = document.getElementById('top-card-inner');
            if (!cardInner) return;
            
            // Toggle flip state
            isStudyCardFlipped = !isStudyCardFlipped;
            
            // Apply 3D rotation
            if (isStudyCardFlipped) {
                cardInner.style.transform = 'rotateY(180deg)';
                
                // Auto-speak if enabled (now speaks only the term, not UI text)
                if (studySettings.autoSpeak) {
                    setTimeout(() => {
                        speakCurrentFlashcard();
                    }, 250); // Wait for flip animation
                }
            } else {
                cardInner.style.transform = 'rotateY(0deg)';
            }
        };

        window.initializeGestures = () => {
            const topCardWrapper = document.getElementById('top-card-wrapper');
            if (!topCardWrapper || !window.Hammer) return;
            
            // CRITICAL: Destroy previous Hammer instance to prevent multiple listeners
            if (currentHammerInstance) {
                currentHammerInstance.destroy();
                currentHammerInstance = null;
            }
            
            currentHammerInstance = new Hammer(topCardWrapper);
            currentHammerInstance.get('pan').set({ direction: Hammer.DIRECTION_ALL, threshold: 0 });
            currentHammerInstance.get('tap').set({ enable: true, time: 250, threshold: 5 });
            
            let dragStarted = false;
            let maxDragDistance = 0;
            const SWIPE_THRESHOLD = 120; // Reduced for easier mobile swiping
            
            // Remove transitions when dragging starts
            currentHammerInstance.on('panstart', () => {
                dragStarted = false;
                maxDragDistance = 0;
                topCardWrapper.classList.remove('transition-transform-smooth', 'transition-appear');
                topCardWrapper.style.transition = 'none';
            });
            
            // Update position, rotation, and visual feedback during drag
            currentHammerInstance.on('panmove', (ev) => {
                const x = ev.deltaX;
                const y = ev.deltaY;
                const distance = Math.sqrt(x * x + y * y);
                
                // Track if user has dragged significantly
                if (distance > 15) {
                    dragStarted = true;
                }
                
                // Track maximum drag distance
                maxDragDistance = Math.max(maxDragDistance, Math.abs(x));
                
                const rotation = x / 20;
                
                // Progressive opacity: starts at 1.0, fades to 0.4 (60% transparent) at swipe threshold
                const opacityProgress = Math.min(Math.abs(x) / SWIPE_THRESHOLD, 1.0);
                const opacity = 1.0 - (opacityProgress * 0.6); // Fade from 100% to 40%
                
                // Update card position and appearance
                topCardWrapper.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg)`;
                topCardWrapper.style.opacity = opacity;
                
                // Progressive border color and width
                const cardFaces = topCardWrapper.querySelectorAll('.study-card');
                cardFaces.forEach(cardFace => {
                    if (Math.abs(x) < 30) {
                        // Dead zone - no border
                        cardFace.style.borderColor = 'transparent';
                        cardFace.style.borderWidth = '4px';
                    } else {
                        // Progressive border intensity
                        const borderProgress = Math.min((Math.abs(x) - 30) / (SWIPE_THRESHOLD - 30), 1.0);
                        const borderWidth = 4 + (borderProgress * 4); // Grows from 4px to 8px
                        
                        if (x < 0) {
                            // Swiping left - Red border (unknown)
                            const alpha = 0.3 + (borderProgress * 0.7); // Fade from 30% to 100%
                            cardFace.style.borderColor = `rgba(239, 68, 68, ${alpha})`;
                        } else {
                            // Swiping right - Green border (known)
                            const alpha = 0.3 + (borderProgress * 0.7);
                            cardFace.style.borderColor = `rgba(16, 185, 129, ${alpha})`;
                        }
                        cardFace.style.borderWidth = `${borderWidth}px`;
                    }
                });
                
                // Animate buttons based on drag direction
                updateButtonScales(x);
            });
            
            // Complete or cancel swipe when drag ends
            currentHammerInstance.on('panend', (ev) => {
                const x = ev.deltaX;
                console.log('Swipe detected, deltaX:', x, 'threshold:', SWIPE_THRESHOLD);

                if (x > SWIPE_THRESHOLD) {
                    // Swiped right far enough - Known (easy rating for SRS)
                    console.log('Right swipe detected - calling handleCardAction(easy)');
                    handleCardAction('easy');
                } else if (x < -SWIPE_THRESHOLD) {
                    // Swiped left far enough - Unknown (again rating for SRS)
                    console.log('Left swipe detected - calling handleCardAction(again)');
                    handleCardAction('again');
                } else {
                    // Didn't swipe far enough - reset card WITHOUT FLIPPING
                    topCardWrapper.classList.add('transition-transform-smooth');
                    topCardWrapper.style.transform = '';
                    topCardWrapper.style.opacity = '1';
                    
                    const cardFaces = topCardWrapper.querySelectorAll('.study-card');
                    cardFaces.forEach(cardFace => {
                        cardFace.style.borderColor = 'transparent';
                        cardFace.style.borderWidth = '4px';
                    });
                    
                    updateButtonScales(0);
                    
                    // CRITICAL FIX: Reset dragStarted so tap works again
                    dragStarted = false;
                    maxDragDistance = 0;
                }
            });
            
            // Tap to flip - ONLY if card is stationary (no significant drag)
            currentHammerInstance.on('tap', (ev) => {
                // Only flip if user did NOT drag the card AND max distance is minimal
                if (!dragStarted && maxDragDistance < 10) {
                    // Check if tapped on a button - if so, don't flip
                    const target = ev.target;
                    if (target && target.closest('button')) {
                        return;
                    }
                    flipTopCard();
                }
            });
        };

        // Helper function to animate buttons during swipe
        window.updateButtonScales = (x) => {
            const knownBtn = document.querySelector('#study-card-container button[onclick*="known"]');
            const unknownBtn = document.querySelector('#study-card-container button[onclick*="unknown"]');
            
            if (!knownBtn || !unknownBtn) return;
            
            if (x === 0) {
                // Reset buttons
                knownBtn.style.transform = 'scale(1)';
                knownBtn.style.backgroundColor = '';
                unknownBtn.style.transform = 'scale(1)';
                unknownBtn.style.backgroundColor = '';
                return;
            }
            
            const progress = Math.min(Math.abs(x) / 150, 1.0);
            
            if (x > 0) {
                // Swiping right - animate known button
                knownBtn.style.transform = `scale(${1 + progress * 0.3})`;
                knownBtn.style.backgroundColor = `rgba(34, 197, 94, ${progress * 0.2})`;
                unknownBtn.style.transform = 'scale(1)';
                unknownBtn.style.backgroundColor = '';
            } else {
                // Swiping left - animate unknown button
                unknownBtn.style.transform = `scale(${1 + progress * 0.3})`;
                unknownBtn.style.backgroundColor = `rgba(239, 68, 68, ${progress * 0.2})`;
                knownBtn.style.transform = 'scale(1)';
                knownBtn.style.backgroundColor = '';
            }
        };

        // Spaced Repetition Algorithm (Anki-inspired)
        window.calculateNextReview = (cardProgress, rating) => {
            // Initialize default values for new cards or handle missing data
            let easeFactor = 2.1; // Default starting ease factor
            let interval = 1; // Default interval
            let repetitions = 0; // Default repetitions

            // If card exists, use its current values (with fallbacks)
            if (cardProgress) {
                easeFactor = isNaN(cardProgress.easeFactor) ? 2.1 : cardProgress.easeFactor;
                interval = cardProgress.interval || 1;
                repetitions = cardProgress.repetitions || 0;
            }

            // Calculate new values based on rating
            if (!cardProgress) {
                // New card intervals
                interval = rating === 'again' ? 0 : // Immediate review
                         rating === 'hard' ? 1 : // 1 day
                         rating === 'good' ? 3 : // 3 days
                         7; // Easy: 7 days
                repetitions = rating === 'again' ? 0 : 1;
            } else {
                // Existing card - update based on performance
                switch (rating) {
                    case 'again':
                        easeFactor = Math.max(1.3, easeFactor - 0.2);
                        repetitions = 0;
                        interval = 0; // Immediate review
                        break;
                    case 'hard':
                        easeFactor = Math.max(1.3, easeFactor - 0.15);
                        repetitions = 0;
                        interval = Math.max(1, Math.round(interval * 0.5)); // Half interval
                        break;
                    case 'good':
                        repetitions++;
                        interval = repetitions === 1 ? 3 :
                                  repetitions === 2 ? 7 :
                                  Math.round(interval * easeFactor);
                        break;
                    case 'easy':
                        easeFactor = Math.min(2.5, easeFactor + 0.15);
                        repetitions++;
                        interval = Math.round(interval * easeFactor * 1.3); // Longer for easy
                        break;
                }
            }

            return {
                easeFactor: easeFactor,
                interval: Math.max(1, interval), // At least 1 day
                repetitions: repetitions,
                nextReview: new Date(Date.now() + interval * 24 * 60 * 60 * 1000).toISOString()
            };
        };

        // Save individual card progress to Firebase
        window.saveCardProgress = async (cardId, rating) => {
            if (!userId || !db) return;

            try {
                const cardProgressRef = doc(db, `artifacts/${appId}/users/${userId}/cardProgress`, cardId);
                const existingDoc = await getDoc(cardProgressRef);
                const existingData = existingDoc.exists() ? existingDoc.data() : null;

                const newData = calculateNextReview(existingData, rating);
                const now = new Date().toISOString();

                await setDoc(cardProgressRef, {
                    userId,
                    cardId,
                    lastRating: rating,
                    lastReviewed: now,
                    timesReviewed: (existingData?.timesReviewed || 0) + 1,
                    timesCorrect: (existingData?.timesCorrect || 0) + (rating !== 'again' ? 1 : 0),
                    timesIncorrect: (existingData?.timesIncorrect || 0) + (rating === 'again' ? 1 : 0),
                    ...newData
                }, { merge: true });

                console.log(`Card ${cardId} progress saved:`, newData);
            } catch (error) {
                console.error('Failed to save card progress:', error);
            }
        };

        window.handleCardAction = (rating) => {
            // Spam protection: Ignore if we are currently animating to the next card
            if (isActionInProgress) return;

            const card = currentStudyCards[currentStudyIndex];
            const topCardWrapper = document.getElementById('top-card-wrapper');

            if (!topCardWrapper || !card) return;

            // Set lockout flag
            isActionInProgress = true;

            // TRACKING: Update specific instance status for current session report
            if (card.masterIndex !== undefined) {
                masterSessionStatus[card.masterIndex] = rating;
            }

            // SRS: Update global database progress using card ID
            saveCardProgress(card.id, rating);

            // LOG: Legacy entry for auditing or extra metrics
            sessionRatingsLog.push({ id: card.id, rating: rating });

            // Track that user has performed at least one action
            hasPerformedAction = true;

            // Save to history for undo
            studyHistory.push({
                index: currentStudyIndex,
                rating: rating,
                stats: { ...studySessionStats }
            });

            // Add to learning stack if not known
            if (rating === 'again' || rating === 'hard') {
                // Prevent duplicate IDs in stack
                if (!learningStack.find(c => c.id === card.id)) {
                    learningStack.push(card);
                }
            }

            // Determine animation direction based on rating
            let direction, endX, rotation;
            switch (rating) {
                case 'again':
                    direction = -1;
                    endX = -window.innerWidth * 1.2;
                    rotation = -30;
                    break;
                case 'hard':
                    direction = -0.5;
                    endX = -window.innerWidth * 0.8;
                    rotation = -15;
                    break;
                case 'good':
                    direction = 0.5;
                    endX = window.innerWidth * 0.8;
                    rotation = 15;
                    break;
                case 'easy':
                    direction = 1;
                    endX = window.innerWidth * 1.2;
                    rotation = 30;
                    break;
            }

            // Animate card exit
            topCardWrapper.classList.remove('transition-appear');
            topCardWrapper.classList.add('transition-transform-smooth');
            topCardWrapper.style.transform = `translateX(${endX}px) translateY(50px) rotate(${rotation}deg)`;
            topCardWrapper.style.opacity = '0';

            // Update stats based on rating
            switch (rating) {
                case "again":
                case "hard":
                    studySessionStats.unknown++;
                    break;
                case "good":
                case "easy":
                    studySessionStats.known++;
                    break;
            }

            // Enable undo button
            document.getElementById('undo-btn').disabled = false;

            // Update display
            updateStudyStats();

            // Move to next card after animation
            setTimeout(() => {
                currentStudyIndex++;
                isStudyCardFlipped = false; // Reset flip state
                renderCardDeck();
                updateStudyProgress();

                // Reset lockout flag after new card is ready
                isActionInProgress = false;

                // Auto-speak new card if enabled
                if (studySettings.autoSpeak) {
                    setTimeout(() => {
                        speakCurrentFlashcard();
                    }, 100); // Short delay for render to complete
                    // Note: lockout remains false as speech is non-blocking
                }
            }, 350);
        };

        window.undoLastAction = () => {
            if (studyHistory.length === 0) return;
            
            const lastAction = studyHistory.pop();
            
            // Restore state
            currentStudyIndex = lastAction.index;
            studySessionStats = { ...lastAction.stats };
            
            // Remove from learning stack if applicable
            if (lastAction.action === 'learning' && learningStack.length > 0) {
                learningStack.pop();
            }
            
            // Disable undo if no more history
            if (studyHistory.length === 0) {
                document.getElementById('undo-btn').disabled = true;
            }
            
            // Re-render
            renderCardDeck();
            updateStudyStats();
            updateStudyProgress();
        };

        window.updateStudyProgress = () => {
            const total = currentStudyCards.length;
            const current = currentStudyIndex;
            const pct = total > 0 ? (current / total) * 100 : 0;
            
            document.getElementById('study-progress-text').textContent = `${current}/${total}`;
            document.getElementById('study-progress-bar').style.width = pct + '%';
        };

        window.updateStudyStats = () => {
            document.getElementById("known-count").textContent = studySessionStats.known;
            document.getElementById("unknown-count").textContent = studySessionStats.unknown;
        };

        window.showCompletionScreen = (mode = "complete") => {
            document.getElementById("study-card-container").classList.add("hidden");
            const completeEl = document.getElementById("study-complete");
            completeEl.classList.remove("hidden");

            // 1. Update Mode UI & Button Visibility
            const emoji = document.getElementById("res-emoji");
            const title = document.getElementById("res-title");
            const subtitle = document.getElementById("res-subtitle");

            const resumeBtn = document.getElementById("btn-resume-study");
            const redoBtn = document.getElementById("btn-redo-subset");
            const missedBtn = document.getElementById("btn-review-missed");

            // Reset buttons
            resumeBtn.classList.add("hidden");
            redoBtn.classList.add("hidden");
            missedBtn.classList.add("hidden");

            if (mode === "exit") {
                emoji.textContent = "‚è±Ô∏è";
                title.textContent = "Session Paused";
                subtitle.textContent = "Keep up the momentum!";
                resumeBtn.classList.remove("hidden");
            } else {
                emoji.textContent = "üèÜ";
                title.textContent = "¬°Buen Trabajo!";
                subtitle.textContent = "Session path complete";
                if (typeof triggerConfetti === "function") triggerConfetti();

                // Logic for recursive results
                if (learningStack.length > 0) {
                    missedBtn.classList.remove("hidden");
                    document.getElementById("res-count-missed").textContent = `${learningStack.length} cards`;
                } else if (isRecursiveSubset) {
                    // Just finished a subset and got them all right
                    redoBtn.classList.remove("hidden");
                    document.getElementById("res-count-redo").textContent = `${lastSubsetCards.length} cards`;
                }
            }

            // 2. Update Metrics
            const sessionDurationMs = Date.now() - currentSessionStartTime;
            totalMasterStudyTime += sessionDurationMs;

            const minutes = Math.floor(totalMasterStudyTime / 60000);
            const seconds = Math.floor((totalMasterStudyTime % 60000) / 1000);
            document.getElementById("res-duration").textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;

            // Calculate Average Time
            const totalSwipes = sessionRatingsLog.length;
            const avgTime = totalSwipes > 0 ? (totalMasterStudyTime / 1000 / totalSwipes).toFixed(1) : "0.0";
            document.getElementById("res-avg-time").textContent = `${avgTime}s`;

            // STATS CALCULATION: Position-Based Unique Tracking
            // This ensures math always equals master deck size (e.g. 21)
            const masteredCount = masterSessionStatus.filter(r => r === "good" || r === "easy").length;
            const learningCount = masterSessionStatus.filter(r => r === "again" || r === "hard").length;

            document.getElementById("res-mastered").textContent = masteredCount;
            document.getElementById("res-learning").textContent = learningCount;

            // 3. Master Count Update
            document.getElementById("res-count-all").textContent = `${masterSessionCards.length} cards`;

            // 4. Decorations
            const header = document.getElementById("session-header");
            header.style.transform = "scale(1)";

            // Save progress to Firebase if completed
            if (mode === "complete") {
                saveStudyProgress();
            }
        };

        window.resumeStudy = () => {
            document.getElementById("study-complete").classList.add("hidden");
            document.getElementById("study-card-container").classList.remove("hidden");
            // Important: restart the timer for this subset path
            currentSessionStartTime = Date.now();
        };

        window.reviewLearningStack = () => {
            // Reset for review session
            currentStudyCards = [...learningStack];
            learningStack = [];
            currentStudyIndex = 0;
            studySessionStats = { known: 0, learning: 0, unknown: 0 };
            studyHistory = [];
            
            // Return to study view
            document.getElementById('study-complete').classList.add('hidden');
            document.getElementById('study-card-container').classList.remove('hidden');
            
            renderCardDeck();
            updateStudyProgress();
        };

        window.saveStudyProgress = async () => {
            if (!userId || !currentStudySet) return;
            
            try {
                const docRef = getDeckDocRef(currentStudySet.setID);
                const timestamp = new Date().toISOString();
                
                await setDoc(docRef, {
                    status: 'complete',
                    completedAt: timestamp,
                    userId: userId,
                    stats: studySessionStats,
                    lastStudied: timestamp
                }, { merge: true });
                
                console.log("Study progress saved successfully");
            } catch (error) {
                console.error("Failed to save study progress:", error);
            }
        };

        window.openDictionary = (cardIndex, isFlipped) => {
            const card = currentStudyCards[cardIndex];
            if (!card) return;
            
            const showSpanish = !studySettings.l1First;
            
            // Determine which definition to show based on card state and language setting
            let term, definition;
            
            if (isFlipped) {
                // Back side is showing
                if (showSpanish) {
                    // Back shows English (translation)
                    term = card.english;
                    definition = card.dictionaryDefinition?.source || '<p>No definition available.</p>';
                } else {
                    // Back shows Spanish (when l1First is enabled)
                    term = card.spanish;
                    definition = card.dictionaryDefinition?.target || '<p>No definition available.</p>';
                }
            } else {
                // Front side is showing
                if (showSpanish) {
                    // Front shows Spanish (main term)
                    term = card.spanish;
                    definition = card.dictionaryDefinition?.target || '<p>No definition available.</p>';
                } else {
                    // Front shows English (when l1First is enabled)
                    term = card.english;
                    definition = card.dictionaryDefinition?.source || '<p>No definition available.</p>';
                }
            }
            
            const modal = document.getElementById('dictionary-modal');
            const content = document.getElementById('dictionary-modal-content');
            
            modal.classList.remove('hidden');
            modal.classList.remove('animate-fade-out');
            modal.classList.add('animate-fade-in');
            
            content.classList.remove('animate-slide-down');
            content.classList.add('animate-slide-up');
            
            document.getElementById('dictionary-content').innerHTML = `
                <h3 class="text-2xl font-bold text-navy-900 mb-4">${term}</h3>
                <div class="text-gray-700 leading-relaxed">${definition}</div>
            `;
            if (window.lucide) lucide.createIcons();
        };

        window.closeDictionary = () => {
            const modal = document.getElementById('dictionary-modal');
            const content = document.getElementById('dictionary-modal-content');
            
            modal.classList.remove('animate-fade-in');
            modal.classList.add('animate-fade-out');
            
            content.classList.remove('animate-slide-up');
            content.classList.add('animate-slide-down');
            
            // Wait for animation to finish before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('animate-fade-out');
            }, 250);
        };

        window.handleDictionaryBackdropClick = (event) => {
            // Only close if the backdrop itself was clicked, not its children
            if (event.target.id === 'dictionary-modal') {
                closeDictionary();
            }
        };

        window.toggleStudySettings = () => {
            const modal = document.getElementById('study-settings-modal');
            const content = document.getElementById('study-settings-modal-content');
            const isHiding = !modal.classList.contains('hidden');
            
            if (isHiding) {
                // Dimissal Animation
                modal.classList.remove('animate-fade-in');
                modal.classList.add('animate-fade-out');
                content.classList.remove('animate-slide-up');
                content.classList.add('animate-slide-down');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('animate-fade-out');
                }, 250);
            } else {
                // Opening Animation
                // Load current settings BEFORE showing to avoid flickery toggles
                document.getElementById('setting-shuffle').checked = studySettings.shuffle;
                document.getElementById('setting-l1-first').checked = studySettings.l1First;
                document.getElementById('setting-auto-speak').checked = studySettings.autoSpeak;

                modal.classList.remove('hidden');
                modal.classList.remove('animate-fade-out');
                modal.classList.add('animate-fade-in');
                
                content.classList.remove('animate-slide-down');
                content.classList.add('animate-slide-up');
            }
        };

        window.handleSettingsBackdropClick = (event) => {
            if (event.target.id === 'study-settings-modal') {
                toggleStudySettings();
            }
        };

        window.applyStudySettings = async () => {
            studySettings.shuffle = document.getElementById('setting-shuffle').checked;
            studySettings.l1First = document.getElementById('setting-l1-first').checked;
            studySettings.autoSpeak = document.getElementById('setting-auto-speak').checked;
            
            // Persist to Firebase if logged in
            if (userId) {
                try {
                    const fRef = getFlashcardSettingsRef();
                    await setDoc(fRef, {
                        ...studySettings,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                } catch (e) {
                    console.error("Failed to persist flashcard settings:", e);
                }
            }
        };

        window.exitFlashcardStudy = () => {
            // INTERCEPT EXIT: If they clicked back while session is active (regardless of swipes)
            const isShowingStats = !document.getElementById("study-complete").classList.contains("hidden");
            const studyActive = document.getElementById("flashcard-study").classList.contains("active");

            if (studyActive && !isShowingStats) {
                showCompletionScreen("exit");
                return;
            }

            // Otherwise, perform actual exit
            forceExitStudy();
        };

        window.forceExitStudy = () => {
            document.getElementById("flashcard-study").classList.remove("active");
            document.getElementById("flashcards").classList.add("active");

            // Reset state
            currentStudySet = null;
            currentStudyCards = [];
            currentStudyIndex = 0;
            isStudyCardFlipped = false;
            studySessionStats = { known: 0, learning: 0, unknown: 0 };
            studyHistory = [];
            learningStack = [];
            hasPerformedAction = false;
            sessionRatingsLog = [];
            totalMasterStudyTime = 0;
        };

        // Speak current flashcard - speaks only the visible side
        window.speakCurrentFlashcard = () => {
            if (currentStudyIndex >= currentStudyCards.length) return;

            const card = currentStudyCards[currentStudyIndex];
            const showSpanish = !studySettings.l1First;
            const isFlipped = isStudyCardFlipped;

            // Determine which text to speak based on flip state and language setting
            let textToSpeak, langToUse;

            if (isFlipped) {
                // Back side is showing
                if (showSpanish) {
                    // Back shows English when l1First is false
                    textToSpeak = card.english;
                    langToUse = 'en-US';
                } else {
                    // Back shows Spanish when l1First is true
                    textToSpeak = card.spanish;
                    langToUse = 'es-ES';
                }
            } else {
                // Front side is showing
                if (showSpanish) {
                    // Front shows Spanish when l1First is false
                    textToSpeak = card.spanish;
                    langToUse = 'es-ES';
                } else {
                    // Front shows English when l1First is true
                    textToSpeak = card.english;
                    langToUse = 'en-US';
                }
            }

            // Remove text in parentheses before speaking
            textToSpeak = textToSpeak.replace(/\([^)]*\)/g, '').trim();

            // Speak only the visible term
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = langToUse;
            utterance.rate = 0.8; // Slightly slower for clarity
            window.speechSynthesis.speak(utterance);
        };

        window.speakText = (text) => {
            if (!text) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            window.speechSynthesis.speak(utterance);
        };


        // --- DUMMY LESSON DATA ---
        const DUMMY_LESSONS = [
            {
                id: 'L-A1-1',
                level: 'A1',
                title: 'Hola y Adi√≥s',
                description: 'Master the essential Spanish greetings and farewells.',
                videoId: 'dQw4w9WgXcQ', // Placeholder ID
                thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
                content: `
                    <h3 class="text-xl font-bold text-navy-900 mb-4">Introduction to Greetings</h3>
                    <p class="mb-4">In Spanish, greetings change depending on the time of day and who you are speaking to.</p>
                    <ul class="list-disc pl-5 space-y-2 mb-4">
                        <li><strong>Hola</strong> - Hello (Universal)</li>
                        <li><strong>Buenos d√≠as</strong> - Good morning (Until noon)</li>
                        <li><strong>Buenas tardes</strong> - Good afternoon (Until sunset)</li>
                        <li><strong>Buenas noches</strong> - Good evening/night</li>
                    </ul>
                    <p>Practice saying these out loud with the video above!</p>
                `
            },
            {
                id: 'L-A1-2',
                level: 'A1',
                title: 'Ser vs Estar',
                description: 'The eternal struggle: learning when to use which verb for "to be".',
                videoId: 'dQw4w9WgXcQ', 
                thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
                content: '<p>Content for Ser vs Estar...</p>'
            },
            {
                id: 'L-A2-1',
                level: 'A2',
                title: 'Past Tense Basics',
                description: 'Introduction to the Preterite tense for completed actions.',
                videoId: 'dQw4w9WgXcQ',
                thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
                content: '<p>Content for Past Tense...</p>'
            }
        ];


        // --- FLASHCARD HIERARCHY DATA STRUCTURE ---
        const INITIAL_FLASHCARD_SEED_DATA = [
            {
                id: 'A1',
                title: 'Level A1: Absolute Beginner',
                description: 'Start here. The foundational vocabulary for survival.',
                units: [
                    {
                        id: 'A1-U1',
                        title: 'Unit 1: The Basics',
                        reviewUrl: 'https://quizlet.com/latest', // Placeholder
                        sets: [
                            { id: 'A1-U1-S1', name: 'Set 1: Greetings & Introductions', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S2', name: 'Set 2: Numbers 1-20', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S3', name: 'Set 3: Common Objects', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S4', name: 'Set 4: Colors', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S5', name: 'Set 5: Family Members', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S6', name: 'Set 6: Days of the Week', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U1-S7', name: 'Set 7: Basic Verbs', url: 'https://quizlet.com/latest', cardCount: 32 }
                        ]
                    },
                    {
                        id: 'A1-U2',
                        title: 'Unit 2: Daily Life',
                        reviewUrl: 'https://quizlet.com/latest',
                        sets: [
                            { id: 'A1-U2-S1', name: 'Set 1: Food & Drink', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S2', name: 'Set 2: Time', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S3', name: 'Set 3: Daily Routine', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S4', name: 'Set 4: House & Home', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S5', name: 'Set 5: Clothes', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S6', name: 'Set 6: Weather', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A1-U2-S7', name: 'Set 7: Emotions', url: 'https://quizlet.com/latest', cardCount: 32 }
                        ]
                    }
                ]
            },
            {
                id: 'A2',
                title: 'Level A2: Elementary',
                description: 'Expanding your world. Describing past events and future plans.',
                units: [
                    {
                        id: 'A2-U1',
                        title: 'Unit 1: Travel & Places',
                        reviewUrl: 'https://quizlet.com/latest',
                        sets: [
                            { id: 'A2-U1-S1', name: 'Set 1: At the Airport', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S2', name: 'Set 2: Directions', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S3', name: 'Set 3: Hotels', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S4', name: 'Set 4: City Buildings', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S5', name: 'Set 5: Transport', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S6', name: 'Set 6: Nature', url: 'https://quizlet.com/latest', cardCount: 32 },
                            { id: 'A2-U1-S7', name: 'Set 7: Countries', url: 'https://quizlet.com/latest', cardCount: 32 }
                        ]
                    }
                ]
            },
            {
                id: 'B1',
                title: 'Level B1: Intermediate',
                description: 'Dealing with most situations while travelling.',
                units: [
                    {
                        id: 'B1-U1',
                        title: 'Unit 1: Opinions & Culture',
                        reviewUrl: 'https://quizlet.com/latest',
                        sets: [
                             { id: 'B1-U1-S1', name: 'Set 1: Abstract Nouns', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S2', name: 'Set 2: Politics', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S3', name: 'Set 3: Art', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S4', name: 'Set 4: Media', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S5', name: 'Set 5: Technology', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S6', name: 'Set 6: Work', url: 'https://quizlet.com/latest', cardCount: 32 },
                             { id: 'B1-U1-S7', name: 'Set 7: Education', url: 'https://quizlet.com/latest', cardCount: 32 }
                        ]
                    }
                ]
            }
        ];


        // --- UTILITIES & UI HELPERS ---
        const $ = selector => document.querySelector(selector);
        
        const showLoading = (message = "Connecting...") => {
            $('#loading-overlay').querySelector('p').textContent = message;
            $('#loading-overlay').style.display = 'flex';
        }
        const hideLoading = () => $('#loading-overlay').style.display = 'none';

        window.showModal = (title, message) => {
            $('#modal-title').textContent = title;
            // Allow HTML in the message to support the simulation button
            $('#modal-message').innerHTML = message.replace(/\n/g, '<br>');
            $('#message-modal').style.display = 'flex';
        };
        window.closeModal = () => {
            $('#message-modal').style.display = 'none';
        };

        const getProgressPath = () => {
            if (!userId) return null;
            return `artifacts/${appId}/users/${userId}/decks`;
        };

        const getDeckDocRef = (deckId) => {
            if (!db || !userId) return null;
            return doc(db, getProgressPath(), deckId);
        };
        
        // Updates the navigation links based on auth state
        const updateNav = (loggedIn) => {
            const signedOutDesktop = $('#desktop-nav-signed-out');
            const signedInDesktop = $('#desktop-nav-signed-in');
            const signedOutMobile = $('#mobile-menu-signed-out');
            const signedInMobile = $('#mobile-menu-signed-in');
            const footer = $('#main-footer');
            const upgradeBtn = $('#nav-upgrade-btn');
            
            if (loggedIn) {
                signedInDesktop?.classList.add('hidden', 'md:flex');
                signedOutDesktop?.classList.add('hidden');
                signedOutDesktop?.classList.remove('md:flex'); 
                signedOutMobile?.classList.add('hidden');
                signedInMobile?.classList.remove('hidden');
                footer?.classList.add('hidden');

                const activePageId = document.querySelector('.page-section.active')?.id;
                if (activePageId === 'home' || activePageId === 'login') {
                     router('dashboard'); 
                }

                // Show upgrade button if not premium
                if (upgradeBtn && userSubscriptionStatus !== 'premium') {
                    upgradeBtn.classList.remove('hidden');
                } else if (upgradeBtn) {
                    upgradeBtn.classList.add('hidden');
                }

            } else {
                signedOutDesktop?.classList.add('hidden', 'md:flex');
                signedInDesktop?.classList.add('hidden');
                signedInDesktop?.classList.remove('md:flex');
                signedOutMobile?.classList.remove('hidden');
                signedInMobile?.classList.add('hidden');
                footer?.classList.remove('hidden');
                if (upgradeBtn) upgradeBtn.classList.add('hidden');
                
                // Unlink Homepage: Redirect home/protected pages to login
                const activePageId = document.querySelector('.page-section.active')?.id;
                if (['home', 'dashboard', 'flashcards', 'lessons', 'tools-landing', 'tools-conjugation', 'account', 'subscription'].includes(activePageId)) {
                    router('login'); 
                }
            }
            $('#current-user-id').textContent = loggedIn ? userId : 'Not Logged In';
        };

        // --- AUTH LOGIC ---

        const initializeFirebase = async () => {
            if (!firebaseConfig.apiKey) {
                showModal("Setup Error", "Firebase configuration is missing. Check your keys.");
                return;
            }
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Initialize Stripe if key is present (not placeholder)
            if (!STRIPE_PUBLIC_KEY.includes('REPLACE')) {
                stripe = Stripe(STRIPE_PUBLIC_KEY);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    
                    // Fetch user subscription status
                    const userDoc = await getDoc(doc(db, `artifacts/${appId}/users`, user.uid));
                    if (userDoc.exists()) {
                        userSubscriptionStatus = userDoc.data().subscriptionStatus || 'free';
                        updateSubscriptionUI();
                    } else {
                        // Create basic doc if doesn't exist
                        await setDoc(doc(db, `artifacts/${appId}/users`, user.uid), {
                            email: user.email,
                            createdAt: new Date().toISOString(),
                            subscriptionStatus: 'free'
                        });
                    }

                    // --- CHECK FOR PAYMENT SUCCESS RETURN ---
                    // This handles the redirect back from Stripe
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('payment_success') === 'true') {
                        console.log("Payment success detected!");
                        
                        // 1. Optimistically update status (Instant Premium UI)
                        userSubscriptionStatus = 'premium';
                        
                        // 2. Clean the URL (remove ?payment_success=true so it doesn't re-trigger on refresh)
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                        // 3. Show celebration
                        setTimeout(() => {
                            if (typeof triggerConfetti === 'function') triggerConfetti();
                            showModal("¬°Excelente! üéâ", "Your payment was successful.\n\nWelcome to Premium! You now have unlimited access to AI Tutoring and advanced drills.");
                        }, 500);
                    }

                    updateNav(true);
                    listenForUserProgress();
                    await loadSettings();
                } else {
                    userId = null;
                    userProgress = {}; 
                    userSubscriptionStatus = 'free';
                    updateNav(false);
                }
                
                hideLoading();
            });
            
            // Initial fetch of public data
            fetchLessons();
            fetchFlashcards();
            
            hydrateVerbData(VERB_DB_RAW);
            fetchVerbsDatabase();

            showLoading("Checking authentication...");
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Custom token sign-in failed:", e));
            } else if (!auth.currentUser) {
                 await signInAnonymously(auth).catch(e => console.error("Anonymous sign-in failed:", e));
            }
        };

        const updateSubscriptionUI = () => {
            const badge = document.getElementById('dashboard-status-badge');
            const mobileUpgrade = document.getElementById('mobile-nav-upgrade');
            const accSub = document.getElementById('acc-subscription');
            const accUpgradeBtn = document.getElementById('acc-upgrade-btn');
            const portalSection = document.getElementById('acc-manage-portal');

            if (userSubscriptionStatus === 'premium') {
                if(badge) {
                    badge.className = "inline-flex items-center gap-1 bg-gradient-to-r from-gold-400 to-gold-600 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mt-2 shadow-sm";
                    badge.innerHTML = `<i data-lucide="star" class="w-3 h-3 fill-white"></i> Premium Member`;
                }
                if(mobileUpgrade) mobileUpgrade.classList.add('hidden');
                if(accSub) {
                    accSub.innerHTML = `<span class="text-gold-600 font-bold flex items-center gap-1"><i data-lucide="star" class="w-4 h-4 fill-gold-600"></i> Premium Active</span>`;
                }
                if (portalSection) portalSection.classList.remove('hidden'); // Show manage button for premium
            } else {
                if(badge) {
                     badge.className = "inline-flex items-center gap-1 bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mt-2";
                     badge.innerHTML = `<span>Free Plan</span>`;
                }
                if(mobileUpgrade) mobileUpgrade.classList.remove('hidden');
                if (portalSection) portalSection.classList.add('hidden');
                // Re-inject upgrade button if missing
                if(accSub && !accSub.querySelector('button')) {
                     accSub.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span>Free Plan</span>
                            <button onclick="router('subscription')" class="text-xs bg-gold-400 text-navy-900 px-2 py-1 rounded font-bold hover:bg-gold-500">UPGRADE</button>
                        </div>
                     `;
                }
            }
            updateNav(!!userId);
            if(window.lucide) lucide.createIcons();
        };

        // --- STRIPE PAYMENT LOGIC (BACKEND INTEGRATED) ---
        window.handleStripeCheckout = async (planKey, forceSimulation = false) => {
            // --- CONFIGURATION ---
            // HARDCODED URL BASED ON YOUR DEPLOYMENT LOGS
            const PROJECT_ID = "spanishbysammy-6a112"; 
            const REGION = "us-central1";
            const FUNCTION_URL = `https://${REGION}-${PROJECT_ID}.cloudfunctions.net`;

            // 0. CHECK FOR FILE PROTOCOL OR LOCALHOST SIMULATION
            const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isFile = window.location.protocol === 'file:';

            // Function to run the simulation (Success effect)
            const runSimulation = async () => {
                showLoading("Simulating Stripe...");
                await new Promise(resolve => setTimeout(resolve, 1500));
                hideLoading();
                if (typeof triggerConfetti === 'function') triggerConfetti();
                try {
                    userSubscriptionStatus = 'premium';
                    updateSubscriptionUI(); // Ensure full UI refresh
                    if (typeof updateNav === 'function') updateNav(true);
                } catch (e) { console.warn("Sim update failed", e); }
                showModal("Simulation Success! üß™", "Payment simulated successfully.\n\n(Note: In a real environment, you would be redirected to Stripe hosted checkout.)");
            };

            if (forceSimulation || isFile) {
                await runSimulation();
                return;
            }

            // 1. Check if logged in
            if (!userId) {
                router('login');
                return;
            }

            // 2. Check Configuration (Public Key)
            if (typeof STRIPE_PUBLIC_KEY === 'undefined' || STRIPE_PUBLIC_KEY.includes('REPLACE')) {
                showModal("Setup Required", "You haven't added your Stripe Public Key to index.html yet.\n\nSearch for 'STRIPE_PUBLIC_KEY' in the code (around line 1700) and replace the placeholder.");
                return;
            }

            // 3. Normalize Plan Key
            let normalizedKey = planKey;
            if (planKey.includes('monthly')) normalizedKey = 'monthly';
            if (planKey.includes('yearly')) normalizedKey = 'yearly';

            const priceId = STRIPE_PRICE_IDS[normalizedKey];
            
            // 4. Check Configuration (Price IDs)
            if (!priceId || priceId.includes('REPLACE')) {
                showModal("Setup Required", "You haven't added your Stripe Price IDs to index.html yet.\n\n1. Create products in Stripe Dashboard\n2. Copy the Price IDs (price_...)\n3. Update STRIPE_PRICE_IDS in index.html");
                return;
            }

            showLoading("Redirecting to secure checkout...");

            try {
                // Call the Cloud Function to create a checkout session
                const targetEndpoint = `${FUNCTION_URL}/createCheckoutSession`;
                console.log(`Attempting to connect to backend: ${targetEndpoint}`);
                
                const response = await fetch(targetEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        priceId: priceId,
                        userId: userId,
                        successUrl: window.location.origin + window.location.pathname + '?payment_success=true',
                        cancelUrl: window.location.origin + window.location.pathname
                    })
                });

                // --- SMART DIAGNOSTICS FOR HTTP ERRORS ---
                if (!response.ok) {
                    const text = await response.text();
                    let errorMessage = `Server Error: ${response.status}`;
                    try {
                        const json = JSON.parse(text);
                        errorMessage = json.error || errorMessage;
                    } catch (e) { errorMessage = text || errorMessage; }

                    if (response.status === 404) {
                        throw new Error(`FUNCTION_NOT_FOUND: The URL ${targetEndpoint} returned 404.`);
                    }
                    
                    throw new Error(errorMessage);
                }

                const { url } = await response.json();
                
                // Redirect to the Stripe hosted checkout page
                window.location.href = url;

            } catch (error) {
                console.error("Stripe Checkout Error:", error);
                hideLoading();
                
                let title = "Checkout Error";
                let message = error.message;
                let showSimulateButton = true; // Always allow simulation on error to unblock testing

                // --- INTERPRET THE ERROR ---
                
                if (error.message.includes("FUNCTION_NOT_FOUND")) {
                    title = "Backend URL Error üö®";
                    message = `We tried to reach: ${FUNCTION_URL}/createCheckoutSession\n\nBut the server said "Not Found".\n\n1. Check your Firebase Console to ensure the function name is exactly 'createCheckoutSession'.\n2. Check if the Region is correct (us-central1).`;
                }
                else if (error.message === 'Failed to fetch' || error.message.includes('NetworkError')) {
                    title = "Connection Failed";
                    message = `Could not reach ${FUNCTION_URL}.\n\nIt seems the frontend cannot see the backend. This might be a CORS issue or internet connectivity.`;
                } 
                else if (error.message.includes('Invalid API Key')) {
                    title = "Backend Config Error";
                    message = "Your Cloud Function has the wrong Stripe Secret Key. Please fix 'STRIPE_SECRET_KEY' in functions/index.js and run 'firebase deploy --only functions' again.";
                }

                // Show the modal with Simulate button
                const modal = document.getElementById('message-modal');
                const titleEl = document.getElementById('modal-title');
                const msgEl = document.getElementById('modal-message');
                
                titleEl.textContent = title;
                msgEl.innerHTML = `<div class="whitespace-pre-wrap text-sm">${message}</div>`;
                
                if (showSimulateButton) {
                    msgEl.innerHTML += `
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="font-bold text-sm mb-2 text-slate-700">Want to test the UI anyway?</p>
                            <button id="sim-btn-error" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded shadow transition">
                                Simulate Success
                            </button>
                        </div>
                    `;
                    setTimeout(() => {
                        const btn = document.getElementById('sim-btn-error');
                        if(btn) btn.onclick = () => { closeModal(); runSimulation(); };
                    }, 100);
                }

                modal.style.display = 'flex';
            }
        };

        // --- CUSTOMER PORTAL LOGIC (BACKEND INTEGRATED) ---
        window.openCustomerPortal = async () => {
            if (!userId) return;
            
            // HARDCODED URL
            const PROJECT_ID = "spanishbysammy-6a112"; 
            const REGION = "us-central1";
            const FUNCTION_URL = `https://${REGION}-${PROJECT_ID}.cloudfunctions.net`;

            showLoading("Opening portal...");

            try {
                const response = await fetch(`${FUNCTION_URL}/createPortalSession`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        returnUrl: window.location.origin + window.location.pathname
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || "Failed to open portal");
                }

                const { url } = await response.json();
                window.location.href = url;

            } catch (error) {
                console.error("Portal Error:", error);
                showModal("Portal Error", error.message);
                hideLoading();
            }
        };

        window.handleAuth = async (isLogin) => {
            const email = $('#auth-email').value;
            const password = $('#auth-password').value;
            const submitBtn = $('#auth-submit-btn');
            submitBtn.disabled = true;
            showLoading(isLogin ? "Logging in..." : "Creating account...");

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                    showModal("Welcome Back!", "Successfully logged in.");
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    await setDoc(doc(db, `artifacts/${appId}/users`, user.uid), {
                        email: user.email,
                        createdAt: new Date().toISOString(),
                        subscriptionStatus: 'free'
                    });
                    showModal("Success!", "Account created and logged in! Welcome to Spanish by Sammy.");
                }
                router('dashboard'); 

            } catch (error) {
                console.error("Auth Error:", error.message);
                showModal(isLogin ? "Login Failed" : "Signup Failed", error.message);
            } finally {
                submitBtn.disabled = false;
                hideLoading();
            }
        };
        
        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            const title = $('#auth-title');
            const submitBtn = $('#auth-submit-btn');
            const switchBtn = document.querySelector('#login button:last-child');
            
            if (isLoginMode) {
                title.textContent = "Log In";
                submitBtn.textContent = "LOG IN";
                submitBtn.onclick = () => handleAuth(true);
                switchBtn.textContent = "Don't have an account? Sign Up";
            } else {
                title.textContent = "Create New Account";
                submitBtn.textContent = "SIGN UP";
                submitBtn.onclick = () => handleAuth(false);
                switchBtn.textContent = "Already have an account? Log In";
            }
        };


        window.logout = async () => {
            showLoading("Logging out...");
            try {
                await signOut(auth);
                // Redirect to landing page on successful logout
                window.location.href = "https://spanishbysammy.netlify.app/";
            } catch (error) {
                console.error("Logout Error:", error.message);
                showModal("Logout Failed", "Could not log out: " + error.message);
                // Fallback to internal login screen if redirect or signout logic hiccups but user stays in app
                router('login');
            } finally {
                hideLoading();
            }
        };
        
        window.seedFlashcardsDatabase = async () => {
            if (!confirm("Are you sure you want to upload flashcards to the database?")) return;
            if (!userId) {
                 alert("Please log in first.");
                 return;
            }
            
            showLoading("Seeding Flashcards...");
            const flashcardsRef = collection(db, `artifacts/${appId}/public/data/flashcards`);
            
            try {
                for (const level of INITIAL_FLASHCARD_SEED_DATA) {
                     await setDoc(doc(flashcardsRef, level.id), level);
                }
                alert("Flashcards seeded successfully!");
                fetchFlashcards();
            } catch (error) {
                console.error("Seeding Error:", error);
                alert("Error seeding: " + error.message);
            } finally {
                hideLoading();
            }
        };

        // --- FIREBASE DATA LOGIC (REPLACING LOCAL STORAGE) ---
        
        const fetchLessons = async () => {
             try {
                const lessonsRef = collection(db, `artifacts/${appId}/public/data/lessons`);
                const snapshot = await getDocs(lessonsRef);
                
                if (snapshot.empty) {
                    allLessons = DUMMY_LESSONS;
                } else {
                    allLessons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allLessons.sort((a, b) => a.id.localeCompare(b.id));
                }

                if (document.getElementById('lessons').classList.contains('active')) {
                    renderLessonLibrary();
                    updateLessonsDashboard();
                } else {
                    updateLessonsDashboard();
                }
                
             } catch (error) {
                 console.error("Error fetching lessons:", error);
                 allLessons = DUMMY_LESSONS;
                 updateLessonsDashboard();
             }
        };

        const fetchFlashcards = async () => {
             console.log("üîç fetchFlashcards() called");
             try {
                const setsRef = collection(db, 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/definedSets');
                console.log("üì° Fetching from:", 'artifacts/spanishbysammy-6a112/public/data/lang-paths/en-es/definedSets');
                const snapshot = await getDocs(setsRef);
                console.log("üì¶ Snapshot received. Empty?", snapshot.empty, "Doc count:", snapshot.docs.length);
                
                if (snapshot.empty) {
                    console.warn("‚ö†Ô∏è No documents found in definedSets!");
                    flashcardData = [];
                } else {
                    const rawSets = snapshot.docs.map(doc => doc.data());
                    console.log("üìÑ Raw sets data:", rawSets);
                    flashcardData = transformSetsToLevels(rawSets);
                    console.log("‚ú® Transformed flashcardData:", flashcardData);
                }

                if (document.getElementById('flashcards').classList.contains('active')) {
                    console.log("üéØ Flashcards page is active, calling renderFlashcards()");
                    renderFlashcards();
                    updateFlashcardDashboard();
                } else {
                    console.log("‚è∏Ô∏è Flashcards page not active, updating dashboard only");
                    updateFlashcardDashboard();
                }
                
             } catch (error) {
                 console.error("‚ùå Error fetching flashcards:", error);
                 flashcardData = [];
                 updateFlashcardDashboard();
             }
        };

        function transformSetsToLevels(rawSets) {
            const levelMap = {};
            
            rawSets.forEach(set => {
                const level = set.level.toUpperCase();
                if (!levelMap[level]) {
                    levelMap[level] = {
                        id: level,
                        title: `Level ${level}`,
                        description: getLevelDescription(level),
                        sets: []
                    };
                }
                levelMap[level].sets.push(set);
            });
            
            return Object.values(levelMap).sort((a, b) => a.id.localeCompare(b.id));
        }

        function getLevelDescription(level) {
            const descriptions = {
                'A1': 'Absolute Beginner - Essential Foundation',
                'A2': 'Elementary - Basic Communication',
                'B1': 'Intermediate - Everyday Conversations',
                'B2': 'Upper Intermediate - Complex Topics',
                'C1': 'Advanced - Professional Fluency',
                'C2': 'Mastery - Native-like Proficiency'
            };
            return descriptions[level] || 'Learning Spanish';
        }

        const listenForUserProgress = () => {
            if (!db || !userId) {
                userProgress = {};
                renderDeckProgress();
                return;
            }
            
            const progressCollectionRef = collection(db, getProgressPath());
            
            onSnapshot(query(progressCollectionRef), (snapshot) => {
                const newProgress = {};
                snapshot.forEach((doc) => {
                    newProgress[doc.id] = doc.data();
                });
                
                userProgress = newProgress;
                
                renderDeckProgress();
                if (document.getElementById('flashcards').classList.contains('active')) {
                    renderFlashcards();
                }
                if (document.getElementById('lessons').classList.contains('active')) {
                    renderLessonLibrary();
                }
                updateFlashcardDashboard();
                updateLessonsDashboard();

            }, (error) => {
                console.error("Error listening to progress:", error.message);
            });
        };

        window.toggleDeckFirebase = async (deckId) => {
            if (!userId || auth.currentUser.isAnonymous) {
                showModal("Access Denied", "Please create a full account to save your permanent progress.");
                return;
            }
            const fromFlashcards = deckId.startsWith('A') || deckId.startsWith('B');
            
            if(!fromFlashcards) showLoading("Saving progress...");

            const docRef = getDeckDocRef(deckId);
            const isCompleted = userProgress[deckId]?.status === 'complete';
            
            try {
                if (isCompleted) {
                    await setDoc(docRef, { status: 'incomplete', completedAt: null, userId: userId });
                    if(!fromFlashcards) showModal("Progress Reset", `Deck ${deckId} status was reset to incomplete.`);
                } else {
                    const timestamp = new Date().toISOString();
                    await setDoc(docRef, { status: 'complete', completedAt: timestamp, userId: userId });
                    if(!fromFlashcards) showModal("Deck Complete!", `Congratulations! Progress saved.`);
                }
            } catch (error) {
                console.error("Toggle Completion Error:", error.message);
                showModal("Save Failed", "Could not update progress: " + error.message);
            } finally {
               if(!fromFlashcards) hideLoading();
            }
        };

        window.handleReviewUnit = async (unitId, url) => {
            if (!userId) return;
            window.open(url, '_blank');
            const docRef = getDeckDocRef(unitId);
            const timestamp = new Date().toISOString();
            
            try {
                await setDoc(docRef, { 
                    lastReviewed: timestamp, 
                    reviewCount: increment(1),
                    userId: userId 
                }, { merge: true });
                
            } catch (error) {
                console.error("Review Update Failed:", error);
            }
        };
        
        const LEVEL_DESCRIPTIONS = {
            'A1': 'Absolute Beginner',
            'A2': 'Beginner',
            'B1': 'Low Intermediate',
            'B2': 'High Intermediate',
            'C1': 'Proficient',
            'C2': 'Expert'
        };

        window.updateLessonsDashboard = () => {
             let totalLessons = allLessons.length;
             let completedCount = 0;
             let firstIncomplete = null;
             
             allLessons.forEach(l => {
                 const isDone = userProgress[l.id]?.status === 'complete';
                 if (isDone) completedCount++;
                 else if (!firstIncomplete) firstIncomplete = l;
             });
             
             const progressEl = document.getElementById('dash-lessons-progress');
             if (progressEl) progressEl.textContent = `${completedCount}/${totalLessons}`;
             
             let levelText = 'A1';
             let descText = 'Absolute Beginner';
             let nextLessonTitle = 'Introduction';
             let pct = 0;

             if (firstIncomplete) {
                 levelText = firstIncomplete.level;
                 descText = LEVEL_DESCRIPTIONS[firstIncomplete.level] || 'Learning';
                 nextLessonTitle = firstIncomplete.title;
                 pct = totalLessons > 0 ? (completedCount / totalLessons) * 100 : 0;
                 currentNextLessonId = firstIncomplete.id;
             } else if(totalLessons > 0) {
                 levelText = "C2+";
                 descText = "Mastery";
                 nextLessonTitle = "All Complete!";
                 pct = 100;
                 currentNextLessonId = null;
             }

             if(progressEl) {
                 document.getElementById('dash-lessons-level').textContent = levelText;
                 document.getElementById('dash-lessons-desc').textContent = descText;
                 document.getElementById('dash-lessons-next').textContent = nextLessonTitle;
             }

             const homeLevel = document.getElementById('home-level-display');
             if (homeLevel) {
                 homeLevel.textContent = levelText;
                 document.getElementById('home-next-lesson').textContent = nextLessonTitle;
                 document.getElementById('home-lesson-bar').style.width = pct + "%";
             }
        }

        window.renderLessonLibrary = () => {
            const container = document.getElementById('lessons-container');
            if(!container) return;
            container.innerHTML = '';
            
            const levels = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            let nextIncompleteLesson = null;
            
            levels.forEach(level => {
                const levelLessons = allLessons.filter(l => l.level === level);
                const totalLevel = levelLessons.length;
                const completedLevel = levelLessons.filter(l => userProgress[l.id]?.status === 'complete').length;
                const isLevelComplete = totalLevel > 0 && totalLevel === completedLevel;

                const levelDiv = document.createElement('div');
                levelDiv.className = 'bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-4';
                
                const headerBg = isLevelComplete ? 'bg-gray-100' : 'bg-navy-900';
                const headerText = isLevelComplete ? 'text-gray-500' : 'text-white';
                const check = isLevelComplete ? `<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>` : '';

                levelDiv.innerHTML = `
                    <div onclick="toggleAccordion('lvl-${level}')" class="${headerBg} ${headerText} p-4 cursor-pointer flex justify-between items-center hover:opacity-90 transition">
                        <div class="flex items-center gap-2">
                            ${check}
                            <h2 class="text-lg font-bold">Level ${level}</h2>
                        </div>
                        <i data-lucide="chevron-down" class="w-5 h-5 transform transition-transform" id="icon-lvl-${level}"></i>
                    </div>
                    <div id="content-lvl-${level}" class="accordion-content bg-gray-50">
                        <div class="p-2 space-y-2">
                            ${levelLessons.length ? '' : '<div class="p-4 text-gray-400 text-sm italic text-center">No lessons available yet.</div>'}
                        </div>
                    </div>
                `;
                container.appendChild(levelDiv);

                if (levelLessons.length > 0) {
                    const contentDiv = levelDiv.querySelector(`#content-lvl-${level} > div`);
                    levelLessons.forEach(lesson => {
                        const lessonItem = document.createElement('div');
                        lessonItem.className = 'bg-white border border-gray-200 rounded overflow-hidden';
                        const isCompleted = userProgress[lesson.id]?.status === 'complete';
                        
                        if (!isCompleted && !nextIncompleteLesson) {
                            nextIncompleteLesson = lesson;
                        }
                        
                        const completedStyles = isCompleted ? 'text-gray-400' : 'text-navy-900';
                        const checkIcon = isCompleted ? `<i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>` : '';

                        lessonItem.innerHTML = `
                            <div onclick="toggleAccordion('${lesson.id}')" class="p-3 cursor-pointer hover:bg-gray-50 transition flex justify-between items-center">
                                <div class="flex items-center gap-2">
                                    ${checkIcon}
                                    <span class="font-medium ${completedStyles}">${lesson.title}</span>
                                </div>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 transform transition-transform" id="icon-${lesson.id}"></i>
                            </div>
                            <div id="content-${lesson.id}" class="accordion-content">
                                <div class="p-4 border-t border-gray-100 flex flex-col sm:flex-row gap-4">
                                    <div class="w-full sm:w-32 h-20 bg-gray-200 rounded flex-shrink-0 overflow-hidden relative">
                                        <img src="${lesson.thumbnail}" class="w-full h-full object-cover opacity-80" alt="Thumbnail">
                                        <div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play-circle" class="w-8 h-8 text-white"></i></div>
                                    </div>
                                    <div class="flex-grow">
                                        <p class="text-sm text-gray-600 mb-3">${lesson.description}</p>
                                        <button onclick="openLesson('${lesson.id}')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-1.5 rounded text-xs font-bold uppercase tracking-wide transition shadow-sm w-full sm:w-auto">
                                            ${isCompleted ? 'Review Lesson' : 'Start Lesson'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        contentDiv.appendChild(lessonItem);
                    });
                }
            });
            
            if(window.lucide) lucide.createIcons();

            if (nextIncompleteLesson) {
                setTimeout(() => {
                    const lvlId = `lvl-${nextIncompleteLesson.level}`;
                    const lvlContent = document.getElementById(`content-${lvlId}`);
                    if(lvlContent && !lvlContent.classList.contains('open')) {
                        toggleAccordion(lvlId);
                    }
                    setTimeout(() => {
                         const lessId = nextIncompleteLesson.id;
                         const lessContent = document.getElementById(`content-${lessId}`);
                         if(lessContent && !lessContent.classList.contains('open')) {
                             toggleAccordion(lessId);
                         }
                    }, 300);
                }, 100);
            }
        };
        
        window.jumpToNextLesson = () => {
             if (currentNextLessonId) {
                 jumpToLesson(currentNextLessonId);
             } else {
                 alert("All lessons completed!");
             }
        };

        window.jumpToLesson = (lessonId) => {
            const lesson = allLessons.find(l => l.id === lessonId);
            if (!lesson) return;
            
            exitSearchMode('lessons');

            const lvlId = `lvl-${lesson.level}`;
            const lvlContent = document.getElementById(`content-${lvlId}`);
            if(lvlContent && !lvlContent.classList.contains('open')) {
                toggleAccordion(lvlId);
            }

            setTimeout(() => {
                const lessonContent = document.getElementById(`content-${lesson.id}`);
                if(lessonContent && !lessonContent.classList.contains('open')) {
                    toggleAccordion(lesson.id);
                }
                
                const element = document.getElementById(`content-${lesson.id}`).parentNode;
                if(element) {
                     element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 300);
        };

        // --- SEARCH BAR LOGIC (NEW) ---
        window.enterSearchMode = (sectionId) => {
            const containerId = sectionId === 'lessons' ? 'lessons-search-container' : 'verb-search-container';
            const container = document.getElementById(containerId);
            const backBtn = document.getElementById(`${sectionId}-back-btn`);
            const dismissBtn = document.getElementById(`${sectionId}-dismiss-btn`);
            
            if(container) {
                container.classList.add('search-active');
                if(backBtn) backBtn.classList.remove('hidden');
                if(dismissBtn) dismissBtn.classList.remove('hidden');
                
                // Show results container immediately in search mode
                if(sectionId === 'lessons') {
                     document.getElementById('lessons-search-results').classList.remove('hidden');
                     document.getElementById('lessons-container').classList.add('hidden');
                     document.getElementById('lessons-dashboard-wrapper').style.marginBottom = '0';
                }
                if (sectionId === 'verbs') {
                     // For verbs, the list container is already inside/adjacent. We might move it if it's not inside.
                     // The structure provided puts verb-list-container inside or adjacent. 
                     // In the modified HTML, it is inside or near. We just ensure it's visible.
                     // Actually, for full screen effect on verbs, we ensure the container fills the space.
                     // The layout handles overflow-y auto on results if designed that way.
                }
            }
        };

        window.exitSearchMode = (sectionId) => {
            const containerId = sectionId === 'lessons' ? 'lessons-search-container' : 'verb-search-container';
            const container = document.getElementById(containerId);
            const backBtn = document.getElementById(`${sectionId}-back-btn`);
            const dismissBtn = document.getElementById(`${sectionId}-dismiss-btn`);
            const input = document.getElementById(sectionId === 'lessons' ? 'lesson-search-input' : 'verb-search-input');

            if(container) {
                container.classList.remove('search-active');
                if(backBtn) backBtn.classList.add('hidden');
                if(dismissBtn) dismissBtn.classList.add('hidden');
                if(input) {
                    input.value = '';
                    input.blur();
                }

                if(sectionId === 'lessons') {
                    // Reset View
                     document.getElementById('lessons-search-results').classList.add('hidden');
                     document.getElementById('lessons-container').classList.remove('hidden');
                     document.getElementById('lessons-dashboard-wrapper').style.marginBottom = '';
                }
                if (sectionId === 'verbs') {
                     filterVerbList(); // Reset list
                }
            }
        };

        window.dismissKeyboard = () => {
             if(document.activeElement) {
                 document.activeElement.blur();
             }
        };

        window.handleLessonSearch = () => {
            const queryText = document.getElementById('lesson-search-input').value.toLowerCase();
            const resultsContainer = document.getElementById('lessons-search-results');
            
            // In search mode, results are always shown (even if empty, showing empty state)
            resultsContainer.innerHTML = '';
            
            const filtered = allLessons.filter(l => 
                l.title.toLowerCase().includes(queryText) || 
                l.description.toLowerCase().includes(queryText)
            );
            
            if (filtered.length === 0) {
                resultsContainer.innerHTML = '<div class="text-center text-gray-500 py-8">No lessons found.</div>';
                return;
            }
            
            filtered.forEach(lesson => {
                const isCompleted = userProgress[lesson.id]?.status === 'complete';
                const card = document.createElement('div');
                // Condensed styling
                card.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-2 mb-2 flex flex-row gap-3 items-center';
                const checkIcon = isCompleted ? `<i data-lucide="check-circle" class="w-3 h-3 text-green-500 inline mr-1"></i>` : '';
                
                card.innerHTML = `
                    <div class="w-12 h-12 bg-gray-200 rounded flex-shrink-0 overflow-hidden relative">
                        <img src="${lesson.thumbnail}" class="w-full h-full object-cover opacity-80" alt="Thumb">
                        <div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play" class="w-4 h-4 text-white fill-white"></i></div>
                    </div>
                    <div class="flex-grow min-w-0">
                        <h3 class="font-bold text-navy-900 text-sm leading-tight truncate">${checkIcon}${lesson.level} - ${lesson.title}</h3>
                        <p class="text-xs text-gray-500 truncate">${lesson.description}</p>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="jumpToLesson('${lesson.id}')" class="bg-gray-100 hover:bg-gray-200 text-navy-900 px-2 py-1 rounded text-xs font-bold whitespace-nowrap border border-gray-200">
                            Jump
                        </button>
                        <button onclick="openLesson('${lesson.id}')" class="bg-orange-500 text-white px-3 py-1 rounded text-xs font-bold whitespace-nowrap">
                            ${isCompleted ? 'Review' : 'Start'}
                        </button>
                    </div>
                `;
                resultsContainer.appendChild(card);
            });
             if(window.lucide) lucide.createIcons();
        };

        window.viewLessonInPlan = (lessonId, levelId) => {
             // Logic to expand accordions (unchanged, but triggered differently if needed)
             // ... existing implementation ...
        };

        window.startNextLesson = () => {
            let nextIncompleteLesson = null;
             for (const lesson of allLessons) {
                 const isCompleted = userProgress[lesson.id]?.status === 'complete';
                 if (!isCompleted) {
                     nextIncompleteLesson = lesson;
                     break;
                 }
             }
             if (nextIncompleteLesson) {
                 openLesson(nextIncompleteLesson.id);
             } else {
                 alert("All lessons complete! Great job!");
             }
        };

        window.openLesson = (lessonId) => {
            // ... existing logic ...
            exitSearchMode('lessons'); // Exit search if active
            const lesson = allLessons.find(l => l.id === lessonId);
            if(!lesson) return;

            justCompletedLesson = false;
            document.getElementById('player-status-badge').classList.add('hidden');

            currentLessonForAI = lesson;

            document.getElementById('player-level').textContent = `Level ${lesson.level}`;
            document.getElementById('player-main-title').textContent = lesson.title;
            document.getElementById('player-title').textContent = lesson.title;
            document.getElementById('player-content').innerHTML = lesson.content;
            
            if(userProgress[lesson.id]?.status === 'complete') {
                document.getElementById('player-status-badge').classList.remove('hidden');
            }
            
            document.getElementById('player-iframe').src = `https://www.youtube.com/embed/${lesson.videoId}?rel=0`;
            document.getElementById('player-video-placeholder').style.display = 'none';

            document.getElementById('lessons').classList.remove('active');
            document.getElementById('lesson-view').classList.add('active');
            window.scrollTo(0,0);
        };
        
        // --- AI & QUIZ LOGIC ---
        const apiKey = ""; 

        async function callGemini(prompt, systemPrompt) {
            if (!USE_CLOUD_FUNCTIONS) {
                if (!apiKey) {
                    alert("API Key is missing for local testing! Please add it to the code.");
                    throw new Error("API Key Missing");
                }

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                const delays = [1000, 2000, 4000, 8000, 16000];
                for (let i = 0; i <= delays.length; i++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const data = await response.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text;
                    } catch (error) {
                        if (i === delays.length) throw error;
                        await new Promise(resolve => setTimeout(resolve, delays[i]));
                    }
                }
            } else {
                alert("Production mode enabled but Cloud Functions not yet deployed.");
                throw new Error("Cloud Functions Not Ready");
            }
        }

        window.startQuiz = async () => {
            if (!currentLessonForAI) return;
            document.getElementById('lesson-view').classList.remove('active');
            document.getElementById('quiz-view').classList.add('active');
            document.getElementById('quiz-loading').classList.remove('hidden');
            document.getElementById('quiz-content').classList.add('hidden');

            await generateQuizQuestions();
        }

        window.generateQuizQuestions = async () => {
            const level = currentLessonForAI.level;
            let languageInstruction = "The user is a beginner student. Ask the questions in English, but provide the multiple choice answers in Spanish.";
            
            if (['C1', 'C2'].includes(level)) {
                languageInstruction = "The user is an advanced student. Ask the questions in Spanish and provide the multiple choice answers in Spanish.";
            } else if (['B1', 'B2'].includes(level)) {
                 languageInstruction = "The user is an intermediate student. Ask the questions in English, but provide the multiple choice answers in Spanish.";
            }

            const systemPrompt = `You are a Spanish language teacher. Create a quiz based on the provided lesson text.
            ${languageInstruction}
            Output STRICT JSON format: { "questions": [ { "question": "...", "options": ["A", "B", "C", "D"], "correctAnswerIndex": 0, "explanation": "..." } ] }`;
            
            const userPrompt = `Using the text and title of this lesson, identify the grammar principle being taught and generate 5 multiple choice questions the user can use to practice that topic.
            Title: ${currentLessonForAI.title}
            Content: ${currentLessonForAI.content.replace(/<[^>]*>/g, '')}`;

            try {
                const jsonString = await callGemini(userPrompt, systemPrompt);
                const cleanJson = jsonString.replace(/```json|```/g, '').trim();
                const data = JSON.parse(cleanJson);
                
                currentQuizQuestions = data.questions;
                currentQuizIndex = 0;
                currentQuizScore = 0;
                renderQuizQuestion();
                document.getElementById('quiz-loading').classList.add('hidden');
                document.getElementById('quiz-content').classList.remove('hidden');
            } catch (error) {
                console.error("Quiz Generation Error:", error);
                alert("Failed to generate quiz. Please try again.");
                router('lesson-view');
            }
        }
        
        window.renderQuizQuestion = () => {
            const q = currentQuizQuestions[currentQuizIndex];
            document.getElementById('quiz-q-num').textContent = currentQuizIndex + 1;
            document.getElementById('quiz-score').textContent = `Score: ${currentQuizScore}`;
            document.getElementById('quiz-question-text').textContent = q.question;
            
            const optionsDiv = document.getElementById('quiz-options');
            optionsDiv.innerHTML = '';
            
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-4 rounded-lg border border-gray-200 hover:bg-gray-50 transition flex items-center gap-3 group';
                btn.onclick = () => handleAnswer(idx, btn);
                btn.innerHTML = `
                    <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center group-hover:border-orange-500 text-xs font-bold text-gray-500 group-hover:text-orange-500 transition">
                        ${String.fromCharCode(65 + idx)}
                    </div>
                    <span class="text-gray-700 group-hover:text-navy-900">${opt}</span>
                `;
                optionsDiv.appendChild(btn);
            });

            document.getElementById('quiz-feedback').classList.add('hidden');
            document.getElementById('quiz-next-btn').classList.add('hidden');
            document.getElementById('quiz-finish-btn').classList.add('hidden');
        }

        window.handleAnswer = (selectedIndex, btnElement) => {
            const q = currentQuizQuestions[currentQuizIndex];
            const isCorrect = selectedIndex === q.correctAnswerIndex;
            const feedbackEl = document.getElementById('quiz-feedback');
            const allBtns = document.querySelectorAll('#quiz-options button');
            allBtns.forEach(b => b.disabled = true);

            if (isCorrect) {
                btnElement.classList.add('bg-green-100', 'border-green-500');
                currentQuizScore++;
                feedbackEl.className = "mt-6 p-4 rounded-lg bg-green-50 text-green-800 text-sm border border-green-200";
                feedbackEl.innerHTML = `<strong>Correct!</strong> ${q.explanation}`;
            } else {
                btnElement.classList.add('bg-red-100', 'border-red-500');
                allBtns[q.correctAnswerIndex].classList.add('bg-green-50', 'border-green-500');
                feedbackEl.className = "mt-6 p-4 rounded-lg bg-red-50 text-red-800 text-sm border border-red-200";
                feedbackEl.innerHTML = `<strong>Incorrect.</strong> The correct answer was ${String.fromCharCode(65 + q.correctAnswerIndex)}. ${q.explanation}`;
            }
            
            feedbackEl.classList.remove('hidden');
            
            if (currentQuizIndex < 4) {
                document.getElementById('quiz-next-btn').classList.remove('hidden');
            } else {
                document.getElementById('quiz-finish-btn').classList.remove('hidden');
            }
            document.getElementById('quiz-score').textContent = `Score: ${currentQuizScore}`;
        }

        window.nextQuestion = () => {
            currentQuizIndex++;
            renderQuizQuestion();
        }

        window.finishQuiz = async () => {
            if (currentQuizScore >= 4) {
                await toggleDeckFirebase(currentLessonForAI.id); 
                justCompletedLesson = true;
                alert("Quiz Passed! Lesson Completed.");
            } else {
                alert(`You scored ${currentQuizScore}/5. You need at least 4/5 to pass. Try again!`);
            }
            
            document.getElementById('quiz-view').classList.remove('active');
            document.getElementById('lesson-view').classList.add('active');
            
            if (justCompletedLesson) {
                triggerConfetti();
                document.getElementById('player-status-badge').classList.remove('hidden');
                renderLessonLibrary();
            }
        }

        // --- AI CHAT LOGIC ---
        window.openAIAssistant = () => {
             if (!currentLessonForAI) return;
             if (userSubscriptionStatus !== 'premium') {
                 showModal("Premium Feature", "AI Tutor Chat is a Premium feature. Please upgrade to Pro.");
                 router('subscription');
                 return;
             }
             
             document.getElementById('lesson-view').classList.remove('active');
             document.getElementById('ai-chat-view').classList.add('active');
             
             const history = document.getElementById('chat-history');
             history.innerHTML = `
                <div class="chat-bubble chat-ai">
                    Hola! I'm your AI tutor. I can help you with the lesson you are currently studying. What questions do you have?
                </div>
             `;
        }

        window.sendChatMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            const history = document.getElementById('chat-history');
            
            history.innerHTML += `<div class="chat-bubble chat-user">${text}</div>`;
            input.value = '';
            history.scrollTop = history.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            history.innerHTML += `
                <div id="${loadingId}" class="chat-bubble chat-ai typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            history.scrollTop = history.scrollHeight;

            const systemPrompt = `You are a helpful, encouraging Spanish tutor. 
            The user is currently studying a lesson titled: "${currentLessonForAI.title}".
            Here is the content of the lesson they are looking at: "${currentLessonForAI.content.replace(/<[^>]*>/g, '')}".
            Answer their questions specifically about this content, or Spanish grammar/vocab in general. Keep answers concise and helpful.`;

            try {
                const responseText = await callGemini(text, systemPrompt);
                document.getElementById(loadingId).remove();
                const formattedText = responseText.replace(/\n/g, '<br>');
                history.innerHTML += `<div class="chat-bubble chat-ai">${formattedText}</div>`;
                
            } catch (error) {
                console.error("Chat Error:", error);
                document.getElementById(loadingId).remove();
                history.innerHTML += `<div class="chat-bubble chat-ai text-red-500">Lo siento, I'm having trouble connecting. Please try again.</div>`;
            }
            history.scrollTop = history.scrollHeight;
        }

        // --- NEW: CONJUGATION DRILL LOGIC ---

        // 2. Data Hydration Logic 
        window.hydrateVerbData = (sourceData = VERB_DB_RAW) => {
            const haber = sourceData.find(v => v.infinitive === 'haber') || VERB_DB_RAW.find(v => v.infinitive === 'haber');
            const estar = sourceData.find(v => v.infinitive === 'estar') || VERB_DB_RAW.find(v => v.infinitive === 'estar');
            
            if (!haber || !estar) {
                console.error("Auxiliary verbs missing in source data!");
                VERB_DB = sourceData;
                return;
            }

            VERB_DB = sourceData.map(verb => {
                const hydrated = JSON.parse(JSON.stringify(verb)); 
                const perfectMapping = {
                    'Present': 'Present Perfect',
                    'Preterite': 'Preterite Perfect',
                    'Imperfect': 'Imperfect Perfect',
                    'Future': 'Future Perfect',
                    'Conditional': 'Conditional Perfect',
                    'Subjunctive Present': 'Present Perfect Subjunctive',
                    'Subjunctive Imperfect': 'Past Perfect Subjunctive' 
                };
                const progressiveMapping = {
                    'Present': 'Present Progressive',
                    'Preterite': 'Preterite Progressive',
                    'Imperfect': 'Imperfect Progressive',
                    'Future': 'Future Progressive',
                    'Conditional': 'Conditional Progressive'
                };

                ALL_SUBJECTS.forEach(sub => {
                    for (const [auxTense, targetTense] of Object.entries(perfectMapping)) {
                        if (haber.conjugations[auxTense] && haber.conjugations[auxTense][sub]) {
                            if (!hydrated.conjugations[targetTense]) hydrated.conjugations[targetTense] = {};
                            hydrated.conjugations[targetTense][sub] = `${haber.conjugations[auxTense][sub]} ${verb.participle}`;
                        }
                    }
                    for (const [auxTense, targetTense] of Object.entries(progressiveMapping)) {
                        if (estar.conjugations[auxTense] && estar.conjugations[auxTense][sub]) {
                            if (!hydrated.conjugations[targetTense]) hydrated.conjugations[targetTense] = {};
                            hydrated.conjugations[targetTense][sub] = `${estar.conjugations[auxTense][sub]} ${verb.gerund}`;
                        }
                    }
                });
                return hydrated;
            });
            console.log("Hydrated Verb DB:", VERB_DB);
            if(document.getElementById('tools-conjugation').classList.contains('active')) {
                filterVerbList();
            }
        }

        // 3. Settings Management (Firestore Persistence)
        const getSettingsRef = () => {
            if(!db || !userId) return null;
            return doc(db, `artifacts/${appId}/users/${userId}/settings/conjugation`);
        }

        const getFlashcardSettingsRef = () => {
            if(!db || !userId) return null;
            return doc(db, `artifacts/${appId}/users/${userId}/settings/flashcards`);
        }

        window.loadSettings = async () => {
            // --- Conjugation Defaults ---
            enabledTenses = {};
            Object.values(TENSE_HIERARCHY).flat().forEach(t => enabledTenses[t] = false);
            enabledTenses['Present'] = true;
            enabledSubjects = {};
            ALL_SUBJECTS.forEach(s => enabledSubjects[s] = true);

            // --- Flashcard Defaults ---
            studySettings = {
                shuffle: false,
                l1First: false,
                autoSpeak: false
            };

            if (!userId) return;

            // Load Conjugation Settings
            try {
                const ref = getSettingsRef();
                const snapshot = await getDoc(ref);
                if (snapshot.exists()) {
                    const data = snapshot.data();
                    if (data.tenses) enabledTenses = { ...enabledTenses, ...data.tenses };
                    if (data.subjects) enabledSubjects = { ...enabledSubjects, ...data.subjects };
                }
            } catch (e) {
                console.error("Failed to load conjugation settings:", e);
            }

            // Load Flashcard Settings
            try {
                const fRef = getFlashcardSettingsRef();
                const fSnapshot = await getDoc(fRef);
                if (fSnapshot.exists()) {
                    const fData = fSnapshot.data();
                    studySettings = { ...studySettings, ...fData };
                }
            } catch (e) {
                console.error("Failed to load flashcard settings:", e);
            }
        }

        window.saveSettings = async () => {
            if (userId) {
                try {
                    const ref = getSettingsRef();
                    await setDoc(ref, {
                        tenses: enabledTenses,
                        subjects: enabledSubjects,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                } catch (e) {
                    console.error("Failed to save conjugation settings:", e);
                }
            }
            alert("Settings saved!");
            toggleSettingsModal();
        }

        window.toggleVerbSort = () => {
            verbSortMode = verbSortMode === 'frequency' ? 'alphabetical' : 'frequency';
            const btnLabel = document.getElementById('verb-sort-label');
            if (verbSortMode === 'frequency') {
                btnLabel.textContent = "Freq";
            } else {
                btnLabel.textContent = "A-Z";
            }
            filterVerbList();
        }

        window.filterVerbList = () => {
            const containerId = 'verb-list-container';
            const query = document.getElementById('verb-search-input').value.toLowerCase();
            const container = document.getElementById(containerId);
            const isSearchMode = document.getElementById('verb-search-container').classList.contains('search-active');
            
            container.innerHTML = '';
            
            // In search mode, ensure container is styled for overlay scroll if needed
            if (isSearchMode) {
                container.className = "search-results-condensed"; // Use fixed/scroll style
            } else {
                container.className = "bg-white rounded-xl shadow-sm border border-gray-200 divide-y divide-gray-100 overflow-hidden mb-6 mt-4 transition-all";
            }

            const sortedVerbs = [...VERB_DB].sort((a,b) => {
                if (verbSortMode === 'frequency') {
                    if (a.rank === b.rank) return a.infinitive.localeCompare(b.infinitive);
                    return a.rank - b.rank;
                } else {
                    return a.infinitive.localeCompare(b.infinitive);
                }
            });
            
            const filtered = sortedVerbs.filter(v => 
                v.infinitive.toLowerCase().includes(query) || 
                v.translation.toLowerCase().includes(query)
            );
            
            if (filtered.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500 italic">No verbs found.</div>`;
                return;
            }
            
            filtered.forEach(verb => {
                const rankBadge = verbSortMode === 'frequency' 
                    ? `<span class="text-[10px] font-mono bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">#${verb.rank}</span>` 
                    : '';

                const div = document.createElement('div');
                
                if (isSearchMode) {
                    // Condensed Item
                    div.className = "p-2 border-b border-gray-100 flex justify-between items-center hover:bg-gray-50 cursor-pointer transition";
                     div.innerHTML = `
                        <div class="flex items-center gap-2">
                            ${rankBadge}
                            <div class="flex items-baseline gap-2">
                                <div class="font-bold text-base text-navy-900 capitalize">${verb.infinitive}</div>
                                <div class="text-xs text-gray-500 truncate max-w-[150px]">${verb.translation}</div>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                    `;
                } else {
                    // Standard Item
                    div.className = "p-4 flex justify-between items-center hover:bg-gray-50 cursor-pointer transition";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            ${rankBadge}
                            <div>
                                <div class="font-bold text-lg text-navy-900 capitalize">${verb.infinitive}</div>
                                <div class="text-sm text-gray-500">${verb.translation}</div>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300"></i>
                    `;
                }

                div.onclick = () => {
                     exitSearchMode('verbs');
                     startDrill(verb.infinitive);
                };
                container.appendChild(div);
            });
            if(window.lucide) lucide.createIcons();
        }

        window.startDrill = (verbKey) => {
            currentDrillVerb = VERB_DB.find(v => v.infinitive === verbKey);
            if (!currentDrillVerb) return;
            
            // Premium Check for advanced drills (optional example)
            // if (currentDrillVerb.rank > 50 && userSubscriptionStatus !== 'premium') { ... }

            document.getElementById('verb-selection-view').classList.add('hidden');
            document.getElementById('verb-practice-view').classList.remove('hidden');
            
            document.getElementById('practice-infinitive').textContent = currentDrillVerb.infinitive.charAt(0).toUpperCase() + currentDrillVerb.infinitive.slice(1);
            document.getElementById('practice-translation').textContent = currentDrillVerb.translation;

            renderSettingsCheckboxes(); 
            nextCard();
        }

        window.exitPractice = () => {
             document.getElementById('verb-practice-view').classList.add('hidden');
             document.getElementById('verb-selection-view').classList.remove('hidden');
        }

        window.nextCard = () => {
             const card = document.getElementById('practice-card');
             card.classList.remove('animate-swipe-left', 'animate-swipe-right');
             void card.offsetWidth; 
             
             const activeTenses = Object.keys(enabledTenses).filter(k => enabledTenses[k]);
             
             if (activeTenses.length === 0) {
                 alert("Please enable at least one tense in settings!");
                 toggleSettingsModal();
                 return;
             }

             const randomTense = activeTenses[Math.floor(Math.random() * activeTenses.length)];
             
             if (!currentDrillVerb.conjugations[randomTense]) {
                 return nextCard(); 
             }
             
             const activeSubjects = ALL_SUBJECTS.filter(s => enabledSubjects[s]);
             if (activeSubjects.length === 0) {
                 alert("Please enable at least one subject in settings!");
                 toggleSettingsModal();
                 return;
             }
             
             const randomSubject = activeSubjects[Math.floor(Math.random() * activeSubjects.length)];
             const answer = currentDrillVerb.conjugations[randomTense][randomSubject];
             
             currentDrillCard = {
                 subject: randomSubject,
                 answer: answer,
                 tense: randomTense
             };
             
             isCardRevealed = false;
             updateCardUI();
        }

        window.updateCardUI = () => {
             document.getElementById('card-tense').textContent = currentDrillCard.tense;
             document.getElementById('card-subject').textContent = currentDrillCard.subject;
             
             const hiddenEl = document.getElementById('card-hidden');
             const revealedEl = document.getElementById('card-revealed');
             
             if (isCardRevealed) {
                 hiddenEl.classList.add('hidden');
                 revealedEl.classList.remove('hidden');
                 revealedEl.textContent = currentDrillCard.answer;
                 
                 if (document.getElementById('setting-autospeak').checked) {
                     speakText(currentDrillCard.answer);
                 }
             } else {
                 hiddenEl.classList.remove('hidden');
                 revealedEl.classList.add('hidden');
             }
        }

        window.flipCard = () => {
            if (!isCardRevealed) {
                isCardRevealed = true;
                updateCardUI();
            }
        }

        window.handleSwipe = (direction) => {
             const card = document.getElementById('practice-card');
             if (direction === 'left') {
                 card.classList.add('animate-swipe-left');
             } else {
                 card.classList.add('animate-swipe-right');
             }
             setTimeout(() => {
                 nextCard();
             }, 350);
        }

        window.speakCurrentCard = () => {
            if (isCardRevealed) {
                speakText(currentDrillCard.answer);
            } else {
                speakText(currentDrillCard.subject);
            }
        }

        window.speakText = (text) => {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES'; 
            window.speechSynthesis.speak(utterance);
        }

        // --- SETTINGS MODAL LOGIC ---
        window.toggleSettingsModal = () => {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
        }

        window.renderSettingsCheckboxes = () => {
             const container = document.getElementById('settings-tenses-container');
             container.innerHTML = '';
             
             // --- 1. SUBJECTS SECTION ---
             const subjectSection = document.createElement('div');
             const allSubjectsEnabled = ALL_SUBJECTS.every(s => enabledSubjects[s]);
             subjectSection.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wide">Subjects</h4>
                    <button onclick="toggleAllSubjects(${!allSubjectsEnabled})" class="text-xs font-bold text-orange-500 hover:text-orange-600">
                        ${allSubjectsEnabled ? 'Disable All' : 'Enable All'}
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2 pl-2 border-l-2 border-gray-100" id="subjects-list"></div>
             `;
             container.appendChild(subjectSection);
             const subList = subjectSection.querySelector('#subjects-list');
             
             ALL_SUBJECTS.forEach(sub => {
                 const div = document.createElement('div');
                 div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100 transition';
                 div.innerHTML = `
                    <span class="text-sm font-medium text-navy-900">${sub}</span>
                    <input type="checkbox" onchange="updateSubjectSetting('${sub}', this.checked)" ${enabledSubjects[sub] ? 'checked' : ''} class="w-5 h-5 accent-navy-900">
                 `;
                 subList.appendChild(div);
             });
             
             container.appendChild(document.createElement('hr')); 

             // --- 2. TENSES SECTIONS ---
             for (const [category, tenses] of Object.entries(TENSE_HIERARCHY)) {
                 const section = document.createElement('div');
                 
                 const allEnabled = tenses.every(t => enabledTenses[t]);
                 
                 section.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wide">${category}</h4>
                        <button onclick="toggleCategory('${category}', ${!allEnabled})" class="text-xs font-bold text-orange-500 hover:text-orange-600">
                            ${allEnabled ? 'Disable All' : 'Enable All'}
                        </button>
                    </div>
                    <div class="space-y-2 pl-2 border-l-2 border-gray-100" id="cat-${category}">
                        <!-- Tenses -->
                    </div>
                 `;
                 container.appendChild(section);
                 
                 const list = section.querySelector(`#cat-${category}`);
                 tenses.forEach(tense => {
                     if (enabledTenses[tense] === undefined) enabledTenses[tense] = false;

                     const div = document.createElement('div');
                     div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100 transition';
                     div.innerHTML = `
                        <span class="text-sm font-medium text-navy-900">${tense}</span>
                        <input type="checkbox" onchange="updateTenseSetting('${tense}', this.checked)" ${enabledTenses[tense] ? 'checked' : ''} class="w-5 h-5 accent-navy-900">
                     `;
                     list.appendChild(div);
                 });
             }
             
             const modalBtn = document.querySelector('#settings-modal button.bg-navy-900');
             modalBtn.onclick = saveSettings; 
        }

        window.toggleAllSubjects = (shouldEnable) => {
            ALL_SUBJECTS.forEach(s => enabledSubjects[s] = shouldEnable);
            renderSettingsCheckboxes();
        }

        window.updateSubjectSetting = (subject, isChecked) => {
            enabledSubjects[subject] = isChecked;
        }

        window.toggleCategory = (category, shouldEnable) => {
            const tenses = TENSE_HIERARCHY[category];
            tenses.forEach(t => enabledTenses[t] = shouldEnable);
            renderSettingsCheckboxes(); 
        }

        window.updateTenseSetting = (tense, isChecked) => {
            enabledTenses[tense] = isChecked;
        }

        window.fetchVerbsDatabase = async () => {
            try {
                const verbsRef = collection(db, `artifacts/${appId}/public/data/verbs`);
                const snapshot = await getDocs(verbsRef);

                if (!snapshot.empty) {
                    const fetchedRaw = snapshot.docs.map(doc => doc.data());
                    hydrateVerbData(fetchedRaw);
                } else {
                    hydrateVerbData(VERB_DB_RAW);
                }
            } catch (e) {
                console.error("Error fetching verbs from DB:", e);
                hydrateVerbData(VERB_DB_RAW);
            }
        }

        window.seedVerbsDatabase = async () => {
            if (!userId) return alert("Please log in first to seed the database.");
            if(!confirm("Are you sure you want to upload all local verbs to the database?")) return;

            showLoading("Seeding Verbs Database...");
            try {
                const verbsCollectionPath = `artifacts/${appId}/public/data/verbs`;
                const verbsRef = collection(db, verbsCollectionPath);
                
                let count = 0;
                for (const verb of VERB_DB_RAW) {
                    await setDoc(doc(verbsRef, verb.infinitive), verb);
                    count++;
                }
                
                alert(`Successfully seeded ${count} verbs to Firestore!`);
                fetchVerbsDatabase();
                
            } catch (error) {
                console.error("Seeding Error:", error);
                alert("Error seeding database: " + error.message);
            } finally {
                hideLoading();
            }
        }

        // --- RENDERING & ROUTING ---

        const renderDeckProgress = () => {
            let completedCount = 0;
            SPANISH_DECKS.forEach(deck => {
                const btn = document.getElementById('btn-' + deck.id);
                if (!btn) return;
                const isCompleted = userProgress[deck.id]?.status === 'complete';
                if (isCompleted) {
                    completedCount++;
                    btn.classList.remove('border-gray-300', 'text-gray-400', 'hover:bg-gray-50');
                    btn.classList.add('bg-green-500', 'text-white', 'border-green-500', 'hover:bg-green-600');
                    btn.querySelector('.status-text').textContent = "Completed";
                } else {
                    btn.classList.remove('bg-green-500', 'text-white', 'border-green-500', 'hover:bg-green-600');
                    btn.classList.add('border-2', 'border-gray-300', 'text-gray-400', 'hover:bg-gray-50');
                    btn.querySelector('.status-text').textContent = "Mark Complete";
                }
            });
            const totalEl = document.getElementById('total-completed');
            if(totalEl) totalEl.textContent = completedCount;
        }

        window.handleSetOpen = (setId, setName) => {
            lastStudiedSet = { id: setId, name: setName };
            updateFlashcardDashboard();
        }

        window.showZipfInfo = () => {
            showModal("Zipf's Law & Fluency", 
                "Linguist George Zipf discovered that a small number of words are used very frequently. \n\n" +
                "‚Ä¢ Top 1,000 words ‚âà 80% of daily speech.\n" +
                "‚Ä¢ Top 3,000 words ‚âà 95% of daily speech.\n\n" +
                "Your 'Wall' progress tracks how close you are to mastering these high-frequency terms."
            );
        };

        window.showReviewInfo = () => {
            showModal("Maintenance & SRS", 
                "We use Spaced Repetition (SRS) to schedule your reviews. \n\n" +
                "‚Ä¢ 1st Review: Due in 3 days\n" +
                "‚Ä¢ 2nd Review: Due in 7 days\n" +
                "‚Ä¢ 3rd Review: Due in 15 days\n" +
                "‚Ä¢ 4th Review: Due in 30 days\n" +
                "‚Ä¢ 5+ Reviews: Due in 60 days\n\n" +
                "Colors indicate urgency:\n" +
                "üü¢ Green: Fresh (Safe)\n" +
                "üü° Yellow: Review Soon\n" +
                "üî¥ Red: Review Now!"
            );
        };

        // --- DASHBOARD CAROUSEL LOGIC ---
        window.switchDashboardView = (direction) => {
            currentDashboardSlide += direction;
            if (currentDashboardSlide < 0) currentDashboardSlide = 0;
            if (currentDashboardSlide > 2) currentDashboardSlide = 2;

            const track = document.getElementById('dashboard-track');
            const prevBtn = document.getElementById('dash-nav-prev');
            const nextBtn = document.getElementById('dash-nav-next');
            const studyBtn = document.getElementById('dash-nav-study');
            const reviewBtn = document.getElementById('dash-nav-review');
            const reportsBtn = document.getElementById('dash-nav-reports');

            track.style.transform = `translateX(-${currentDashboardSlide * 33.333}%)`;

            // Update navigation buttons
            if (studyBtn) studyBtn.classList.toggle('bg-orange-500', currentDashboardSlide === 0);
            if (studyBtn) studyBtn.classList.toggle('text-white', currentDashboardSlide === 0);
            if (studyBtn) studyBtn.classList.toggle('bg-gray-200', currentDashboardSlide !== 0);
            if (studyBtn) studyBtn.classList.toggle('text-gray-700', currentDashboardSlide !== 0);

            if (reviewBtn) reviewBtn.classList.toggle('bg-orange-500', currentDashboardSlide === 1);
            if (reviewBtn) reviewBtn.classList.toggle('text-white', currentDashboardSlide === 1);
            if (reviewBtn) reviewBtn.classList.toggle('bg-gray-200', currentDashboardSlide !== 1);
            if (reviewBtn) reviewBtn.classList.toggle('text-gray-700', currentDashboardSlide !== 1);

            if (reportsBtn) reportsBtn.classList.toggle('bg-orange-500', currentDashboardSlide === 2);
            if (reportsBtn) reportsBtn.classList.toggle('text-white', currentDashboardSlide === 2);
            if (reportsBtn) reportsBtn.classList.toggle('bg-gray-200', currentDashboardSlide !== 2);
            if (reportsBtn) reportsBtn.classList.toggle('text-gray-700', currentDashboardSlide !== 2);

            // Hide prev/next buttons at extremes
            if (prevBtn) prevBtn.style.display = currentDashboardSlide === 0 ? 'none' : 'block';
            if (nextBtn) nextBtn.style.display = currentDashboardSlide === 2 ? 'none' : 'block';
        };

        const getDaysAgo = (dateString) => {
            if (!dateString) return null;
            const diff = new Date() - new Date(dateString);
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

        window.updateFlashcardDashboard = () => {
            let totalSets = 0;
            let totalCompleted = 0;
            let totalVocabLearned = 0;
            let currentLevel = null;
            let nextSet = null;
            let currentLevelProgress = { completed: 0, total: 0 };
            const activeDates = new Set();
            activeDates.add(new Date().toDateString());

            // NEW STRUCTURE: Level ‚Üí Sets (no units)
            for(let level of flashcardData) {
                let levelCompletedCount = 0;
                
                for(let set of level.sets) {
                    totalSets++;
                    const progressData = userProgress[set.setID];
                    const isDone = progressData?.status === 'complete';
                    
                    if(isDone) {
                        totalCompleted++;
                        levelCompletedCount++;
                        totalVocabLearned += (set.cardCount || 32);
                        
                        if (progressData.completedAt) {
                            activeDates.add(new Date(progressData.completedAt).toDateString());
                        }
                    } else {
                        if(!nextSet) {
                            nextSet = set;
                            currentLevel = level;
                        }
                    }
                }
                
                // Track current level progress
                if (!currentLevel || levelCompletedCount < level.sets.length) {
                    if (!currentLevel) {
                        currentLevel = level;
                    }
                    if (currentLevel.id === level.id) {
                        currentLevelProgress = {
                            completed: levelCompletedCount,
                            total: level.sets.length,
                            levelId: level.id,
                            title: level.title
                        };
                    }
                }
            }

            // If all complete, use last level
            if (!nextSet && flashcardData.length > 0) {
                const lastLevel = flashcardData[flashcardData.length-1];
                currentLevel = lastLevel;
                currentLevelProgress = {
                    completed: lastLevel.sets.length,
                    total: lastLevel.sets.length,
                    levelId: lastLevel.id,
                    title: lastLevel.title
                };
                nextSet = { title: "All complete! üéâ" };
            }

            // Update Calendar
            const calendarEl = document.getElementById('streak-calendar');
            const streakMsg = document.getElementById('streak-msg'); 
            
            if (calendarEl) {
                calendarEl.innerHTML = '';
                const today = new Date();
                
                for(let i=1; i<=28; i++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day text-xs font-bold text-gray-300';
                    const checkDate = new Date(today.getFullYear(), today.getMonth(), i).toDateString();
                    const isToday = i === today.getDate();
                    const hasActivity = activeDates.has(checkDate);

                    if (hasActivity) {
                        dayDiv.innerHTML = 'üî•';
                        dayDiv.classList.add('text-orange-500');
                    } else {
                        dayDiv.textContent = i;
                    }
                    if (isToday) {
                        dayDiv.classList.add('bg-gray-100', 'rounded');
                    }
                    calendarEl.appendChild(dayDiv);
                }
                
                document.getElementById('streak-badge').textContent = activeDates.size + " Days";
                if(streakMsg) streakMsg.textContent = "Great job! Keep the fire burning!";
            }

            // Update Current Level Progress
            const currentLevelTitle = document.getElementById('dash-current-unit-title');
            if(currentLevelTitle && currentLevelProgress) {
                currentLevelTitle.textContent = currentLevelProgress.title || 'Loading...';
            }
            
            const pct = currentLevelProgress.total > 0 
                ? Math.round((currentLevelProgress.completed / currentLevelProgress.total) * 100) 
                : 0;
            
            const progBar = document.getElementById('dash-progress-bar');
            if(progBar) progBar.style.width = pct + "%";
            
            const progText = document.getElementById('dash-progress-text');
            if(progText) progText.textContent = `${currentLevelProgress.completed}/${currentLevelProgress.total}`;

            // Update Sticky Header
            const stickyTitle = document.getElementById('sticky-title');
            if(stickyTitle) stickyTitle.textContent = currentLevelProgress.title || 'Loading...';
            
            const stickySubtitle = document.getElementById('sticky-subtitle');
            if(stickySubtitle) stickySubtitle.textContent = currentLevel ? currentLevel.title : 'Level';
            
            const stickyProgBar = document.getElementById('sticky-progress-bar');
            if(stickyProgBar) stickyProgBar.style.width = pct + "%";
            
            const stickyProgText = document.getElementById('sticky-progress-text');
            if(stickyProgText) stickyProgText.textContent = `${currentLevelProgress.completed}/${currentLevelProgress.total}`;

            // Update Next Set
            const nextSetEl = document.getElementById('dash-next-set');
            if(nextSetEl && nextSet) nextSetEl.textContent = nextSet.title || 'Loading...';
            
            // Store for jump functionality
            window.nextSetTarget = nextSet;

            const wallTotal = 10000;
            const wallPct = Math.min(100, Math.round((totalVocabLearned / wallTotal) * 100));
            
            const wallCountEl = document.getElementById('wall-vocab-count');
            if(wallCountEl) wallCountEl.textContent = totalVocabLearned.toLocaleString();
            const wallProgEl = document.getElementById('wall-progress-bar');
            if(wallProgEl) wallProgEl.style.width = wallPct + "%";
            const fluTextEl = document.getElementById('zipf-fluency-text');
            
            let fluencyPct = 0;
            if (totalVocabLearned > 0) {
                fluencyPct = Math.min(99, Math.round(15 * Math.log(totalVocabLearned) - 30)); 
                if (fluencyPct < 0) fluencyPct = 0;
            }
            if(fluTextEl) fluTextEl.textContent = `${fluencyPct}% Conversational Fluency Achieved`;

            const homeWallCount = document.getElementById('home-wall-count');
            if (homeWallCount) homeWallCount.textContent = totalVocabLearned.toLocaleString();
            const homeWallBar = document.getElementById('home-wall-bar');
            if (homeWallBar) homeWallBar.style.width = wallPct + "%";
            const homeStreakDisplay = document.getElementById('home-streak-display');
            if (homeStreakDisplay) homeStreakDisplay.textContent = `${activeDates.size} Day Streak`;

            // Update CEFR Level Display
            const cefrLevel = getCEFRLevel(totalVocabLearned);
            const cefrIconEl = document.getElementById('cefr-level-icon');
            const cefrLevelEl = document.getElementById('cefr-level-display');
            const cefrDescEl = document.getElementById('cefr-description');
            const cefrProgressEl = document.getElementById('cefr-progress-bar');
            const cefrWordsToNextEl = document.getElementById('cefr-words-to-next');
            const cefrCurrentRangeEl = document.getElementById('cefr-current-range');

            if (cefrIconEl) cefrIconEl.textContent = getCEFRIcon(cefrLevel.current.level);
            if (cefrLevelEl) {
                const levelSpan = cefrLevelEl.querySelector('span:last-child');
                if (levelSpan) levelSpan.textContent = cefrLevel.current.level;
            }
            if (cefrDescEl) cefrDescEl.textContent = cefrLevel.current.description;
            if (cefrProgressEl) cefrProgressEl.style.width = cefrLevel.progress + '%';
            if (cefrWordsToNextEl) cefrWordsToNextEl.textContent = cefrLevel.wordsToNext;
            if (cefrCurrentRangeEl) cefrCurrentRangeEl.textContent = cefrLevel.current.range;

            // Review Maintenance: Coming soon for new structure
            const reviewContainer = document.getElementById('review-list-container');
            const emptyState = document.getElementById('review-empty-state');

            if (reviewContainer) {
                reviewContainer.innerHTML = '';

                // Reset stats to 0 for now
                document.getElementById('rev-stat-total').textContent = '0';
                document.getElementById('rev-stat-red').textContent = '0';
                document.getElementById('rev-stat-yellow').textContent = '0';
                document.getElementById('rev-stat-green').textContent = '0';

                // Show empty state
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.textContent = 'Review system coming soon for new structure!';
                }
            }
        }

        window.jumpToNext = () => {
            if(!window.nextUnitTarget) return;
            
            const levelContent = document.getElementById(`content-${window.nextUnitTarget.levelId}`);
            if(levelContent && !levelContent.classList.contains('open')) {
                toggleAccordion(window.nextUnitTarget.levelId);
            }

            setTimeout(() => {
                const unitContent = document.getElementById(`content-${window.nextUnitTarget.unitId}`);
                if(unitContent && !unitContent.classList.contains('open')) {
                    toggleAccordion(window.nextUnitTarget.unitId);
                }
                
                const unitElement = document.getElementById(`content-${window.nextUnitTarget.unitId}`).parentNode;
                unitElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        window.triggerConfetti = () => {
            if (window.confetti) {
                window.confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        window.renderFlashcards = () => {
            const container = document.getElementById('flashcards-container');
            if(!container) return;

            const currentlyOpen = new Set();
            document.querySelectorAll('.accordion-content.open').forEach(el => {
                currentlyOpen.add(el.id);
            });

            container.innerHTML = ''; 

            flashcardData.forEach(level => {
                const totalSets = level.sets.length;
                const completedSets = level.sets.filter(s => userProgress[s.setID]?.status === 'complete').length;
                const isLevelComplete = totalSets > 0 && completedSets === totalSets;
                
                if (isLevelComplete && previousLevelStates[level.id] === false) {
                    triggerConfetti();
                    if(currentlyOpen.has(`content-${level.id}`)) {
                        currentlyOpen.delete(`content-${level.id}`);
                    }
                }
                previousLevelStates[level.id] = isLevelComplete;

                const levelCard = document.createElement('div');
                levelCard.className = 'bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden';
                
                const headerBg = isLevelComplete ? 'bg-gray-200' : 'bg-navy-900';
                const titleColor = isLevelComplete ? 'text-gray-500' : 'text-white';
                const subTextColor = isLevelComplete ? 'text-gray-400' : 'text-gray-300';
                const chevronColor = isLevelComplete ? 'text-gray-500' : 'text-white';
                const checkMark = isLevelComplete ? `<i data-lucide="check-circle-2" class="w-6 h-6 text-green-600 mr-2"></i>` : '';

                levelCard.innerHTML = `
                    <div onclick="toggleAccordion('${level.id}')" class="${headerBg} p-6 cursor-pointer flex justify-between items-center transition hover:opacity-90">
                        <div class="flex items-center">
                            ${checkMark}
                            <div>
                                <h2 class="text-xl font-bold ${titleColor}">${level.title}</h2>
                                <p class="text-sm mt-1 ${subTextColor}">${level.description}</p>
                            </div>
                        </div>
                        <i data-lucide="chevron-down" class="w-6 h-6 transform transition-transform duration-300 ${chevronColor}" id="icon-${level.id}"></i>
                    </div>
                    
                    <div id="content-${level.id}" class="accordion-content bg-gray-50">
                        <div class="p-2">
                            <ul class="divide-y divide-gray-100" id="sets-${level.id}"></ul>
                        </div>
                    </div>
                `;

                container.appendChild(levelCard);

                const setsList = levelCard.querySelector(`#sets-${level.id}`);
                
                level.sets.forEach(set => {
                    const isCompleted = userProgress[set.setID]?.status === 'complete';
                    
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-3 hover:bg-gray-50 transition';
                    li.innerHTML = `
                        <div class="flex items-center gap-3">
                            <button onclick="toggleDeckFirebase('${set.setID}')" class="focus:outline-none transition transform hover:scale-110">
                                <i data-lucide="check-circle" class="w-6 h-6 ${isCompleted ? 'text-green-500' : 'text-gray-300'}"></i>
                            </button>
                            <span class="font-medium text-gray-700 ${isCompleted ? 'line-through opacity-50' : ''}">${set.title}</span>
                        </div>
                        <button onclick="openFlashcardStudy('${set.setID}')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-1.5 rounded text-xs font-bold uppercase">
                            Study
                        </button>
                    `;
                    setsList.appendChild(li);
                });
            });
            
            if(window.lucide) lucide.createIcons();

            currentlyOpen.forEach(id => {
                const el = document.getElementById(id);
                const icon = document.getElementById(id.replace('content-', 'icon-'));
                if (el) {
                    el.classList.add('open');
                    el.style.maxHeight = 'none';
                }
                if (icon) {
                    icon.classList.add('rotate-180');
                }
            });
        };

        window.toggleAccordion = (id) => {
            const content = document.getElementById(`content-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            const isOpen = content.classList.contains('open');
        
            if (isOpen) {
                content.style.maxHeight = content.scrollHeight + "px";
                content.offsetHeight; 
                content.style.maxHeight = null;
                content.classList.remove('open');
                icon.classList.remove('rotate-180');
            } else {
                content.classList.add('open');
                icon.classList.add('rotate-180');
                content.style.maxHeight = content.scrollHeight + "px";
                setTimeout(() => {
                    if (content.classList.contains('open')) {
                        content.style.maxHeight = 'none';
                    }
                }, 500);
            }
        };


        window.router = (pageId) => {
            const protectedPages = ['dashboard', 'flashcards', 'lessons', 'tools-landing', 'tools-conjugation', 'account', 'subscription'];
            if (protectedPages.includes(pageId) && !userId) {
                pageId = 'login';
            }

            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            const target = document.getElementById(pageId);
            if(target) {
                target.classList.add('active');
                window.scrollTo(0,0);
            }
            
            setTimeout(() => { 
                if (window.lucide) lucide.createIcons();
                if (pageId === 'tools-landing') {
                    renderDeckProgress(); 
                }
                if (pageId === 'flashcards') {
                    renderFlashcards(); 
                    updateFlashcardDashboard();
                }
                if (pageId === 'lessons') {
                    renderLessonLibrary();
                    updateLessonsDashboard();
                }
                if (pageId === 'tools-conjugation') {
                     exitPractice();
                     filterVerbList(); 
                }
                if (pageId === 'account') {
                    if(auth.currentUser) {
                        document.getElementById('acc-email').textContent = auth.currentUser.email || 'Anonymous';
                        document.getElementById('acc-uid').textContent = auth.currentUser.uid;
                    }
                }
            }, 50);

            document.getElementById('mobile-menu').classList.add('hidden');
        }

        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });

        window.addEventListener('scroll', () => {
            const flashcardsSection = document.getElementById('flashcards');
            if (!flashcardsSection || !flashcardsSection.classList.contains('active')) return;

            const stickyHeader = document.getElementById('flashcards-sticky-header');
            const cardsContainer = document.getElementById('flashcards-container');
            const dashboard = document.getElementById('flashcard-dashboard');

            if (!stickyHeader || !cardsContainer) return;
            
            // Get position of the FIRST CARD inside the container relative to viewport
            // We use the first child of the container as the trigger point
            const firstCard = cardsContainer.firstElementChild;
            
            if (firstCard) {
                const rect = firstCard.getBoundingClientRect();
                const triggerPoint = 80; // Approximate top nav height + padding
                
                // If the top of the first card scrolls ABOVE the trigger point, show sticky header
                if (rect.top < triggerPoint) {
                    if (stickyHeader.classList.contains('hidden')) {
                         stickyHeader.classList.remove('hidden');
                    }
                } else {
                    if (!stickyHeader.classList.contains('hidden')) {
                        stickyHeader.classList.add('hidden');
                    }
                }
            } else {
                 // Fallback if no cards loaded yet
                 stickyHeader.classList.add('hidden');
            }
        });

        window.onload = () => {
            initializeFirebase();
        };

    </script>
</body>
</html>
